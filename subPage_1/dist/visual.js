"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(a,r){function h(e){try{d(i.next(e))}catch(t){r(t)}}function l(e){try{d(i.throw(e))}catch(t){r(t)}}function d(e){var t;e.done?a(e.value):((t=e.value)instanceof n?t:new n(function(e){e(t)})).then(h,l)}d((i=i.apply(e,t||[])).next())})};function compareImages(){let e=parseInt(document.getElementById("threshold").value);processImages(e)}const btnCompare=document.getElementById("btnCompare");function compareImageSize(e,t){return e.width===t.width&&e.height===t.height||(alert("兩張圖片大小必須相同"),!1)}function getImageData(e){let t=document.createElement("canvas");t.width=e.width,t.height=e.height;let n=t.getContext("2d");return n.drawImage(e,0,0),n.getImageData(0,0,e.width,e.height)}function findDifferentPixels(e,t,n=10){let i=[];if(e.width!==t.width||e.height!==t.height)throw Error("圖片大小不一致");for(let a=0;a<e.height;a++)for(let r=0;r<e.width;r++){let h=(a*e.width+r)*4,l=e.data[h],d=e.data[h+1],o=e.data[h+2],g=t.data[h],c=t.data[h+1],u=t.data[h+2],s=Math.abs(l-g)>n||Math.abs(d-c)>n||Math.abs(o-u)>n;s&&i.push({x:r,y:a,r1:l,g1:d,b1:o,r2:g,g2:c,b2:u})}return i}function loadImage(e){return __awaiter(this,void 0,void 0,function*(){return new Promise((t,n)=>{let i=new Image;i.onload=()=>t(i),i.onerror=n,i.src=URL.createObjectURL(e)})})}function calculateBoundingCircle(e){let t=Math.min(...e.map(e=>e.x)),n=Math.max(...e.map(e=>e.x)),i=Math.min(...e.map(e=>e.y)),a=Math.max(...e.map(e=>e.y));return{centerX:(t+n)/2,centerY:(i+a)/2,radius:Math.max((n-t)/2,(a-i)/2)+10}}function drawBoundingCircle(e,t,n,i,a=!1){let r=new Path2D;return r.arc(t,n,i,0,2*Math.PI),e.beginPath(),e.arc(t,n,i,0,2*Math.PI),a?(e.strokeStyle="red",e.lineWidth=5,e.setLineDash([])):(e.strokeStyle="yellow",e.lineWidth=3,e.setLineDash([5,5])),e.stroke(),r}function processImages(){return __awaiter(this,arguments,void 0,function*(e=10){let t=document.getElementById("image1"),n=document.getElementById("image2"),i=t.files[0],a=n.files[0];if(!i||!a){alert("請選擇兩張圖片");return}let r=document.getElementById("originalCanvas1"),h=document.getElementById("originalCanvas2"),l=document.getElementById("diffCanvas"),d=r.getContext("2d"),o=h.getContext("2d"),g=l.getContext("2d");d.clearRect(0,0,r.width,r.height),o.clearRect(0,0,h.width,h.height),g.clearRect(0,0,l.width,l.height);try{let[c,u]=yield Promise.all([loadImage(i),loadImage(a)]);if(r.width=c.width,r.height=c.height,d.drawImage(c,0,0),h.width=u.width,h.height=u.height,o.drawImage(u,0,0),!compareImageSize(c,u))return;let s=getImageData(c),f=getImageData(u),m=findDifferentPixels(s,f,e);return drawBoundingCircle_multiple(m,c,u,l,g),m}catch(w){return console.error("圖片加載錯誤",w),alert("圖片加載失敗"),[]}})}function clusterDiffPixels(e,t=50){if(e.length<=1)return[e];let n=[],i=new Set;for(let a=0;a<e.length;a++){if(i.has(a))continue;let r=[e[a]];i.add(a);for(let h=a+1;h<e.length;h++){if(i.has(h))continue;let l=Math.sqrt(Math.pow(e[a].x-e[h].x,2)+Math.pow(e[a].y-e[h].y,2));l<=t&&(r.push(e[h]),i.add(h))}n.push(r)}return n}function drawBoundingCircle_multiple(e,t,n,i,a){i.width=t.width,i.height=t.height,a.drawImage(n,0,0);let r=clusterDiffPixels(e),h=[];r.forEach(e=>{let{centerX:t,centerY:n,radius:i}=calculateBoundingCircle(e),r=drawBoundingCircle(a,t,n,i);h.push(r)});let l=e.length/(t.width*t.height)*100,d=document.getElementById("diff-info");d&&(d.textContent=`差異像素百分比: ${l.toFixed(2)}%
                                       差異像素數量: ${e.length}
                                       總像素數量: ${t.width*t.height}
                                       聚類數量: ${r.length}
                                       詳細差異: ${JSON.stringify(r.map(e=>({count:e.length,center:calculateBoundingCircle(e)})))}`),console.log(`差異像素聚類: `,r)}btnCompare.addEventListener("click",compareImages);