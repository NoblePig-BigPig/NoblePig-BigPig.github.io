!function(e,t){"use strict";class r{}r.Scene3D=null,r.Laya3D=null;class a{get cull(){return this._cull}set cull(e){this._cull=e}get blend(){return this._blend}set blend(e){this._blend=e}get srcBlend(){return this._srcBlend}set srcBlend(e){this._srcBlend=e}get dstBlend(){return this._dstBlend}set dstBlend(e){this._dstBlend=e}get srcBlendRGB(){return this._srcBlendRGB}set srcBlendRGB(e){this._srcBlendRGB=e}get dstBlendRGB(){return this._dstBlendRGB}set dstBlendRGB(e){this._dstBlendRGB=e}get srcBlendAlpha(){return this._srcBlendAlpha}set srcBlendAlpha(e){this._srcBlendAlpha=e}get dstBlendAlpha(){return this._dstBlendAlpha}set dstBlendAlpha(e){this._dstBlendAlpha=e}get blendEquation(){return this._blendEquation}set blendEquation(e){this._blendEquation=e}get blendEquationRGB(){return this._blendEquationRGB}set blendEquationRGB(e){this._blendEquationRGB=e}get blendEquationAlpha(){return this._blendEquationAlpha}set blendEquationAlpha(e){this._blendEquationAlpha=e}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest=e}get depthWrite(){return this._depthWrite}set depthWrite(e){this._depthWrite=e}get stencilWrite(){return this._stencilWrite}set stencilWrite(e){this._stencilWrite=e}get stencilTest(){return this._stencilTest}set stencilTest(e){this._stencilTest=e}get stencilRef(){return this._stencilRef}set stencilRef(e){this._stencilRef=e}get stencilOp(){return this._stencilOp}set stencilOp(e){this._stencilOp=e}createObj(){}constructor(){this._stencilOp=new t.Vector3,this.createObj(),this.cull=a.CULL_BACK,this.blend=a.BLEND_DISABLE,this.srcBlend=a.BLENDPARAM_ONE,this.dstBlend=a.BLENDPARAM_ZERO,this.srcBlendRGB=a.BLENDPARAM_ONE,this.dstBlendRGB=a.BLENDPARAM_ZERO,this.srcBlendAlpha=a.BLENDPARAM_ONE,this.dstBlendAlpha=a.BLENDPARAM_ZERO,this.blendEquation=a.BLENDEQUATION_ADD,this.blendEquationRGB=a.BLENDEQUATION_ADD,this.blendEquationAlpha=a.BLENDEQUATION_ADD,this.depthTest=a.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=a.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new t.Vector3(a.STENCILOP_KEEP,a.STENCILOP_KEEP,a.STENCILOP_REPLACE)}setNull(){this.cull=null,this.blend=null,this.srcBlend=null,this.dstBlend=null,this.srcBlendRGB=null,this.dstBlendRGB=null,this.srcBlendAlpha=null,this.dstBlendAlpha=null,this.blendEquation=null,this.blendEquationRGB=null,this.blendEquationAlpha=null,this.depthTest=null,this.depthWrite=null,this.stencilRef=null,this.stencilTest=null,this.stencilWrite=null,this.stencilOp.set(null,null,null)}cloneTo(e){e.cull=this.cull,e.blend=this.blend,e.srcBlend=this.srcBlend,e.dstBlend=this.dstBlend,e.srcBlendRGB=this.srcBlendRGB,e.dstBlendRGB=this.dstBlendRGB,e.srcBlendAlpha=this.srcBlendAlpha,e.dstBlendAlpha=this.dstBlendAlpha,e.blendEquation=this.blendEquation,e.blendEquationRGB=this.blendEquationRGB,e.blendEquationAlpha=this.blendEquationAlpha,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.stencilRef=this.stencilRef,e.stencilTest=this.stencilTest,e.stencilWrite=this.stencilWrite,this.stencilOp.cloneTo(e.stencilOp)}clone(){var e=new a;return this.cloneTo(e),e}}a.CULL_NONE=t.CullMode.Off,a.CULL_FRONT=t.CullMode.Front,a.CULL_BACK=t.CullMode.Back,a.BLEND_DISABLE=t.BlendType.BLEND_DISABLE,a.BLEND_ENABLE_ALL=t.BlendType.BLEND_ENABLE_ALL,a.BLEND_ENABLE_SEPERATE=t.BlendType.BLEND_ENABLE_SEPERATE,a.BLENDPARAM_ZERO=t.BlendFactor.Zero,a.BLENDPARAM_ONE=t.BlendFactor.One,a.BLENDPARAM_SRC_COLOR=t.BlendFactor.SourceColor,a.BLENDPARAM_ONE_MINUS_SRC_COLOR=t.BlendFactor.OneMinusSourceColor,a.BLENDPARAM_DST_COLOR=t.BlendFactor.DestinationColor,a.BLENDPARAM_ONE_MINUS_DST_COLOR=t.BlendFactor.OneMinusDestinationColor,a.BLENDPARAM_SRC_ALPHA=t.BlendFactor.SourceAlpha,a.BLENDPARAM_ONE_MINUS_SRC_ALPHA=t.BlendFactor.OneMinusSourceAlpha,a.BLENDPARAM_DST_ALPHA=t.BlendFactor.DestinationAlpha,a.BLENDPARAM_ONE_MINUS_DST_ALPHA=t.BlendFactor.OneMinusDestinationAlpha,a.BLENDPARAM_SRC_ALPHA_SATURATE=t.BlendFactor.SourceAlphaSaturate,a.BLENDPARAM_BLENDCOLOR=t.BlendFactor.BlendColor,a.BLENDPARAM_BLEND_ONEMINUS_COLOR=t.BlendFactor.OneMinusBlendColor,a.BLENDEQUATION_ADD=t.BlendEquationSeparate.ADD,a.BLENDEQUATION_SUBTRACT=t.BlendEquationSeparate.SUBTRACT,a.BLENDEQUATION_REVERSE_SUBTRACT=t.BlendEquationSeparate.REVERSE_SUBTRACT,a.BLENDEQUATION_MIN=t.BlendEquationSeparate.MIN,a.BLENDEQUATION_MAX=t.BlendEquationSeparate.MAX,a.DEPTHTEST_OFF=t.CompareFunction.Off,a.DEPTHTEST_NEVER=t.CompareFunction.Never,a.DEPTHTEST_LESS=t.CompareFunction.Less,a.DEPTHTEST_EQUAL=t.CompareFunction.Equal,a.DEPTHTEST_LEQUAL=t.CompareFunction.LessEqual,a.DEPTHTEST_GREATER=t.CompareFunction.Greater,a.DEPTHTEST_NOTEQUAL=t.CompareFunction.NotEqual,a.DEPTHTEST_GEQUAL=t.CompareFunction.GreaterEqual,a.DEPTHTEST_ALWAYS=t.CompareFunction.Always,a.STENCILTEST_OFF=t.CompareFunction.Off,a.STENCILTEST_NEVER=t.CompareFunction.Never,a.STENCILTEST_LESS=t.CompareFunction.Less,a.STENCILTEST_EQUAL=t.CompareFunction.Equal,a.STENCILTEST_LEQUAL=t.CompareFunction.LessEqual,a.STENCILTEST_GREATER=t.CompareFunction.Greater,a.STENCILTEST_NOTEQUAL=t.CompareFunction.NotEqual,a.STENCILTEST_GEQUAL=t.CompareFunction.GreaterEqual,a.STENCILTEST_ALWAYS=t.CompareFunction.Always,a.STENCILOP_KEEP=t.StencilOperation.Keep,a.STENCILOP_ZERO=t.StencilOperation.Zero,a.STENCILOP_REPLACE=t.StencilOperation.Replace,a.STENCILOP_INCR=t.StencilOperation.IncrementSaturate,a.STENCILOP_INCR_WRAP=t.StencilOperation.IncrementWrap,a.STENCILOP_DECR=t.StencilOperation.DecrementSaturate,a.STENCILOP_DECR_WRAP=t.StencilOperation.DecrementWrap,a.STENCILOP_INVERT=t.StencilOperation.Invert,a.Default=new a;class i extends t.Material{static __initDefine__(){i.SHADERDEFINE_DIFFUSEMAP=t.Shader3D.getDefineByName("DIFFUSEMAP"),i.SHADERDEFINE_NORMALMAP=t.Shader3D.getDefineByName("NORMALMAP"),i.SHADERDEFINE_SPECULARMAP=t.Shader3D.getDefineByName("SPECULARMAP"),i.SHADERDEFINE_ENABLEVERTEXCOLOR=t.Shader3D.getDefineByName("ENABLEVERTEXCOLOR"),i.SHADERDEFINE_ENABLETRANSMISSION=t.Shader3D.getDefineByName("ENABLETRANSMISSION"),i.SHADERDEFINE_THICKNESSMAP=t.Shader3D.getDefineByName("THICKNESSMAP"),i.ALBEDOTEXTURE=t.Shader3D.propertyNameToID("u_DiffuseTexture"),i.NORMALTEXTURE=t.Shader3D.propertyNameToID("u_NormalTexture"),i.SPECULARTEXTURE=t.Shader3D.propertyNameToID("u_SpecularTexture"),i.ALBEDOCOLOR=t.Shader3D.propertyNameToID("u_DiffuseColor"),i.MATERIALSPECULAR=t.Shader3D.propertyNameToID("u_MaterialSpecular"),i.SHININESS=t.Shader3D.propertyNameToID("u_Shininess"),i.TILINGOFFSET=t.Shader3D.propertyNameToID("u_TilingOffset"),i.TRANSMISSIONRATE=t.Shader3D.propertyNameToID("u_TransmissionRate"),i.IBACKDIFFUSE=t.Shader3D.propertyNameToID("u_BackDiffuse"),i.IBACKSCALE=t.Shader3D.propertyNameToID("u_BackScale"),i.THINKNESSTEXTURE=t.Shader3D.propertyNameToID("u_ThinknessTexture"),i.TRANSMISSIONCOLOR=t.Shader3D.propertyNameToID("u_TransmissionColor"),i.AlbedoIntensity=t.Shader3D.propertyNameToID("u_AlbedoIntensity")}set renderMode(e){switch(e){case i.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=t.Material.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=a.CULL_BACK,this.blend=a.BLEND_DISABLE,this.depthTest=a.DEPTHTEST_LESS;break;case i.RENDERMODE_CUTOUT:this.renderQueue=t.Material.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=a.CULL_BACK,this.blend=a.BLEND_DISABLE,this.depthTest=a.DEPTHTEST_LESS;break;case i.RENDERMODE_TRANSPARENT:this.renderQueue=t.Material.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=a.CULL_BACK,this.blend=a.BLEND_ENABLE_ALL,this.blendSrc=a.BLENDPARAM_SRC_ALPHA,this.blendDst=a.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=a.DEPTHTEST_LESS;break;default:throw new Error("unknown renderMode: "+e)}}get enableVertexColor(){return this.hasDefine(i.SHADERDEFINE_ENABLEVERTEXCOLOR)}set enableVertexColor(e){e?this.addDefine(i.SHADERDEFINE_ENABLEVERTEXCOLOR):this.removeDefine(i.SHADERDEFINE_ENABLEVERTEXCOLOR)}get tilingOffset(){return this.getVector4ByIndex(i.TILINGOFFSET)}set tilingOffset(e){e?this.setVector4ByIndex(i.TILINGOFFSET,e):this.getVector4ByIndex(i.TILINGOFFSET).setValue(1,1,0,0)}get albedoColor(){return this.getColorByIndex(i.ALBEDOCOLOR)}set albedoColor(e){this.setColorByIndex(i.ALBEDOCOLOR,e)}get albedoIntensity(){return this.getFloatByIndex(i.AlbedoIntensity)}set albedoIntensity(e){this.setFloatByIndex(i.AlbedoIntensity,e)}get specularColor(){return this.getColorByIndex(i.MATERIALSPECULAR)}set specularColor(e){this.setColorByIndex(i.MATERIALSPECULAR,e)}get shininess(){return this.getFloatByIndex(i.SHININESS)}set shininess(e){e=Math.max(0,Math.min(1,e)),this.setFloatByIndex(i.SHININESS,e)}get albedoTexture(){return this.getTextureByIndex(i.ALBEDOTEXTURE)}set albedoTexture(e){e?this.addDefine(i.SHADERDEFINE_DIFFUSEMAP):this.removeDefine(i.SHADERDEFINE_DIFFUSEMAP),this.setTextureByIndex(i.ALBEDOTEXTURE,e)}get normalTexture(){return this.getTextureByIndex(i.NORMALTEXTURE)}set normalTexture(e){e?this.addDefine(i.SHADERDEFINE_NORMALMAP):this.removeDefine(i.SHADERDEFINE_NORMALMAP),this.setTextureByIndex(i.NORMALTEXTURE,e)}get specularTexture(){return this.getTextureByIndex(i.SPECULARTEXTURE)}set specularTexture(e){e?this.addDefine(i.SHADERDEFINE_SPECULARMAP):this.removeDefine(i.SHADERDEFINE_SPECULARMAP),this.setTextureByIndex(i.SPECULARTEXTURE,e)}get enableTransmission(){return this.hasDefine(i.SHADERDEFINE_ENABLETRANSMISSION)}set enableTransmission(e){e?this.addDefine(i.SHADERDEFINE_ENABLETRANSMISSION):this.removeDefine(i.SHADERDEFINE_ENABLETRANSMISSION)}get transmissionRata(){return this.getFloatByIndex(i.TRANSMISSIONRATE)}set transmissionRata(e){this.setFloatByIndex(i.TRANSMISSIONRATE,e)}get backDiffuse(){return this.getFloatByIndex(i.IBACKDIFFUSE)}set backDiffuse(e){this.setFloatByIndex(i.IBACKDIFFUSE,Math.max(e,1))}get backScale(){return this.getFloatByIndex(i.IBACKSCALE)}set backScale(e){this.setFloatByIndex(i.IBACKSCALE,e)}get thinknessTexture(){return this.getTextureByIndex(i.THINKNESSTEXTURE)}set thinknessTexture(e){e?this.addDefine(i.SHADERDEFINE_THICKNESSMAP):this.removeDefine(i.SHADERDEFINE_THICKNESSMAP),this.setTextureByIndex(i.THINKNESSTEXTURE,e)}get transmissionColor(){return this.getColorByIndex(i.TRANSMISSIONCOLOR)}set transmissionColor(e){this.setColorByIndex(i.TRANSMISSIONCOLOR,e)}get transmissionRate(){return this.getFloatByIndex(i.TRANSMISSIONRATE)}constructor(){super(),this.setShaderName("BLINNPHONG"),this.renderMode=i.RENDERMODE_OPAQUE}clone(){var e=new i;return this.cloneTo(e),e}cloneTo(e){super.cloneTo(e),e.albedoIntensity=this.albedoIntensity,e.enableVertexColor=this.enableVertexColor,this.albedoColor.cloneTo(e.albedoColor)}}var n;i.RENDERMODE_OPAQUE=0,i.RENDERMODE_CUTOUT=1,i.RENDERMODE_TRANSPARENT=2,e.PBRRenderQuality=void 0,(n=e.PBRRenderQuality||(e.PBRRenderQuality={}))[n.High=0]="High",n[n.Low=1]="Low";class s{static get defaultDFG(){return s._defaultDFG}static set defaultDFG(e){s._defaultDFG=e}static DefaultDfgTexture(){let e,r=t.Base64Tool.decode("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"),a=t.HDRTextureInfo.getHDRInfo(r),i=t.LayaGL.renderEngine.getCapable(t.RenderCapable.TextureFormat_R32G32B32A32),n=t.LayaGL.renderEngine.getCapable(t.RenderCapable.Texture_FloatLinearFiltering);if(i&&n)e=new t.Texture2D(a.width,a.height,a.format,!1,!1,!1),e.setHDRData(a);else{e=new t.Texture2D(a.width,a.height,t.TextureFormat.R8G8B8A8,!1,!1,!1);let r=a.width*a.height,i=a.readScanLine(),n=new Uint8Array(4*r);for(let e=0;e<r;e++){let t=i[4*e],r=i[4*e+1],a=i[4*e+2],s=Math.max(t,r,a,1e-5),o=Math.max(1,255/s);o=Math.min(1,Math.max(0,o/255)),n[4*e]=255*Math.min(1,Math.max(0,t*o)),n[4*e+1]=255*Math.min(1,Math.max(0,r*o)),n[4*e+2]=255*Math.min(1,Math.max(0,a*o)),n[4*e+3]=255*o}e.setPixelsData(n,!1,!1)}e.lock=!0,e.wrapModeU=t.WrapMode.Clamp,e.wrapModeV=t.WrapMode.Clamp,e.anisoLevel=1,this._defaultDFG=e}}var o,l,h,d,c,u;e.ShaderDataType=void 0,(o=e.ShaderDataType||(e.ShaderDataType={}))[o.None=0]="None",o[o.Int=1]="Int",o[o.Bool=2]="Bool",o[o.Float=3]="Float",o[o.Vector2=4]="Vector2",o[o.Vector3=5]="Vector3",o[o.Vector4=6]="Vector4",o[o.Color=7]="Color",o[o.Matrix4x4=8]="Matrix4x4",o[o.Texture2D=9]="Texture2D",o[o.Texture3D=10]="Texture3D",o[o.TextureCube=11]="TextureCube",o[o.Buffer=12]="Buffer",o[o.Matrix3x3=13]="Matrix3x3",o[o.Texture2DArray=14]="Texture2DArray";class _{static init(){_.DEFINE_EMISSION=t.Shader3D.getDefineByName("EMISSION"),_.DEFINE_CLEARCOAT=t.Shader3D.getDefineByName("CLEARCOAT"),_.DEFINE_CLEARCOAT_NORMAL=t.Shader3D.getDefineByName("CLEARCOAT_NORMAL"),_.DEFINE_ANISOTROPY=t.Shader3D.getDefineByName("ANISOTROPIC"),_.DEFINE_IOR=t.Shader3D.getDefineByName("IOR"),_.DEFINE_IRIDESCENCE=t.Shader3D.getDefineByName("IRIDESCENCE"),_.DEFINE_SHEEN=t.Shader3D.getDefineByName("SHEEN"),_.DEFINE_TRANSMISSION=t.Shader3D.getDefineByName("TRANSMISSION"),_.DEFINE_THICKNESS=t.Shader3D.getDefineByName("THICKNESS"),t.Shader3D.addInclude("BRDF.glsl","#if !defined(BRDF)\n#define BRDF\nfloat D_GGX(float roughness,float NoH,vec3 h,vec3 n){\n#if !defined(GL_FRAGMENT_PRECISION_HIGH)\nvec3 NxH=cross(n,h);float oneMinusNoHSquared=dot(NxH,NxH);\n#else\nfloat oneMinusNoHSquared=1.0-NoH*NoH;\n#endif\nfloat a=NoH*roughness;float k=roughness/(oneMinusNoHSquared+a*a);float d=k*k*INVERT_PI;return saturateMediump(d);}float D_GGX_Anisotropic(float NoH,const vec3 h,const vec3 t,const vec3 b,float at,float ab){float ToH=dot(t,h);float BoH=dot(b,h);float a2=at*ab;highp vec3 v=vec3(ab*ToH,at*BoH,a2*NoH);highp float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*INVERT_PI;}float D_Charlie(float roughness,float NoH){float invR=1.0/roughness;float cos2h=NoH*NoH;float sin2h=max(1.0-cos2h,0.0078125);return(2.0+invR)*pow(sin2h,invR*0.5)*0.5*INVERT_PI;}float V_SmithGGXCorrelated(float roughness,float NoV,float NoL){float a2=roughness*roughness;float lambdaV=NoL*sqrt((NoV-a2*NoV)*NoV+a2);float lambdaL=NoV*sqrt((NoL-a2*NoL)*NoL+a2);float v=0.5/(lambdaV+lambdaL);return saturateMediump(v);}float V_SmithGGXCorrelated_Fast(float roughness,float NoV,float NoL){float v=0.5/mix(2.0*NoL*NoV,NoL+NoV,roughness);return saturateMediump(v);}float V_kelemen(float LoH){return saturateMediump(0.25/(LoH*LoH));}float lCharlieNumericHelper(float x,float alphaG){float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}float lCharlie(float cosTheta,float alphaG){if(abs(cosTheta)<0.5){return exp(lCharlieNumericHelper(cosTheta,alphaG));}else{return exp(2.0*lCharlieNumericHelper(0.5,alphaG)-lCharlieNumericHelper(1.0-cosTheta,alphaG));}}float V_Charlie(float NoL,float NoV,float roughness){float alphaG=roughness*roughness;return clamp(1.0/((1.0+lCharlie(NoV,alphaG)+lCharlie(NoL,alphaG))*(4.0*NoV*NoL)),0.0,1.0);}float V_Neubelt(float NoV,float NoL){return saturateMediump(1.0/(4.0*(NoL+NoV-NoL*NoV)));}float V_SmithGGXCorrelated_Anisotropic(float at,float ab,float ToV,float BoV,float ToL,float BoL,float NoV,float NoL){float lambdaV=NoL*length(vec3(at*ToV,ab*BoV,NoV));float lambdaL=NoV*length(vec3(at*ToL,ab*BoL,NoL));float v=0.5/(lambdaV+lambdaL);return saturateMediump(v);}vec3 F_Schlick(vec3 f0,float f90,float VoH){return f0+(f90-f0)*pow5(1.0-VoH);}vec3 F_Schlick(vec3 f0,float VoH){return f0+(1.0-f0)*pow5(1.0-VoH);}float F_Schlick(float f0,float f90,float VoH){return f0+(f90-f0)*pow5(1.0-VoH);}float F_Schlick(float f0,float VoH){return f0+(1.0-f0)*pow5(1.0-VoH);}vec3 F_Schlick(vec3 f0,vec3 f90,float VoH){return f0+(f90-f0)*pow5(1.0-VoH);}\n#ifdef IRIDESCENCE\nconst mat3 XYZ_to_REC709_MAT=mat3(vec3(3.2409699419,-0.9692436363,0.0556300797),vec3(-1.5373831776,1.8759675015,-0.2039769589),vec3(-0.498610760,0.0415550574,1.0569715142));float IorToFresnel0(float iorT,float iorI){return pow2((iorT-iorI)/(iorT+iorI));}vec3 IorToFresnel0(vec3 iorT,float iorI){return pow2((iorT-vec3(iorI))/(iorT+vec3(iorI)));}vec3 Fresnel0ToIor(vec3 f0){vec3 sqrtF0=sqrt(f0);return(1.0+sqrtF0)/(1.0-sqrtF0);}vec3 evalSensitivity(float OPD,vec3 shift){float phase=2.0*PI*OPD*1.0e-9;vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-pow2(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*pow2(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_to_REC709_MAT*xyz;return srgb;}vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0){vec3 I;float iridescenceIor=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=pow2(outsideIOR/iridescenceIor)*(1.0-pow2(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if(cosTheta2Sq<0.0){return vec3(1.0);}float cosTheta2=sqrt(cosTheta2Sq);float R0=IorToFresnel0(iridescenceIor,outsideIOR);float R12=F_Schlick(R0,cosTheta1);float R21=R12;float T121=1.0-R12;float phi12=0.0;if(iridescenceIor<outsideIOR)phi12=PI;float phi21=PI-phi12;vec3 baseIOR=Fresnel0ToIor(clamp(baseF0,0.0,0.9999));vec3 R1=IorToFresnel0(baseIOR,iridescenceIor);vec3 R23=F_Schlick(R1,cosTheta2);vec3 phi23=vec3(0.0);if(baseIOR[0]<iridescenceIor)phi23[0]=PI;if(baseIOR[1]<iridescenceIor)phi23[1]=PI;if(baseIOR[2]<iridescenceIor)phi23[2]=PI;float OPD=2.0*iridescenceIor*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=pow2(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for(int m=1;m<=2;++m){Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*OPD,float(m)*phi);I+=Cm*Sm;}return max(I,vec3(0.0));}\n#endif\nfloat distribution(float roughness,float NoH,vec3 h,vec3 n){return D_GGX(roughness,NoH,h,n);}float visibility(float roughness,float NoV,float NoL){return V_SmithGGXCorrelated(roughness,NoV,NoL);}vec3 fresnel(vec3 f0,float LoH){float f90=saturate(dot(f0,vec3(50.0*0.33)));return F_Schlick(f0,f90,LoH);}vec3 fresnel(vec3 f0,vec3 f90,float LoH){return F_Schlick(f0,f90,LoH);}float Fd_Lambert(){return 1.0;}float Fd_Burley(float roughness,float NoV,float NoL,float LoH){float f90=0.5+2.0*roughness*LoH*LoH;float lightScatter=F_Schlick(1.0,f90,NoL);float veiwScatter=F_Schlick(1.0,f90,NoV);return lightScatter*veiwScatter*INVERT_PI;}\n#ifdef IRIDESCENCE\nvec3 Fd_IridescenceLambert(vec3 f0,vec3 f90,vec3 iridescenceFresnel,float iridescenceFactor,float VoH){vec3 iridescenceFresnelMax=vec3(vecmax(iridescenceFresnel));vec3 schlickFresnel=F_Schlick(f0,f90,VoH);vec3 F=mix(schlickFresnel,iridescenceFresnelMax,iridescenceFactor);return(1.0-F)*Fd_Lambert();}\n#endif\n#endif\n"),t.Shader3D.addInclude("PBRGI.glsl",'#if !defined(pbrGI_lib)\n#define pbrGI_lib\n#include "globalIllumination.glsl";\n#ifdef ANISOTROPIC\nvec3 anisotropyBentNormal(const in Surface surface,const in PixelInfo info){float anisotropy=surface.anisotropy;vec3 anisotropyDirection=info.anisotropicB;vec3 n=info.normalWS;vec3 v=info.viewDir;float roughness=surface.perceptualRoughness;vec3 anisotropicTangent=cross(anisotropyDirection,v);vec3 anisotropicNormal=cross(anisotropicTangent,anisotropyDirection);float bendFactor=1.0-anisotropy*(1.0-roughness);float bendFactorPow4=pow2(bendFactor)*pow2(bendFactor);vec3 bentNormal=normalize(mix(anisotropicNormal,n,bendFactorPow4));return bentNormal;}\n#endif\nvec3 getReflectedVector(const in vec3 n,const in vec3 v,const in vec3 positionWS){vec3 r;r=reflect(-v,n);\n#ifdef SPECCUBE_BOX_PROJECTION\nr=getBoxProjectionReflectedVector(r,positionWS);\n#endif\nreturn r;}\n#ifdef IRIDESCENCE\nvoid iridescenceIBL(const in Surface surface,const in PixelInfo info,in vec3 E,inout vec3 Fd,inout vec3 Fr){vec3 dfg=info.dfg;float NoV=info.NoV;vec3 n=info.normalWS;vec3 v=info.viewDir;vec3 positionWS=info.positionWS;vec3 iridescenceFresnel=info.iridescenceFresnel;vec3 diffuseColor=surface.diffuseColor;float roughness=surface.perceptualRoughness;float occlusion=surface.occlusion;float iridescenceFactor=surface.iridescence;vec3 irradiance=diffuseIrradiance(n,positionWS,info.viewDir);Fd+=diffuseColor*irradiance*(1.0-E)*occlusion;vec3 iridescenceF0=mix(surface.f0,iridescenceFresnel,vec3(iridescenceFactor));vec3 Er=mix(dfg.xxx,dfg.yyy,iridescenceF0);\n#ifdef ANISOTROPIC\nvec3 bentNormal=anisotropyBentNormal(surface,info);vec3 r=getReflectedVector(bentNormal,v,positionWS);\n#else\nvec3 r=getReflectedVector(n,v,positionWS);\n#endif\nvec3 indirectSpecular=specularRadiance(r,roughness);Fr+=Er*indirectSpecular*occlusion*(1.0+Er*(1.0/dfg.y-1.0));}\n#endif\n#ifdef SHEEN\nvoid sheenIBL(const in Surface surface,const in PixelInfo info,inout vec3 Fd,inout vec3 Fr){vec3 v=info.viewDir;vec3 n=info.normalWS;vec3 positionWS=info.positionWS;float occlusion=surface.occlusion;float roughness=surface.sheenPerceptualRoughness;Fd*=info.sheenScaling;Fr*=info.sheenScaling;vec3 r=getReflectedVector(n,v,positionWS);vec3 indirectSpecular=specularRadiance(r,roughness);Fr+=indirectSpecular*info.sheenDfg*surface.sheenColor*occlusion;}\n#endif\n#ifdef CLEARCOAT\nvoid clearCoatIBL(const in Surface surface,const in PixelInfo info,inout vec3 Fd,inout vec3 Fr){vec3 v=info.viewDir;vec3 n=info.clearCoatNormal;float NoV=info.clearCoatNoV;vec3 positionWS=info.positionWS;float clearCoat=surface.clearCoat;float roughness=surface.clearCoatPerceptualRoughness;float occlusion=surface.occlusion;float Fc=F_Schlick(0.04,1.0,NoV)*clearCoat;float attenuation=1.0-Fc;Fd*=attenuation;Fr*=attenuation;vec3 r=getReflectedVector(n,v,positionWS);vec3 indirectSpecular=specularRadiance(r,roughness);Fr+=indirectSpecular*Fc*occlusion;}\n#endif\n#ifdef TRANSMISSION\nvec3 getRefraction(const in Surface surface,const in PixelInfo info){vec3 position=info.positionWS;\n#ifdef THICKNESS\nvec3 n=info.normalWS;vec3 r=-info.viewDir;float airIOR=1.0;float etaIR=airIOR/surface.ior;vec3 refractionV=normalize(refract(r,n,etaIR))*surface.thickness*info.worldScale.xyz;position+=refractionV;\n#endif\nvec4 p=u_ViewProjection*vec4(position,1.0);vec2 refractionUV=(p.xy/p.w)*0.5+0.5;float refractionLOD=u_OpaqueTextureParams.z*surface.perceptualRoughness*saturate(surface.ior*2.0-2.0);vec3 refraction=texture2DLodEXT(u_CameraOpaqueTexture,refractionUV,refractionLOD).xyz;return refraction;}vec3 transmissionIBL(const in Surface surface,const in PixelInfo info,in vec3 E){vec3 refraction=getRefraction(surface,info);\n#ifndef THICKNESS\nE*=1.0+surface.transmission*(1.0-E.g)/(1.0+E.g);\n#endif\n#ifdef THICKNESS\nvec3 attenuationColor=surface.attenuationColor;float attenuationDistance=surface.attenuationDistance;vec3 absorption=-log(attenuationColor)/(attenuationDistance);vec3 T=exp(-absorption*info.worldScale.xyz*surface.thickness);\n#endif\nvec3 Ft=refraction;Ft*=surface.diffuseColor;Ft*=1.0-E;\n#ifdef THICKNESS\nFt*=T;\n#endif\nreturn Ft*surface.transmission;}\n#endif\nvoid baseIBL(const in Surface surface,const in PixelInfo info,in vec3 E,inout vec3 Fd,inout vec3 Fr){vec3 dfg=info.dfg;float NoV=info.NoV;vec3 n=info.normalWS;vec3 v=info.viewDir;vec3 positionWS=info.positionWS;vec3 diffuseColor=surface.diffuseColor;float roughness=surface.perceptualRoughness;float occlusion=surface.occlusion;\n#ifdef ANISOTROPIC\nvec3 bentNormal=anisotropyBentNormal(surface,info);vec3 r=getReflectedVector(bentNormal,v,positionWS);\n#else\nvec3 r=getReflectedVector(n,v,positionWS);\n#endif\nvec3 indirectSpecular=specularRadiance(r,roughness);float specularAO=occlusion;Fr+=E*indirectSpecular*specularAO*info.energyCompensation;\n#if defined(USELIGHTMAP)\nvec2 lightmapUV=info.lightmapUV;vec3 bakedlight=getBakedLightmapColor(lightmapUV,n);Fd+=bakedlight*diffuseColor;\n#else\nvec3 irradiance=diffuseIrradiance(n,positionWS,info.viewDir);Fd+=diffuseColor*irradiance*(1.0-E)*occlusion;\n#endif\n}vec3 getE(const in Surface surface,const in PixelInfo info){\n#ifdef IRIDESCENCE\nvec3 dfg=info.dfg;float NoV=info.NoV;vec3 iridescenceFresnel=info.iridescenceFresnel;vec3 f0=surface.f0;float iridescenceFactor=surface.iridescence;vec3 iridescenceFresnelMax=vec3(vecmax(iridescenceFresnel));vec3 schlickFresnel=F_Schlick(f0,vec3(1.0),NoV);vec3 F=mix(schlickFresnel,iridescenceFresnelMax,iridescenceFactor);vec3 E=mix(dfg.xxx,dfg.yyy,F);\n#else\nvec3 dfg=info.dfg;vec3 f0=surface.f0;vec3 f90=surface.f90;vec3 E=(f90-f0)*dfg.x+f0*dfg.y;\n#endif\nreturn E;}vec3 PBRGI(const in Surface surface,const in PixelInfo info){vec3 Fd=vec3(0.0);vec3 Fr=vec3(0.0);vec3 E=getE(surface,info);\n#ifdef IRIDESCENCE\niridescenceIBL(surface,info,E,Fd,Fr);\n#else\nbaseIBL(surface,info,E,Fd,Fr);\n#endif\n#ifdef SHEEN\nsheenIBL(surface,info,Fd,Fr);\n#endif\n#ifdef CLEARCOAT\nclearCoatIBL(surface,info,Fd,Fr);\n#endif\n#ifdef TRANSMISSION\nFd*=(1.0-surface.transmission);vec3 Ft=transmissionIBL(surface,info,E);\n#endif\nvec3 gi=Fd+Fr;\n#ifdef TRANSMISSION\ngi+=Ft;\n#endif\nreturn gi;}\n#endif\n'),t.Shader3D.addInclude("PBRCommon.glsl","#if !defined(pbrCommon_lib)\n#define pbrCommon_lib\nvarying vec3 v_PositionWS;varying vec3 v_NormalWS;varying vec3 v_TangentWS;varying vec3 v_BiNormalWS;\n#ifdef UV\nvarying vec2 v_Texcoord0;\n#endif\n#ifdef UV1\n#ifdef LIGHTMAP\nvarying vec2 v_Texcoord1;\n#endif\n#endif\n#ifdef COLOR\nvarying vec4 v_VertexColor;\n#endif\nstruct PixelParams{vec3 positionWS;vec3 normalWS;vec3 tangentWS;vec3 biNormalWS;mat3 TBN;\n#ifdef UV\nvec2 uv0;\n#endif\n#ifdef UV1\n#ifdef LIGHTMAP\nvec2 uv1;\n#endif\n#endif\n#ifdef COLOR\nvec4 vertexColor;\n#endif\n};\n#endif\n"),t.Shader3D.addInclude("PBRVertex.glsl",'#if !defined(pbrVertex_lib)\n#define pbrVertex_lib\n#include "ShadingVertex.glsl";\n#ifdef THICKNESS\nvarying vec4 v_WorldScale;\n#endif\nvoid initPixelParams(inout PixelParams params,in Vertex vertex){shadingPixelParams(params,vertex);sharePixelParams(params);\n#ifdef THICKNESS\nmat4 worldMat=getWorldMatrix();v_WorldScale.x=length(vec3(worldMat[0].xyz));v_WorldScale.y=length(vec3(worldMat[1].xyz));v_WorldScale.z=length(vec3(worldMat[2].xyz));v_WorldScale.w=length(v_WorldScale.xyz);\n#endif\n}\n#endif\n'),t.Shader3D.addInclude("PBRFrag.glsl",'\n#if !defined(pbrFrag_lib)\n#define pbrFrag_lib\n#include "PBRLighting.glsl";\n#ifdef THICKNESS\nvarying vec4 v_WorldScale;\n#endif\nvoid getPixelInfo(inout PixelInfo info,const in PixelParams pixel,const in Surface surface){info.positionWS=pixel.positionWS;info.vertexNormalWS=pixel.normalWS;\n#ifdef TANGENT\ninfo.normalWS=normalize(pixel.TBN*surface.normalTS);\n#else\ninfo.normalWS=pixel.normalWS;\n#endif\ninfo.tangentWS=pixel.tangentWS;info.biNormalWS=pixel.biNormalWS;info.viewDir=normalize(u_CameraPos-info.positionWS);info.NoV=min(max(dot(info.normalWS,info.viewDir),MIN_N_DOT_V),1.0);info.dfg=prefilteredDFG_LUT(surface.perceptualRoughness,info.NoV);\n#ifdef SHEEN\ninfo.energyCompensation=vec3(1.0);\n#else\ninfo.energyCompensation=(1.0+surface.f0*(1.0/info.dfg.y-1.0));\n#endif\n#ifdef IRIDESCENCE\ninfo.iridescenceFresnel=evalIridescence(1.0,surface.iridescenceIor,info.NoV,surface.iridescenceThickness,surface.f0);\n#endif\n#ifdef SHEEN\ninfo.sheenDfg=prefilteredDFG_LUT(surface.sheenPerceptualRoughness,info.NoV).z;info.sheenScaling=1.0-vecmax(surface.sheenColor)*info.sheenDfg;\n#endif\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_NORMAL\ninfo.clearCoatNormal=normalize(pixel.TBN*surface.clearCoatNormalTS);\n#else\ninfo.clearCoatNormal=info.vertexNormalWS;\n#endif\ninfo.clearCoatNoV=min(max(dot(info.clearCoatNormal,info.viewDir),MIN_N_DOT_V),1.0);\n#endif\n#ifdef ANISOTROPIC\nmat3 anisotropyTBN=mat3(info.tangentWS,info.biNormalWS*-1.0,info.normalWS);info.anisotropicT=anisotropyTBN*normalize(vec3(surface.anisotropyDirection,0.0));info.anisotropicB=cross(info.vertexNormalWS,info.anisotropicT);info.ToV=dot(info.anisotropicT,info.viewDir);info.BoV=dot(info.anisotropicB,info.viewDir);info.at=mix(surface.roughness,1.0,pow2(surface.anisotropy));info.ab=surface.roughness;\n#endif\n#ifdef THICKNESS\ninfo.worldScale=v_WorldScale;\n#endif\n#ifdef LIGHTMAP\n#ifdef UV1\ninfo.lightmapUV=pixel.uv1;\n#endif\n#endif\n}vec3 PBRLighting(const in Surface surface,const in PixelInfo info){vec3 lightColor=vec3(0.0);\n#ifdef DIRECTIONLIGHT\nfor(int i=0;i<CalculateLightCount;i++){if(i>=DirectionCount)break;DirectionLight directionLight=getDirectionLight(i,info.positionWS);if(directionLight.lightMode!=LightMode_Mix){Light light=getLight(directionLight);lightColor+=PBRLighting(surface,info,light)*light.attenuation;}}\n#endif\n#if defined(POINTLIGHT) || defined(SPOTLIGHT)\nivec4 clusterInfo=getClusterInfo(u_View,u_Viewport,info.positionWS,gl_FragCoord,u_ProjectionParams);\n#endif\n#ifdef POINTLIGHT\nfor(int i=0;i<CalculateLightCount;i++){\n#ifdef BREAK_TEXTURE_SAMPLE\nif(i>=clusterInfo.x)break;\n#endif\nPointLight pointLight=getPointLight(i,clusterInfo,info.positionWS);if(pointLight.lightMode!=LightMode_Mix){Light light=getLight(pointLight,info.normalWS,info.positionWS);\n#ifndef BREAK_TEXTURE_SAMPLE\nif(i<clusterInfo.x)\n#endif\nlightColor+=PBRLighting(surface,info,light)*light.attenuation;}}\n#endif\n#ifdef SPOTLIGHT\nfor(int i=0;i<CalculateLightCount;i++){\n#ifdef BREAK_TEXTURE_SAMPLE\nif(i>=clusterInfo.y)break;\n#endif\nSpotLight spotLight=getSpotLight(i,clusterInfo,info.positionWS);if(spotLight.lightMode!=LightMode_Mix){Light light=getLight(spotLight,info.normalWS,info.positionWS);\n#ifndef BREAK_TEXTURE_SAMPLE\nif(i<clusterInfo.y)\n#endif\nlightColor+=PBRLighting(surface,info,light)*light.attenuation;}}\n#endif\nvec3 giColor=PBRGI(surface,info);vec3 color=lightColor+giColor;\n#ifdef EMISSION\ncolor+=surface.emissionColor;\n#endif\nreturn color;}\n#endif\n'),s.DefaultDfgTexture(),t.SubShader.regIncludeBindUnifrom("PBRGI.glsl",{u_IBLDFG:e.ShaderDataType.Texture2D},{u_IBLDFG:s.defaultDFG}),t.Shader3D.addInclude("PBRMetallicFrag.glsl",'#if !defined(PBRMetallic_lib)\n#define PBRMetallic_lib\n#include "ShadingFrag.glsl";\n#include "PBRFrag.glsl";\nstruct SurfaceInputs{vec3 diffuseColor;float alpha;float alphaTest;float metallic;float smoothness;float occlusion;vec3 emissionColor;vec3 normalTS;\n#ifdef CLEARCOAT\nfloat clearCoat;float clearCoatRoughness;\n#ifdef CLEARCOAT_NORMAL\nvec3 clearCoatNormalTS;\n#endif\n#endif\n#ifdef ANISOTROPIC\nfloat anisotropy;vec2 anisotropyDirection;\n#endif\n};void initSurface(inout Surface surface,const in SurfaceInputs inputs,const in PixelParams pixel){surface.alpha=inputs.alpha;surface.normalTS=inputs.normalTS;vec3 baseColor=inputs.diffuseColor;float metallic=inputs.metallic;float perceptualRoughness=1.0-inputs.smoothness;float ior=1.5;surface.ior=1.5;vec3 f0=vec3(0.04,0.04,0.04);surface.perceptualRoughness=clamp(perceptualRoughness,MIN_PERCEPTUAL_ROUGHNESS,1.0);surface.roughness=surface.perceptualRoughness*surface.perceptualRoughness;surface.diffuseColor=computeDiffuse(baseColor,metallic);surface.f0=computeF0(f0,baseColor,metallic);surface.f90=computeF90(surface.f0);surface.occlusion=inputs.occlusion;\n#ifdef EMISSION\nsurface.emissionColor=inputs.emissionColor;\n#endif\n#ifdef CLEARCOAT\nsurface.clearCoat=inputs.clearCoat;surface.clearCoatPerceptualRoughness=clamp(inputs.clearCoatRoughness,MIN_PERCEPTUAL_ROUGHNESS,1.0);surface.clearCoatRoughness=surface.clearCoatPerceptualRoughness*surface.clearCoatPerceptualRoughness;\n#ifdef CLEARCOAT_NORMAL\nsurface.clearCoatNormalTS=inputs.clearCoatNormalTS;\n#endif\n#endif\n#ifdef ANISOTROPIC\nsurface.anisotropy=inputs.anisotropy;surface.anisotropyDirection=inputs.anisotropyDirection;\n#endif\n}vec4 PBR_Metallic_Flow(const in SurfaceInputs inputs,in PixelParams pixel){\n#ifdef ALPHATEST\nif(inputs.alpha<inputs.alphaTest){discard;}\n#endif\nSurface surface;initSurface(surface,inputs,pixel);PixelInfo info;getPixelInfo(info,pixel,surface);vec3 surfaceColor=vec3(0.0);surfaceColor+=PBRLighting(surface,info);return vec4(surfaceColor,surface.alpha);}\n#endif\n')}}e.PBRRenderMode=void 0,(l=e.PBRRenderMode||(e.PBRRenderMode={}))[l.Opaque=0]="Opaque",l[l.Cutout=1]="Cutout",l[l.Fade=2]="Fade",l[l.Transparent=3]="Transparent";class f extends t.Material{static __init__(){f.SHADERDEFINE_ALBEDOTEXTURE=t.Shader3D.getDefineByName("ALBEDOTEXTURE"),f.SHADERDEFINE_NORMALTEXTURE=t.Shader3D.getDefineByName("NORMALTEXTURE"),f.SHADERDEFINE_PARALLAXTEXTURE=t.Shader3D.getDefineByName("PARALLAXTEXTURE"),f.SHADERDEFINE_OCCLUSIONTEXTURE=t.Shader3D.getDefineByName("OCCLUSIONTEXTURE"),f.SHADERDEFINE_EMISSIONTEXTURE=t.Shader3D.getDefineByName("EMISSIONTEXTURE"),f.SHADERDEFINE_TRANSPARENTBLEND=t.Shader3D.getDefineByName("TRANSPARENTBLEND"),f.SHADERDEFINE_LAYA_PBR_BRDF_HIGH=t.Shader3D.getDefineByName("LAYA_PBR_BRDF_HIGH"),f.SHADERDEFINE_LAYA_PBR_BRDF_LOW=t.Shader3D.getDefineByName("LAYA_PBR_BRDF_LOW"),f.SHADERDEFINE_DETAILALBEDO=t.Shader3D.getDefineByName("DETAILTEXTURE"),f.SHADERDEFINE_DETAILNORMAL=t.Shader3D.getDefineByName("DETAILNORMAL"),f.SHADERDEFINE_ENABLEVERTEXCOLOR=t.Shader3D.getDefineByName("ENABLEVERTEXCOLOR"),f.ALBEDOTEXTURE=t.Shader3D.propertyNameToID("u_AlbedoTexture"),f.ALBEDOCOLOR=t.Shader3D.propertyNameToID("u_AlbedoColor"),f.TILINGOFFSET=t.Shader3D.propertyNameToID("u_TilingOffset"),f.NORMALTEXTURE=t.Shader3D.propertyNameToID("u_NormalTexture"),f.NORMALSCALE=t.Shader3D.propertyNameToID("u_NormalScale"),f.SMOOTHNESS=t.Shader3D.propertyNameToID("u_Smoothness"),f.OCCLUSIONTEXTURE=t.Shader3D.propertyNameToID("u_OcclusionTexture"),f.OCCLUSIONSTRENGTH=t.Shader3D.propertyNameToID("u_OcclusionStrength"),f.PARALLAXTEXTURE=t.Shader3D.propertyNameToID("u_ParallaxTexture"),f.PARALLAXSCALE=t.Shader3D.propertyNameToID("u_ParallaxScale"),f.EMISSIONTEXTURE=t.Shader3D.propertyNameToID("u_EmissionTexture"),f.EMISSIONCOLOR=t.Shader3D.propertyNameToID("u_EmissionColor"),f.EMISSIONIntensity=t.Shader3D.propertyNameToID("u_EmissionIntensity"),f.DETAILALBEDOTEXTURE=t.Shader3D.propertyNameToID("u_DetailAlbedoTexture"),f.DETAILNORMALTEXTURE=t.Shader3D.propertyNameToID("u_DetailNormalTexture"),f.DETAILTILLINGOFFSET=t.Shader3D.propertyNameToID("u_DetailTillingOffset"),f.DETAILNORMALSCALE=t.Shader3D.propertyNameToID("u_DetailNormalScale"),f.CLEARCOAT=t.Shader3D.propertyNameToID("u_ClearCoatFactor"),f.SHADERDEFINE_CLEARCOATTEXTURE=t.Shader3D.getDefineByName("CLEARCOATMAP"),f.CLEARCOATTEXTURE=t.Shader3D.propertyNameToID("u_ClearCoatTexture"),f.CLEARCOATROUGHNESS=t.Shader3D.propertyNameToID("u_ClearCoatRoughness"),f.SHADERDEFINE_CLEARCOATROUGHNESSTEXTURE=t.Shader3D.getDefineByName("CLEARCOAT_ROUGHNESSMAP"),f.CLEARCOATROUGHNESSTEXTURE=t.Shader3D.propertyNameToID("u_ClearCoatRoughnessTexture"),f.CLEARCOATNORMALTEXTURE=t.Shader3D.propertyNameToID("u_ClearCoatNormalTexture"),f.ANISOTROPY=t.Shader3D.propertyNameToID("u_AnisotropyStrength"),f.SHADERDEFINE_ANISOTROPYTEXTURE=t.Shader3D.getDefineByName("ANISOTROPYMAP"),f.ANISOTROPYTEXTURE=t.Shader3D.propertyNameToID("u_AnisotropyTexture"),f.ANISOTROPYROTATION=t.Shader3D.propertyNameToID("u_AnisotropyRotation")}get albedoColor(){return this._shaderValues.getColor(f.ALBEDOCOLOR)}set albedoColor(e){this._shaderValues.setColor(f.ALBEDOCOLOR,e)}get albedoTexture(){return this.hasDefine(f.SHADERDEFINE_ALBEDOTEXTURE)?this._shaderValues.getTexture(f.ALBEDOTEXTURE):null}set albedoTexture(e){e?this._shaderValues.addDefine(f.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(f.SHADERDEFINE_ALBEDOTEXTURE),this.setTextureByIndex(f.ALBEDOTEXTURE,e)}get normalTexture(){return this.hasDefine(f.SHADERDEFINE_NORMALTEXTURE)?this._shaderValues.getTexture(f.NORMALTEXTURE):null}set normalTexture(e){e?this._shaderValues.addDefine(f.SHADERDEFINE_NORMALTEXTURE):this._shaderValues.removeDefine(f.SHADERDEFINE_NORMALTEXTURE),this.setTextureByIndex(f.NORMALTEXTURE,e)}get normalTextureScale(){return this._shaderValues.getNumber(f.NORMALSCALE)}set normalTextureScale(e){this._shaderValues.setNumber(f.NORMALSCALE,e)}get parallaxTexture(){return this._shaderValues.getTexture(f.PARALLAXTEXTURE)}set parallaxTexture(e){e?this._shaderValues.addDefine(f.SHADERDEFINE_PARALLAXTEXTURE):this._shaderValues.removeDefine(f.SHADERDEFINE_PARALLAXTEXTURE),this.setTextureByIndex(f.PARALLAXTEXTURE,e)}get parallaxTextureScale(){return this._shaderValues.getNumber(f.PARALLAXSCALE)}set parallaxTextureScale(e){this._shaderValues.setNumber(f.PARALLAXSCALE,Math.max(.005,Math.min(.08,e)))}get occlusionTexture(){return this._shaderValues.getTexture(f.OCCLUSIONTEXTURE)}set occlusionTexture(e){e?this._shaderValues.addDefine(f.SHADERDEFINE_OCCLUSIONTEXTURE):this._shaderValues.removeDefine(f.SHADERDEFINE_OCCLUSIONTEXTURE),this.setTextureByIndex(f.OCCLUSIONTEXTURE,e)}get occlusionTextureStrength(){return this._shaderValues.getNumber(f.OCCLUSIONSTRENGTH)}set occlusionTextureStrength(e){this._shaderValues.setNumber(f.OCCLUSIONSTRENGTH,Math.max(0,Math.min(1,e)))}get smoothness(){return this._shaderValues.getNumber(f.SMOOTHNESS)}set smoothness(e){this._shaderValues.setNumber(f.SMOOTHNESS,Math.max(0,Math.min(1,e)))}get enableVertexColor(){return this.hasDefine(f.SHADERDEFINE_ENABLEVERTEXCOLOR)}set enableVertexColor(e){e?this.addDefine(f.SHADERDEFINE_ENABLEVERTEXCOLOR):this.removeDefine(f.SHADERDEFINE_ENABLEVERTEXCOLOR)}get enableEmission(){return this._shaderValues.hasDefine(_.DEFINE_EMISSION)}set enableEmission(e){e?this._shaderValues.addDefine(_.DEFINE_EMISSION):this._shaderValues.removeDefine(_.DEFINE_EMISSION)}get emissionColor(){return this._shaderValues.getColor(f.EMISSIONCOLOR)}set emissionColor(e){this._shaderValues.setColor(f.EMISSIONCOLOR,e)}get emissionIntensity(){return this._shaderValues.getNumber(f.EMISSIONIntensity)}set emissionIntensity(e){this._shaderValues.setNumber(f.EMISSIONIntensity,e)}get emissionTexture(){return this._shaderValues.getTexture(f.EMISSIONTEXTURE)}set emissionTexture(e){e?this._shaderValues.addDefine(f.SHADERDEFINE_EMISSIONTEXTURE):this._shaderValues.removeDefine(f.SHADERDEFINE_EMISSIONTEXTURE),this.setTextureByIndex(f.EMISSIONTEXTURE,e)}get tilingOffset(){return this._shaderValues.getVector(f.TILINGOFFSET)}set tilingOffset(e){e?this._shaderValues.setVector(f.TILINGOFFSET,e):this._shaderValues.getVector(f.TILINGOFFSET).setValue(1,1,0,0)}get detailAlbedoTexture(){return this._shaderValues.getTexture(f.DETAILALBEDOTEXTURE)}set detailAlbedoTexture(e){e?this._shaderValues.addDefine(f.SHADERDEFINE_DETAILALBEDO):this._shaderValues.removeDefine(f.SHADERDEFINE_DETAILALBEDO),this.setTextureByIndex(f.DETAILALBEDOTEXTURE,e)}get detailNormalTexture(){return this._shaderValues.getTexture(f.DETAILNORMALTEXTURE)}set detailNormalTexture(e){e?this._shaderValues.addDefine(f.SHADERDEFINE_DETAILNORMAL):this._shaderValues.removeDefine(f.SHADERDEFINE_DETAILNORMAL),this.setTextureByIndex(f.DETAILNORMALTEXTURE,e)}get detailTilingOffset(){return this._shaderValues.getVector(f.DETAILTILLINGOFFSET)}set detailTilingOffset(e){e?this._shaderValues.setVector(f.DETAILTILLINGOFFSET,e):this._shaderValues.getVector(f.DETAILTILLINGOFFSET).setValue(1,1,0,0)}get detailNormalScale(){return this._shaderValues.getNumber(f.DETAILNORMALSCALE)}set detailNormalScale(e){this._shaderValues.setNumber(f.DETAILNORMALSCALE,e)}set renderMode(r){switch(r){case e.PBRRenderMode.Opaque:this.alphaTest=!1,this.renderQueue=t.Material.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=a.CULL_BACK,this.blend=a.BLEND_DISABLE,this.depthTest=a.DEPTHTEST_LESS,this._shaderValues.removeDefine(f.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Cutout:this.renderQueue=t.Material.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=a.CULL_BACK,this.blend=a.BLEND_DISABLE,this.depthTest=a.DEPTHTEST_LESS,this._shaderValues.removeDefine(f.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Fade:this.renderQueue=t.Material.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=a.CULL_BACK,this.blend=a.BLEND_ENABLE_ALL,this.blendSrc=a.BLENDPARAM_SRC_ALPHA,this.blendDst=a.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=a.DEPTHTEST_LESS,this._shaderValues.removeDefine(f.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Transparent:this.renderQueue=t.Material.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=a.CULL_BACK,this.blend=a.BLEND_ENABLE_ALL,this.blendSrc=a.BLENDPARAM_ONE,this.blendDst=a.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=a.DEPTHTEST_LESS,this._shaderValues.addDefine(f.SHADERDEFINE_TRANSPARENTBLEND);break;default:throw new Error("unknown renderMode: "+r)}}get anisotropyEnable(){return this.shaderData.hasDefine(_.DEFINE_ANISOTROPY)}set anisotropyEnable(e){e?this.shaderData.addDefine(_.DEFINE_ANISOTROPY):this.shaderData.removeDefine(_.DEFINE_ANISOTROPY)}get anisotropy(){return this.getFloatByIndex(f.ANISOTROPY)}set anisotropy(e){this.setFloatByIndex(f.ANISOTROPY,Math.min(1,Math.max(-1,e)))}get anisotropyTexture(){return this.getTextureByIndex(f.ANISOTROPYTEXTURE)}set anisotropyTexture(e){this.setTextureByIndex(f.ANISOTROPYTEXTURE,e),e?this.addDefine(f.SHADERDEFINE_ANISOTROPYTEXTURE):this.removeDefine(f.SHADERDEFINE_ANISOTROPYTEXTURE)}get anisotropyRotation(){return this.getFloatByIndex(f.ANISOTROPYROTATION)}set anisotropyRotation(e){e=Math.max(Math.min(e,1),0),this.setFloatByIndex(f.ANISOTROPYROTATION,e)}get clearCoatEnable(){return this.shaderData.hasDefine(_.DEFINE_CLEARCOAT)}set clearCoatEnable(e){e?this.shaderData.addDefine(_.DEFINE_CLEARCOAT):this.shaderData.removeDefine(_.DEFINE_CLEARCOAT)}get clearCoat(){return this.shaderData.getNumber(f.CLEARCOAT)}set clearCoat(e){this.shaderData.setNumber(f.CLEARCOAT,e)}get clearCoatTexture(){return this.shaderData.getTexture(f.CLEARCOATTEXTURE)}set clearCoatTexture(e){e?this.shaderData.addDefine(f.SHADERDEFINE_CLEARCOATTEXTURE):this.shaderData.removeDefine(f.SHADERDEFINE_CLEARCOATTEXTURE),this.setTextureByIndex(f.CLEARCOATTEXTURE,e)}get clearCoatRoughness(){return this.shaderData.getNumber(f.CLEARCOATROUGHNESS)}set clearCoatRoughness(e){this.shaderData.setNumber(f.CLEARCOATROUGHNESS,e)}get clearCoatRoughnessTexture(){return this.shaderData.getTexture(f.CLEARCOATROUGHNESSTEXTURE)}set clearCoatRoughnessTexture(e){e?this.shaderData.addDefine(f.SHADERDEFINE_CLEARCOATROUGHNESSTEXTURE):this.shaderData.removeDefine(f.SHADERDEFINE_CLEARCOATROUGHNESSTEXTURE),this.setTextureByIndex(f.CLEARCOATROUGHNESSTEXTURE,e)}get clearCoatNormalTexture(){return this.shaderData.getTexture(f.CLEARCOATNORMALTEXTURE)}set clearCoatNormalTexture(e){e?this.shaderData.addDefine(_.DEFINE_CLEARCOAT_NORMAL):this.shaderData.removeDefine(_.DEFINE_CLEARCOAT_NORMAL),this.setTextureByIndex(f.CLEARCOATNORMALTEXTURE,e)}constructor(){super(),this._shaderValues.setColor(f.ALBEDOCOLOR,new t.Color(1,1,1,1)),this._shaderValues.setColor(f.EMISSIONCOLOR,new t.Color(1,1,1,1)),this._shaderValues.setVector(f.TILINGOFFSET,new t.Vector4(1,1,0,0)),this._shaderValues.setNumber(f.SMOOTHNESS,.5),this._shaderValues.setNumber(f.OCCLUSIONSTRENGTH,1),this._shaderValues.setNumber(f.NORMALSCALE,1),this._shaderValues.setNumber(f.PARALLAXSCALE,.001),this._shaderValues.setNumber(t.Material.ALPHATESTVALUE,.5),this.renderMode=e.PBRRenderMode.Opaque}get smoothnessTextureScale(){return this._shaderValues.getNumber(f.SMOOTHNESS)}set smoothnessTextureScale(e){this._shaderValues.setNumber(f.SMOOTHNESS,Math.max(0,Math.min(1,e)))}}f.renderQuality=e.PBRRenderQuality.High,e.PBRMetallicSmoothnessSource=void 0,(h=e.PBRMetallicSmoothnessSource||(e.PBRMetallicSmoothnessSource={}))[h.MetallicGlossTextureAlpha=0]="MetallicGlossTextureAlpha",h[h.AlbedoTextureAlpha=1]="AlbedoTextureAlpha";class g extends f{static __init__(){g.SHADERDEFINE_METALLICGLOSSTEXTURE=t.Shader3D.getDefineByName("METALLICGLOSSTEXTURE"),g.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=t.Shader3D.getDefineByName("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA"),g.METALLICGLOSSTEXTURE=t.Shader3D.propertyNameToID("u_MetallicGlossTexture"),g.METALLIC=t.Shader3D.propertyNameToID("u_Metallic")}get metallicGlossTexture(){return this._shaderValues.getTexture(g.METALLICGLOSSTEXTURE)}set metallicGlossTexture(e){e?this._shaderValues.addDefine(g.SHADERDEFINE_METALLICGLOSSTEXTURE):this._shaderValues.removeDefine(g.SHADERDEFINE_METALLICGLOSSTEXTURE),this._shaderValues.setTexture(g.METALLICGLOSSTEXTURE,e)}get metallic(){return this._shaderValues.getNumber(g.METALLIC)}set metallic(e){this._shaderValues.setNumber(g.METALLIC,Math.max(0,Math.min(1,e)))}get smoothnessSource(){return this._smoothnessSource}set smoothnessSource(e){e?this._shaderValues.addDefine(g.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA):this._shaderValues.removeDefine(g.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._smoothnessSource=e}constructor(){super(),this._smoothnessSource=0,this.setShaderName("PBR")}clone(){var e=new g;return this.cloneTo(e),e}}class m extends t.Material{static __initDefine__(){m.TINTCOLOR=t.Shader3D.propertyNameToID("u_TintColor"),m.EXPOSURE=t.Shader3D.propertyNameToID("u_Exposure"),m.ROTATION=t.Shader3D.propertyNameToID("u_Rotation"),m.TEXTURECUBE=t.Shader3D.propertyNameToID("u_CubeTexture")}get tintColor(){return this._shaderValues.getColor(m.TINTCOLOR)}set tintColor(e){this._shaderValues.setColor(m.TINTCOLOR,e)}get exposure(){return this._shaderValues.getNumber(m.EXPOSURE)}set exposure(e){this._shaderValues.setNumber(m.EXPOSURE,e)}get rotation(){return this._shaderValues.getNumber(m.ROTATION)}set rotation(e){this._shaderValues.setNumber(m.ROTATION,e)}get textureCube(){return this._shaderValues.getTexture(m.TEXTURECUBE)}set textureCube(e){this._shaderValues.setTexture(m.TEXTURECUBE,e)}clone(){var e=new m;return this.cloneTo(e),e}constructor(){super(),this.setShaderName("SkyBox")}}class p extends t.Material{static __initDefine__(){p.SHADERDEFINE_SUN_HIGH_QUALITY=t.Shader3D.getDefineByName("SUN_HIGH_QUALITY"),p.SHADERDEFINE_SUN_SIMPLE=t.Shader3D.getDefineByName("SUN_SIMPLE"),p.SUNSIZE=t.Shader3D.propertyNameToID("u_SunSize"),p.SUNSIZECONVERGENCE=t.Shader3D.propertyNameToID("u_SunSizeConvergence"),p.ATMOSPHERETHICKNESS=t.Shader3D.propertyNameToID("u_AtmosphereThickness"),p.SKYTINT=t.Shader3D.propertyNameToID("u_SkyTint"),p.GROUNDTINT=t.Shader3D.propertyNameToID("u_GroundTint"),p.EXPOSURE=t.Shader3D.propertyNameToID("u_Exposure")}get sunDisk(){return this._sunDisk}set sunDisk(e){switch(e){case p.SUN_HIGH_QUALITY:this._shaderValues.removeDefine(p.SHADERDEFINE_SUN_SIMPLE),this._shaderValues.addDefine(p.SHADERDEFINE_SUN_HIGH_QUALITY);break;case p.SUN_SIMPLE:this._shaderValues.removeDefine(p.SHADERDEFINE_SUN_HIGH_QUALITY),this._shaderValues.addDefine(p.SHADERDEFINE_SUN_SIMPLE);break;case p.SUN_NODE:this._shaderValues.removeDefine(p.SHADERDEFINE_SUN_HIGH_QUALITY),this._shaderValues.removeDefine(p.SHADERDEFINE_SUN_SIMPLE);break;default:throw"SkyBoxProceduralMaterial: unknown sun value."}this._sunDisk=e}get sunSize(){return this._shaderValues.getNumber(p.SUNSIZE)}set sunSize(e){e=Math.min(Math.max(0,e),1),this._shaderValues.setNumber(p.SUNSIZE,e)}get sunSizeConvergence(){return this._shaderValues.getNumber(p.SUNSIZECONVERGENCE)}set sunSizeConvergence(e){e=Math.min(Math.max(0,e),20),this._shaderValues.setNumber(p.SUNSIZECONVERGENCE,e)}get atmosphereThickness(){return this._shaderValues.getNumber(p.ATMOSPHERETHICKNESS)}set atmosphereThickness(e){e=Math.min(Math.max(0,e),5),this._shaderValues.setNumber(p.ATMOSPHERETHICKNESS,e)}get skyTint(){return this._shaderValues.getColor(p.SKYTINT)}set skyTint(e){this._shaderValues.setColor(p.SKYTINT,e)}get groundTint(){return this._shaderValues.getColor(p.GROUNDTINT)}set groundTint(e){this._shaderValues.setColor(p.GROUNDTINT,e)}get exposure(){return this._shaderValues.getNumber(p.EXPOSURE)}set exposure(e){e=Math.min(Math.max(0,e),8),this._shaderValues.setNumber(p.EXPOSURE,e)}constructor(){super(),this.setShaderName("SkyProcedural"),this.sunDisk=p.SUN_HIGH_QUALITY,this.sunSize=.04,this.sunSizeConvergence=5,this.atmosphereThickness=1,this.skyTint=new t.Color(.5,.5,.5,1),this.groundTint=new t.Color(.369,.349,.341,1),this.exposure=1.3}clone(){var e=new p;return this.cloneTo(e),e}}p.SUN_NODE=0,p.SUN_SIMPLE=1,p.SUN_HIGH_QUALITY=2;class S extends t.Material{static __initDefine__(){S.SHADERDEFINE_ALBEDOTEXTURE=t.Shader3D.getDefineByName("ALBEDOTEXTURE"),S.SHADERDEFINE_ENABLEVERTEXCOLOR=t.Shader3D.getDefineByName("ENABLEVERTEXCOLOR"),S.ALBEDOTEXTURE=t.Shader3D.propertyNameToID("u_AlbedoTexture"),S.ALBEDOCOLOR=t.Shader3D.propertyNameToID("u_AlbedoColor"),S.TILINGOFFSET=t.Shader3D.propertyNameToID("u_TilingOffset")}get albedoColor(){return this.getColorByIndex(S.ALBEDOCOLOR)}set albedoColor(e){this.setColorByIndex(S.ALBEDOCOLOR,e.scale(this._albedoIntensity))}get albedoIntensity(){return this._albedoIntensity}set albedoIntensity(e){this._albedoIntensity=e}get albedoTexture(){return this.getTextureByIndex(S.ALBEDOTEXTURE)}set albedoTexture(e){e?this.addDefine(S.SHADERDEFINE_ALBEDOTEXTURE):this.removeDefine(S.SHADERDEFINE_ALBEDOTEXTURE),this.setTextureByIndex(S.ALBEDOTEXTURE,e)}get tilingOffset(){return this.getVector4ByIndex(S.TILINGOFFSET)}set tilingOffset(e){e?this.setVector4ByIndex(S.TILINGOFFSET,e):this.setVector4ByIndex(S.TILINGOFFSET,new t.Vector4(1,1,0,0))}get enableVertexColor(){return this.hasDefine(S.SHADERDEFINE_ENABLEVERTEXCOLOR)}set enableVertexColor(e){e?this.addDefine(S.SHADERDEFINE_ENABLEVERTEXCOLOR):this.removeDefine(S.SHADERDEFINE_ENABLEVERTEXCOLOR)}constructor(){super(),this.setShaderName("Unlit"),this.renderMode=S.RENDERMODE_OPAQUE,this.albedoIntensity=1}clone(){var e=new S;return this.cloneTo(e),e}set renderMode(e){switch(e){case S.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=t.Material.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=a.CULL_BACK,this.blend=a.BLEND_DISABLE,this.depthTest=a.DEPTHTEST_LESS;break;case S.RENDERMODE_CUTOUT:this.renderQueue=t.Material.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=a.CULL_BACK,this.blend=a.BLEND_DISABLE,this.depthTest=a.DEPTHTEST_LESS;break;case S.RENDERMODE_TRANSPARENT:this.renderQueue=t.Material.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=a.CULL_BACK,this.blend=a.BLEND_ENABLE_ALL,this.blendSrc=a.BLENDPARAM_SRC_ALPHA,this.blendDst=a.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=a.DEPTHTEST_LESS;break;default:throw new Error("unknown renderMode: "+e)}}}S.RENDERMODE_OPAQUE=0,S.RENDERMODE_CUTOUT=1,S.RENDERMODE_TRANSPARENT=2,S.RENDERMODE_ADDTIVE=3,e.BaseRenderType=void 0,(d=e.BaseRenderType||(e.BaseRenderType={}))[d.BaseRender=0]="BaseRender",d[d.MeshRender=1]="MeshRender",d[d.ParticleRender=2]="ParticleRender",d[d.TrailRender=3]="TrailRender",d[d.LineRender=4]="LineRender",d[d.TerrainRender=5]="TerrainRender",d[d.SkyRender=7]="SkyRender",d[d.SimpleSkinRender=8]="SimpleSkinRender",d[d.SkinnedMeshRender=9]="SkinnedMeshRender",e.ENodeCustomData=void 0,(c=e.ENodeCustomData||(e.ENodeCustomData={}))[c.custom_0=0]="custom_0",c[c.custom_1=1]="custom_1",c[c.custom_2=2]="custom_2";class E{}class D{}class T{static getMeshDefine(e,r){r.length=0;let a=e._vertexBuffer.vertexDeclaration._vertexElements;for(const e of a)switch(e.elementUsage){case t.VertexMesh.MESH_COLOR0:r.push(D.SHADERDEFINE_COLOR);break;case t.VertexMesh.MESH_TEXTURECOORDINATE0:r.push(D.SHADERDEFINE_UV0);break;case t.VertexMesh.MESH_TEXTURECOORDINATE1:r.push(D.SHADERDEFINE_UV1);break;case t.VertexMesh.MESH_TANGENT0:r.push(D.SHADERDEFINE_TANGENT)}}}class A extends t.Component{constructor(){super(),this.runInEditor=!0}_onEnable(){const e=this.owner.getComponent(k);e&&e._enabled&&e._onMeshChange(this._sharedMesh)}_onDisable(){this.owner.getComponent(k)}get sharedMesh(){return this._sharedMesh}set sharedMesh(e){if(this._sharedMesh!==e){var t=this._sharedMesh;t&&t._removeReference(),e&&e._addReference(),this._sharedMesh=e;const r=this.owner.getComponent(k);if(!r)return;r._onMeshChange(e),this._sharedMesh=e}}_onDestroy(){this._sharedMesh&&(this._sharedMesh._removeReference(),this._sharedMesh=null)}_cloneTo(e){e.sharedMesh=this.sharedMesh,super._cloneTo(e)}}A._meshVerticeDefine=[],e.StaticFlag=void 0,(u=e.StaticFlag||(e.StaticFlag={}))[u.Normal=1]="Normal",u[u.StaticBatch=2]="StaticBatch";class x extends t.Node{static __init__(){x.WORLDMATRIX=t.Shader3D.propertyNameToID("u_WorldMat"),x.WORLDINVERTFRONT=t.Shader3D.propertyNameToID("u_WorldInvertFront"),x.sprite3DCommandUniformMap=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Sprite3D"),x.sprite3DCommandUniformMap.addShaderUniform(x.WORLDMATRIX,"u_WorldMat",e.ShaderDataType.Matrix4x4),x.sprite3DCommandUniformMap.addShaderUniform(x.WORLDINVERTFRONT,"u_WorldInvertFront",e.ShaderDataType.Vector4)}static instantiate(e,t=null,r=!0,a=null,i=null){var n=e.clone();t&&t.addChild(n);var s=n.transform;if(r){var o=s.worldMatrix;e.transform.worldMatrix.cloneTo(o),s.worldMatrix=o}else a&&(s.position=a),i&&(s.rotation=i);return n}static load(e,r){t.ILaya.loader.load(e).then((e=>{r&&r.runWith([null==e?void 0:e.create()])}))}get id(){return this._id}get layer(){return this._layer}set layer(e){if(this._layer!==e){if(!(e>=0&&e<=30))throw new Error("Layer value must be 0-30.");this._layer=e,this.event(t.Event.LAYER_CHANGE,e)}}get isStatic(){return!!(this._isStatic>>1|0)}set isStatic(r){this._isStatic=r?e.StaticFlag.StaticBatch:e.StaticFlag.Normal,this.event(t.Event.STATIC_MASK,this._isStatic)}get transform(){return this._transform}get scene(){return this._scene}constructor(t,r){super(),this._isRenderNode=0,this._nodeType=1,this._id=++y,this._transform=E.Render3DModuleDataFactory.createTransform(this),this._isStatic=r?e.StaticFlag.StaticBatch:e.StaticFlag.Normal,this.layer=0,this.name=t||"New Sprite3D"}_onActive(){super._onActive(),t.Stat.sprite3DCount++}_onInActive(){super._onInActive(),t.Stat.sprite3DCount--}_onAdded(){if(this._parent instanceof x){var e=this._parent;this.transform._setParent(e.transform)}else this.transform._onWorldTransform();super._onAdded()}_onRemoved(){super._onRemoved(),this._parent instanceof x&&this.transform._setParent(null)}onStartListeningToType(e){super.onStartListeningToType(e),(e.startsWith("collision")||e.startsWith("trigger"))&&this.event(t.Event.UPDATE_PHY_EVENT_FILTER)}_cloneTo(e,t,r){if(this._destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");var a=this._transform,i=e._transform;e.name=this.name,e.tag=this.tag,e._destroyed=this._destroyed,e.active=this.active,i.localPosition=a.localPosition,i.localRotation=a.localRotation,i.localScale=a.localScale,e._isStatic=this._isStatic,e.layer=this.layer,super._cloneTo(e,t,r)}static _createSprite3DInstance(e){let t=new(Object.getPrototypeOf(e).constructor),r=e._children;for(let e=0,a=r.length;e<a;e++){let a=x._createSprite3DInstance(r[e]);t.addChild(a)}return t}static _parseSprite3DInstance(e,t,r,a){let i=r._children,n=a._children;for(let r=0,a=i.length;r<a;r++)x._parseSprite3DInstance(e,t,i[r],n[r]);r._cloneTo(a,e,t)}clone(){let e=x._createSprite3DInstance(this);return x._parseSprite3DInstance(this,e,this,e),e}destroy(e=!0){this._destroyed||(super.destroy(e),this._transform=null)}}var R,M,C,I,v,y=0;class B extends x{static __init__(){B.SHADERDEFINE_RECEIVE_SHADOW=t.Shader3D.getDefineByName("RECEIVESHADOW"),B.SAHDERDEFINE_LIGHTMAP=t.Shader3D.getDefineByName("LIGHTMAP"),B.SHADERDEFINE_LIGHTMAP_DIRECTIONAL=t.Shader3D.getDefineByName("LIGHTMAP_DIRECTIONAL"),B.LIGHTMAPSCALEOFFSET=t.Shader3D.propertyNameToID("u_LightmapScaleOffset"),B.LIGHTMAP=t.Shader3D.propertyNameToID("u_LightMap"),B.LIGHTMAP_DIRECTION=t.Shader3D.propertyNameToID("u_LightMapDirection"),B.PICKCOLOR=t.Shader3D.propertyNameToID("u_PickColor");const r=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Sprite3D");B.SHADERDEFINE_MORPHTARGET=t.Shader3D.getDefineByName("MORPHTARGETS"),B.SHADERDEFINE_MORPHTARGET_POSITION=t.Shader3D.getDefineByName("MORPHTARGETS_POSITION"),B.SHADERDEFINE_MORPHTARGET_NORMAL=t.Shader3D.getDefineByName("MORPHTARGETS_NORMAL"),B.SHADERDEFINE_MORPHTARGET_TANGENT=t.Shader3D.getDefineByName("MORPHTARGETS_TANGENT"),B.MorphTex=t.Shader3D.propertyNameToID("u_MorphTargetsTex"),B.MorphParams=t.Shader3D.propertyNameToID("u_MorphParams"),B.MorphAttriOffset=t.Shader3D.propertyNameToID("u_MorphAttrOffset"),B.MorphActiceTargets=t.Shader3D.propertyNameToID("u_MorphActiveTargets"),B.MorphActiveCount=t.Shader3D.propertyNameToID("u_MorphTargetActiveCount"),r.addShaderUniform(B.MorphTex,"u_MorphTargetsTex",e.ShaderDataType.Texture2D),r.addShaderUniform(B.MorphParams,"u_MorphParams",e.ShaderDataType.Vector4),r.addShaderUniform(B.MorphAttriOffset,"u_MorphAttrOffset",e.ShaderDataType.Vector4),r.addShaderUniform(B.MorphActiceTargets,"u_MorphActiveTargets",e.ShaderDataType.Buffer),r.addShaderUniform(B.MorphActiveCount,"u_MorphTargetActiveCount",e.ShaderDataType.Int),r.addShaderUniform(B.LIGHTMAPSCALEOFFSET,"u_LightmapScaleOffset",e.ShaderDataType.Vector4),r.addShaderUniform(B.LIGHTMAP,"u_LightMap",e.ShaderDataType.Texture2D),r.addShaderUniform(B.LIGHTMAP_DIRECTION,"u_LightMapDirection",e.ShaderDataType.Texture2D),r.addShaderUniform(B.PICKCOLOR,"u_PickColor",e.ShaderDataType.Vector3),B.REFLECTIONTEXTURE=t.Shader3D.propertyNameToID("u_ReflectTexture"),B.REFLECTIONCUBE_HDR_PARAMS=t.Shader3D.propertyNameToID("u_ReflectCubeHDRParams"),r.addShaderUniform(B.REFLECTIONTEXTURE,"u_ReflectTexture",e.ShaderDataType.TextureCube),r.addShaderUniform(B.REFLECTIONCUBE_HDR_PARAMS,"u_ReflectCubeHDRParams",e.ShaderDataType.Vector4),B.AMBIENTSHAR=t.Shader3D.propertyNameToID("u_AmbientSHAr"),r.addShaderUniform(B.AMBIENTSHAR,"u_AmbientSHAr",e.ShaderDataType.Vector4),B.AMBIENTSHAG=t.Shader3D.propertyNameToID("u_AmbientSHAg"),r.addShaderUniform(B.AMBIENTSHAG,"u_AmbientSHAg",e.ShaderDataType.Vector4),B.AMBIENTSHAB=t.Shader3D.propertyNameToID("u_AmbientSHAb"),r.addShaderUniform(B.AMBIENTSHAB,"u_AmbientSHAb",e.ShaderDataType.Vector4),B.AMBIENTSHBR=t.Shader3D.propertyNameToID("u_AmbientSHBr"),r.addShaderUniform(B.AMBIENTSHBR,"u_AmbientSHBr",e.ShaderDataType.Vector4),B.AMBIENTSHBG=t.Shader3D.propertyNameToID("u_AmbientSHBg"),r.addShaderUniform(B.AMBIENTSHBG,"u_AmbientSHBg",e.ShaderDataType.Vector4),B.AMBIENTSHBB=t.Shader3D.propertyNameToID("u_AmbientSHBb"),r.addShaderUniform(B.AMBIENTSHBB,"u_AmbientSHBb",e.ShaderDataType.Vector4),B.AMBIENTSHC=t.Shader3D.propertyNameToID("u_AmbientSHC"),r.addShaderUniform(B.AMBIENTSHC,"u_AmbientSHC",e.ShaderDataType.Vector4)}constructor(e){super(e)}_onInActive(){super._onInActive()}_onActive(){super._onActive()}_onActiveInScene(){super._onActiveInScene()}_addToInitStaticBatchManager(){}_setBelongScene(e){super._setBelongScene(e)}_setUnBelongScene(){super._setUnBelongScene()}}class w{static merge(e,r,a){t.Vector3.min(e.min,r.min,a.min),t.Vector3.max(e.max,r.max,a.max),a.min=a.min,a.max=a.max}static containPoint(e,t){let r=e._imp.getMax(),a=e._imp.getMin();return!(t.x>r.x||t.x<a.x)&&(!(t.y>r.y||t.y<a.y)&&!(t.z>r.z||t.z<a.z))}get min(){return this.getMin()}set min(e){this.setMin(e)}get max(){return this.getMax()}set max(e){this.setMax(e)}setMin(e){this._imp.setMin(e)}getMin(){return this._imp.getMin()}setMax(e){this._imp.setMax(e)}getMax(){return this._imp.getMax()}setCenter(e){this._imp.setCenter(e)}getCenter(){return this._imp.getCenter()}setExtent(e){this._imp.setExtent(e)}getExtent(){return this._imp.getExtent()}constructor(e,t){this._imp=E.Render3DModuleDataFactory.createBounds(e,t)}_getUpdateFlag(e){return this._imp._getUpdateFlag(e)}_setUpdateFlag(e,t){this._imp._setUpdateFlag(e,t)}_getCenter(e,r,a){t.Vector3.add(e,r,a),t.Vector3.scale(a,.5,a)}_getExtent(e,r,a){t.Vector3.subtract(r,e,a),t.Vector3.scale(a,.5,a)}_getMin(e,r,a){t.Vector3.subtract(e,r,a)}_getMax(e,r,a){t.Vector3.add(e,r,a)}_rotateExtents(e,t,r){var a=e.x,i=e.y,n=e.z,s=t.elements;r.x=Math.abs(s[0]*a)+Math.abs(s[4]*i)+Math.abs(s[8]*n),r.y=Math.abs(s[1]*a)+Math.abs(s[5]*i)+Math.abs(s[9]*n),r.z=Math.abs(s[2]*a)+Math.abs(s[6]*i)+Math.abs(s[10]*n)}_tranform(e,t){this._imp._tranform(e,t._imp)}getCorners(e){this._imp.getCorners(e)}getBoundBox(e){this._imp._getBoundBox().cloneTo(e)}calculateBoundsintersection(e){return this._imp.calculateBoundsintersection(e._imp)}cloneTo(e){this._imp.cloneTo(e._imp)}clone(){var e=new w(new t.Vector3,new t.Vector3);return this.cloneTo(e),e}}w._UPDATE_MIN=1,w._UPDATE_MAX=2,w._UPDATE_CENTER=4,w._UPDATE_EXTENT=8,e.volumeIntersectType=void 0,(R=e.volumeIntersectType||(e.volumeIntersectType={}))[R.contain=0]="contain",R[R.intersect=1]="intersect",R[R.Disjoint=2]="Disjoint";class L extends t.Component{constructor(){super(),this._aroundVolumeCacheNum=0,this._bounds=new w,this._primitiveBounds=new w,this._importance=0,this.runInEditor=!0}get type(){return this._type}get bounds(){return this._bounds}get boundsMax(){return this._primitiveBounds.getMax()}set boundsMax(e){this._primitiveBounds.setMax(e),this._reCaculateBoundBox()}get boundsMin(){return this._primitiveBounds.getMin()}set boundsMin(e){this._primitiveBounds.setMin(e),this._reCaculateBoundBox()}get probePosition(){return this.owner.transform.position}get importance(){return this._importance}set importance(e){this._importance=e}_onEnable(){this.owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._VolumeChange),this._volumeManager=this.owner.scene._volumeManager,this._volumeManager.add(this),this._reCaculateBoundBox()}_onDisable(){this.owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._VolumeChange),this._volumeManager.remove(this)}_VolumeChange(){this._volumeManager._needUpdateAllRender=!0;let e=this._volumeManager._regVolumeManager[this.type];e&&(e._needUpdateAllRender=!0),this._reCaculateBoundBox()}_reCaculateBoundBox(){this.owner&&this._primitiveBounds._tranform(this.owner.transform.worldMatrix,this._bounds)}}class N{constructor(){this._reflectionProbes=new t.SingletonList,this._needUpdateAllRender=!1,this._sceneReflectionProbe=new b,this._sceneReflectionProbe.boxProjection=!1,this._sceneReflectionProbe._isScene=!0}get sceneReflectionProbe(){return this._sceneReflectionProbe}set sceneReflectionProbe(e){this._sceneReflectionProbe=e,this._needUpdateAllRender=!0}_updateRenderObject(e){if(0!=this._reflectionProbes.length){for(var t,r,a=this._reflectionProbes.elements,i=0,n=e.bounds,s=0,o=this._reflectionProbes.length;s<o;s++){let e=a[s];if(t){if(t.importance>e.importance)continue;if((r=n.calculateBoundsintersection(e.bounds))<i&&t.importance==e.importance)continue}else if((r=n.calculateBoundsintersection(e.bounds))<i)continue;t=e,i=r}!t&&this._sceneReflectionProbe&&(t=this._sceneReflectionProbe),e.probReflection=t}else e.probReflection=this._sceneReflectionProbe}add(e){this._reflectionProbes.add(e),this._needUpdateAllRender=!0}remove(e){this._reflectionProbes.remove(e),this._needUpdateAllRender=!0}handleMotionlist(e){var t=e.elements;let r;for(var a=0,i=e.length;a<i;a++)r=t[a],r._surportReflectionProbe&&1==r.reflectionMode&&this._updateRenderObject(t[a])}reCaculateAllRenderObjects(e){var t=e.elements;let r;for(var a=0,i=e.length;a<i;a++)r=t[a],r._surportReflectionProbe&&1==r.reflectionMode&&this._updateRenderObject(r),this._needUpdateAllRender=!1}destroy(){for(let e=0;e<this._reflectionProbes.length;e++){this._reflectionProbes.elements[e].destroy()}this._reflectionProbes.length=0,this._sceneReflectionProbe.destroy(),this._sceneReflectionProbe=null}}class P extends L{static init(){P.SHADERDEFINE_VOLUMETRICGI=t.Shader3D.getDefineByName("VOLUMETRICGI"),P.VOLUMETRICGI_PROBECOUNTS=t.Shader3D.propertyNameToID("u_VolGIProbeCounts"),P.VOLUMETRICGI_PROBESTEPS=t.Shader3D.propertyNameToID("u_VolGIProbeStep"),P.VOLUMETRICGI_PROBESTARTPOS=t.Shader3D.propertyNameToID("u_VolGIProbeStartPosition"),P.VOLUMETRICGI_PROBEPARAMS=t.Shader3D.propertyNameToID("u_VolGIProbeParams"),P.VOLUMETRICGI_IRRADIANCE=t.Shader3D.propertyNameToID("u_ProbeIrradiance"),P.VOLUMETRICGI_DISTANCE=t.Shader3D.propertyNameToID("u_ProbeDistance");let r=t.LayaGL.renderDeviceFactory.createGlobalUniformMap(P.BlockName);r.addShaderUniform(P.VOLUMETRICGI_PROBECOUNTS,"u_VolGIProbeCounts",e.ShaderDataType.Vector3),r.addShaderUniform(P.VOLUMETRICGI_PROBESTEPS,"u_VolGIProbeStep",e.ShaderDataType.Vector3),r.addShaderUniform(P.VOLUMETRICGI_PROBESTARTPOS,"u_VolGIProbeStartPosition",e.ShaderDataType.Vector3),r.addShaderUniform(P.VOLUMETRICGI_PROBEPARAMS,"u_VolGIProbeParams",e.ShaderDataType.Vector4),r.addShaderUniform(P.VOLUMETRICGI_IRRADIANCE,"u_ProbeIrradiance",e.ShaderDataType.Texture2D),r.addShaderUniform(P.VOLUMETRICGI_DISTANCE,"u_ProbeDistance",e.ShaderDataType.Texture2D)}static getID(){return P.volumetricCount++}get shaderData(){return this._dataModule.shaderData}constructor(){super(),this._type=O.VolumetricGIType,this._probeCounts=new t.Vector3,this._probeStep=new t.Vector3,this._params=new t.Vector4(8,16,0,0),this._dataModule=E.Render3DModuleDataFactory.createVolumetricGI(),this._dataModule.setParams(this._params),this._volumetricProbeID=P.getID(),this._dataModule.intensity=1}_onEnable(){super._onEnable(),this._dataModule.updateMark=r.Scene3D._updateMark}get irradiance(){return this._irradiance}set irradiance(e){this._irradiance!=e&&(this._irradiance&&this._irradiance._removeReference(),e?(e._addReference(),this._dataModule.irradiance=e._texture):this._dataModule.irradiance=null,this._irradiance=e,this._irradiance=e,this._dataModule.updateMark=r.Scene3D._updateMark)}get distance(){return this._distance}set distance(e){this._distance!=e&&(this._distance&&this._distance._removeReference(),e?(e._addReference(),this._dataModule.distance=e._texture):this._dataModule.distance=null,this._distance=e,this._dataModule.updateMark=r.Scene3D._updateMark)}get normalBias(){return this._params.z}set normalBias(e){this._params.z=e,this._dataModule.setParams(this._params),this._dataModule.updateMark=r.Scene3D._updateMark}get viewBias(){return this._params.w}set viewBias(e){this._params.w=e,this._dataModule.setParams(this._params),this._dataModule.updateMark=r.Scene3D._updateMark}get irradianceTexel(){return this._params.x}get distanceTexel(){return this._params.y}get intensity(){return this._dataModule.intensity}set intensity(e){e!=this._dataModule.intensity&&(e=Math.max(e,0),this._dataModule.updateMark=r.Scene3D._updateMark)}get probeCounts(){return this._probeCounts}set probeCounts(e){e.equal(this._probeCounts)||(e.cloneTo(this._probeCounts),this._dataModule.setProbeCounts(e),this._dataModule.updateMark=r.Scene3D._updateMark)}get probeStep(){return this._probeStep}set probeStep(e){e.equal(this._probeStep)||(e.cloneTo(this._probeStep),this._dataModule.setProbeStep(e),this._dataModule.updateMark=r.Scene3D._updateMark)}_reCaculateBoundBox(){super._reCaculateBoundBox(),this.bounds.cloneTo(this._dataModule.bound)}_onDestroy(){this.irradiance=null,this.distance=null,this._dataModule.destroy(),this._dataModule=null}_cloneTo(e){e.irradiance=this.irradiance,e.distance=this.distance,this._probeCounts.cloneTo(e._probeCounts),this.probeStep.cloneTo(e.probeStep),e.normalBias=this.normalBias,e.viewBias=this.viewBias,e.intensity=this.intensity}}P.BlockName="VolumetricGIProbe",P.volumetricCount=0;class F{constructor(){this._GIVolumes=new t.SingletonList,this._needUpdateAllRender=!0}removeVolumetricGI(e){e._baseRenderNode.shaderData.removeDefine(P.SHADERDEFINE_VOLUMETRICGI),e.lightProbe=null}add(e){this._GIVolumes.add(e),this._needUpdateAllRender=!0}remove(e){this._GIVolumes.remove(e),this._needUpdateAllRender=!0}_updateRenderObject(e){if(0==this._GIVolumes.length)return void this.removeVolumetricGI(e);let t,r=e.bounds,a=0,i=0,n=this._GIVolumes.elements;for(let e=0;e<this._GIVolumes.length;e++){let s=n[e];if(t){if(t.importance>s.importance)continue;if(i=r.calculateBoundsintersection(s.bounds),i<a&&t.importance==s.importance)continue}else if(i=r.calculateBoundsintersection(s.bounds),i<a)continue;t=s,a=i}t?e.lightProbe=t:this.removeVolumetricGI(e)}handleMotionlist(e){for(let t=0;t<e.length;t++){let r=e.elements[t];r._surportVolumetricGI&&this._updateRenderObject(r)}this._needUpdateAllRender=!1}reCaculateAllRenderObjects(e){for(let t=0;t<e.length;t++){let r=e.elements[t];r._surportVolumetricGI&&this._updateRenderObject(r)}this._needUpdateAllRender=!1}destroy(){let e=this._GIVolumes.length;for(var t=0;t<e;t++)this._GIVolumes.elements[t].destroy()}}class O{constructor(){this._motionObjects=new t.SingletonList,this._volumeList=new t.SingletonList,this._needUpdateAllRender=!1,this._regVolumeManager={},this._reflectionProbeManager=new N,this._regVolumeManager[O.ReflectionProbeVolumeType]=this._reflectionProbeManager,this._volumetricGIManager=new F,this._regVolumeManager[O.VolumetricGIType]=this._volumetricGIManager}get reflectionProbeManager(){return this._reflectionProbeManager}get volumetricGIManager(){return this._volumetricGIManager}add(e){let t=this._regVolumeManager[e.type];t?t.add(e):(this._volumeList.add(e),this._needUpdateAllRender=!0)}remove(e){let t=this._regVolumeManager[e.type];t?t.remove(e):(this._volumeList.remove(e),this._needUpdateAllRender=!0)}addMotionObject(e){this._motionObjects.add(e)}removeMotionObject(e){this._motionObjects.remove(e)}_updateRenderObject(e){let t,r=this._volumeList.elements,a=e.bounds.getCenter();for(var i=0,n=this._volumeList.length;i<n;i++){let e=r[i],n=e.bounds;w.containPoint(n,a)&&(t=e)}e.volume=t}handleMotionlist(){for(var e=this._motionObjects.elements,t=0,r=this._motionObjects.length;t<r;t++)this._updateRenderObject(e[t]);this.reflectionProbeManager._needUpdateAllRender||this.reflectionProbeManager.handleMotionlist(this._motionObjects),this.volumetricGIManager._needUpdateAllRender||this.volumetricGIManager.handleMotionlist(this._motionObjects),this.clearMotionObjects()}reCaculateAllRenderObjects(e){if(this._needUpdateAllRender){for(var t=e.elements,r=0,a=e.length;r<a;r++)this._updateRenderObject(t[r]);this._needUpdateAllRender=!1}else this.handleMotionlist();this.reflectionProbeManager._needUpdateAllRender?this.reflectionProbeManager.reCaculateAllRenderObjects(e):this.reflectionProbeManager.handleMotionlist(this._motionObjects),this.volumetricGIManager._needUpdateAllRender?this.volumetricGIManager.reCaculateAllRenderObjects(e):this.volumetricGIManager.handleMotionlist(this._motionObjects)}needreCaculateAllRenderObjects(){return this._needUpdateAllRender||this.reflectionProbeManager._needUpdateAllRender||this.volumetricGIManager._needUpdateAllRender}clearMotionObjects(){this._motionObjects.length=0,this._motionObjects.elements.length>100&&(this._motionObjects.elements.length=100),this._motionObjects.elements.fill(null)}destroy(){this._reflectionProbeManager.destroy(),this._volumetricGIManager.destroy()}}O.ReflectionProbeVolumeType=1,O.VolumetricGIType=2,e.AmbientMode=void 0,(M=e.AmbientMode||(e.AmbientMode={}))[M.SolidColor=0]="SolidColor",M[M.SphericalHarmonics=1]="SphericalHarmonics",e.ReflectionProbeMode=void 0,(C=e.ReflectionProbeMode||(e.ReflectionProbeMode={}))[C.off=0]="off",C[C.simple=1]="simple";class b extends L{static getID(){return b.reflectionCount++}static init(){b.SHADERDEFINE_GI_IBL=t.Shader3D.getDefineByName("GI_IBL");let r=b.CommandMap=t.LayaGL.renderDeviceFactory.createGlobalUniformMap(b.BlockName);const a=(e,a,i=0)=>{let n=t.Shader3D.propertyNameToID(e);return i>0?r.addShaderUniformArray(n,e,a,i):r.addShaderUniform(n,e,a),n};b.AMBIENTCOLOR=a("u_AmbientColor",e.ShaderDataType.Vector4),b.AMBIENTSH=a("u_IblSH",e.ShaderDataType.Vector3,9),b.IBLTEX=a("u_IBLTex",e.ShaderDataType.TextureCube),b.IBLROUGHNESSLEVEL=a("u_IBLRoughnessLevel",e.ShaderDataType.Float),b.AMBIENTINTENSITY=a("u_AmbientIntensity",e.ShaderDataType.Float),b.REFLECTIONINTENSITY=a("u_ReflectionIntensity",e.ShaderDataType.Float),b.REFLECTIONCUBE_PROBEPOSITION=a("u_SpecCubeProbePosition",e.ShaderDataType.Vector3),b.REFLECTIONCUBE_PROBEBOXMAX=a("u_SpecCubeBoxMax",e.ShaderDataType.Vector3),b.REFLECTIONCUBE_PROBEBOXMIN=a("u_SpecCubeBoxMin",e.ShaderDataType.Vector3)}constructor(){super(),this._ambientColor=new t.Color,this._isScene=!1,this._importance=0,this._type=O.ReflectionProbeVolumeType,this._dataModule=E.Render3DModuleDataFactory.createReflectionProbe(),this._dataModule.bound=this._bounds,this.ambientIntensity=1,this.reflectionIntensity=1,this.boundsMax=new t.Vector3(5,5,5),this.boundsMin=new t.Vector3(-5,-5,-5),this._reflectionProbeID=b.getID(),this.ambientMode=e.AmbientMode.SolidColor,this._dataModule.updateMark=-1}get shaderData(){return this._dataModule.shaderData}get boxProjection(){return this._dataModule.boxProjection}set boxProjection(e){e!=this._dataModule.boxProjection&&(this._dataModule.updateMark=r.Scene3D._updateMark),this._dataModule.boxProjection=e}get importance(){return this._importance}set importance(e){this._importance=e}get ambientIntensity(){return this._dataModule.ambientIntensity}set ambientIntensity(e){e!=this._dataModule.ambientIntensity&&(this._dataModule.ambientIntensity=e,this._dataModule.updateMark=r.Scene3D._updateMark)}get reflectionIntensity(){return this._dataModule.reflectionIntensity}set reflectionIntensity(e){e!=this._dataModule.reflectionIntensity&&(e=Math.max(e,0),this._dataModule.reflectionIntensity=e,this._dataModule.updateMark=r.Scene3D._updateMark)}_reCaculateBoundBox(){super._reCaculateBoundBox(),this.owner&&this._dataModule.setProbePosition(this.owner.transform.position),this.bounds.cloneTo(this._dataModule.bound)}get bounds(){return this._bounds}get boundsMax(){return this._primitiveBounds.getMax()}set boundsMax(e){super.boundsMax=e,this.boxProjection&&(this._dataModule.updateMark=r.Scene3D._updateMark)}get boundsMin(){return this._primitiveBounds.getMin()}set boundsMin(e){super.boundsMin=e,this.boxProjection&&(this._dataModule.updateMark=r.Scene3D._updateMark)}get probePosition(){return this.owner.transform.position}get ambientColor(){return this._ambientColor}set ambientColor(t){t.cloneTo(this._ambientColor),this._dataModule.setAmbientColor(this._ambientColor),this.ambientMode==e.AmbientMode.SolidColor&&(this._dataModule.updateMark=r.Scene3D._updateMark)}get ambientSH(){return this._ambientSH}set ambientSH(t){this.ambientMode==e.AmbientMode.SphericalHarmonics&&(this._dataModule.updateMark=r.Scene3D._updateMark),this._ambientSH=t,this._dataModule.setAmbientSH(this._ambientSH)}get ambientMode(){return this._dataModule.ambientMode}set ambientMode(e){e!=this.ambientMode&&(this._dataModule.ambientMode=e,this._dataModule.updateMark=r.Scene3D._updateMark)}get iblTex(){return this._iblTex}set iblTex(e){this._iblTex!=e&&(this._iblTex&&this._iblTex._removeReference(),this._iblTex=e,this._dataModule.iblTex=null,e&&(e._addReference(),this._dataModule.iblTex=e._texture),this._dataModule.updateMark=r.Scene3D._updateMark)}get iblTexRGBD(){return this._dataModule.iblTexRGBD}set iblTexRGBD(e){e!=this._dataModule.iblTexRGBD&&(this._dataModule.iblTexRGBD=e,this._dataModule.updateMark=r.Scene3D._updateMark)}_onEnable(){super._onEnable(),this._dataModule.updateMark=r.Scene3D._updateMark}_onDestroy(){this.iblTex=null,this._dataModule.destroy()}}b.BlockName="ReflectionProbe",b.reflectionCount=0,b.defaultTextureHDRDecodeValues=new t.Vector4(1,1,0,0);class V{}e.RenderBitFlag=void 0,(I=e.RenderBitFlag||(e.RenderBitFlag={}))[I.RenderBitFlag_CullFlag=0]="RenderBitFlag_CullFlag",I[I.RenderBitFlag_Batch=1]="RenderBitFlag_Batch",I[I.RenderBitFlag_Editor=2]="RenderBitFlag_Editor",I[I.RenderBitFlag_InstanceBatch=3]="RenderBitFlag_InstanceBatch",I[I.RenderBitFlag_VertexMergeBatch=4]="RenderBitFlag_VertexMergeBatch",e.IrradianceMode=void 0,(v=e.IrradianceMode||(e.IrradianceMode={}))[v.LightMap=0]="LightMap",v[v.VolumetricGI=1]="VolumetricGI",v[v.Common=2]="Common";class U extends t.Component{static __init__(){U.shaderValueInit()}static getMeshDefine(e,r){r.length=0;for(var a=0,i=e._subMeshes.length;a<i;a++)for(var n=e.getSubMesh(a)._vertexBuffer.vertexDeclaration._vertexElements,s=0,o=n.length;s<o;s++){switch(n[s]._elementUsage){case t.VertexMesh.MESH_COLOR0:r.push(D.SHADERDEFINE_COLOR);break;case t.VertexMesh.MESH_TEXTURECOORDINATE0:r.push(D.SHADERDEFINE_UV0);break;case t.VertexMesh.MESH_TEXTURECOORDINATE1:r.push(D.SHADERDEFINE_UV1);break;case t.VertexMesh.MESH_TANGENT0:r.push(D.SHADERDEFINE_TANGENT)}}}static changeVertexDefine(e,t,r){var a=e;if(a){U.getMeshDefine(a,U._meshVerticeDefine);for(var i=0,n=U._meshVerticeDefine.length;i<n;i++)r.removeDefine(U._meshVerticeDefine[i])}if(t){U.getMeshDefine(t,U._meshVerticeDefine);for(i=0,n=U._meshVerticeDefine.length;i<n;i++)r.addDefine(U._meshVerticeDefine[i])}}static shaderValueInit(){V.SHADERDEFINE_GI_LEGACYIBL=t.Shader3D.getDefineByName("GI_LEGACYIBL"),V.SHADERDEFINE_IBL_RGBD=t.Shader3D.getDefineByName("IBL_RGBD"),V.SHADERDEFINE_SPECCUBE_BOX_PROJECTION=t.Shader3D.getDefineByName("SPECCUBE_BOX_PROJECTION")}get enabled(){return super.enabled}set enabled(e){super.enabled=e,this._baseRenderNode.enable=e}get sortingFudge(){return this._baseRenderNode.sortingFudge}set sortingFudge(e){this._baseRenderNode.sortingFudge=e}get renderbitFlag(){return this._baseRenderNode.renderbitFlag}get boundsChange(){return this._baseRenderNode.boundsChange}set boundsChange(e){this._baseRenderNode.boundsChange=e}get renderNode(){return this._baseRenderNode}get distanceForSort(){return this._baseRenderNode.distanceForSort}set distanceForSort(e){this._baseRenderNode.distanceForSort=e}get geometryBounds(){return this._baseRenderNode.baseGeometryBounds}set geometryBounds(e){this._baseRenderNode.baseGeometryBounds=e}get lightmapIndex(){return this._baseRenderNode.lightmapIndex}set lightmapIndex(e){this._baseRenderNode.lightmapIndex=e}setLightmapIndex(e){let t=this._scene;-1!=e&&t.lightmaps[e]?this._baseRenderNode.lightmap=t.lightmaps[e]._dataModule:this._baseRenderNode.lightmap=null,this._getIrradientMode()}get irradientMode(){return this._baseRenderNode.irradientMode}get lightmapScaleOffset(){return this._lightmapScaleOffset}set lightmapScaleOffset(e){e.cloneTo(this._lightmapScaleOffset),this._baseRenderNode.setLightmapScaleOffset(this._lightmapScaleOffset)}get sharedMaterial(){return this._sharedMaterials[0]}set sharedMaterial(e){var t=this._sharedMaterials[0];this._changeMaterialReference(t,e),this._sharedMaterials[0]=e;let r=this._renderElements[0];r&&r.material!=e&&(this._materialsInstance[0]=!1,r.material=e),this._isSupportRenderFeature()}get sharedMaterials(){return this._sharedMaterials.slice()}set sharedMaterials(e){var t=this._materialsInstance,r=this._sharedMaterials;if(e){let a=e.length;for(let i=0;i<a;i++){let a=e[i],n=r[i];this._changeMaterialReference(n,a),r[i]=a;let s=this._renderElements[i];s&&s.material!=a&&(t[i]=!1,s.material=a)}for(let e=a,t=r.length;e<t;e++){let t=r[e];t&&t._removeReference();let a=this._renderElements[e];a&&(a.material=null)}t.length=a,r.length=a}else{for(let e=0,t=r.length;e<t;e++){let t=r[e];t&&t._removeReference()}this._sharedMaterials=[]}this._isSupportRenderFeature()}get bounds(){return this._baseRenderNode.bounds}get receiveShadow(){return this._receiveShadow}set receiveShadow(e){this._receiveShadow!==e&&(this._receiveShadow=e,e?this._baseRenderNode.shaderData.addDefine(B.SHADERDEFINE_RECEIVE_SHADOW):this._baseRenderNode.shaderData.removeDefine(B.SHADERDEFINE_RECEIVE_SHADOW)),this._baseRenderNode.receiveShadow=e}get castShadow(){return this._baseRenderNode.castShadow}set castShadow(e){this._baseRenderNode.castShadow=e}get reflectionMode(){return this._baseRenderNode.reflectionMode}set reflectionMode(e){this._baseRenderNode.reflectionMode=e}get volume(){return this._volume}set volume(e){if(e)return this._volume!=e?(e._addRenderNode&&e._addRenderNode(this),void(this._volume=e)):void(e._motionInVolume&&e._motionInVolume(this));this._volume&&(this._volume._removeRenderNode&&this._volume._removeRenderNode(this),this._volume=null)}get probReflection(){return this._probReflection}set probReflection(e){if(this._probReflection==e)return;this._probReflection=e;const t=b.BlockName;e?(this._baseRenderNode.probeReflection=e._dataModule,this._baseRenderNode.additionShaderData.set(t,e.shaderData)):(this._baseRenderNode.probeReflection=null,this._baseRenderNode.additionShaderData.delete(t)),this._baseRenderNode.additionShaderData=this._baseRenderNode.additionShaderData,this._getIrradientMode()}get lightProbe(){return this._lightProb}set lightProbe(e){if(this._lightProb==e)return;this._baseRenderNode.lightProbUpdateMark=-1,this._lightProb=e;const t=P.BlockName;e?(this._baseRenderNode.volumetricGI=e._dataModule,this._baseRenderNode.additionShaderData.set(t,e.shaderData)):(this._baseRenderNode.volumetricGI=null,this._baseRenderNode.additionShaderData.delete(t)),this._baseRenderNode.additionShaderData=this._baseRenderNode.additionShaderData,this._getIrradientMode()}setNodeCustomData(e,t){this.renderNode.setNodeCustomData(e,t)}constructor(){super(),this._sharedMaterials=[],this._sceneUpdateMark=-1,this._updateMark=-1,this._surportReflectionProbe=!1,this._surportVolumetricGI=!1,this._motionIndexList=-1,this._LOD=-1,this._lightmapScaleOffset=new t.Vector4,this._renderElements=[],this._baseRenderNode=this._createBaseRenderNode(),this._baseRenderNode.setCommonUniformMap(this._getcommonUniformMap()),this._baseRenderNode.shaderData=t.LayaGL.renderDeviceFactory.createShaderData(null),this._renderid=++U._uniqueIDCounter,this._baseRenderNode.bounds=this._bounds=new w(t.Vector3.ZERO,t.Vector3.ZERO),this._enabled=!0,this._baseRenderNode.enable=!0,this._materialsInstance=[],this.lightmapIndex=-1,this.receiveShadow=!1,this._baseRenderNode.sortingFudge=0,this.reflectionMode=e.ReflectionProbeMode.simple,this._calculateBoundingBox&&this._baseRenderNode.set_caculateBoundingBox(this,this._calculateBoundingBox),this._renderUpdate&&this._baseRenderNode.set_renderUpdatePreCall(this,this._renderUpdate),this.runInEditor=!0,this._asynNative=!0,this.boundsChange=!0,this._baseRenderNode.renderbitFlag=0,this._baseRenderNode.staticMask=1,this.castShadow=!1,this._baseRenderNode.renderNodeType=0}_setRenderElements(){var e,t,r;let a=[];0==this._renderElements.length&&this._inRenderList&&(null===(e=this.owner)||void 0===e||e.scene._removeRenderObject(this)),(null===(t=this.owner)||void 0===t?void 0:t.activeInHierarchy)&&this.enabled&&(null===(r=this.owner)||void 0===r?void 0:r.scene)&&this._renderElements.length>0&&!this._inRenderList&&this.owner.scene._addRenderObject(this),this._renderElements.forEach((e=>{a.push(e._renderElementOBJ)})),this._baseRenderNode.setRenderelements(a)}_onWorldMatNeedChange(e){this.boundsChange=!0,this._addReflectionProbeUpdate(),this._batchRender&&this._batchRender._updateOneRender(this)}_getcommonUniformMap(){return["Sprite3D"]}_createBaseRenderNode(){return E.Render3DModuleDataFactory.createBaseRenderNode()}renderUpdate(e){}_onAdded(){this._transform=this.owner.transform,this.owner._isRenderNode++,this.setRenderbitFlag(e.RenderBitFlag.RenderBitFlag_Editor,this.owner._getBit(t.NodeFlags.HIDE_BY_EDITOR)),this._baseRenderNode.transform=this._transform,this._changeLayer(this.owner.layer),this._changeStaticMask(this.owner._isStatic)}_onEnable(){super._onEnable(),this.owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this.owner.on(t.Event.LAYER_CHANGE,this,this._changeLayer),this.owner.on(t.Event.STATIC_MASK,this,this._changeStaticMask),this._changeLayer(this.owner.layer),this._changeStaticMask(this.owner._isStatic),this.owner.scene._addRenderObject(this),this._setBelongScene(this.owner.scene)}_onDisable(){this.owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this.owner.off(t.Event.LAYER_CHANGE,this,this._changeLayer),this.owner.off(t.Event.STATIC_MASK,this,this._changeStaticMask),this.owner.scene._removeRenderObject(this),this._setUnBelongScene(),this.volume=null}_onDestroy(){this.owner&&this.owner._isRenderNode--,-1!==this._motionIndexList&&this._scene._sceneRenderManager.removeMotionObject(this),this._scene&&this._scene.sceneRenderableManager.removeRenderObject(this),this._baseRenderNode.destroy();for(let e=0,t=this._sharedMaterials.length;e<t;e++){let t=this._sharedMaterials[e];t&&!t.destroyed&&t._removeReference()}this._sharedMaterials=null,this._bounds=null,this._lightmapScaleOffset=null,this._scene=null,this._transform=null,this._batchRender=null}_getIrradientMode(){this.lightmapIndex>=0?this._baseRenderNode.irradientMode=e.IrradianceMode.LightMap:this.lightProbe?this._baseRenderNode.irradientMode=e.IrradianceMode.VolumetricGI:this._baseRenderNode.irradientMode=e.IrradianceMode.Common}_changeLayer(e){this._baseRenderNode.layer=e}_changeStaticMask(e){this._baseRenderNode.staticMask=e}_changeMaterialReference(e,t){e&&e._removeReference(),t&&t._addReference()}_getInstanceMaterial(e,t){var r=e.clone();return r.name=r.name+"(Instance)",this._materialsInstance[t]=!0,this._changeMaterialReference(this._sharedMaterials[t],r),this._sharedMaterials[t]=r,r}_isSupportRenderFeature(){let e=this._surportReflectionProbe,t=this._surportVolumetricGI;this._surportReflectionProbe=!1,this._surportVolumetricGI=!1;for(var r=this._sharedMaterials,a=0,i=r.length;a<i;a++){var n=r[a];this._surportReflectionProbe||(this._surportReflectionProbe=this._surportReflectionProbe||n&&n._shader._supportReflectionProbe),this._surportVolumetricGI||(this._surportVolumetricGI=this._surportVolumetricGI||n&&n._shader._surportVolumetricGI)}(!e&&this._surportReflectionProbe||!t&&this._surportVolumetricGI)&&this._addReflectionProbeUpdate()}_addReflectionProbeUpdate(){this._scene&&this._scene._volumeManager.addMotionObject(this)}_setBelongScene(e){this._scene=e,this._onWorldMatNeedChange(1),this._isSupportRenderFeature(),this._batchRender&&this._batchRender._batchOneRender(this),this.setLightmapIndex(this.lightmapIndex),this._statAdd()}_statAdd(){t.Stat.renderNode++}_statRemove(){t.Stat.renderNode--}_setUnBelongScene(){this._statRemove(),this._scene._volumeManager.removeMotionObject(this);let e=this._batchRender;this._batchRender&&this._batchRender._removeOneRender(this),this._batchRender=e,this._scene=null}_needRender(e,t){return!e||e.intersects(this.bounds)}_cloneTo(e){super._cloneTo(e),e.receiveShadow=this.receiveShadow,e.sharedMaterials=this.sharedMaterials,e.reflectionMode=this.reflectionMode,e.castShadow=this.castShadow,e.sortingFudge=this.sortingFudge}setRenderbitFlag(e,t){t?this._baseRenderNode.renderbitFlag|=1<<e:this._baseRenderNode.renderbitFlag&=~(1<<e)}get material(){var e=this._sharedMaterials[0];if(e&&!this._materialsInstance[0]){var t=this._getInstanceMaterial(e,0),r=this._renderElements[0];r&&(r.material=t)}return this._sharedMaterials[0]}set material(e){this.sharedMaterial=e,this._isSupportRenderFeature()}get materials(){for(var e=0,t=this._sharedMaterials.length;e<t;e++)if(!this._materialsInstance[e]){var r=this._getInstanceMaterial(this._sharedMaterials[e],e),a=this._renderElements[e];a&&(a.material=r)}return this._sharedMaterials.slice()}set materials(e){this.sharedMaterials=e,this._isSupportRenderFeature()}}U._meshVerticeDefine=[],U._uniqueIDCounter=0,U._tempBoundBoxCorners=[new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3],U._defaultLightmapScaleOffset=new t.Vector4(1,1,0,0);class H{get transform(){return this._renderElementOBJ.transform}set transform(e){this._transform=e,this._renderElementOBJ.transform=e}get material(){return this._material}set material(e){this._material&&this._material._removeOwnerElement(this._renderElementOBJ),e?(this._material=e,this.material._setOwner3DElement(this._renderElementOBJ)):(this._material=null,this._renderElementOBJ.materialShaderData=null,this._renderElementOBJ.materialRenderQueue=0,this._renderElementOBJ.subShader=this._subShader=null,this._renderElementOBJ.materialId=-1)}get renderSubShader(){return this._subShader}set renderSubShader(e){this._subShader=e,this._renderElementOBJ.subShader=e}get subShaderIndex(){return this._subShaderIndex}set subShaderIndex(e){this._subShaderIndex=e}get render(){return this._baseRender}set render(e){this._baseRender=e,this._renderElementOBJ.renderShaderData=e._baseRenderNode.shaderData}constructor(){this._subShaderIndex=0,this._createRenderElementOBJ()}_createRenderElementOBJ(){this._renderElementOBJ=E.Render3DPassFactory.createRenderElement3D()}setTransform(e){this.transform=e,this._renderElementOBJ.transform=e}setGeometry(e){this._geometry=e,this._renderElementOBJ.geometry=e._geometryElementOBj}destroy(){this.material=null,this._renderElementOBJ=null,this._geometry=null,this._baseRender=null,this._baseRender=null,this._subShader=null}}class G extends H{constructor(){super(),this._dynamicWorldPositionNormalNeedUpdate=!0,this._renderElementOBJ.canDynamicBatch=!0}_onWorldMatrixChanged(){this._dynamicWorldPositionNormalNeedUpdate=!0}setTransform(e){this.transform!==e&&(this.transform&&this.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),e&&e.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),this._dynamicWorldPositionNormalNeedUpdate=!0,this.transform=e)}setGeometry(e){this._geometry!==e&&(this._geometry=e,this._renderElementOBJ.geometry=e._geometryElementOBj)}destroy(){this._renderElementOBJ&&(this.transform&&this.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),super.destroy(),this.instanceSubMesh=null,this.staticBatchElementList&&this.staticBatchElementList.destroy(),this.instanceBatchElementList&&this.instanceBatchElementList.destroy(),this.vertexBatchElementList&&this.vertexBatchElementList.destroy(),this.vertexBatchVertexDeclaration=null)}}class k extends U{static __init__(){D.SHADERDEFINE_UV0=t.Shader3D.getDefineByName("UV"),D.SHADERDEFINE_COLOR=t.Shader3D.getDefineByName("COLOR"),D.SHADERDEFINE_UV1=t.Shader3D.getDefineByName("UV1"),D.SHADERDEFINE_TANGENT=t.Shader3D.getDefineByName("TANGENT"),D.SHADERDEFINE_GPU_INSTANCE=t.Shader3D.getDefineByName("GPU_INSTANCE")}constructor(){super(),this._revertStaticBatchDefineUV1=!1,this.morphTargetActiveCount=0,this._morphWeightChange=!0,this._morphTargetValues={},this._meshChange=!1,this._projectionViewWorldMatrix=new t.Matrix4x4,this._baseRenderNode.renderNodeType=e.BaseRenderType.MeshRender}_createBaseRenderNode(){return E.Render3DModuleDataFactory.createMeshRenderNode()}_createRenderElement(){return new G}getMesh(){return this._mesh}_onEnable(){super._onEnable();const e=this.owner.getComponent(A);e&&e._enabled&&this._onMeshChange(e.sharedMesh)}_getMeshDefine(e,t){t.length=0,T.getMeshDefine(e,t)}_changeVertexDefine(e){var t=this._baseRenderNode.shaderData,r=this._mesh;if(r){this._getMeshDefine(r,A._meshVerticeDefine);for(var a=0,i=A._meshVerticeDefine.length;a<i;a++)t.removeDefine(A._meshVerticeDefine[a])}if(e){this._getMeshDefine(e,A._meshVerticeDefine);for(a=0,i=A._meshVerticeDefine.length;a<i;a++)t.addDefine(A._meshVerticeDefine[a])}}get morphTargetValues(){return this._morphTargetValues}set morphTargetValues(e){this._morphTargetValues=e}_changeMorphTargetValue(e){this._morphWeightChange=!0}setMorphChannelWeight(e,t){let r=this._mesh;if(r&&r.morphTargetData){let a=r.morphTargetData.getMorphChannel(e);this.morphTargetValues[a.name]=t,this._morphWeightChange=!0}}_applyMorphdata(){let e=this._mesh,r=this._baseRenderNode.shaderData;if(this._morphWeightChange&&e){let a=e.morphTargetData,i=a.channelCount;for(let e=0;e<i;e++){let t=a.getMorphChannelbyIndex(e),r=this.morphTargetValues[t.name],i=0;t.targets.forEach((e=>{r<=e.fullWeight?this.morphTargetWeight[e._index]=(r-i)/(e.fullWeight-i):this.morphTargetWeight[e._index]=1,i=e.fullWeight}))}let n=0;this.morphTargetWeight.forEach(((e,t)=>{if(e>0){let r=4*n;this.morphTargetActiveData[r]=t,this.morphTargetActiveData[r+1]=e,n++}})),this.morphTargetActiveCount=Math.min(n,t.Config3D.maxMorphTargetCount),t.LayaGL.renderEngine.getCapable(t.RenderCapable.Texture3D)&&(r.setInt(B.MorphActiveCount,this.morphTargetActiveCount),r.setBuffer(B.MorphActiceTargets,this.morphTargetActiveData)),this._morphWeightChange=!1}}_setBelongScene(e){super._setBelongScene(e)}_setUnBelongScene(){super._setUnBelongScene()}_statAdd(){t.Stat.renderNode++,t.Stat.meshRenderNode++}_statRemove(){t.Stat.renderNode--,t.Stat.meshRenderNode--}_changeMorphData(e){let r=this._baseRenderNode.shaderData,a=this._mesh;let i=t.Config3D.maxMorphTargetCount;if(this.morphTargetActiveData=new Float32Array(4*i),t.LayaGL.renderEngine.getCapable(t.RenderCapable.Texture3D)){if(a&&a.morphTargetData){let e=a.morphTargetData;r.removeDefine(B.SHADERDEFINE_MORPHTARGET),e.vertexDec._vertexElements.forEach((e=>{switch(e.elementUsage){case t.VertexMesh.MESH_POSITION0:r.removeDefine(B.SHADERDEFINE_MORPHTARGET_POSITION);break;case t.VertexMesh.MESH_NORMAL0:r.removeDefine(B.SHADERDEFINE_MORPHTARGET_NORMAL);break;case t.VertexMesh.MESH_TANGENT0:r.removeDefine(B.SHADERDEFINE_MORPHTARGET_TANGENT)}}))}if(e&&e.morphTargetData){let a=e.morphTargetData;r.addDefine(B.SHADERDEFINE_MORPHTARGET),a.vertexDec._vertexElements.forEach((e=>{switch(e.elementUsage){case t.VertexMesh.MESH_POSITION0:r.addDefine(B.SHADERDEFINE_MORPHTARGET_POSITION);break;case t.VertexMesh.MESH_NORMAL0:r.addDefine(B.SHADERDEFINE_MORPHTARGET_NORMAL);break;case t.VertexMesh.MESH_TANGENT0:r.addDefine(B.SHADERDEFINE_MORPHTARGET_TANGENT)}})),r.setVector(B.MorphAttriOffset,e.morphTargetData.attributeOffset),r.setTexture(B.MorphTex,e.morphTargetData.targetTexture),r.setVector(B.MorphParams,a.params),r.setBuffer(B.MorphActiceTargets,this.morphTargetActiveData)}}if(a&&a.morphTargetData&&(this.morphTargetWeight=null,this.morphtargetChannels=null,this._morphTargetValues={}),e&&e.morphTargetData){let t=e.morphTargetData,r=t.channelCount;this.morphTargetWeight=new Float32Array(t.targetCount),this.morphtargetChannels=new Array(r);for(let e=0;e<r;e++){let r=t.getMorphChannelbyIndex(e);this.morphtargetChannels[e]=r,this._morphTargetValues[r.name]=0}}}_onMeshChange(e){if(e&&this._mesh!=e){this._changeVertexDefine(e),this._changeMorphData(e),this._mesh=e,e.morphTargetData?this.geometryBounds=e.morphTargetData.bounds:this.geometryBounds=e.bounds;var t=e.subMeshCount;this._renderElements.length=t;let n=this.sharedMaterials;n.length=t;for(var r=0;r<t;r++){var a=this._renderElements[r];a||(a=this._renderElements[r]=this._renderElements[r]?this._renderElements[r]:this._createRenderElement(),this.owner&&a.setTransform(this.owner._transform),a.render=this),n[r]=n[r]||i.defaultMaterial,a.setGeometry(e.getSubMesh(r))}this.sharedMaterials=n,this.boundsChange=!0}else e||(this._renderElements.forEach,this._renderElements.forEach((e=>{e._renderElementOBJ.destroy(),e.destroy()})),this._renderElements.length=0,this._mesh=null,this._changeVertexDefine(null),this._changeMorphData(null),this.boundsChange=!1);this._setRenderElements(),this._meshChange=!0}_onWorldMatNeedChange(e){super._onWorldMatNeedChange(e),this._mesh||(this.boundsChange=!1)}renderUpdate(e){if(this._mesh&&(this._mesh.morphTargetData&&this._applyMorphdata(),this._meshChange)){if(1==this._renderElements.length){this._renderElements[0]._renderElementOBJ.isRender=this._renderElements[0]._geometry._prepareRender(e),this._renderElements[0]._geometry._updateRenderParams(e);let t=this.sharedMaterial;this._renderElements[0].material=t}else for(var t=0,r=this._renderElements.length;t<r;t++){this._renderElements[t]._renderElementOBJ.isRender=this._renderElements[t]._geometry._prepareRender(e),this._renderElements[t]._geometry._updateRenderParams(e);let r=this.sharedMaterials[t];this._renderElements[t].material=r}this._meshChange=!1}}_onDestroy(){super._onDestroy(),this._morphTargetValues=null}_cloneTo(e){super._cloneTo(e),e._onMeshChange(this._mesh),this.morphTargetWeight&&(e.morphTargetWeight=new Float32Array(this.morphTargetWeight));for(const t in this._morphTargetValues)e._morphTargetValues[t]=this._morphTargetValues[t]}}class z extends B{get meshFilter(){return this._meshFilter}get meshRenderer(){return this._render}constructor(e=null,t=null){super(t),this._meshFilter=this.addComponent(A),this._render=this.addComponent(k),e&&(this._meshFilter.sharedMesh=e)}}class W{static get vertexDeclaration(){return W._vertexDeclaration}static __init__(){W._vertexDeclaration=new t.VertexDeclaration(40,[new t.VertexElement(0,t.VertexElementFormat.Vector3,t.VertexMesh.MESH_POSITION0),new t.VertexElement(12,t.VertexElementFormat.Vector4,t.VertexMesh.MESH_COLOR0),new t.VertexElement(28,t.VertexElementFormat.Vector3,t.VertexMesh.MESH_NORMAL0)])}get vertexDeclaration(){return W._vertexDeclaration}constructor(){}}class Q{static __init__(){Q._screenShader=t.Shader3D.find("BlitScreen"),Q.SCREENTEXTURE_ID=t.Shader3D.propertyNameToID(Q.SCREENTEXTURE_NAME),Q.SCREENTEXTUREOFFSETSCALE_ID=t.Shader3D.propertyNameToID(Q.SCREENTEXTUREOFFSETSCALE_NAME),Q.MAINTEXTURE_TEXELSIZE_ID=t.Shader3D.propertyNameToID(Q.MAINTEXTURE_TEXELSIZE_NAME)}constructor(){this._commandBuffer=null}recover(){this._commandBuffer=null}destroy(){this._commandBuffer=null,this._context=null}}Q.SCREENTEXTURE_NAME="u_MainTex",Q.SCREENTEXTUREOFFSETSCALE_NAME="u_OffsetScale",Q.MAINTEXTURE_TEXELSIZE_NAME="u_MainTex_TexelSize";class Y{static __init__(){Y._instance=new Y,this.GammaCorrect=t.Shader3D.getDefineByName("GAMMACORRECT")}get camera(){return this._camera}set camera(e){this._camera=e,this._contextOBJ.cameraModuleData=e?e._renderDataModule:null}set destTarget(e){this._contextOBJ.setRenderTarget(e?e._renderTarget:null,t.RenderClearFlag.Nothing)}set viewport(e){this._contextOBJ.setViewPort(e)}set scissor(e){this._contextOBJ.setScissor(e)}get invertY(){return this._contextOBJ.invertY}set invertY(e){this._contextOBJ.invertY=e}get pipelineMode(){return this._contextOBJ.pipelineMode}set pipelineMode(e){this._contextOBJ.pipelineMode=e}get cameraShaderValue(){return this._contextOBJ.cameraData}set cameraShaderValue(e){this._contextOBJ.cameraData=e}get scene(){return this._scene}set scene(e){e?(this._contextOBJ.sceneData=e._shaderValues,this._scene=e,this._contextOBJ.sceneModuleData=e._sceneModuleData):(this._contextOBJ.sceneModuleData=null,this._contextOBJ.sceneData=null,this._scene=null)}changeViewport(e,r,a,i){t.Viewport.TEMP.set(e,r,a,i),this.viewport=t.Viewport.TEMP}changeScissor(e,r,a,i){t.Vector4.TEMP.setValue(e,r,a,i),this.scissor=t.Vector4.TEMP}applyContext(e){this._contextOBJ.cameraUpdateMask=e}drawRenderElement(e){this._contextOBJ.drawRenderElementOne(e)}constructor(){this.configPipeLineMode="Forward",this._contextOBJ=E.Render3DPassFactory.createRenderContext3D()}}class X{constructor(){}static lightAttenTexture(e,t,r,a,i,n){var s=e/r,o=1/(1+25*s);s>=.64&&(s>1?o=0:o*=1-(s-.64)/.36),n[i]=Math.floor(255*o+.5)}static haloTexture(e,t,r,a,i,n){var s=(e-(r>>=1))/r,o=(t-(a>>=1))/a,l=s*s+o*o;l>1&&(l=1),n[i]=Math.floor(255*(1-l)+.5)}static _generateTexture2D(e,r,a,i){var n=0,s=0;switch(e.format){case t.TextureFormat.R8G8B8:s=3;break;case t.TextureFormat.R8G8B8A8:s=4;break;case t.TextureFormat.Alpha8:s=1;break;default:throw"GeneratedTexture._generateTexture: unkonw texture format."}for(var o=new Uint8Array(r*a*s),l=0;l<a;l++)for(var h=0;h<r;h++)i(h,l,r,a,n,o),n+=s;e.setPixelsData(o,!1,!1)}}class K{static _createFloatTextureBuffer(e,r){var a=new t.Texture2D(e,r,t.TextureFormat.R32G32B32A32,!1,!1);return a.setPixelsData(null,!1,!1),a.filterMode=t.FilterMode.Point,a.wrapModeU=t.WrapMode.Clamp,a.wrapModeV=t.WrapMode.Clamp,a.anisoLevel=1,a}static _rotationTransformScaleSkinAnimation(e,t,r,a,i,n,s,o,l,h,d,c){var u,_,f,g,m,p=$,S=ee,E=te,D=a+a,T=i+i,A=n+n,x=a*D,R=i*D,M=i*T,C=n*D,I=n*T,v=n*A,y=s*D,B=s*T,w=s*A;for(p[15]=1,p[0]=1-M-v,p[1]=R+w,p[2]=C-B,p[4]=R-w,p[5]=1-x-v,p[6]=I+y,p[8]=C+B,p[9]=I-y,p[10]=1-x-M,S[15]=1,S[0]=o,S[5]=l,S[10]=h,u=0;u<4;u++)_=p[u],f=p[u+4],g=p[u+8],m=p[u+12],E[u]=_,E[u+4]=f,E[u+8]=g,E[u+12]=_*e+f*t+g*r+m;for(u=0;u<4;u++)_=E[u],f=E[u+4],g=E[u+8],m=E[u+12],d[u+c]=_*S[0]+f*S[1]+g*S[2]+m*S[3],d[u+c+4]=_*S[4]+f*S[5]+g*S[6]+m*S[7],d[u+c+8]=_*S[8]+f*S[9]+g*S[10]+m*S[11],d[u+c+12]=_*S[12]+f*S[13]+g*S[14]+m*S[15]}static billboardTrans(e,r,a,i){t.Vector3.normalize(a,q),t.Vector3.cross(r,a,j),t.Vector3.normalize(j,j),t.Vector3.scale(j,e.x,i),t.Vector3.scale(a,e.y,q),t.Vector3.add(i,q,i)}static PointinTriangle(e,t,r,a){let i=r.vsub(e,j),n=t.vsub(e,q),s=a.vsub(e,Z),o=i.dot(i),l=i.dot(n),h=i.dot(s),d=n.dot(n),c=n.dot(s),u=1/(o*d-l*l),_=(d*h-l*c)*u;if(_<0||_>1)return!1;let f=(o*c-l*h)*u;return!(f<0||f>1)&&_+f<=1}static _computeBoneAndAnimationDatasByBindPoseMatrxix(e,t,r,a,i,n){var s,o,l=0,h=0,d=e.length;for(s=0;s<d;l+=e[s].keyframeWidth,h+=16,s++)K._rotationTransformScaleSkinAnimation(t[l+0],t[l+1],t[l+2],t[l+3],t[l+4],t[l+5],t[l+6],t[l+7],t[l+8],t[l+9],a,h),0!=s&&(o=16*e[s].parentIndex,K.mulMatrixByArray(a,o,a,h,a,h));var c=r.length;for(s=0;s<c;s++)K.mulMatrixByArrayAndMatrixFast(a,16*n[s],r[s],i,16*s)}static _computeAnimationDatasByArrayAndMatrixFast(e,t,r,a){for(var i=0,n=e.length;i<n;i++)K.mulMatrixByArrayAndMatrixFast(t,16*a[i],e[i],r,16*i)}static _computeBoneAndAnimationDatasByBindPoseMatrxixOld(e,t,r,a,i){var n,s,o=0,l=0,h=e.length;for(n=0;n<h;o+=e[n].keyframeWidth,l+=16,n++)K._rotationTransformScaleSkinAnimation(t[o+7],t[o+8],t[o+9],t[o+3],t[o+4],t[o+5],t[o+6],t[o+0],t[o+1],t[o+2],a,l),0!=n&&(s=16*e[n].parentIndex,K.mulMatrixByArray(a,s,a,l,a,l));var d=r.length;for(n=0;n<d;n++){var c=16*n;K.mulMatrixByArrayAndMatrixFast(a,c,r[n],i,c)}}static _computeAnimationDatasByArrayAndMatrixFastOld(e,t,r){for(var a=e.length,i=0;i<a;i++){var n=16*i;K.mulMatrixByArrayAndMatrixFast(t,n,e[i],r,n)}}static _computeRootAnimationData(e,t,r){for(var a=0,i=0,n=0,s=e.length;a<s;i+=e[a].keyframeWidth,n+=16,a++)K.createAffineTransformationArray(t[i+0],t[i+1],t[i+2],t[i+3],t[i+4],t[i+5],t[i+6],t[i+7],t[i+8],t[i+9],r,n)}static transformVector3ArrayByQuat(e,t,r,a,i){var n=e[t],s=e[t+1],o=e[t+2],l=r.x,h=r.y,d=r.z,c=r.w,u=c*n+h*o-d*s,_=c*s+d*n-l*o,f=c*o+l*s-h*n,g=-l*n-h*s-d*o;a[i]=u*c+g*-l+_*-d-f*-h,a[i+1]=_*c+g*-h+f*-l-u*-d,a[i+2]=f*c+g*-d+u*-h-_*-l}static mulMatrixByArray(e,t,r,a,i,n){var s,o,l,h,d;if(i===r){for(r=re,s=0;s<16;++s)r[s]=i[n+s];a=0}for(s=0;s<4;s++)o=e[t+s],l=e[t+s+4],h=e[t+s+8],d=e[t+s+12],i[n+s]=o*r[a+0]+l*r[a+1]+h*r[a+2]+d*r[a+3],i[n+s+4]=o*r[a+4]+l*r[a+5]+h*r[a+6]+d*r[a+7],i[n+s+8]=o*r[a+8]+l*r[a+9]+h*r[a+10]+d*r[a+11],i[n+s+12]=o*r[a+12]+l*r[a+13]+h*r[a+14]+d*r[a+15]}static mulMatrixByArrayFast(e,t,r,a,i,n){var s,o,l,h,d;for(s=0;s<4;s++)o=e[t+s],l=e[t+s+4],h=e[t+s+8],d=e[t+s+12],i[n+s]=o*r[a+0]+l*r[a+1]+h*r[a+2]+d*r[a+3],i[n+s+4]=o*r[a+4]+l*r[a+5]+h*r[a+6]+d*r[a+7],i[n+s+8]=o*r[a+8]+l*r[a+9]+h*r[a+10]+d*r[a+11],i[n+s+12]=o*r[a+12]+l*r[a+13]+h*r[a+14]+d*r[a+15]}static mulMatrixByArrayAndMatrixFast(e,t,r,a,i){var n,s,o,l,h,d=r.elements,c=d[0],u=d[1],_=d[2],f=d[3],g=d[4],m=d[5],p=d[6],S=d[7],E=d[8],D=d[9],T=d[10],A=d[11],x=d[12],R=d[13],M=d[14],C=d[15],I=t,v=t+4,y=t+8,B=t+12,w=i,L=i+4,N=i+8,P=i+12;for(n=0;n<4;n++)s=e[I+n],o=e[v+n],l=e[y+n],h=e[B+n],a[w+n]=s*c+o*u+l*_+h*f,a[L+n]=s*g+o*m+l*p+h*S,a[N+n]=s*E+o*D+l*T+h*A,a[P+n]=s*x+o*R+l*M+h*C}static createAffineTransformationArray(e,t,r,a,i,n,s,o,l,h,d,c){var u=a+a,_=i+i,f=n+n,g=a*u,m=a*_,p=a*f,S=i*_,E=i*f,D=n*f,T=s*u,A=s*_,x=s*f;d[c+0]=(1-(S+D))*o,d[c+1]=(m+x)*o,d[c+2]=(p-A)*o,d[c+3]=0,d[c+4]=(m-x)*l,d[c+5]=(1-(g+D))*l,d[c+6]=(E+T)*l,d[c+7]=0,d[c+8]=(p+A)*h,d[c+9]=(E-T)*h,d[c+10]=(1-(g+S))*h,d[c+11]=0,d[c+12]=e,d[c+13]=t,d[c+14]=r,d[c+15]=1}static transformVector3ArrayToVector3ArrayCoordinate(e,t,r,a,i){var n=e[t+0],s=e[t+1],o=e[t+2],l=r.elements,h=n*l[3]+s*l[7]+o*l[11]+l[15];a[i]=n*l[0]+s*l[4]+o*l[8]+l[12]/h,a[i+1]=n*l[1]+s*l[5]+o*l[9]+l[13]/h,a[i+2]=n*l[2]+s*l[6]+o*l[10]+l[14]/h}static transformVector3ArrayToVector3ArrayNormal(e,t,r,a,i){var n=e[t+0],s=e[t+1],o=e[t+2],l=r.elements;a[i]=n*l[0]+s*l[4]+o*l[8],a[i+1]=n*l[1]+s*l[5]+o*l[9],a[i+2]=n*l[2]+s*l[6]+o*l[10]}static transformLightingMapTexcoordArray(e,t,r,a,i){a[i+0]=e[t+0]*r.x+r.z,a[i+1]=1-((1-e[t+1])*r.y+r.w)}static getURLVerion(e){var t=e.indexOf("?");return t>=0?e.substr(t):null}static _createAffineTransformationArray(e,t,r,a){var i=t.x,n=t.y,s=t.z,o=t.w,l=i+i,h=n+n,d=s+s,c=i*l,u=i*h,_=i*d,f=n*h,g=n*d,m=s*d,p=o*l,S=o*h,E=o*d,D=r.x,T=r.y,A=r.z;a[0]=(1-(f+m))*D,a[1]=(u+E)*D,a[2]=(_-S)*D,a[3]=0,a[4]=(u-E)*T,a[5]=(1-(c+m))*T,a[6]=(g+p)*T,a[7]=0,a[8]=(_+S)*A,a[9]=(g-p)*A,a[10]=(1-(c+f))*A,a[11]=0,a[12]=e.x,a[13]=e.y,a[14]=e.z,a[15]=1}static _mulMatrixArray(e,t,r,a,i){var n=t,s=e,o=a,l=n[r],h=n[r+1],d=n[r+2],c=n[r+3],u=n[r+4],_=n[r+5],f=n[r+6],g=n[r+7],m=n[r+8],p=n[r+9],S=n[r+10],E=n[r+11],D=n[r+12],T=n[r+13],A=n[r+14],x=n[r+15],R=s[0],M=s[1],C=s[2],I=s[3],v=s[4],y=s[5],B=s[6],w=s[7],L=s[8],N=s[9],P=s[10],F=s[11],O=s[12],b=s[13],V=s[14],U=s[15];o[i]=l*R+h*v+d*L+c*O,o[i+1]=l*M+h*y+d*N+c*b,o[i+2]=l*C+h*B+d*P+c*V,o[i+3]=l*I+h*w+d*F+c*U,o[i+4]=u*R+_*v+f*L+g*O,o[i+5]=u*M+_*y+f*N+g*b,o[i+6]=u*C+_*B+f*P+g*V,o[i+7]=u*I+_*w+f*F+g*U,o[i+8]=m*R+p*v+S*L+E*O,o[i+9]=m*M+p*y+S*N+E*b,o[i+10]=m*C+p*B+S*P+E*V,o[i+11]=m*I+p*w+S*F+E*U,o[i+12]=D*R+T*v+A*L+x*O,o[i+13]=D*M+T*y+A*N+x*b,o[i+14]=D*C+T*B+A*P+x*V,o[i+15]=D*I+T*w+A*F+x*U}static arcTanAngle(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}static angleTo(e,r,a){t.Vector3.subtract(r,e,J),t.Vector3.normalize(J,J),a.x=Math.asin(J.y),a.y=K.arcTanAngle(-J.z,-J.x)}static transformQuat(e,t,r){var a=t,i=e.x,n=e.y,s=e.z,o=a[0],l=a[1],h=a[2],d=a[3],c=d*i+l*s-h*n,u=d*n+h*i-o*s,_=d*s+o*n-l*i,f=-o*i-l*n-h*s;r.x=c*d+f*-o+u*-h-_*-l,r.y=u*d+f*-l+_*-o-c*-h,r.z=_*d+f*-h+c*-l-u*-o}static quaternionWeight(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t,r.w=e.w}static quaternionConjugate(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w}static scaleWeight(e,t,r){var a=e.x,i=e.y,n=e.z;r.x=a>0?Math.pow(Math.abs(a),t):-Math.pow(Math.abs(a),t),r.y=i>0?Math.pow(Math.abs(i),t):-Math.pow(Math.abs(i),t),r.z=n>0?Math.pow(Math.abs(n),t):-Math.pow(Math.abs(n),t)}static scaleBlend(e,t,r,a){var i=j,n=q;K.scaleWeight(e,1-r,i),K.scaleWeight(t,r,n);var s=r>.5?t:e;a.x=s.x>0?Math.abs(i.x*n.x):-Math.abs(i.x*n.x),a.y=s.y>0?Math.abs(i.y*n.y):-Math.abs(i.y*n.y),a.z=s.z>0?Math.abs(i.z*n.z):-Math.abs(i.z*n.z)}static matrix4x4MultiplyFFF(e,t,r){var a,i,n,s,o;if(r===t)for(t=new Float32Array(16),a=0;a<16;++a)t[a]=r[a];var l=t[0],h=t[1],d=t[2],c=t[3],u=t[4],_=t[5],f=t[6],g=t[7],m=t[8],p=t[9],S=t[10],E=t[11],D=t[12],T=t[13],A=t[14],x=t[15];for(a=0;a<4;a++)i=e[a],n=e[a+4],s=e[a+8],o=e[a+12],r[a]=i*l+n*h+s*d+o*c,r[a+4]=i*u+n*_+s*f+o*g,r[a+8]=i*m+n*p+s*S+o*E,r[a+12]=i*D+n*T+s*A+o*x}static matrix4x4MultiplyMFM(e,t,r){K.matrix4x4MultiplyFFF(e.elements,t,r.elements)}static _buildTexture2D(e,r,a,i,n=!1){var s=new t.Texture2D(e,r,a,n,!0);return s.anisoLevel=1,s.filterMode=t.FilterMode.Point,X._generateTexture2D(s,e,r,i),s}static _drawBound(e,t,r){e.lineCount+12>e.maxLineCount&&(e.maxLineCount+=12);var a=j,i=q,n=t.min,s=t.max;a.setValue(n.x,n.y,n.z),i.setValue(s.x,n.y,n.z),e.addLine(a,i,r,r),a.setValue(n.x,n.y,n.z),i.setValue(n.x,n.y,s.z),e.addLine(a,i,r,r),a.setValue(s.x,n.y,n.z),i.setValue(s.x,n.y,s.z),e.addLine(a,i,r,r),a.setValue(n.x,n.y,s.z),i.setValue(s.x,n.y,s.z),e.addLine(a,i,r,r),a.setValue(n.x,n.y,n.z),i.setValue(n.x,s.y,n.z),e.addLine(a,i,r,r),a.setValue(n.x,n.y,s.z),i.setValue(n.x,s.y,s.z),e.addLine(a,i,r,r),a.setValue(s.x,n.y,n.z),i.setValue(s.x,s.y,n.z),e.addLine(a,i,r,r),a.setValue(s.x,n.y,s.z),i.setValue(s.x,s.y,s.z),e.addLine(a,i,r,r),a.setValue(n.x,s.y,n.z),i.setValue(s.x,s.y,n.z),e.addLine(a,i,r,r),a.setValue(n.x,s.y,n.z),i.setValue(n.x,s.y,s.z),e.addLine(a,i,r,r),a.setValue(s.x,s.y,n.z),i.setValue(s.x,s.y,s.z),e.addLine(a,i,r,r),a.setValue(n.x,s.y,s.z),i.setValue(s.x,s.y,s.z),e.addLine(a,i,r,r)}static _getHierarchyPath(e,t,r){r.length=0;for(var a=t;a!==e;){var i=a._parent;if(!i)return null;r.push(i.getChildIndex(a)),a=i}return r}static _getNodeByHierarchyPath(e,t){for(var r=e,a=t.length-1;a>=0;a--)r=r.getChildAt(t[a]);return r}static _getParentNodeByHierarchyPath(e,t){let r=t.length,a=e;for(let e=0;e<r;e++){if(!a)return null;a=a.parent}return a}static uint8ArrayToArrayBuffer(e){return t.Utils.uint8ArrayToArrayBuffer(e)}static uint8ArrayToArrayBufferAsync(e){return t.Utils.uint8ArrayToArrayBufferAsync(e)}}window.getRTBase64=K.uint8ArrayToArrayBuffer;const J=new t.Vector3,j=new t.Vector3,q=new t.Vector3,Z=new t.Vector3,$=new Float32Array(16),ee=new Float32Array(16),te=new Float32Array(16),re=new Float32Array(16);class ae{constructor(){this.updateMark=-1,this.pointLightCount=0,this.spotLightCount=0,this.indices=[]}}class ie{constructor(e,r,a,i){this._updateMark=0,this._depthSliceParam=new t.Vector2,this._xSlices=e,this._ySlices=r,this._zSlices=a;var n=e*r,s=a*(1+Math.ceil(i/4));this._clusterTexture=K._createFloatTextureBuffer(n,s),this._clusterTexture.lock=!0,this._clusterPixels=new Float32Array(n*s*4);for(var o=new Array(this._zSlices),l=0;l<this._zSlices;l++){o[l]=new Array(this._ySlices);for(var h=0;h<this._ySlices;h++){o[l][h]=new Array(this._xSlices);for(var d=0;d<this._xSlices;d++)o[l][h][d]=new ae}}this._clusterDatas=o}_placePointLightToClusters(e,t){for(var r=this._clusterDatas,a=this._updateMark,i=t.zMin,n=t.zMax;i<n;i++)for(var s=t.yMin,o=t.yMax;s<o;s++)for(var l=t.xMin,h=t.xMax;l<h;l++){var d=r[i][s][l];d.updateMark!=a&&(d.pointLightCount=0,d.spotLightCount=0,d.updateMark=a);var c=d.indices,u=d.pointLightCount++;u<c.length?c[u]=e:c.push(e)}}_placeSpotLightToClusters(e,t){for(var r=this._clusterDatas,a=this._updateMark,i=t.zMin,n=t.zMax;i<n;i++)for(var s=t.yMin,o=t.yMax;s<o;s++)for(var l=t.xMin,h=t.xMax;l<h;l++){var d=r[i][s][l];d.updateMark!=a&&(d.pointLightCount=0,d.spotLightCount=0,d.updateMark=a);var c=d.indices,u=d.pointLightCount+d.spotLightCount++;u<c.length?c[u]=e:c.push(e)}}_insertConePlane(e,r,a,i,n){var s=de,o=ce;t.Vector3.cross(n,r,s),t.Vector3.cross(s,r,o),t.Vector3.normalize(o,o);var l=a*Math.tan(i),h=e.x+a*r.x+l*o.x,d=e.y+a*r.y+l*o.y,c=e.z+a*r.z+l*o.z;return h*n.x+d*n.y+c*n.z<=0||e.x*n.x+e.y*n.y+e.z*n.z<=0}_shrinkSphereLightZPerspective(e,t,r,a,i){var n=r.z,s=n-a,o=n+a;if(s>t||o<=e)return!1;var l=this._depthSliceParam;return i.zMin=Math.floor(Math.log2(Math.max(s,e))*l.x-l.y),i.zMax=Math.min(Math.ceil(Math.log2(o)*l.x-l.y),this._zSlices),!0}_shrinkSpotLightZPerspective(e,t,r,a,i,n,s){var o=a.x,l=a.y,h=a.z,d=Math.tan(n)*i,c=r.x,u=r.y,_=r.z,f=o-c,g=l-u,m=h-_,p=f*f+g*g+m*m,S=Math.sqrt(1-m*m/p),E=Math.max(Math.min(_,h-S*d),r.z-i),D=Math.min(Math.max(_,h+S*d),r.z+i);if(E>t||D<=e)return!1;var T=this._depthSliceParam;return s.zMin=Math.floor(Math.log2(Math.max(E,e))*T.x-T.y),s.zMax=Math.min(Math.ceil(Math.log2(D)*T.x-T.y),this._zSlices),!0}_shrinkSphereLightByBoundOrth(e,t,r,a,i,n,s){var o=i.z,l=o-n,h=o+n;if(l>a||h<=r)return!1;var d=i.x,c=d-n,u=d+n;if(c>e||u<=-e)return!1;var _=i.y,f=_-n,g=_+n;if(f>t||g<=-t)return!1;var m=this._xSlices,p=this._ySlices,S=this._depthSliceParam,E=2*e/m,D=2*t/p;return s.xMin=Math.max(Math.floor((c+e)/E),0),s.xMax=Math.min(Math.ceil((u+e)/E),m),s.yMin=Math.max(Math.floor((t-g)/D),0),s.yMax=Math.min(Math.ceil((t-f)/D),p),s.zMin=Math.floor(Math.log2(Math.max(l,r))*S.x-S.y),s.zMax=Math.min(Math.ceil(Math.log2(h)*S.x-S.y),this._zSlices),!0}_shrinkSpotLightByBoundOrth(e,t,r,a,i,n,s,o,l){var h=n.x,d=n.y,c=n.z,u=Math.tan(o)*s,_=i.x,f=i.y,g=i.z,m=h-_,p=d-f,S=c-g,E=m*m+p*p+S*S,D=Math.sqrt(1-S*S/E),T=Math.max(Math.min(g,c-D*u),i.z-s),A=Math.min(Math.max(g,c+D*u),i.z+s);if(T>a||A<=r)return!1;var x=Math.sqrt(1-m*m/E),R=Math.max(Math.min(_,h-x*u),i.x-s),M=Math.min(Math.max(_,h+x*u),i.x+s);if(R>e||M<=-e)return!1;var C=Math.sqrt(1-p*p/E),I=Math.max(Math.min(f,d-C*u),i.y-s),v=Math.min(Math.max(f,d+C*u),i.y+s);if(I>t||v<=-t)return!1;var y=this._xSlices,B=this._ySlices,w=this._depthSliceParam,L=2*e/y,N=2*t/B;return l.xMin=Math.max(Math.floor((R+e)/L),0),l.xMax=Math.min(Math.ceil((M+e)/L),y),l.yMin=Math.max(Math.floor((t-v)/N),0),l.yMax=Math.min(Math.ceil((t-I)/N),B),l.zMin=Math.floor(Math.log2(Math.max(T,r))*w.x-w.y),l.zMax=Math.min(Math.ceil(Math.log2(A)*w.x-w.y),this._zSlices),!0}_shrinkXYByRadiusPerspective(e,t,r,a,i){var n,s,o,l,h,d=e.x,c=e.y,u=e.z,_=this._ySlices+1;for(h=0;h<_;h++){if(c*(f=i[h]).y+u*f.z<t){s=Math.max(0,h-1);break}}if(h==_)return!1;for(l=this._ySlices,h=s+1;h<_;h++){if(c*(f=i[h]).y+u*f.z<=-t){l=Math.max(0,h);break}}for(_=this._xSlices+1,h=0;h<_;h++){if(d*(f=a[h]).x+u*f.z<t){n=Math.max(0,h-1);break}}for(o=this._xSlices,h=n+1;h<_;h++){var f;if(d*(f=a[h]).x+u*f.z<=-t){o=Math.max(0,h);break}}return r.xMin=n,r.xMax=o,r.yMin=s,r.yMax=l,!0}_shrinkSpotXYByConePerspective(e,t,r,a,i,n,s){for(var o,l,h,d,c=oe,u=i.yMax+1,_=i.yMin+1;_<u;_++)if(this._insertConePlane(e,t,r,a,s[_])){l=Math.max(0,_-1);break}d=i.yMax;for(_=l+1;_<u;_++){var f=s[_];if(c.setValue(0,-f.y,-f.z),!this._insertConePlane(e,t,r,a,c)){d=Math.max(0,_);break}}u=i.xMax+1;for(_=i.xMin+1;_<u;_++)if(this._insertConePlane(e,t,r,a,n[_])){o=Math.max(0,_-1);break}h=i.xMax;for(_=o+1;_<u;_++){f=n[_];if(c.setValue(-f.x,0,-f.z),!this._insertConePlane(e,t,r,a,c)){h=Math.max(0,_);break}}i.xMin=o,i.xMax=h,i.yMin=l,i.yMax=d}_updatePointLightPerspective(e,r,a,i,n,s,o){var l=ue,h=ne;t.Vector3.transformV3ToV3(i.owner._transform.position,a,h),h.z*=-1,this._shrinkSphereLightZPerspective(e,r,h,i.range,l)&&this._shrinkXYByRadiusPerspective(h,i.range,l,s,o)&&this._placePointLightToClusters(n,l)}_updateSpotLightPerspective(e,r,a,i,n,s,o){var l=ue,h=ne,d=se,c=he,u=i.owner._transform.position,_=i.range;i.owner._transform.worldMatrix.getForward(d),t.Vector3.normalize(d,d),t.Vector3.scale(d,_,c),t.Vector3.add(u,c,c),t.Vector3.transformV3ToV3(u,a,h),t.Vector3.transformV3ToV3(c,a,c),h.z*=-1,c.z*=-1;var f=i.spotAngle/2*Math.PI/180;if(this._shrinkSpotLightZPerspective(e,r,h,c,_,f,l)&&this._shrinkXYByRadiusPerspective(h,_,l,s,o)){var g=le;g.x=c.x-h.x,g.y=c.y-h.y,g.z=c.z-h.z,t.Vector3.normalize(g,g),this._shrinkSpotXYByConePerspective(h,g,_,f,l,s,o),this._placeSpotLightToClusters(n,l)}}_updatePointLightOrth(e,r,a,i,n,s,o){var l=ue,h=ne;t.Vector3.transformV3ToV3(s.owner._transform.position,n,h),h.z*=-1,this._shrinkSphereLightByBoundOrth(e,r,a,i,h,s.range,l)&&this._placePointLightToClusters(o,l)}_updateSpotLightOrth(e,r,a,i,n,s,o){var l=ue,h=ne,d=se,c=he,u=s.owner._transform.position,_=s.range;s.owner._transform.worldMatrix.getForward(d),t.Vector3.normalize(d,d),t.Vector3.scale(d,_,c),t.Vector3.add(u,c,c),t.Vector3.transformV3ToV3(u,n,h),t.Vector3.transformV3ToV3(c,n,c),h.z*=-1,c.z*=-1;var f=s.spotAngle/2*Math.PI/180;this._shrinkSpotLightByBoundOrth(e,r,a,i,h,c,_,f,l)&&this._placeSpotLightToClusters(o,l)}update(e,r){this._updateMark++;var a=e.nearPlane;this._depthSliceParam.x=t.Config3D.lightClusterCount.z/Math.log2(e.farPlane/a),this._depthSliceParam.y=Math.log2(a)*this._depthSliceParam.x;var i=e.nearPlane,n=e.farPlane,s=e.viewMatrix,o=r._directionLights._length,l=r._pointLights,h=l._length,d=l._elements,c=r._spotLights,u=c._length,_=c._elements;if(e.orthographic){for(var f=e.orthographicVerticalSize/2,g=f*e.aspectRatio,m=0;m<h;m++,o++)this._updatePointLightOrth(g,f,i,n,s,d[m],o);for(m=0;m<u;m++,o++)this._updateSpotLightOrth(g,f,i,n,s,_[m],o)}else{e._updateClusterPlaneXY();var p=e._clusterXPlanes,S=e._clusterYPlanes;for(m=0;m<h;m++,o++)this._updatePointLightPerspective(i,n,s,d[m],o,p,S);for(m=0;m<u;m++,o++)this._updateSpotLightPerspective(i,n,s,_[m],o,p,S)}if(h+u>0){for(var E=this._xSlices,D=this._ySlices,T=this._zSlices,A=E*D*4,x=A*T,R=this._clusterPixels,M=R.length,C=this._clusterDatas,I=this._updateMark,v=!0,y=0;y<T;y++)for(var B=0;B<D;B++)for(var w=0;w<E;w++){var L=C[y][B][w],N=4*(w+B*E+y*E*D);if(L.updateMark!==I)R[N]=0,R[N+1]=0;else if(v){var P=L.indices,F=L.pointLightCount,O=L.spotLightCount,b=F+O;if(x+b<M){R[N]=F,R[N+1]=O,R[N+2]=Math.floor(x/A),R[N+3]=x%A;for(m=0;m<b;m++)R[x++]=P[m]}else{b=M-(x+b),F=Math.min(F,b),R[N]=F,R[N+1]=Math.min(O,b-F),R[N+2]=Math.floor(x/A),R[N+3]=x%A;for(m=0;m<b;m++)R[x++]=P[m];v=!1}}}var V=this._clusterTexture.width;this._clusterTexture.setSubPixelsData(0,0,V,Math.ceil(x/(4*V)),R,0,!1,!1,!1)}}}const ne=new t.Vector3,se=new t.Vector3,oe=new t.Vector3,le=new t.Vector3,he=new t.Vector3;new t.Vector3;const de=new t.Vector3,ce=new t.Vector3,ue=new class{};class _e{constructor(){this.flags=0,this.maxSubSteps=1,this.fixedTimeStep=1/60,this.enableCCD=!1,this.ccdThreshold=1e-4,this.ccdSphereRadius=1e-4}}class fe extends t.EventDispatcher{get isDefaultMatrix(){return this._getTransformFlag(fe.TRANSFORM_LOCALMATRIX)&&this.localMatrix,this._isDefaultMatrix}get _isFrontFaceInvert(){if(this._getTransformFlag(fe.TRANSFORM_WORLDSCALE)){var e=this.getWorldLossyScale(),t=e.x<0;e.y<0&&(t=!t),e.z<0&&(t=!t),this._faceInvert=t,this._frontFaceValue=this._faceInvert?-1:1}return this._faceInvert}getFrontFaceValue(){return this._getTransformFlag(fe.TRANSFORM_WORLDSCALE)&&this._isFrontFaceInvert,this._frontFaceValue}get owner(){return this._owner}get worldNeedUpdate(){return this._getTransformFlag(fe.TRANSFORM_WORLDMATRIX)}get localPositionX(){return this._localPosition.x}set localPositionX(e){this._localPosition.x=e,this.localPosition=this._localPosition}get localPositionY(){return this._localPosition.y}set localPositionY(e){this._localPosition.y=e,this.localPosition=this._localPosition}get localPositionZ(){return this._localPosition.z}set localPositionZ(e){this._localPosition.z=e,this.localPosition=this._localPosition}get localPosition(){return this._localPosition}set localPosition(e){this._localPosition!==e&&e.cloneTo(this._localPosition),this._setTransformFlag(fe.TRANSFORM_LOCALMATRIX,!0),this._onWorldPositionTransform()}get localRotationX(){return this.localRotation.x}set localRotationX(e){let t=this.localRotation;t.x=e,this.localRotation=t}get localRotationY(){return this.localRotation.y}set localRotationY(e){let t=this.localRotation;t.y=e,this.localRotation=t}get localRotationZ(){return this.localRotation.z}set localRotationZ(e){let t=this.localRotation;t.z=e,this.localRotation=t}get localRotationW(){return this.localRotation.w}set localRotationW(e){let t=this.localRotation;t.w=e,this.localRotation=t}get localRotation(){if(this._getTransformFlag(fe.TRANSFORM_LOCALQUATERNION)){var e=this._localRotationEuler;t.Quaternion.createFromYawPitchRoll(e.y/fe._angleToRandin,e.x/fe._angleToRandin,e.z/fe._angleToRandin,this._localRotation),this._setTransformFlag(fe.TRANSFORM_LOCALQUATERNION,!1)}return this._localRotation}set localRotation(e){this._localRotation!==e&&e.cloneTo(this._localRotation),this._localRotation.normalize(this._localRotation),this._setTransformFlag(fe.TRANSFORM_LOCALEULER|fe.TRANSFORM_LOCALMATRIX,!0),this._setTransformFlag(fe.TRANSFORM_LOCALQUATERNION,!1),this._onWorldRotationTransform()}get localScaleX(){return this._localScale.x}set localScaleX(e){this._localScale.x=e,this.localScale=this._localScale}get localScaleY(){return this._localScale.y}set localScaleY(e){this._localScale.y=e,this.localScale=this._localScale}get localScaleZ(){return this._localScale.z}set localScaleZ(e){this._localScale.z=e,this.localScale=this._localScale}get localScale(){return this._localScale}set localScale(e){this._localScale!==e&&e.cloneTo(this._localScale),this._setTransformFlag(fe.TRANSFORM_LOCALMATRIX,!0),this._onWorldScaleTransform()}get localRotationEulerX(){return this.localRotationEuler.x}set localRotationEulerX(e){let t=this.localRotationEuler;t.x=e,this.localRotationEuler=t}get localRotationEulerY(){return this.localRotationEuler.y}set localRotationEulerY(e){let t=this.localRotationEuler;t.y=e,this.localRotationEuler=t}get localRotationEulerZ(){return this.localRotationEuler.z}set localRotationEulerZ(e){let t=this.localRotationEuler;t.z=e,this.localRotationEuler=t}get localRotationEuler(){if(this._getTransformFlag(fe.TRANSFORM_LOCALEULER)){this._localRotation.getYawPitchRoll(ge);var e=ge,t=this._localRotationEuler;t.x=e.y*fe._angleToRandin,t.y=e.x*fe._angleToRandin,t.z=e.z*fe._angleToRandin,this._setTransformFlag(fe.TRANSFORM_LOCALEULER,!1)}return this._localRotationEuler}set localRotationEuler(e){this._localRotationEuler!==e&&e.cloneTo(this._localRotationEuler),this._setTransformFlag(fe.TRANSFORM_LOCALEULER,!1),this._setTransformFlag(fe.TRANSFORM_LOCALQUATERNION|fe.TRANSFORM_LOCALMATRIX,!0),this._onWorldRotationTransform()}get localMatrix(){return this._getTransformFlag(fe.TRANSFORM_LOCALMATRIX)&&(t.Matrix4x4.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix),this._isDefaultMatrix=this._localMatrix.isIdentity(),this._setTransformFlag(fe.TRANSFORM_LOCALMATRIX,!1)),this._localMatrix}set localMatrix(e){this._localMatrix!==e&&e.cloneTo(this._localMatrix),this._isDefaultMatrix=this._localMatrix.isIdentity(),this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._setTransformFlag(fe.TRANSFORM_LOCALEULER,!0),this._setTransformFlag(fe.TRANSFORM_LOCALMATRIX,!1),this._onWorldTransform()}get position(){if(this._getTransformFlag(fe.TRANSFORM_WORLDPOSITION)){if(null!=this._parent){var e=this.worldMatrix.elements;this._position.x=e[12],this._position.y=e[13],this._position.z=e[14]}else this._localPosition.cloneTo(this._position);this._setTransformFlag(fe.TRANSFORM_WORLDPOSITION,!1)}return this._position}set position(e){if(null!=this._parent){var r=pe;this._parent.worldMatrix.invert(r),t.Vector3.transformCoordinate(e,r,this._localPosition)}else e.cloneTo(this._localPosition);this.localPosition=this._localPosition,this._position!==e&&e.cloneTo(this._position),this._setTransformFlag(fe.TRANSFORM_WORLDPOSITION,!1)}get rotation(){return this._getTransformFlag(fe.TRANSFORM_WORLDQUATERNION)&&(null!=this._parent?t.Quaternion.multiply(this._parent.rotation,this.localRotation,this._rotation):this.localRotation.cloneTo(this._rotation),this._setTransformFlag(fe.TRANSFORM_WORLDQUATERNION,!1)),this._rotation}set rotation(e){null!=this._parent?(this._parent.rotation.invert(me),t.Quaternion.multiply(me,e,this._localRotation)):e.cloneTo(this._localRotation),this.localRotation=this._localRotation,e!==this._rotation&&e.cloneTo(this._rotation),this._setTransformFlag(fe.TRANSFORM_WORLDQUATERNION,!1)}get rotationEuler(){if(this._getTransformFlag(fe.TRANSFORM_WORLDEULER)){this.rotation.getYawPitchRoll(ge);var e=ge,t=this._rotationEuler;t.x=e.y*fe._angleToRandin,t.y=e.x*fe._angleToRandin,t.z=e.z*fe._angleToRandin,this._setTransformFlag(fe.TRANSFORM_WORLDEULER,!1)}return this._rotationEuler}set rotationEuler(e){t.Quaternion.createFromYawPitchRoll(e.y/fe._angleToRandin,e.x/fe._angleToRandin,e.z/fe._angleToRandin,this._rotation),this.rotation=this._rotation,this._rotationEuler!==e&&e.cloneTo(this._rotationEuler),this._setTransformFlag(fe.TRANSFORM_WORLDEULER,!1)}get worldMatrix(){if(this._getTransformFlag(fe.TRANSFORM_WORLDMATRIX)){if(null!=this._parent){let e=this._parent;for(;e._parent&&e.isDefaultMatrix;)e=e._parent;t.Matrix4x4.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix)}else this.localMatrix.cloneTo(this._worldMatrix);this._setTransformFlag(fe.TRANSFORM_WORLDMATRIX,!1)}return this._worldMatrix}set worldMatrix(e){null===this._parent?e.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),t.Matrix4x4.multiply(this._localMatrix,e,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix!==e&&e.cloneTo(this._worldMatrix),this._setTransformFlag(fe.TRANSFORM_WORLDMATRIX,!1)}constructor(e){super(),this._localPosition=new t.Vector3(0,0,0),this._localRotation=new t.Quaternion(0,0,0,1),this._localScale=new t.Vector3(1,1,1),this._localRotationEuler=new t.Vector3(0,0,0),this._localMatrix=new t.Matrix4x4,this._position=new t.Vector3(0,0,0),this._rotation=new t.Quaternion(0,0,0,1),this._scale=new t.Vector3(1,1,1),this._rotationEuler=new t.Vector3(0,0,0),this._worldMatrix=new t.Matrix4x4,this._children=null,this._isDefaultMatrix=!1,this._faceInvert=!1,this._frontFaceValue=1,this._parent=null,this._transformFlag=0,this._owner=e,this._children=[],this._initProperty()}_initProperty(){this._setTransformFlag(fe.TRANSFORM_LOCALQUATERNION|fe.TRANSFORM_LOCALEULER|fe.TRANSFORM_LOCALMATRIX,!1),this._setTransformFlag(fe.TRANSFORM_WORLDPOSITION|fe.TRANSFORM_WORLDQUATERNION|fe.TRANSFORM_WORLDEULER|fe.TRANSFORM_WORLDSCALE|fe.TRANSFORM_WORLDMATRIX,!0)}_getScaleMatrix(){var e=me,r=Se,a=Ee,i=De;return t.Matrix3x3.createFromMatrix4x4(this.worldMatrix,a),this.rotation.invert(e),t.Matrix3x3.createRotationQuaternion(e,r),t.Matrix3x3.multiply(r,a,i),i}_setTransformFlag(e,t){t?this._transformFlag|=e:this._transformFlag&=~e}_getTransformFlag(e){return 0!=(this._transformFlag&e)}_setParent(e){if(this._parent!==e){if(this._parent){var t=this._parent._children,r=t.indexOf(this);t.splice(r,1)}e&&(e._children.push(this),e&&this._onWorldTransform()),this._parent=e}}_onWorldPositionRotationTransform(){this._getTransformFlag(fe.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(fe.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(fe.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(fe.TRANSFORM_WORLDEULER)||(this._setTransformFlag(fe.TRANSFORM_WORLDMATRIX|fe.TRANSFORM_WORLDPOSITION|fe.TRANSFORM_WORLDQUATERNION|fe.TRANSFORM_WORLDEULER,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag));for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldPositionRotationTransform()}_onWorldPositionScaleTransform(){this._getTransformFlag(fe.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(fe.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(fe.TRANSFORM_WORLDSCALE)||(this._setTransformFlag(fe.TRANSFORM_WORLDMATRIX|fe.TRANSFORM_WORLDPOSITION|fe.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag));for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldPositionScaleTransform()}_onWorldPositionTransform(){this._getTransformFlag(fe.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(fe.TRANSFORM_WORLDPOSITION)||(this._setTransformFlag(fe.TRANSFORM_WORLDMATRIX|fe.TRANSFORM_WORLDPOSITION,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag));for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldPositionTransform()}_onWorldRotationTransform(){this._getTransformFlag(fe.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(fe.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(fe.TRANSFORM_WORLDEULER)||(this._setTransformFlag(fe.TRANSFORM_WORLDMATRIX|fe.TRANSFORM_WORLDQUATERNION|fe.TRANSFORM_WORLDEULER,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag));for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldPositionRotationTransform()}_onWorldScaleTransform(){this._getTransformFlag(fe.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(fe.TRANSFORM_WORLDSCALE)||(this._setTransformFlag(fe.TRANSFORM_WORLDMATRIX|fe.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag));for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldPositionScaleTransform()}_onWorldTransform(){this._getTransformFlag(fe.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(fe.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(fe.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(fe.TRANSFORM_WORLDEULER)&&this._getTransformFlag(fe.TRANSFORM_WORLDSCALE)||(this._setTransformFlag(fe.TRANSFORM_WORLDMATRIX|fe.TRANSFORM_WORLDPOSITION|fe.TRANSFORM_WORLDQUATERNION|fe.TRANSFORM_WORLDEULER|fe.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag));for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldTransform()}translate(e,r=!0){r?(t.Matrix4x4.createFromQuaternion(this.localRotation,pe),t.Vector3.transformCoordinate(e,pe,ge),t.Vector3.add(this.localPosition,ge,this._localPosition),this.localPosition=this._localPosition):(t.Vector3.add(this.position,e,this._position),this.position=this._position)}rotate(e,r=!0,a=!0){var i;a?i=e:(t.Vector3.scale(e,Math.PI/180,ge),i=ge),t.Quaternion.createFromYawPitchRoll(i.y,i.x,i.z,me),r?(t.Quaternion.multiply(this.localRotation,me,this._localRotation),this.localRotation=this._localRotation):(t.Quaternion.multiply(me,this.rotation,this._rotation),this.rotation=this._rotation)}getForward(e){var t=this.worldMatrix.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}getUp(e){var t=this.worldMatrix.elements;e.x=t[4],e.y=t[5],e.z=t[6]}getRight(e){var t=this.worldMatrix.elements;e.x=t[0],e.y=t[1],e.z=t[2]}lookAt(e,r,a=!1,i=!0){var n;if(a){if(n=this.localPosition,Math.abs(n.x-e.x)<t.MathUtils3D.zeroTolerance&&Math.abs(n.y-e.y)<t.MathUtils3D.zeroTolerance&&Math.abs(n.z-e.z)<t.MathUtils3D.zeroTolerance)return;i?(t.Quaternion.lookAt(this.localPosition,e,r,this._localRotation),this._localRotation.invert(this._localRotation)):(t.Vector3.subtract(this.localPosition,e,ge),t.Quaternion.rotationLookAt(ge,r,this._localRotation),this._localRotation.invert(this._localRotation)),this.localRotation=this._localRotation}else{var s=this.position;if(n=s,Math.abs(n.x-e.x)<t.MathUtils3D.zeroTolerance&&Math.abs(n.y-e.y)<t.MathUtils3D.zeroTolerance&&Math.abs(n.z-e.z)<t.MathUtils3D.zeroTolerance)return;i?(t.Quaternion.lookAt(s,e,r,this._rotation),this._rotation.invert(this._rotation)):(t.Vector3.subtract(this.position,e,ge),t.Quaternion.rotationLookAt(ge,r,this._rotation),this._rotation.invert(this._rotation)),this.rotation=this._rotation}}objLookat(e,t,r=!1){this.lookAt(e,t,r,!1)}getWorldLossyScale(){if(this._getTransformFlag(fe.TRANSFORM_WORLDSCALE)){if(null!==this._parent){var e=this._getScaleMatrix().elements;this._scale.x=e[0],this._scale.y=e[4],this._scale.z=e[8]}else this._localScale.cloneTo(this._scale);this._setTransformFlag(fe.TRANSFORM_WORLDSCALE,!1)}return this._scale}setWorldLossyScale(e){if(null!==this._parent){var r=Te,a=Te,i=a.elements,n=this._parent._getScaleMatrix();n.invert(n),t.Matrix3x3.createFromScaling(e,r),t.Matrix3x3.multiply(n,r,a),this._localScale.x=i[0],this._localScale.y=i[4],this._localScale.z=i[8]}else e.cloneTo(this._localScale);this.localScale=this._localScale,this._scale!==e&&e.cloneTo(this._scale),this._setTransformFlag(fe.TRANSFORM_WORLDSCALE,!1)}localToGlobal(e,r){t.Vector3.transformV3ToV3(e,this.worldMatrix,r)}globalToLocal(e,r){this.worldMatrix.invert(pe),t.Vector3.transformV3ToV3(e,pe,r)}toLocalNormal(e,r){this.worldMatrix.invert(pe),t.Vector3.TransformNormal(e,pe,r)}toDir(e,t){this.rotationTo(this.rotation,e,t),this.rotation=this.rotation}rotationTo(e,r,a){var i=t.Vector3.dot(r,a);return i<-.999999?(t.Vector3.cross(t.Vector3.UnitX,r,Ae),t.Vector3.scalarLength(Ae)<1e-6&&t.Vector3.cross(t.Vector3.UnitY,r,Ae),t.Vector3.normalize(Ae,Ae),t.Quaternion.createFromAxisAngle(Ae,Math.PI,e),!0):i>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,!1):(t.Vector3.cross(r,a,Ae),e.x=Ae.x,e.y=Ae.y,e.z=Ae.z,e.w=1+i,e.normalize(e),!0)}get scale(){return console.warn("Transfrm3D: discard function,please use getWorldLossyScale instead."),this.getWorldLossyScale()}set scale(e){console.warn("Transfrm3D: discard function,please use setWorldLossyScale instead."),this.setWorldLossyScale(e)}}fe.TRANSFORM_LOCALQUATERNION=1,fe.TRANSFORM_LOCALEULER=2,fe.TRANSFORM_LOCALMATRIX=4,fe.TRANSFORM_WORLDPOSITION=8,fe.TRANSFORM_WORLDQUATERNION=16,fe.TRANSFORM_WORLDSCALE=32,fe.TRANSFORM_WORLDMATRIX=64,fe.TRANSFORM_WORLDEULER=128,fe.TRANSFORM_LOCALPOS=256,fe.TRANSFORM_LOCALSCALE=512,fe._angleToRandin=180/Math.PI;const ge=new t.Vector3,me=new t.Quaternion,pe=new t.Matrix4x4,Se=new t.Matrix3x3,Ee=new t.Matrix3x3,De=new t.Matrix3x3,Te=new t.Matrix3x3,Ae=new t.Vector3;class xe{set bufferState(e){this._geometryElementOBj.bufferState=e._deviceBufferState,this._bufferState=e}get bufferState(){return this._bufferState}set mode(e){this._geometryElementOBj.mode=e}get mode(){return this._geometryElementOBj.mode}set drawType(e){this._geometryElementOBj.drawType=e}get drawType(){return this._geometryElementOBj.drawType}setDrawArrayParams(e,t){this._geometryElementOBj.setDrawArrayParams(e,t)}setDrawElemenParams(e,t){this._geometryElementOBj.setDrawElemenParams(e,t)}set instanceCount(e){this._geometryElementOBj.instanceCount=e}get instanceCount(){return this._geometryElementOBj.instanceCount}set indexFormat(e){this._geometryElementOBj.indexFormat=e}get indexFormat(){return this._geometryElementOBj.indexFormat}get destroyed(){return this._destroyed}constructor(e,r){this._destroyed=!1,this._geometryElementOBj=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(e,r),this._id=++xe._uniqueIDCounter}_getType(){throw new Error("GeometryElement:must override it.")}_prepareRender(e){return!0}_updateRenderParams(e){throw new Error("GeometryElement:must override it.")}destroy(){this._destroyed||(this._destroyed=!0,this._geometryElementOBj.destroy())}clearRenderParams(){this._geometryElementOBj.clearRenderParams()}}xe._uniqueIDCounter=0,xe._typeCounter=0;class Re extends xe{static __init__(){Re.instance=new Re}constructor(){super(t.MeshTopology.Triangles,t.DrawType.DrawElement);var e=new Float32Array([-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1]),r=new Uint16Array([0,2,1,2,0,3,4,6,7,6,4,5,0,7,3,7,0,4,1,6,5,6,1,2,3,6,2,6,3,7,0,5,4,5,0,1]),a=t.VertexMesh.getVertexDeclaration("POSITION");let i=E.renderOBJCreate.createVertexBuffer3D(8*a.vertexStride,t.BufferUsage.Static,!1);i.vertexDeclaration=a;let n=E.renderOBJCreate.createIndexBuffer3D(t.IndexFormat.UInt16,36,t.BufferUsage.Static,!1);i.setData(e),n.setData(r),this.bufferState=new t.BufferState,this.bufferState.applyState([i],n),this._geometryElementOBj.setDrawElemenParams(36,0),this.indexFormat=t.IndexFormat.UInt16}_updateRenderParams(e){}}class Me{static get vertexDeclaration(){return Me._vertexDeclaration}static __init__(){Me._vertexDeclaration=new t.VertexDeclaration(20,[new t.VertexElement(0,t.VertexElementFormat.Vector3,t.VertexMesh.MESH_POSITION0),new t.VertexElement(12,t.VertexElementFormat.Vector2,t.VertexMesh.MESH_TEXTURECOORDINATE0)])}get position(){return this._position}get textureCoordinate0(){return this._textureCoordinate0}get vertexDeclaration(){return Me._vertexDeclaration}constructor(e,t){this._position=e,this._textureCoordinate0=t}}class Ce extends xe{static __init__(){Ce.instance=new Ce}get stacks(){return this._stacks}get slices(){return this._slices}constructor(e=48,r=48){super(t.MeshTopology.Triangles,t.DrawType.DrawElement),this._stacks=e,this._slices=r;for(var a=Me.vertexDeclaration,i=a.vertexStride/4,n=(this._stacks+1)*(this._slices+1),s=3*this._stacks*(this._slices+1)*2,o=new Float32Array(n*i),l=new Uint16Array(s),h=Math.PI/this._stacks,d=2*Math.PI/this._slices,c=0,u=0,_=0,f=0;f<this._stacks+1;f++)for(var g=Math.sin(f*h),m=Math.cos(f*h),p=0;p<this._slices+1;p++){var S=g*Math.sin(p*d),D=g*Math.cos(p*d);o[u+0]=S*Ce._radius,o[u+1]=m*Ce._radius,o[u+2]=D*Ce._radius,o[u+3]=-p/this._slices+.75,o[u+4]=f/this._stacks,u+=i,f!=this._stacks-1&&(l[_++]=c+1,l[_++]=c,l[_++]=c+(this._slices+1),l[_++]=c+(this._slices+1),l[_++]=c,l[_++]=c+this._slices,c++)}let T=E.renderOBJCreate.createVertexBuffer3D(4*o.length,t.BufferUsage.Static,!1);T.vertexDeclaration=a;let A=E.renderOBJCreate.createIndexBuffer3D(t.IndexFormat.UInt16,l.length,t.BufferUsage.Static,!1);T.setData(o.buffer),A.setData(l);var x=new t.BufferState;x.applyState([T],A),this.bufferState=x,this.indexFormat=t.IndexFormat.UInt16,this._geometryElementOBj.setDrawElemenParams(A.indexCount,0)}_updateRenderParams(e){}}Ce._radius=1;class Ie{static __init__(){Ie.SUNLIGHTDIRECTION=t.Shader3D.propertyNameToID("u_SunLight_direction"),Ie.SUNLIGHTDIRCOLOR=t.Shader3D.propertyNameToID("u_SunLight_color"),Ie.SKYVIEWMATRIX=t.Shader3D.propertyNameToID("u_SkyViewMat"),Ie.SKYPROJECTIONMATRIX=t.Shader3D.propertyNameToID("u_SkyProjectionMat"),Ie.SKYPROJECTIONVIEWMATRIX=t.Shader3D.propertyNameToID("u_SkyProjectionViewMat");const r=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("SkyRenderer");r.addShaderUniform(Ie.SUNLIGHTDIRECTION,"u_SunLight_direction",e.ShaderDataType.Vector3),r.addShaderUniform(Ie.SUNLIGHTDIRCOLOR,"u_SunLight_color",e.ShaderDataType.Color),r.addShaderUniform(Ie.SKYVIEWMATRIX,"u_SkyViewMat",e.ShaderDataType.Matrix4x4),r.addShaderUniform(Ie.SKYPROJECTIONMATRIX,"u_SkyProjectionMat",e.ShaderDataType.Matrix4x4),r.addShaderUniform(Ie.SKYPROJECTIONVIEWMATRIX,"u_SkyProjectionViewMat",e.ShaderDataType.Matrix4x4)}get material(){return this._material}set material(e){this._material!==e&&(this._material&&this._material._removeReference(),this._material=e,this._cacheRenderElement&&(this._cacheRenderElement.material=e),e&&e._addReference())}get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,this._cacheRenderElement&&this._cacheRenderElement.setGeometry(this.mesh))}get meshType(){return this.mesh==Re.instance?"box":this.mesh==Ce.instance?"dome":""}set meshType(e){this.mesh="dome"==e?Ce.instance:Re.instance}constructor(){this.mesh=Ce.instance,this._renderData=new U,this._baseRenderNode=E.Render3DModuleDataFactory.createBaseRenderNode(),this._baseRenderNode.transform=new fe(null)}_isAvailable(){return!(!this._material||!this._mesh)}renderUpdate(e){let t=this.mesh;this._renderGeometry=t._prepareRender(e),t._updateRenderParams(e)}setRenderElement(e){this._cacheRenderElement!=e&&(e.setGeometry(this.mesh),e.material=this._material,e.render=this._renderData,e._renderElementOBJ.isRender=this._renderGeometry,this._baseRenderNode.setRenderelements([e._renderElementOBJ]),this._baseRenderNode.setCommonUniformMap(["Sprite3D","SkyRenderer"]),this._cacheRenderElement=e)}destroy(){this._material&&(this._material._removeReference(),this._material=null),this._renderData.destroy(),this._cacheRenderElement=null,this._baseRenderNode.setRenderelements([]),this._baseRenderNode.destroy()}}const ve=new t.Matrix4x4(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1);class ye extends H{constructor(){super(),this._viewMatrix=new t.Matrix4x4,this._projectionMatrix=new t.Matrix4x4,this._projectViewMatrix=new t.Matrix4x4}calculateViewMatrix(e){e.cloneTo(this._viewMatrix),this._viewMatrix.setTranslationVector(t.Vector3.ZERO)}caluclateProjectionMatrix(e,r,a,i,n,s){if(s){let e=.2,r=e;t.Matrix4x4.createOrthoOffCenter(-e,e,-r,r,a,i,this._projectionMatrix)}else{e.cloneTo(this._projectionMatrix);let t=1e-6,a=1/Math.tan(Math.PI*n/180*.5);this._projectionMatrix.elements[0]=a/r,this._projectionMatrix.elements[5]=a,this._projectionMatrix.elements[10]=t-1,this._projectionMatrix.elements[11]=-1,this._projectionMatrix.elements[14]=-0}}renderpre(e){e.invertY?(t.Matrix4x4.multiply(ve,this._projectionMatrix,t.Matrix4x4.TEMP),t.Matrix4x4.multiply(t.Matrix4x4.TEMP,this._viewMatrix,Be),this._renderElementOBJ.renderShaderData.setMatrix4x4(Ie.SKYPROJECTIONMATRIX,t.Matrix4x4.TEMP),this._renderElementOBJ.renderShaderData.setMatrix4x4(Ie.SKYPROJECTIONVIEWMATRIX,Be)):(t.Matrix4x4.multiply(this._projectionMatrix,this._viewMatrix,this._projectViewMatrix),this._renderElementOBJ.renderShaderData.setMatrix4x4(Ie.SKYPROJECTIONMATRIX,this._projectionMatrix),this._renderElementOBJ.renderShaderData.setMatrix4x4(Ie.SKYPROJECTIONVIEWMATRIX,this._projectViewMatrix)),this._renderElementOBJ.renderShaderData.setMatrix4x4(Ie.SKYVIEWMATRIX,this._viewMatrix),this._renderElementOBJ.renderShaderData.setColor(Ie.SUNLIGHTDIRCOLOR,e.scene._sunColor),this._renderElementOBJ.renderShaderData.setVector3(Ie.SUNLIGHTDIRECTION,e.scene._sundir)}}const Be=new t.Matrix4x4;class we extends x{static shaderValueInit(){we.SHADERDEFINE_DEPTH=t.Shader3D.getDefineByName("DEPTHMAP"),we.SHADERDEFINE_DEPTHNORMALS=t.Shader3D.getDefineByName("DEPTHNORMALSMAP"),we.SHADERDEFINE_ORTHOGRAPHIC=t.Shader3D.getDefineByName("CAMERAORTHOGRAPHIC"),we.SHADERDEFINE_FXAA=t.Shader3D.getDefineByName("FXAA"),we.CAMERAPOS=t.Shader3D.propertyNameToID("u_CameraPos"),we.VIEWMATRIX=t.Shader3D.propertyNameToID("u_View"),we.VIEWPROJECTMATRIX=t.Shader3D.propertyNameToID("u_ViewProjection"),we.PROJECTMATRIX=t.Shader3D.propertyNameToID("u_Projection"),we.CAMERADIRECTION=t.Shader3D.propertyNameToID("u_CameraDirection"),we.CAMERAUP=t.Shader3D.propertyNameToID("u_CameraUp"),we.VIEWPORT=t.Shader3D.propertyNameToID("u_Viewport"),we.PROJECTION_PARAMS=t.Shader3D.propertyNameToID("u_ProjectionParams"),we.DEPTHTEXTURE=t.Shader3D.propertyNameToID("u_CameraDepthTexture"),we.DEPTHNORMALSTEXTURE=t.Shader3D.propertyNameToID("u_CameraDepthNormalsTexture"),we.OPAQUETEXTURE=t.Shader3D.propertyNameToID("u_CameraOpaqueTexture"),we.OPAQUETEXTUREPARAMS=t.Shader3D.propertyNameToID("u_OpaqueTextureParams"),we.DEPTHZBUFFERPARAMS=t.Shader3D.propertyNameToID("u_ZBufferParams");let r=we.cameraUniformMap=t.LayaGL.renderDeviceFactory.createGlobalUniformMap(we.cameraBlockName);r.addShaderUniform(we.CAMERAPOS,"u_CameraPos",e.ShaderDataType.Vector3),r.addShaderUniform(we.VIEWMATRIX,"u_View",e.ShaderDataType.Matrix4x4),r.addShaderUniform(we.PROJECTMATRIX,"u_Projection",e.ShaderDataType.Matrix4x4),r.addShaderUniform(we.VIEWPROJECTMATRIX,"u_ViewProjection",e.ShaderDataType.Matrix4x4),r.addShaderUniform(we.CAMERADIRECTION,"u_CameraDirection",e.ShaderDataType.Vector3),r.addShaderUniform(we.CAMERAUP,"u_CameraUp",e.ShaderDataType.Vector3),r.addShaderUniform(we.VIEWPORT,"u_Viewport",e.ShaderDataType.Vector4),r.addShaderUniform(we.PROJECTION_PARAMS,"u_ProjectionParams",e.ShaderDataType.Vector4),r.addShaderUniform(we.DEPTHTEXTURE,"u_CameraDepthTexture",e.ShaderDataType.Texture2D),r.addShaderUniform(we.DEPTHNORMALSTEXTURE,"u_CameraDepthNormalsTexture",e.ShaderDataType.Texture2D),r.addShaderUniform(we.OPAQUETEXTURE,"u_CameraOpaqueTexture",e.ShaderDataType.Texture2D),r.addShaderUniform(we.OPAQUETEXTUREPARAMS,"u_OpaqueTextureParams",e.ShaderDataType.Vector4),r.addShaderUniform(we.DEPTHZBUFFERPARAMS,"u_ZBufferParams",e.ShaderDataType.Vector4)}static __init__(){we.shaderValueInit()}get clearColor(){return this._clearColor}set clearColor(e){this._clearColor=e,e.toLinear(this._linearClearColor)}get skyRenderElement(){return this._skyRenderElement}get fieldOfView(){return this._fieldOfView}set fieldOfView(e){this._fieldOfView=e,this._calculateProjectionMatrix(),this._caculateMaxLocalYRange()}get maxlocalYDistance(){return this._yrange}get nearPlane(){return this._nearPlane}set nearPlane(e){this._nearPlane=e,this._calculateProjectionMatrix()}get farPlane(){return this._farPlane}set farPlane(e){this._farPlane=e,this._calculateProjectionMatrix(),this._caculateMaxLocalYRange()}get orthographic(){return this._orthographic}set orthographic(e){this._orthographic=e,this._calculateProjectionMatrix(),e?this._shaderValues.addDefine(we.SHADERDEFINE_ORTHOGRAPHIC):this._shaderValues.removeDefine(we.SHADERDEFINE_ORTHOGRAPHIC)}get orthographicVerticalSize(){return this._orthographicVerticalSize}set orthographicVerticalSize(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}get cullingMask(){return this._cullingMask}set cullingMask(e){this._cullingMask=e}get renderingOrder(){return this._renderingOrder}set renderingOrder(e){this._renderingOrder=e,this._sortCamerasByRenderingOrder()}constructor(e=.3,r=1e3){super(),this._forward=new t.Vector3,this._up=new t.Vector3,this._shaderValues=t.LayaGL.renderDeviceFactory.createShaderData(null),this._linearClearColor=new t.Color,this.clearColor=new t.Color(100/255,149/255,237/255,1),this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=e,this._farPlane=r,this.cullingMask=2147483647,this.staticMask=4294967295,this.useOcclusionCulling=!0,this._renderEngine=t.LayaGL.renderEngine,this._orthographic=!1,this._skyRenderElement=new ye}_caculateMaxLocalYRange(){let e=3.1416*this.fieldOfView/180/2,t=this.farPlane;this._yrange=Math.tan(e)*t*2}_calculateProjectionMatrix(){}_onScreenSizeChanged(){this._calculateProjectionMatrix()}_sortCamerasByRenderingOrder(){if(this.displayedInStage)for(var e=this.scene._cameraPool,t=e.length-1,r=0;r<t;r++)if(e[r].renderingOrder>e[t].renderingOrder){var a=e[r];e[r]=e[t],e[t]=a}}_prepareCameraToRender(){this.transform.getForward(this._forward),this.transform.getUp(this._up),this._shaderValues.setVector3(we.CAMERAPOS,this.transform.position),this._shaderValues.setVector3(we.CAMERADIRECTION,this._forward),this._shaderValues.setVector3(we.CAMERAUP,this._up)}render(e){}addLayer(e){this.cullingMask|=Math.pow(2,e)}removeLayer(e){this.cullingMask&=~Math.pow(2,e)}addAllLayers(){this.cullingMask=2147483647}removeAllLayers(){this.cullingMask=0}resetProjectionMatrix(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()}_onActive(){this._scene._addCamera(this),super._onActive()}_onInActive(){this._scene._removeCamera(this),super._onInActive()}destroy(e=!0){this._skyRenderElement.destroy(),this._skyRenderElement=null,t.ILaya.stage.off(t.Event.RESIZE,this,this._onScreenSizeChanged),super.destroy(e)}}we.cameraBlockName="BaseCamera",we.RENDERINGTYPE_SHADERDEFINE_FXAA="FXAA",we.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",we.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",we._invertYScaleMatrix=new t.Matrix4x4(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1),we._invertYProjectionMatrix=new t.Matrix4x4,we._invertYProjectionViewMatrix=new t.Matrix4x4;class Le{constructor(){this._length=0,this._elements=[]}add(e){let t=this._elements.indexOf(e);-1!=t&&t<this._length||(this._length===this._elements.length?this._elements.push(e):this._elements[this._length]=e,this._length++)}remove(e){var t=this._elements.indexOf(e);if(-1!=t&&(this._length--,t!==this._length)){var r=this._elements[this._length];this._elements[t]=r}}shift(){return this._length--,this._elements.shift()}getBrightestLight(){for(var e,t=-1,r=this._elements,a=0;a<this._length;a++){var i=r[a]._intensity;t<i&&(t=i,e=a)}return e}normalLightOrdering(e){var t=this._elements[0];this._elements[0]=this._elements[e],this._elements[e]=t}}class Ne extends Le{remove(e){var t=this._elements.indexOf(e);this._elements.splice(t,1),this._length--}}class Pe{get lightmapColor(){return this._lightmapColor}set lightmapColor(e){this._lightmapColor!=e&&(this._lightmapColor&&this._lightmapColor._removeReference(),this._lightmapColor=e,e?(e._addReference(),this._dataModule.lightmapColor=e._texture):this._dataModule.lightmapColor=null)}get lightmapDirection(){return this._lightmapDirection}set lightmapDirection(e){this._lightmapDirection!=e&&(this._lightmapDirection&&this._lightmapDirection._removeReference(),this._lightmapDirection=e,e?(e._addReference(),this._dataModule.lightmapDirection=e._texture):this._dataModule.lightmapDirection=null)}constructor(){this._dataModule=E.Render3DModuleDataFactory.createLightmapData()}}Pe.ApplyLightmapEvent="ApplyLightmap";class Fe{}var Oe;e.ShadowCascadesMode=void 0,(Oe=e.ShadowCascadesMode||(e.ShadowCascadesMode={}))[Oe.NoCascades=0]="NoCascades",Oe[Oe.TwoCascades=1]="TwoCascades",Oe[Oe.FourCascades=2]="FourCascades";class be{constructor(e=new t.Vector3,r=0){this.normal=e,this.distance=r}static createPlaneBy3P(e,t,r,a){var i=t.x-e.x,n=t.y-e.y,s=t.z-e.z,o=r.x-e.x,l=r.y-e.y,h=r.z-e.z,d=n*h-s*l,c=s*o-i*h,u=i*l-n*o,_=1/Math.sqrt(d*d+c*c+u*u),f=d*_,g=c*_,m=u*_,p=a.normal;p.x=f,p.y=g,p.z=m,a.normal=p.normalize(),a.distance=-(f*e.x+g*e.y+m*e.z)}normalize(){var e=this.normal.x,t=this.normal.y,r=this.normal.z,a=1/Math.sqrt(e*e+t*t+r*r);this.normal.x=e*a,this.normal.y=t*a,this.normal.z=r*a,this.distance*=a}cloneTo(e){this.normal.cloneTo(e.normal),e.distance=this.distance}clone(){var e=new be;return this.cloneTo(e),e}}be.PlaneIntersectionType_Back=0,be.PlaneIntersectionType_Front=1,be.PlaneIntersectionType_Intersecting=2;class Ve{constructor(e,t){this.origin=e,this.direction=t}at(e,r){t.Vector3.scale(this.direction,e,r),t.Vector3.add(this.origin,r,r)}}class Ue{}Ue.Disjoint=0,Ue.Contains=1,Ue.Intersects=2;class He{constructor(){}static distancePlaneToPoint(e,r){return t.Vector3.dot(e.normal,r)+e.distance}static distanceBoxToPoint(e,t){var r=e.min,a=r.x,i=r.y,n=r.z,s=e.max,o=s.x,l=s.y,h=s.z,d=t.x,c=t.y,u=t.z,_=0;return d<a&&(_+=(a-d)*(a-d)),d>o&&(_+=(o-d)*(o-d)),c<i&&(_+=(i-c)*(i-c)),c>l&&(_+=(l-c)*(l-c)),u<n&&(_+=(n-u)*(n-u)),u>h&&(_+=(h-u)*(h-u)),Math.sqrt(_)}static distanceBoxToBox(e,t){var r,a=e.min,i=a.x,n=a.y,s=a.z,o=e.max,l=o.x,h=o.y,d=o.z,c=t.min,u=c.x,_=c.y,f=c.z,g=t.max,m=g.x,p=g.y,S=g.z,E=0;return i>m?E+=(r=i-m)*r:u>l&&(E+=(r=u-l)*r),n>p?E+=(r=n-p)*r:_>h&&(E+=(r=_-h)*r),s>S?E+=(r=s-S)*r:f>d&&(E+=(r=f-d)*r),Math.sqrt(E)}static distanceSphereToPoint(e,r){var a=Math.sqrt(t.Vector3.distanceSquared(e.center,r));return a-=e.radius,Math.max(a,0)}static distanceSphereToSphere(e,r){var a=Math.sqrt(t.Vector3.distanceSquared(e.center,r.center));return a-=e.radius+r.radius,Math.max(a,0)}static intersectsRayAndTriangleRD(e,r,a,i,n){var s=e.origin,o=s.x,l=s.y,h=s.z,d=e.direction,c=d.x,u=d.y,_=d.z,f=r.x,g=r.y,m=r.z,p=a.x,S=a.y,E=a.z,D=i.x,T=i.y,A=i.z,x=Ge.x,R=Ge.y,M=Ge.z;x=p-f,R=S-g,M=E-m;var C=ke.x,I=ke.y,v=ke.z;C=D-f,I=T-g,v=A-m;var y=ze.x,B=ze.y,w=ze.z,L=x*(y=u*v-_*I)+R*(B=_*C-c*v)+M*(w=c*I-u*C);if(t.MathUtils3D.isZero(L))return!1;var N=1/L,P=We.x,F=We.y,O=We.z,b=(P=o-f)*y+(F=l-g)*B+(O=h-m)*w;if((b*=N)<0||b>1)return!1;var V=Qe.x,U=Qe.y,H=Qe.z,G=c*(V=F*M-O*R)+u*(U=O*x-P*M)+_*(H=P*R-F*x);if((G*=N)<0||b+G>1)return!1;var k=C*V+I*U+v*H;return!((k*=N)<0)}static intersectsRayAndTriangleRP(e,r,a,i,n){var s;return He.intersectsRayAndTriangleRD(e,r,a,i,s)?(t.Vector3.scale(e.direction,s,Ge),t.Vector3.add(e.origin,Ge,n),!0):(t.Vector3.ZERO.cloneTo(n),!1)}static intersectsRayAndPoint(e,r){t.Vector3.subtract(e.origin,r,Ge);var a=t.Vector3.dot(Ge,e.direction),i=t.Vector3.dot(Ge,Ge)-t.MathUtils3D.zeroTolerance;return!(i>0&&a>0)&&!(a*a-i<0)}static intersectsRayAndRay(e,r,a){var i=e.origin,n=i.x,s=i.y,o=i.z,l=e.direction,h=l.x,d=l.y,c=l.z,u=r.origin,_=u.x,f=u.y,g=u.z,m=r.direction,p=m.x,S=m.y,E=m.z;t.Vector3.cross(l,m,Ge);var D=Ge,T=t.Vector3.scalarLength(Ge);if(t.MathUtils3D.isZero(T)&&t.MathUtils3D.nearEqual(_,n)&&t.MathUtils3D.nearEqual(f,s)&&t.MathUtils3D.nearEqual(g,o))return t.Vector3.ZERO.cloneTo(a),!0;T*=T;var A=_-n,x=f-s,R=g-o,M=p,C=S,I=E,v=D.x,y=D.y,B=D.z,w=A*C*B+x*I*v+R*M*y-A*I*y-x*M*B-R*C*v;M=h,C=d,I=c;var L=w/T;t.Vector3.scale(l,L,Ge),t.Vector3.scale(m,L,ke),t.Vector3.add(i,Ge,ze),t.Vector3.add(u,ke,We);var N=ze,P=We;return t.MathUtils3D.nearEqual(P.x,N.x)&&t.MathUtils3D.nearEqual(P.y,N.y)&&t.MathUtils3D.nearEqual(P.z,N.z)?(a=ze,!0):(t.Vector3.ZERO.cloneTo(a),!1)}static intersectsPlaneAndTriangle(e,t,r,a){var i=He.intersectsPlaneAndPoint(e,t),n=He.intersectsPlaneAndPoint(e,r),s=He.intersectsPlaneAndPoint(e,a);return i==be.PlaneIntersectionType_Front&&n==be.PlaneIntersectionType_Front&&s==be.PlaneIntersectionType_Front?be.PlaneIntersectionType_Front:i==be.PlaneIntersectionType_Back&&n==be.PlaneIntersectionType_Back&&s==be.PlaneIntersectionType_Back?be.PlaneIntersectionType_Back:be.PlaneIntersectionType_Intersecting}static intersectsRayAndPlaneRD(e,r){var a=r.normal,i=t.Vector3.dot(a,e.direction);if(Math.abs(i)<t.MathUtils3D.zeroTolerance)return-1;var n=t.Vector3.dot(a,e.origin),s=(-r.distance-n)/i;if(s<0){if(s<-t.MathUtils3D.zeroTolerance)return-1;s=0}return s}static intersectsRayAndPlaneRP(e,r,a){var i=He.intersectsRayAndPlaneRD(e,r);if(-1==i)return a.setValue(0,0,0),!1;var n=Ge;return t.Vector3.scale(e.direction,i,n),t.Vector3.add(e.origin,n,a),!0}static intersectsRayAndBoxRD(e,r){var a=e.origin,i=a.x,n=a.y,s=a.z,o=e.direction,l=o.x,h=o.y,d=o.z,c=r.min,u=c.x,_=c.y,f=c.z,g=r.max,m=g.x,p=g.y,S=g.z,E=0,D=t.MathUtils3D.MaxValue;if(t.MathUtils3D.isZero(l)){if(i<u||i>m)return-1}else{var T=1/l,A=(u-i)*T,x=(m-i)*T;if(A>x){var R=A;A=x,x=R}if((E=Math.max(A,E))>(D=Math.min(x,D)))return-1}if(t.MathUtils3D.isZero(h)){if(n<_||n>p)return-1}else{var M=1/h,C=(_-n)*M,I=(p-n)*M;if(C>I){var v=C;C=I,I=v}if((E=Math.max(C,E))>(D=Math.min(I,D)))return-1}if(t.MathUtils3D.isZero(d)){if(s<f||s>S)return-1}else{var y=1/d,B=(f-s)*y,w=(S-s)*y;if(B>w){var L=B;B=w,w=L}if((E=Math.max(B,E))>(D=Math.min(w,D)))return-1}return E}static intersectsRayAndBoxRP(e,r,a){var i=He.intersectsRayAndBoxRD(e,r);return-1===i?(t.Vector3.ZERO.cloneTo(a),i):(t.Vector3.scale(e.direction,i,Ge),t.Vector3.add(e.origin,Ge,ke),ke.cloneTo(a),i)}static intersectsRayAndSphereRD(e,r){var a=r.radius;t.Vector3.subtract(e.origin,r.center,Ge);var i=t.Vector3.dot(Ge,e.direction),n=t.Vector3.dot(Ge,Ge)-a*a;if(n>0&&i>0)return-1;var s=i*i-n;if(s<0)return-1;var o=-i-Math.sqrt(s);return o<0&&(o=0),o}static intersectsRayAndSphereRP(e,r,a){var i=He.intersectsRayAndSphereRD(e,r);return-1===i?(t.Vector3.ZERO.cloneTo(a),i):(t.Vector3.scale(e.direction,i,Ge),t.Vector3.add(e.origin,Ge,ke),ke.cloneTo(a),i)}static intersectsSphereAndTriangle(e,r,a,i){var n=e.center,s=e.radius;return He.closestPointPointTriangle(n,r,a,i,Ge),t.Vector3.subtract(Ge,n,ke),t.Vector3.dot(ke,ke)<=s*s}static intersectsPlaneAndPoint(e,r){var a=t.Vector3.dot(e.normal,r)+e.distance;return a>0?be.PlaneIntersectionType_Front:a<0?be.PlaneIntersectionType_Back:be.PlaneIntersectionType_Intersecting}static intersectsPlaneAndPlane(e,r){t.Vector3.cross(e.normal,r.normal,Ge);var a=t.Vector3.dot(Ge,Ge);return!t.MathUtils3D.isZero(a)}static intersectsPlaneAndPlaneRL(e,r,a){var i=e.normal,n=r.normal;t.Vector3.cross(i,n,Qe);var s=t.Vector3.dot(Qe,Qe);return!t.MathUtils3D.isZero(s)&&(t.Vector3.scale(n,e.distance,Ge),t.Vector3.scale(i,r.distance,ke),t.Vector3.subtract(Ge,ke,ze),t.Vector3.cross(ze,Qe,We),t.Vector3.normalize(Qe,Qe),new Ve(We,Qe),!0)}static intersectsPlaneAndBox(e,r){var a=e.distance,i=e.normal,n=i.x,s=i.y,o=i.z,l=r.min,h=l.x,d=l.y,c=l.z,u=r.max,_=u.x,f=u.y,g=u.z;Ge.x=n>0?h:_,Ge.y=s>0?d:f,Ge.z=o>0?c:g,ke.x=n>0?_:h,ke.y=s>0?f:d,ke.z=o>0?g:c;var m=t.Vector3.dot(i,Ge);return m+a>0?be.PlaneIntersectionType_Front:(m=t.Vector3.dot(i,ke))+a<0?be.PlaneIntersectionType_Back:be.PlaneIntersectionType_Intersecting}static intersectsPlaneAndSphere(e,r){var a=r.radius,i=t.Vector3.dot(e.normal,r.center)+e.distance;return i>a?be.PlaneIntersectionType_Front:i<-a?be.PlaneIntersectionType_Back:be.PlaneIntersectionType_Intersecting}static intersectsBoxAndBox(e,t){var r=e.min,a=e.max,i=t.min,n=t.max;return!(r.x>n.x||i.x>a.x)&&(!(r.y>n.y||i.y>a.y)&&!(r.z>n.z||i.z>a.z))}static intersectsBoxAndSphere(e,r){var a=r.center,i=r.radius,n=Ge;return t.Vector3.Clamp(a,e.min,e.max,n),t.Vector3.distanceSquared(a,n)<=i*i}static intersectsSphereAndSphere(e,r){var a=e.radius+r.radius;return t.Vector3.distanceSquared(e.center,r.center)<=a*a}static boxContainsPoint(e,t){var r=e.min,a=e.max;return r.x<=t.x&&a.x>=t.x&&r.y<=t.y&&a.y>=t.y&&r.z<=t.z&&a.z>=t.z?Ue.Contains:Ue.Disjoint}static boxContainsBox(e,t){var r=e.min,a=r.x,i=r.y,n=r.z,s=e.max,o=s.x,l=s.y,h=s.z,d=t.min,c=d.x,u=d.y,_=d.z,f=t.max,g=f.x,m=f.y,p=f.z;return o<c||a>g||l<u||i>m||h<_||n>p?Ue.Disjoint:a<=c&&g<=o&&i<=u&&m<=l&&n<=_&&p<=h?Ue.Contains:Ue.Intersects}static boxContainsSphere(e,r){var a=e.min,i=a.x,n=a.y,s=a.z,o=e.max,l=o.x,h=o.y,d=o.z,c=r.center,u=c.x,_=c.y,f=c.z,g=r.radius;return t.Vector3.Clamp(c,a,o,Ge),t.Vector3.distanceSquared(c,Ge)>g*g?Ue.Disjoint:i+g<=u&&u<=l-g&&l-i>g&&n+g<=_&&_<=h-g&&h-n>g&&s+g<=f&&f<=d-g&&d-s>g?Ue.Contains:Ue.Intersects}static sphereContainsPoint(e,r){return t.Vector3.distanceSquared(r,e.center)<=e.radius*e.radius?Ue.Contains:Ue.Disjoint}static sphereContainsTriangle(e,t,r,a){var i=He.sphereContainsPoint(e,t),n=He.sphereContainsPoint(e,r),s=He.sphereContainsPoint(e,a);return i==Ue.Contains&&n==Ue.Contains&&s==Ue.Contains?Ue.Contains:He.intersectsSphereAndTriangle(e,t,r,a)?Ue.Intersects:Ue.Disjoint}static sphereContainsBox(e,r){var a=e.center;a.x,a.y,a.z;var i=e.radius,n=r.min;n.x,n.y,n.z;var s=r.max;s.x,s.y,s.z;var o=Ge;if(o.x,o.y,o.z,!He.intersectsBoxAndSphere(r,e))return Ue.Disjoint;var l=i*i;return t.Vector3.scalarLengthSquared(Ge)>l||t.Vector3.scalarLengthSquared(Ge)>l||t.Vector3.scalarLengthSquared(Ge)>l||t.Vector3.scalarLengthSquared(Ge)>l||t.Vector3.scalarLengthSquared(Ge)>l||t.Vector3.scalarLengthSquared(Ge)>l||t.Vector3.scalarLengthSquared(Ge)>l||t.Vector3.scalarLengthSquared(Ge)>l?Ue.Intersects:Ue.Contains}static sphereContainsSphere(e,r){var a=e.radius,i=r.radius,n=t.Vector3.distance(e.center,r.center);return a+i<n?Ue.Disjoint:a-i<n?Ue.Intersects:Ue.Contains}static closestPointPointTriangle(e,r,a,i,n){t.Vector3.subtract(a,r,Ge),t.Vector3.subtract(i,r,ke),t.Vector3.subtract(e,r,ze),t.Vector3.subtract(e,a,We),t.Vector3.subtract(e,i,Qe);var s=t.Vector3.dot(Ge,ze),o=t.Vector3.dot(ke,ze),l=t.Vector3.dot(Ge,We),h=t.Vector3.dot(ke,We),d=t.Vector3.dot(Ge,Qe),c=t.Vector3.dot(ke,Qe);if(s<=0&&o<=0)r.cloneTo(n);else if(l>=0&&h<=l)a.cloneTo(n);else{var u=s*h-l*o;if(u<=0&&s>=0&&l<=0){var _=s/(s-l);return t.Vector3.scale(Ge,_,n),void t.Vector3.add(r,n,n)}if(c>=0&&d<=c)i.cloneTo(n);else{var f=d*o-s*c;if(f<=0&&o>=0&&c<=0){var g=o/(o-c);return t.Vector3.scale(ke,g,n),void t.Vector3.add(r,n,n)}var m=l*c-d*h;if(m<=0&&h-l>=0&&d-c>=0){var p=(h-l)/(h-l+(d-c));return t.Vector3.subtract(i,a,n),t.Vector3.scale(n,p,n),void t.Vector3.add(a,n,n)}var S=1/(m+f+u),E=f*S,D=u*S;t.Vector3.scale(Ge,E,Ye),t.Vector3.scale(ke,D,Xe),t.Vector3.add(Ye,Xe,n),t.Vector3.add(r,n,n)}}}static closestPointPlanePoint(e,r,a){var i=e.normal,n=t.Vector3.dot(i,r)-e.distance;t.Vector3.scale(i,n,Ge),t.Vector3.subtract(r,Ge,a)}static closestPointBoxPoint(e,r,a){t.Vector3.max(r,e.min,Ge),t.Vector3.min(Ge,e.max,a)}static closestPointSpherePoint(e,r,a){var i=e.center;t.Vector3.subtract(r,i,a),t.Vector3.normalize(a,a),t.Vector3.scale(a,e.radius,a),t.Vector3.add(a,i,a)}static closestPointSphereSphere(e,r,a){var i=e.center;t.Vector3.subtract(r.center,i,a),t.Vector3.normalize(a,a),t.Vector3.scale(a,e.radius,a),t.Vector3.add(a,i,a)}}const Ge=new t.Vector3,ke=new t.Vector3,ze=new t.Vector3,We=new t.Vector3,Qe=new t.Vector3,Ye=new t.Vector3,Xe=new t.Vector3;var Ke;e.FrustumCorner=void 0,(Ke=e.FrustumCorner||(e.FrustumCorner={}))[Ke.FarBottomLeft=0]="FarBottomLeft",Ke[Ke.FarTopLeft=1]="FarTopLeft",Ke[Ke.FarTopRight=2]="FarTopRight",Ke[Ke.FarBottomRight=3]="FarBottomRight",Ke[Ke.nearBottomLeft=4]="nearBottomLeft",Ke[Ke.nearTopLeft=5]="nearTopLeft",Ke[Ke.nearTopRight=6]="nearTopRight",Ke[Ke.nearBottomRight=7]="nearBottomRight",Ke[Ke.unknown=8]="unknown";class Je{static getPlanesFromMatrix(e,t,r,a,i,n,s){var o=e.elements,l=o[0],h=o[1],d=o[2],c=o[3],u=o[4],_=o[5],f=o[6],g=o[7],m=o[8],p=o[9],S=o[10],E=o[11],D=o[12],T=o[13],A=o[14],x=o[15],R=t.normal;R.x=d,R.y=f,R.z=S,t.distance=A,t.normal=R,t.normalize();var M=r.normal;M.x=c-d,M.y=g-f,M.z=E-S,r.distance=x-A,r.normal=M,r.normalize();var C=a.normal;C.x=c+l,C.y=g+u,C.z=E+m,a.distance=x+D,a.normal=C,a.normalize();var I=i.normal;I.x=c-l,I.y=g-u,I.z=E-m,i.distance=x-D,i.normal=I,i.normalize();var v=n.normal;v.x=c-h,v.y=g-_,v.z=E-p,n.distance=x-T,n.normal=v,n.normalize();var y=s.normal;y.x=c+h,y.y=g+_,y.z=E+p,s.distance=x+T,s.normal=y,s.normalize()}constructor(e){this._matrix=e,this.initBoundingPlane()}initBoundingPlane(){this._near=new be,this._far=new be,this._left=new be,this._right=new be,this._top=new be,this._bottom=new be,Je.getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}get matrix(){return this._matrix}set matrix(e){e.cloneTo(this._matrix),Je.getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}get near(){return this._near}get far(){return this._far}get left(){return this._left}get right(){return this._right}get top(){return this._top}get bottom(){return this._bottom}equalsBoundFrustum(e){return this._matrix.equalsOtherMatrix(e.matrix)}equalsObj(e){if(e instanceof Je){var t=e;return this.equalsBoundFrustum(t)}return!1}getPlane(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}}static get3PlaneInterPoint(e,r,a,i){var n=e.normal,s=r.normal,o=a.normal;t.Vector3.cross(s,o,je),t.Vector3.cross(o,n,qe),t.Vector3.cross(n,s,Ze);var l=t.Vector3.dot(n,je),h=t.Vector3.dot(s,qe),d=t.Vector3.dot(o,Ze);t.Vector3.scale(je,-e.distance/l,$e),t.Vector3.scale(qe,-r.distance/h,et),t.Vector3.scale(Ze,-a.distance/d,tt),t.Vector3.add($e,et,rt),t.Vector3.add(tt,rt,i)}getCorners(t){Je.get3PlaneInterPoint(this._near,this._bottom,this._right,t[e.FrustumCorner.nearBottomRight]),Je.get3PlaneInterPoint(this._near,this._top,this._right,t[e.FrustumCorner.nearTopRight]),Je.get3PlaneInterPoint(this._near,this._top,this._left,t[e.FrustumCorner.nearTopLeft]),Je.get3PlaneInterPoint(this._near,this._bottom,this._left,t[e.FrustumCorner.nearBottomLeft]),Je.get3PlaneInterPoint(this._far,this._bottom,this._right,t[e.FrustumCorner.FarBottomRight]),Je.get3PlaneInterPoint(this._far,this._top,this._right,t[e.FrustumCorner.FarTopRight]),Je.get3PlaneInterPoint(this._far,this._top,this._left,t[e.FrustumCorner.FarTopLeft]),Je.get3PlaneInterPoint(this._far,this._bottom,this._left,t[e.FrustumCorner.FarBottomLeft])}containsPoint(e){for(var t=be.PlaneIntersectionType_Front,r=be.PlaneIntersectionType_Front,a=0;a<6;a++){switch(a){case 0:r=He.intersectsPlaneAndPoint(this._near,e);break;case 1:r=He.intersectsPlaneAndPoint(this._far,e);break;case 2:r=He.intersectsPlaneAndPoint(this._left,e);break;case 3:r=He.intersectsPlaneAndPoint(this._right,e);break;case 4:r=He.intersectsPlaneAndPoint(this._top,e);break;case 5:r=He.intersectsPlaneAndPoint(this._bottom,e)}switch(r){case be.PlaneIntersectionType_Back:return Ue.Disjoint;case be.PlaneIntersectionType_Intersecting:t=be.PlaneIntersectionType_Intersecting}}return t===be.PlaneIntersectionType_Intersecting?Ue.Intersects:Ue.Contains}intersects(e){var t=e.min,r=e.max,a=t.x,i=t.y,n=t.z,s=r.x,o=r.y,l=r.z,h=this._near.normal;if(this._near.distance+h.x*(h.x<0?a:s)+h.y*(h.y<0?i:o)+h.z*(h.z<0?n:l)<0)return!1;var d=this._left.normal;if(this._left.distance+d.x*(d.x<0?a:s)+d.y*(d.y<0?i:o)+d.z*(d.z<0?n:l)<0)return!1;var c=this._right.normal;if(this._right.distance+c.x*(c.x<0?a:s)+c.y*(c.y<0?i:o)+c.z*(c.z<0?n:l)<0)return!1;var u=this._bottom.normal;if(this._bottom.distance+u.x*(u.x<0?a:s)+u.y*(u.y<0?i:o)+u.z*(u.z<0?n:l)<0)return!1;var _=this._top.normal;if(this._top.distance+_.x*(_.x<0?a:s)+_.y*(_.y<0?i:o)+_.z*(_.z<0?n:l)<0)return!1;var f=this._far.normal;return!(this._far.distance+f.x*(f.x<0?a:s)+f.y*(f.y<0?i:o)+f.z*(f.z<0?n:l)<0)}containsBoundBox(e){for(var t=je,r=qe,a=e.min,i=e.max,n=Ue.Contains,s=0;s<6;s++){var o=this.getPlane(s),l=o.normal;if(l.x>=0?(t.x=i.x,r.x=a.x):(t.x=a.x,r.x=i.x),l.y>=0?(t.y=i.y,r.y=a.y):(t.y=a.y,r.y=i.y),l.z>=0?(t.z=i.z,r.z=a.z):(t.z=a.z,r.z=i.z),He.intersectsPlaneAndPoint(o,t)===be.PlaneIntersectionType_Back)return Ue.Disjoint;He.intersectsPlaneAndPoint(o,r)===be.PlaneIntersectionType_Back&&(n=Ue.Intersects)}return n}containsBoundSphere(e){for(var t=be.PlaneIntersectionType_Front,r=be.PlaneIntersectionType_Front,a=0;a<6;a++){switch(a){case 0:r=He.intersectsPlaneAndSphere(this._near,e);break;case 1:r=He.intersectsPlaneAndSphere(this._far,e);break;case 2:r=He.intersectsPlaneAndSphere(this._left,e);break;case 3:r=He.intersectsPlaneAndSphere(this._right,e);break;case 4:r=He.intersectsPlaneAndSphere(this._top,e);break;case 5:r=He.intersectsPlaneAndSphere(this._bottom,e)}switch(r){case be.PlaneIntersectionType_Back:return Ue.Disjoint;case be.PlaneIntersectionType_Intersecting:t=be.PlaneIntersectionType_Intersecting}}return t===be.PlaneIntersectionType_Intersecting?Ue.Intersects:Ue.Contains}cloneTo(e){e.matrix=this.matrix}clone(){let e=new Je(new t.Matrix4x4);return this.cloneTo(e),e}}const je=new t.Vector3,qe=new t.Vector3,Ze=new t.Vector3,$e=new t.Vector3,et=new t.Vector3,tt=new t.Vector3,rt=new t.Vector3;var at,it,nt,st,ot;e.ShadowMode=void 0,(at=e.ShadowMode||(e.ShadowMode={}))[at.None=0]="None",at[at.Hard=1]="Hard",at[at.SoftLow=2]="SoftLow",at[at.SoftHigh=3]="SoftHigh",e.LightType=void 0,(it=e.LightType||(e.LightType={}))[it.Directional=0]="Directional",it[it.Spot=1]="Spot",it[it.Point=2]="Point",it[it.Area=3]="Area",e.LightMode=void 0,(nt=e.LightMode||(e.LightMode={}))[nt.mix=0]="mix",nt[nt.realTime=1]="realTime",nt[nt.bakeOnly=2]="bakeOnly";class lt extends t.Component{get intensity(){return this._intensity}set intensity(e){this._intensity=e}get shadowMode(){return this._dataModule.shadowMode}set shadowMode(e){this._dataModule.shadowMode=e}get shadowDistance(){return this._dataModule.shadowDistance}set shadowDistance(e){this._dataModule.shadowDistance=e}get shadowResolution(){return this._dataModule.shadowResolution}set shadowResolution(e){this._dataModule.shadowResolution=e}get shadowDepthBias(){return this._dataModule.shadowDepthBias}set shadowDepthBias(e){this._dataModule.shadowDepthBias=e}get shadowNormalBias(){return this._dataModule.shadowNormalBias}set shadowNormalBias(e){this._dataModule.shadowNormalBias=e}get shadowStrength(){return this._dataModule.shadowStrength}set shadowStrength(e){this._dataModule.shadowStrength=e}get shadowNearPlane(){return this._dataModule.shadowNearPlane}set shadowNearPlane(e){this._dataModule.shadowNearPlane=e}get lightmapBakedType(){return this._lightmapBakedType}set lightmapBakedType(t){let r=this._lightmapBakedType;this._lightmapBakedType!==t&&(this._lightmapBakedType=t,this._enabled&&(t==e.LightMode.bakeOnly?this._removeFromScene():r==e.LightMode.bakeOnly&&this._addToScene()))}get lightWorldMatrix(){var e=this.owner.transform.position,r=this.owner.transform.rotation;return t.Matrix4x4.createAffineTransformation(e,r,t.Vector3.ONE,this._lightWoldMatrix),this._lightWoldMatrix}get lightType(){return this._lightType}constructor(){super(),this._shadowMode=e.ShadowMode.None,this._isAlternate=!1,this._lightWoldMatrix=new t.Matrix4x4,this._creatModuleData(),this.runInEditor=!0,this._intensity=1,this._intensityColor=new t.Vector3,this.color=new t.Color(1,1,1,1),this._lightmapBakedType=e.LightMode.realTime,this.shadowResolution=2048,this.shadowDistance=50,this.shadowDepthBias=1,this.shadowNormalBias=1,this.shadowNearPlane=.1,this.shadowStrength=1,this.shadowMode=e.ShadowMode.None}_creatModuleData(){}_setOwner(e){super._setOwner(e),this._dataModule.transform=this.owner.transform}_getRenderDataModule(){return this._dataModule}_cloneTo(e){super._cloneTo(e),e.color=this.color.clone(),e.intensity=this.intensity,e.lightmapBakedType=this.lightmapBakedType}_addToScene(){var e=this.owner.scene,r=t.Config3D.maxLightCount;e._lightCount<r?(e._lightCount++,this._addToLightQueue(),this._isAlternate=!1):(e._alternateLights.add(this),this._isAlternate=!0,console.warn("LightSprite:light count has large than maxLightCount,the latest added light will be ignore."))}_removeFromScene(){var e=this.owner._scene;if(e)if(this._isAlternate)e._alternateLights.remove(this);else if(e._lightCount--,this._removeFromLightQueue(),e._alternateLights._length>0){var t=e._alternateLights.shift();t._addToLightQueue(),t._isAlternate=!1,e._lightCount++}}_addToLightQueue(){}_removeFromLightQueue(){}_onEnable(){this.lightmapBakedType!==e.LightMode.bakeOnly&&this._addToScene()}_onDisable(){this.lightmapBakedType!==e.LightMode.bakeOnly&&this._removeFromScene()}}!function(e){e[e.Near=0]="Near",e[e.Far=1]="Far",e[e.Left=2]="Left",e[e.Right=3]="Right",e[e.Bottom=4]="Bottom",e[e.Top=5]="Top"}(st||(st={})),e.ShadowMapFormat=void 0,(ot=e.ShadowMapFormat||(e.ShadowMapFormat={}))[ot.bit16=0]="bit16",ot[ot.bit24_8=1]="bit24_8",ot[ot.bit32=2]="bit32";class ht{static init(){ht._adjustNearPlane=new be(new t.Vector3,0),ht._adjustFarPlane=new be(new t.Vector3,0)}static supportShadow(){return t.LayaGL.renderEngine.getCapable(t.RenderCapable.RenderTextureFormat_Depth)}static getTemporaryShadowTexture(r,a,i){let n=t.RenderTargetFormat.DEPTH_16;switch(i){case e.ShadowMapFormat.bit16:n=t.RenderTargetFormat.DEPTH_16;break;case e.ShadowMapFormat.bit24_8:n=t.RenderTargetFormat.DEPTHSTENCIL_24_8;break;case e.ShadowMapFormat.bit32:n=t.RenderTargetFormat.DEPTH_32}var s=t.RenderTexture.createFromPool(r,a,n,t.RenderTargetFormat.None,!1,1);return s.compareMode=t.TextureCompareMode.LESS,s.filterMode=t.FilterMode.Bilinear,s.wrapModeU=t.WrapMode.Clamp,s.wrapModeV=t.WrapMode.Clamp,s}static getShadowBias(r,a,i,n){var s;r._lightType==e.LightType.Directional?s=2/a.elements[0]:r._lightType==e.LightType.Spot?s=Math.tan(.5*r.spotAngle*t.MathUtils3D.Deg2Rad)*r.range:(console.warn("ShadowUtils:Only spot and directional shadow casters are supported now."),s=0);var o=s/i,l=-r.shadowDepthBias*o,h=-r.shadowNormalBias*o;if(r.shadowMode==e.ShadowMode.SoftHigh){const e=2.5;l*=e,h*=e}n.setValue(l,h,0,0)}static getCameraFrustumPlanes(e,t){Je.getPlanesFromMatrix(e,t[st.Near],t[st.Far],t[st.Left],t[st.Right],t[st.Top],t[st.Bottom])}static getFarWithRadius(e,t){return Math.sqrt(e*e/t)}static getCascadesSplitDistance(t,r,a,i,n,s,o,l){l[0]=a;var h=i-a,d=Math.tan(.5*n),c=1+d*d*(s*s+1);switch(o){case e.ShadowCascadesMode.NoCascades:l[1]=ht.getFarWithRadius(i,c);break;case e.ShadowCascadesMode.TwoCascades:l[1]=ht.getFarWithRadius(a+h*t,c),l[2]=ht.getFarWithRadius(i,c);break;case e.ShadowCascadesMode.FourCascades:l[1]=ht.getFarWithRadius(a+h*r.x,c),l[2]=ht.getFarWithRadius(a+h*r.y,c),l[3]=ht.getFarWithRadius(a+h*r.z,c),l[4]=ht.getFarWithRadius(i,c)}}static applySliceTransform(e,t,r,a,i){var n=dt.elements,s=1/t,o=1/r;n[0]=e.resolution*s,n[5]=e.resolution*o,n[12]=e.offsetX*s,n[13]=e.offsetY*o,n[1]=n[2]=n[2]=n[4]=n[6]=n[7]=n[8]=n[9]=n[11]=n[14]=0,n[10]=n[15]=1;var l=16*a;K._mulMatrixArray(n,i,l,i,l)}static getDirectionLightShadowCullPlanes(r,a,i,n,s,o){var l=_t,h=ht._backPlaneFaces,d=ft,c=gt,u=ht._edgePlanePoint2,_=o.cullPlanes,f=r[st.Near],g=r[st.Far],m=r[st.Left],p=r[st.Right],S=r[st.Bottom],E=r[st.Top],D=i[a]-n,T=ht._adjustNearPlane,A=ht._adjustFarPlane;T.normal=f.normal,A.normal=g.normal,T.distance=f.distance-D,A.distance=Math.min(-f.distance+o.sphereCenterZ+o.splitBoundSphere.radius,g.distance),Je.get3PlaneInterPoint(T,S,p,l[e.FrustumCorner.nearBottomRight]),Je.get3PlaneInterPoint(T,E,p,l[e.FrustumCorner.nearTopRight]),Je.get3PlaneInterPoint(T,E,m,l[e.FrustumCorner.nearTopLeft]),Je.get3PlaneInterPoint(T,S,m,l[e.FrustumCorner.nearBottomLeft]),Je.get3PlaneInterPoint(A,S,p,l[e.FrustumCorner.FarBottomRight]),Je.get3PlaneInterPoint(A,E,p,l[e.FrustumCorner.FarTopRight]),Je.get3PlaneInterPoint(A,E,m,l[e.FrustumCorner.FarTopLeft]),Je.get3PlaneInterPoint(A,S,m,l[e.FrustumCorner.FarBottomLeft]);for(var x=0,R=0;R<6;R++){var M;switch(R){case st.Near:M=T;break;case st.Far:M=A;break;default:M=r[R]}t.Vector3.dot(M.normal,s)<0&&(M.cloneTo(_[x]),h[x]=R,x++)}var C=x;for(R=0;R<x;R++)for(var I=h[R],v=d[I],y=0;y<4;y++){for(var B=v[y],w=!0,L=0;L<x;L++)if(B==h[L]){w=!1;break}if(w){var N=c[I][B],P=l[N[0]],F=l[N[1]];t.Vector3.add(P,s,u),be.createPlaneBy3P(P,F,u,_[C++])}}o.cullPlaneCount=C}static getBoundSphereByFrustum(e,r,a,i,n,s,o){var l,h,d=Math.sqrt(1+i*i)*Math.tan(a/2),c=d*d,u=r-e,_=r+e;c>u/_?(l=r,h=r*d):(l=.5*_*(1+c),h=.5*Math.sqrt(u*u+2*(r*r+e*e)*c+_*_*c*c));var f=o.center;return o.radius=h,t.Vector3.scale(s,l,f),t.Vector3.add(n,f,f),o.center=f,l}static getMaxTileResolutionInAtlas(e,t,r){for(var a=Math.min(e,t),i=Math.floor(e/a)*Math.floor(t/a);i<r;)a=Math.floor(a>>1),i=Math.floor(e/a)*Math.floor(t/a);return a}static getDirectionalLightMatrices(e,r,a,i,n,s,o,l){var h=o.splitBoundSphere,d=h.center,c=h.radius,u=s/2,_=c*u/(u-ht.atlasBorderSize),f=2*_,g=s/f,m=f/s,p=Math.ceil(t.Vector3.dot(d,e)*g)*m,S=Math.ceil(t.Vector3.dot(d,r)*g)*m,E=t.Vector3.dot(d,a);d.x=e.x*p+r.x*S+a.x*E,d.y=e.y*p+r.y*S+a.y*E,d.z=e.z*p+r.z*S+a.z*E,h.center=d;var D=o.position,T=o.viewMatrix,A=o.projectionMatrix,x=o.viewProjectMatrix;o.resolution=s,o.offsetX=i%2*s,o.offsetY=Math.floor(i/2)*s,t.Vector3.scale(a,c+n,D),t.Vector3.subtract(d,D,D),t.Matrix4x4.createLookAt(D,d,e,T),t.Matrix4x4.createOrthoOffCenter(-_,_,-_,_,0,2*c+n,A),t.Matrix4x4.multiply(A,T,x);let R=ct.elements;t.LayaGL.renderEngine._screenInvertY&&(R=ut.elements),K._mulMatrixArray(R,x.elements,0,l,16*i)}static prepareShadowReceiverShaderValues(e,t,r,a,i,n,s){if(i.setValue(1/e,1/t,e,t),a>1){const e=16;for(var o=a*e,l=4*e;o<l;o++)n[o]=0;for(o=0;o<a;o++){var h=r[o].splitBoundSphere,d=h.center,c=h.radius,u=4*o;s[u]=d.x,s[u+1]=d.y,s[u+2]=d.z,s[u+3]=c*c}const t=4;for(o=a*t,l=4*t;o<l;o++)s[o]=0}}}ht._backPlaneFaces=new Array(5),ht._edgePlanePoint2=new t.Vector3,ht.atlasBorderSize=4;const dt=new t.Matrix4x4,ct=new t.Matrix4x4(.5,0,0,0,0,.5,0,0,0,0,1,0,.5,.5,0,1),ut=new t.Matrix4x4(.5,0,0,0,0,-.5,0,0,0,0,1,0,.5,.5,0,1),_t=[new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3],ft=[[st.Left,st.Right,st.Top,st.Bottom],[st.Left,st.Right,st.Top,st.Bottom],[st.Near,st.Far,st.Top,st.Bottom],[st.Near,st.Far,st.Top,st.Bottom],[st.Near,st.Far,st.Left,st.Right],[st.Near,st.Far,st.Left,st.Right]],gt=[[[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.nearTopLeft],[e.FrustumCorner.nearTopRight,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.nearBottomRight,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.nearTopLeft,e.FrustumCorner.nearTopRight]],[[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.FarTopRight],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.FarTopRight,e.FrustumCorner.FarTopLeft]],[[e.FrustumCorner.nearTopLeft,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.FarTopLeft],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.nearTopLeft]],[[e.FrustumCorner.nearBottomRight,e.FrustumCorner.nearTopRight],[e.FrustumCorner.FarTopRight,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.nearTopRight,e.FrustumCorner.FarTopRight]],[[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.nearBottomRight,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown]],[[e.FrustumCorner.nearTopRight,e.FrustumCorner.nearTopLeft],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.FarTopRight],[e.FrustumCorner.nearTopLeft,e.FrustumCorner.FarTopLeft],[e.FrustumCorner.FarTopRight,e.FrustumCorner.nearTopRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown]]];class mt{static __init__(){mt.SHADOW_BIAS=t.Shader3D.propertyNameToID("u_ShadowBias"),mt.SHADOW_LIGHT_DIRECTION=t.Shader3D.propertyNameToID("u_ShadowLightDirection"),mt.SHADOW_SPLIT_SPHERES=t.Shader3D.propertyNameToID("u_ShadowSplitSpheres"),mt.SHADOW_MATRICES=t.Shader3D.propertyNameToID("u_ShadowMatrices"),mt.SHADOW_MAP_SIZE=t.Shader3D.propertyNameToID("u_ShadowMapSize"),mt.SHADOW_MAP=t.Shader3D.propertyNameToID("u_ShadowMap"),mt.SHADOW_PARAMS=t.Shader3D.propertyNameToID("u_ShadowParams"),mt.SHADOW_SPOTMAP_SIZE=t.Shader3D.propertyNameToID("u_SpotShadowMapSize"),mt.SHADOW_SPOTMAP=t.Shader3D.propertyNameToID("u_SpotShadowMap"),mt.SHADOW_SPOTMATRICES=t.Shader3D.propertyNameToID("u_SpotViewProjectMatrix");const r=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Shadow");r.addShaderUniform(mt.SHADOW_LIGHT_DIRECTION,"u_ShadowLightDirection",e.ShaderDataType.Vector3),r.addShaderUniform(mt.SHADOW_BIAS,"u_ShadowBias",e.ShaderDataType.Vector4),r.addShaderUniformArray(mt.SHADOW_SPLIT_SPHERES,"u_ShadowSplitSpheres",e.ShaderDataType.Vector4,4),r.addShaderUniformArray(mt.SHADOW_MATRICES,"u_ShadowMatrices",e.ShaderDataType.Matrix4x4,4),r.addShaderUniform(mt.SHADOW_MAP_SIZE,"u_ShadowMapSize",e.ShaderDataType.Vector4),r.addShaderUniform(mt.SHADOW_MAP,"u_ShadowMap",e.ShaderDataType.Texture2D),r.addShaderUniform(mt.SHADOW_PARAMS,"u_ShadowParams",e.ShaderDataType.Vector4),r.addShaderUniform(mt.SHADOW_SPOTMAP_SIZE,"u_SpotShadowMapSize",e.ShaderDataType.Vector4),r.addShaderUniform(mt.SHADOW_SPOTMAP,"u_SpotShadowMap",e.ShaderDataType.Texture2D),r.addShaderUniform(mt.SHADOW_SPOTMATRICES,"u_SpotViewProjectMatrix",e.ShaderDataType.Matrix4x4),this.ShadowUniformMap=r}constructor(){}getDirectLightShadowMap(r){var a,i,n,s,o=r.shadowResolution,l=r.shadowCascadesMode;return l==e.ShadowCascadesMode.NoCascades?(s=o,a=o,i=o):(n=l==e.ShadowCascadesMode.TwoCascades?2:4,a=2*(s=ht.getMaxTileResolutionInAtlas(o,o,n)),i=l==e.ShadowCascadesMode.TwoCascades?s:2*s),this._shadowDirectLightMap&&t.RenderTexture.recoverToPool(this._shadowDirectLightMap),this._shadowDirectLightMap=ht.getTemporaryShadowTexture(a,i,e.ShadowMapFormat.bit16),this._shadowDirectLightMap}getSpotLightShadowPassData(r){this._shadowSpotLightMap&&t.RenderTexture.recoverToPool(this._shadowSpotLightMap);var a=r.shadowResolution,i=a,n=a;return this._shadowSpotLightMap=ht.getTemporaryShadowTexture(i,n,e.ShadowMapFormat.bit16),this._shadowSpotLightMap}getPointLightShadowPassData(){}cleanUp(){this._shadowDirectLightMap&&t.RenderTexture.recoverToPool(this._shadowDirectLightMap),this._shadowSpotLightMap&&t.RenderTexture.recoverToPool(this._shadowSpotLightMap),this._shadowDirectLightMap=null,this._shadowSpotLightMap=null}}class pt{static __init__(){pt.DEPTHPASS=t.Shader3D.getDefineByName("DEPTHPASS"),pt.DEFINE_SHADOW_BIAS=t.Shader3D.propertyNameToID("u_ShadowBias"),pt.DEPTHTEXTURE=t.Shader3D.propertyNameToID("u_CameraDepthTexture"),pt.DEPTHNORMALSTEXTURE=t.Shader3D.propertyNameToID("u_CameraDepthNormalsTexture"),pt.DEPTHZBUFFERPARAMS=t.Shader3D.propertyNameToID("u_ZBufferParams")}constructor(){}getTarget(e,r,a){switch(this._viewPort=e.viewport,r){case t.DepthTextureMode.Depth:e.depthTexture=this._depthTexture=t.RenderTexture.createFromPool(this._viewPort.width,this._viewPort.height,a,t.RenderTargetFormat.None,!1,1);break;case t.DepthTextureMode.DepthNormals:e.depthNormalTexture=this._depthNormalsTexture=t.RenderTexture.createFromPool(this._viewPort.width,this._viewPort.height,t.RenderTargetFormat.R8G8B8A8,a,!1,1);break;case t.DepthTextureMode.MotionVectors:break;default:throw"there is UnDefined type of DepthTextureMode"}}_setupDepthModeShaderValue(e,r){if(e!==t.DepthTextureMode.Depth)throw"there is UnDefined type of DepthTextureMode";var a=r.farPlane,i=r.nearPlane;this._zBufferParams.setValue(1-a/i,a/i,(i-a)/(i*a),1/i),r._shaderValues.setVector(pt.DEFINE_SHADOW_BIAS,pt.SHADOW_BIAS),r._shaderValues.setTexture(pt.DEPTHTEXTURE,this._depthTexture),r._shaderValues.setVector(pt.DEPTHZBUFFERPARAMS,this._zBufferParams)}cleanUp(){this._depthTexture instanceof t.RenderTexture&&this._depthTexture&&t.RenderTexture.recoverToPool(this._depthTexture),this._depthNormalsTexture&&t.RenderTexture.recoverToPool(this._depthNormalsTexture),this._depthTexture=null,this._depthNormalsTexture=null}}pt.SHADOW_BIAS=new t.Vector4;class St{constructor(){}static calculateCursorRay(e,r,a,i,n,s){var o=e.x,l=e.y,h=Et,d=h;d.x=o,d.y=l,d.z=r.minDepth;var c=Dt,u=c;u.x=o,u.y=l,u.z=r.maxDepth;var _=s.origin,f=Tt;r.unprojectFromWVP(h,a,i,n,_),r.unprojectFromWVP(c,a,i,n,f);var g=s.direction;g.x=f.x-_.x,g.y=f.y-_.y,g.z=f.z-_.z,t.Vector3.normalize(s.direction,s.direction)}static rayIntersectsTriangle(e,r,a,i){var n=Et,s=Dt;t.Vector3.subtract(a,r,n),t.Vector3.subtract(i,r,s);var o,l=Tt;if(t.Vector3.cross(e.direction,s,l),(o=t.Vector3.dot(n,l))>-Number.MIN_VALUE&&o<Number.MIN_VALUE)return Number.NaN;var h,d=1/o,c=At;if(t.Vector3.subtract(e.origin,r,c),h=t.Vector3.dot(c,l),(h*=d)<0||h>1)return Number.NaN;var u,_,f=xt;return t.Vector3.cross(c,n,f),u=t.Vector3.dot(e.direction,f),(u*=d)<0||h+u>1?Number.NaN:(_=t.Vector3.dot(s,f),(_*=d)<0?Number.NaN:_)}static rayPlaneIntersection(e,r){let a=new t.Vector3,i=t.Vector3.dot(e.direction.normalize(),r.normal.normalize());if(0==i)return null;let n=(-r.distance-t.Vector3.dot(e.origin,r.normal))/i;return n<0?null:(e.at(n,a),a)}}const Et=new t.Vector3,Dt=new t.Vector3,Tt=new t.Vector3,At=new t.Vector3,xt=new t.Vector3;class Rt extends xe{static __init__(){Rt._vertexDeclaration=new t.VertexDeclaration(16,[new t.VertexElement(0,t.VertexElementFormat.Vector4,Rt.SCREENQUAD_POSITION_UV)]),Rt.instance=new Rt,Rt.instance.invertY=!0,Rt.InvertInstance=new Rt,Rt.InvertInstance.invertY=!1}constructor(){super(t.MeshTopology.TriangleStrip,t.DrawType.DrawArray),this._bufferState=new t.BufferState,this._bufferStateInvertUV=new t.BufferState,this.setDrawArrayParams(0,4),this._vertexBuffer=E.renderOBJCreate.createVertexBuffer3D(64,t.BufferUsage.Static,!1),this._vertexBuffer.vertexDeclaration=Rt._vertexDeclaration,this._vertexBuffer.setData(Rt._vertices.buffer),this._bufferState.applyState([this._vertexBuffer],null),this._vertexBufferInvertUV=E.renderOBJCreate.createVertexBuffer3D(64,t.BufferUsage.Static,!1),this._vertexBufferInvertUV.vertexDeclaration=Rt._vertexDeclaration,this._vertexBufferInvertUV.setData(Rt._verticesInvertUV.buffer),this._bufferStateInvertUV.applyState([this._vertexBufferInvertUV],null),this.invertY=!1}set invertY(e){e=t.LayaGL.renderEngine._screenInvertY?!e:e,this.bufferState=e?this._bufferStateInvertUV:this._bufferState}_updateRenderParams(e){}destroy(){super.destroy(),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferStateInvertUV.destroy(),this._vertexBufferInvertUV.destroy()}}Rt.SCREENQUAD_POSITION_UV=0,Rt._vertices=new Float32Array([1,1,1,1,1,-1,1,0,-1,1,0,1,-1,-1,0,0]),Rt._verticesInvertUV=new Float32Array([1,1,1,0,1,-1,1,1,-1,1,0,0,-1,-1,0,1]);class Mt extends Q{static create(e,t,r=null,a=null,i=null,n=0,s=Mt._SCREENTYPE_QUAD,o=null){var l;return(l=Mt._pool.length>0?Mt._pool.pop():new Mt)._source=e,l.dest=t,l.offsetScale=r||Mt._defaultOffsetScale,l.setshader(a,n,i),l._commandBuffer=o,l}constructor(){super(),this._source=null,this._dest=null,this._offsetScale=new t.Vector4,this._shader=null,this._shaderData=null,this._internalShaderData=null,this._subShader=0,this._blitQuadCMDData=E.Render3DPassFactory.createBlitQuadCMDData(),this._transform3D=E.Render3DModuleDataFactory.createTransform(null),this._renderElement=new H,this._renderElement.setTransform(this._transform3D),this._renderElement.setGeometry(Rt.instance),this._blitQuadCMDData.element=this._renderElement._renderElementOBJ,this._blitQuadCMDData.element.isRender=!0}get offsetScale(){return this._offsetScale}set offsetScale(e){e.cloneTo(this._offsetScale),this._blitQuadCMDData.offsetScale=e}get dest(){return this._dest}set dest(e){this._dest=e,this._blitQuadCMDData.dest=e?e._renderTarget:null}set shaderData(e){e?this._shaderData=e:(this._internalShaderData||(this._internalShaderData=t.LayaGL.renderDeviceFactory.createShaderData()),this._internalShaderData.clearData(),this._shaderData=this._internalShaderData),this._renderElement._renderElementOBJ.materialShaderData=this._shaderData}getRenderCMD(){return this._blitQuadCMDData}setshader(e,t,r){this._shader=e||Q._screenShader,this._subShader=t||0,this.shaderData=r,this._renderElement.renderSubShader=this._shader.getSubShaderAt(this._subShader),this._renderElement._subShaderIndex=t}run(){var e;if(this._source)e=this._source;else{if(!this._commandBuffer._camera._internalRenderTexture)throw"camera internalRenderTexture is null,please set camera enableBuiltInRenderTexture";e=this._commandBuffer._camera._internalRenderTexture}this._blitQuadCMDData.source=e._texture;var r=this._dest?this._dest:this._commandBuffer._camera._internalRenderTexture;if(r!=this._dest&&(this._blitQuadCMDData.dest=r._renderTarget),r)t.Viewport.TEMP.set(0,0,r.width,r.height),t.Vector4.TEMP.setValue(0,0,r.width,r.height),this._blitQuadCMDData.viewport=t.Viewport.TEMP,this._blitQuadCMDData.scissor=t.Vector4.TEMP;else{let e=this._commandBuffer._camera.viewport,r=e.height,a=Y.clientHeight-e.y-r;t.Viewport.TEMP.set(e.x,a,e.width,r),t.Vector4.TEMP.setValue(e.x,a,e.width,r),this._blitQuadCMDData.viewport=t.Viewport.TEMP,this._blitQuadCMDData.scissor=t.Vector4.TEMP}let a=!!r;this._renderElement.setGeometry(a?Rt.InvertInstance:Rt.instance),t.Stat.blitDrawCall++}recover(){Mt._pool.push(this),this._source=null,this._dest=null,Mt._defaultOffsetScale.cloneTo(this._offsetScale),this._shader=null,this._shaderData=null,super.recover()}destroy(){this._source=null,this.dest=null,this._offsetScale=null,this._shader=null,this._shaderData=null,this._internalShaderData&&this._internalShaderData.destroy(),this._internalShaderData=null,this._renderElement.destroy()}}Mt._SCREENTYPE_QUAD=0,Mt._SCREENTYPE_TRIANGLE=1,Mt._pool=[],Mt._defaultOffsetScale=new t.Vector4(0,0,1,1);class Ct extends Q{static create(e,t,r,a,i){var n;return(n=Ct._pool.length>0?Ct._pool.pop():new Ct)._setRenderDataCMD.dest=e,n._setRenderDataCMD.propertyID=t,n._setRenderDataCMD.dataType=a,n._setRenderDataCMD.value=r,n._commandBuffer=i,n}constructor(){super(),this._setRenderDataCMD=E.Render3DPassFactory.createSetRenderDataCMD()}getRenderCMD(){return this._setRenderDataCMD}recover(){Ct._pool.push(this)}}Ct.ShaderDataType_define=-2,Ct._pool=[];class It extends Q{static create(e,t,r,a){var i;return(i=It._pool.length>0?It._pool.pop():new It)._setRenderDefineCMD.dest=e,i._setRenderDefineCMD.add=r,i._setRenderDefineCMD.define=t,i._commandBuffer=a,i}constructor(){super(),this._setRenderDefineCMD=E.Render3DPassFactory.createSetShaderDefineCMD()}getRenderCMD(){return this._setRenderDefineCMD}recover(){It._pool.push(this)}}It._pool=[];class vt extends Q{static create(e,t,r,a,i,n){var s;return(s=vt._pool.length>0?vt._pool.pop():new vt)._matrix=t,s._transform.worldMatrix=s._matrix,s.material=r,s.subMeshIndex=a,s._subShaderIndex=i,s.mesh=e,s._commandBuffer=n,s}get subMeshIndex(){return this._subMeshIndex}set subMeshIndex(e){this._subMeshIndex=e,this._drawRenderCMDDData.subMeshIndex=e}constructor(){super(),this._drawRenderCMDDData=E.Render3DPassFactory.createDrawNodeCMDData(),this._transform=E.Render3DModuleDataFactory.createTransform(null),this._meshRender=new k}set material(e){this._material&&this._material._removeReference(1),this._material=e,this._material&&this._material._addReference(1)}get material(){return this._material}set mesh(e){this._mesh!=e&&(this._mesh=e,this._meshRender._onMeshChange(this._mesh),this._renderElemnts=this._meshRender._renderElements,this._renderElemnts.forEach((e=>{e.material=this._material,e.setTransform(this._transform),e.renderSubShader=this._material._shader.getSubShaderAt(this._subShaderIndex),e._subShaderIndex=this._subShaderIndex})))}getRenderCMD(){return this._drawRenderCMDDData}run(){this._meshRender.sharedMaterial=this.material,this._meshRender._baseRenderNode.transform=this._transform,this._meshRender.renderUpdate(Y._instance),this._meshRender.probReflection=Y._instance.scene.sceneReflectionProb,this._drawRenderCMDDData.destSubShader=this.material.shader.getSubShaderAt(this._subShaderIndex),this._drawRenderCMDDData.destShaderData=this.material.shaderData,this._drawRenderCMDDData.node=this._meshRender._baseRenderNode}recover(){vt._pool.push(this),super.recover(),this._material&&(this.material=null),this._mesh&&(this.mesh=null)}destroy(){super.destroy(),this._renderElemnts.forEach((e=>{e.destroy()})),this._material&&this._material._removeReference(1),this._material=null,this._renderElemnts=null,this._transform=null,this._material=null,this._matrix=null}}vt._pool=[];class yt extends Q{static create(e,t,r,a){var i;return(i=yt._pool.length>0?yt._pool.pop():new yt).render=e,i.material=t,i.subMeshIndex=r,i._commandBuffer=a,i}get render(){return this._render}set render(e){this._drawNodeCMDData.node=e._baseRenderNode,this._render=e}get material(){return this._material}set material(e){this._material&&this._material._removeReference(1),e?(e._addReference(1),this._drawNodeCMDData.destShaderData=e.shaderData,this._drawNodeCMDData.destSubShader=e.shader.getSubShaderAt(0)):(this._drawNodeCMDData.destShaderData=null,this._drawNodeCMDData.destSubShader=null),this._material=e}get subMeshIndex(){return this._subMeshIndex}set subMeshIndex(e){this._subMeshIndex=e,this._drawNodeCMDData.subMeshIndex=e}constructor(){super(),this._drawNodeCMDData=E.Render3DPassFactory.createDrawNodeCMDData()}getRenderCMD(){return this._drawNodeCMDData}run(){this.render&&(this.render.renderUpdate(this._context),this._prematerial=this.render.sharedMaterials[this.subMeshIndex])}recover(){yt._pool.push(this),super.recover(),this.material=null,this.render.sharedMaterials[this.subMeshIndex]=this._prematerial,this._render=null,this.subMeshIndex=0}destroy(){super.destroy(),this.material=null}}yt._pool=[];class Bt extends Q{static create(e,r,a,i){let n=Y._instance,s=n._contextOBJ.globalShaderData;return s||(s=n._contextOBJ.globalShaderData=t.LayaGL.renderDeviceFactory.createShaderData(null)),Ct.create(s,e,r,a,i)}}class wt extends xe{constructor(e){super(e?e._geometryElementOBj.mode:t.MeshTopology.Triangles,t.DrawType.DrawElementInstance),this._subMesh=e,e&&(this.indexFormat=e._mesh.indexFormat)}set subMesh(e){this._subMesh=e,e&&(this.indexFormat=e._mesh.indexFormat),this.mode=e._geometryElementOBj.mode}get subMesh(){return this._subMesh}_updateRenderParams(e){let r;switch(this.clearRenderParams(),this.indexFormat){case t.IndexFormat.UInt32:r=4;break;case t.IndexFormat.UInt16:r=2;break;case t.IndexFormat.UInt8:r=1}this.setDrawElemenParams(this._subMesh.indexCount,this._subMesh._indexStart*r)}}class Lt extends Q{static create(e,t,r,a,i,n,s,o){var l;if(r&&r.length>Lt.maxInstanceCount||s>Lt.maxInstanceCount)throw"the number of renderings exceeds the maximum number of merges";return(l=Lt._pool.length>0?Lt._pool.pop():new Lt)._matrixs=r,l.material=a,l._subMeshIndex=t,l._subShaderIndex=i,l._commandBuffer=o,l._instanceProperty=n,l._drawnums=s,l.mesh=e,r&&l._updateWorldMatrixBuffer(),l._setInstanceBuffer(),l}constructor(){super(),this._subShaderIndex=0,this._transform=E.Render3DModuleDataFactory.createTransform(null),this._instanceRenderElementArray=[],this._instanceGeometryArray=[],this._instanceWorldMatrixData=new Float32Array(20*Lt.maxInstanceCount),this._instanceWorldMatrixBuffer=E.renderOBJCreate.createVertexBuffer3D(4*this._instanceWorldMatrixData.length,t.BufferUsage.Dynamic,!1),this._instanceWorldMatrixBuffer.vertexDeclaration=t.VertexMesh.instanceWorldMatrixDeclaration,this._instanceWorldMatrixBuffer.instanceBuffer=!0,this._render=new U,this._render._baseRenderNode.shaderData.addDefine(D.SHADERDEFINE_GPU_INSTANCE),this._instanceBufferState=new t.BufferState,this._drawElementCMDData=E.Render3DPassFactory.createDrawElementCMDData()}set material(e){this._material&&this._material._removeReference(1),this._material=e,this._material&&this._material._addReference(1)}get bufferState(){return this._instanceWorldMatrixBuffer}get mesh(){return this._mesh}set mesh(e){if(this._mesh==e)return;if(U.changeVertexDefine(this._mesh,e,this._render._baseRenderNode.shaderData),this._mesh=e,!this._mesh)return;let t=this._mesh._subMeshes;if(-1==this._subMeshIndex)for(let e=0,r=t.length;e<r;e++){let r=this._instanceRenderElementArray[e]=this._instanceRenderElementArray[e]?this._instanceRenderElementArray[e]:new H,a=this._instanceGeometryArray[e]=this._instanceGeometryArray[e]?this._instanceGeometryArray[e]:new wt(t[e]);r.setGeometry(a),r.transform=this._transform,r.material=this._material,r._subShaderIndex=this._subShaderIndex,r.render=this._render,r._renderElementOBJ.owner=this._render._baseRenderNode,a.bufferState=this._instanceBufferState,a.instanceCount=this._drawnums}else{let e=this._instanceRenderElementArray[0]=this._instanceRenderElementArray[0]?this._instanceRenderElementArray[0]:new H,r=this._instanceGeometryArray[0]=this._instanceGeometryArray[0]?this._instanceGeometryArray[0]:new wt(t[this._subMeshIndex]);e.setGeometry(r),e.transform=this._transform,e.material=this._material,e.render=this._render,r.bufferState=this._instanceBufferState,r.instanceCount=this._drawnums,e._renderElementOBJ.owner=this._render._baseRenderNode}}_setInstanceBuffer(){let e=this._instanceBufferState,t=[];this._mesh._bufferState._vertexBuffers.forEach((e=>{t.push(e)})),t.push(this._instanceWorldMatrixBuffer);let r=this._instanceProperty._propertyMap;for(let e in r)t.push(r[e]._vertexBuffer);e.applyState(t,this._mesh._indexBuffer),this._instanceGeometryArray.forEach((t=>{t.bufferState=e}))}_updateWorldMatrixBuffer(){let e=this._instanceWorldMatrixData,t=this._drawnums;for(let r=0;r<t;r++)e.set(this._matrixs[r].elements,20*r);this._instanceWorldMatrixBuffer.setData(e.buffer,0,0,80*t)}setWorldMatrix(e){if(e.length<this._drawnums)throw"worldMatrixArray length is less then drawnums";this._matrixs=e,this._matrixs&&this._updateWorldMatrixBuffer()}setDrawNums(e){if(this._matrixs&&this._matrixs.length<e)throw"worldMatrixArray length is less then drawnums";this._drawnums=e;let t=this._mesh._subMeshes;if(-1==this._subMeshIndex)for(let e=0,r=t.length;e<r;e++){(this._instanceGeometryArray[e]?this._instanceGeometryArray[e]:new wt(t[e])).instanceCount=this._drawnums}else{(this._instanceGeometryArray[0]?this._instanceGeometryArray[0]:new wt(t[0])).instanceCount=this._drawnums}this._matrixs&&this._updateWorldMatrixBuffer()}getRenderCMD(){return this._drawElementCMDData}renderUpdateElement(e,t){let r=e._renderElementOBJ;return r.isRender=e._geometry._prepareRender(t),e._geometry._updateRenderParams(t),r}run(){let e=Y._instance;e._contextOBJ.cameraUpdateMask=Vt._updateMark;let t=this._instanceProperty._propertyMap;for(let e in t)t[e].updateVertexBufferData(this._drawnums);let r=this.mesh._subMeshes;if(-1==this._subMeshIndex){let t=[];for(let a=0,i=r.length;a<i;a++){let r=this._instanceRenderElementArray[a],i=this.renderUpdateElement(r,e);t.push(i)}this._drawElementCMDData.setRenderelements(t)}else{let t=this._instanceRenderElementArray[this._subMeshIndex],r=this.renderUpdateElement(t,e);this._drawElementCMDData.setRenderelements([r])}}recover(){Lt._pool.push(this),super.recover(),this._material&&this._material._removeReference(1),this._material=null,this._instanceBufferState.destroy(),this._instanceBufferState=null,delete this._instanceRenderElementArray,this._instanceRenderElementArray=[],delete this._instanceGeometryArray,this._instanceGeometryArray=[],this.mesh=null}destroy(){super.destroy(),this._material&&this._material._removeReference(1),this._material=null,this._instanceBufferState.destroy(),this._instanceBufferState=null,delete this._instanceRenderElementArray,this._instanceRenderElementArray=[],delete this._instanceGeometryArray,this._instanceGeometryArray=[],this.mesh=null}}Lt._pool=[],Lt.maxInstanceCount=1024;class Nt extends Q{static create(e,r,a,i,n,s=1,o=0,l){var h;(h=Nt._pool.length>0?Nt._pool.pop():new Nt).renderTexture=e;let d=0;return r&&(d|=t.RenderClearFlag.Color,h._setRenderTargetCMD.clearColorValue=n),a&&(d|=t.RenderClearFlag.Depth,h._setRenderTargetCMD.clearDepthValue=s),i&&(d|=t.RenderClearFlag.Stencil,h._setRenderTargetCMD.clearStencilValue=o),h._setRenderTargetCMD.clearFlag=d,h}get renderTexture(){return this._renderTexture}set renderTexture(e){this._renderTexture=e,this._setRenderTargetCMD.rt=e._renderTarget}constructor(){super(),this._renderTexture=null,this._setRenderTargetCMD=E.Render3DPassFactory.createSetRenderTargetCMD()}getRenderCMD(){return this._setRenderTargetCMD}recover(){Nt._pool.push(this),this._renderTexture=null}}Nt._pool=[];class Pt extends Q{static create(e){var t;return(t=Pt._pool.length>0?Pt._pool.pop():new Pt).renderElement=e,t}get renderElement(){return this._renderElement}set renderElement(e){this._renderElement=e,this._drawElementCMDData.setRenderelements([this._renderElement._renderElementOBJ])}constructor(){super(),this._drawElementCMDData=E.Render3DPassFactory.createDrawElementCMDData()}recover(){super.recover(),Pt._pool.push(this)}getRenderCMD(){return this._drawElementCMDData}destroy(){this._renderElement=null,this._drawElementCMDData=null}}Pt._pool=[];class Ft{constructor(e=null,t=!1){this._shadow=!1,this._camera=null,this._commands=[],this._renderCMDs=[],this._name=e,this._shadow=t}get name(){return this._name}get casterShadow(){return this._shadow}get context(){return this._context}set context(e){this._context=e}_apply(e=!1){for(var r=0,a=this._commands.length;r<a;r++){let e=this._commands[r];e.run&&e.run()}e&&this.context._contextOBJ.runCMDList(this._renderCMDs),t.Stat.cmdDrawCall+=this._renderCMDs.length}_applyOne(){if(this._commands.length){var e=this._commands.shift();e.run&&e.run(),e.getRenderCMD&&this.context._contextOBJ.runOneCMD(this._renderCMDs.shift()),e.recover()}return this._commands.length>0}getCommandsSize(){return this._commands.length}setShaderDataTexture(t,r,a){let i=Ct.create(t,r,a,e.ShaderDataType.Texture2D,this);this._commands.push(i),i.getRenderCMD&&this._renderCMDs.push(i.getRenderCMD())}setGlobalTexture(t,r){let a=Bt.create(t,r,e.ShaderDataType.Texture2D,this);this._commands.push(a),a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}setShaderDataColor(t,r,a){let i=Ct.create(t,r,a,e.ShaderDataType.Color,this);this._commands.push(i),i.getRenderCMD&&this._renderCMDs.push(i.getRenderCMD())}setGlobalColor(t,r){let a=Bt.create(t,r,e.ShaderDataType.Color,this);this._commands.push(a),a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}setShaderDataVector(t,r,a){let i=Ct.create(t,r,a,e.ShaderDataType.Vector4,this);this._commands.push(i),i.getRenderCMD&&this._renderCMDs.push(i.getRenderCMD())}setGlobalVector(t,r){let a=Bt.create(t,r,e.ShaderDataType.Vector4,this);this._commands.push(a),a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}setShaderDataVector3(t,r,a){let i=Ct.create(t,r,a,e.ShaderDataType.Vector3,this);this._commands.push(i),i.getRenderCMD&&this._renderCMDs.push(i.getRenderCMD())}setGlobalVector3(t,r){let a=Bt.create(t,r,e.ShaderDataType.Vector3,this);this._commands.push(a),a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}setShaderDataVector2(t,r,a){let i=Ct.create(t,r,a,e.ShaderDataType.Vector2,this);this._commands.push(i),i.getRenderCMD&&this._renderCMDs.push(i.getRenderCMD())}setGlobalVector2(t,r){let a=Bt.create(t,r,e.ShaderDataType.Vector2,this);this._commands.push(a),a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}setShaderDataNumber(t,r,a){let i=Ct.create(t,r,a,e.ShaderDataType.Float,this);this._commands.push(i),i.getRenderCMD&&this._renderCMDs.push(i.getRenderCMD())}setGlobalNumber(t,r){let a=Bt.create(t,r,e.ShaderDataType.Float,this);this._commands.push(a),a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}setShaderDataInt(t,r,a){let i=Ct.create(t,r,a,e.ShaderDataType.Int,this);this._commands.push(i),i.getRenderCMD&&this._renderCMDs.push(i.getRenderCMD())}setGlobalInt(t,r){let a=Bt.create(t,r,e.ShaderDataType.Int,this);this._commands.push(a),a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}setShaderDataMatrix(t,r,a){let i=Ct.create(t,r,a,e.ShaderDataType.Matrix4x4,this);this._commands.push(i),i.getRenderCMD&&this._renderCMDs.push(i.getRenderCMD())}setShaderDefine(e,t,r){let a=It.create(e,t,r,this);this._commands.push(a),a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}setGlobalMatrix(t,r){let a=Bt.create(t,r,e.ShaderDataType.Matrix4x4,this);this._commands.push(a),a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}blitScreenQuad(e,t,r=null,a=null,i=null,n=0){let s=Mt.create(e,t,r,a,i,n,Mt._SCREENTYPE_QUAD,this);this._commands.push(s),s.getRenderCMD&&this._renderCMDs.push(s.getRenderCMD())}blitScreenQuadByMaterial(e,t,r=null,a=null,i=0){var n,s;a&&(n=a._shader,s=a.shaderData);let o=Mt.create(e,t,r,n,s,i,Mt._SCREENTYPE_QUAD,this);this._commands.push(o),o.getRenderCMD&&this._renderCMDs.push(o.getRenderCMD())}blitScreenTriangle(e,t,r=null,a=null,i=null,n=0){let s=Mt.create(e,t,r,a,i,n,Mt._SCREENTYPE_TRIANGLE,this);this._commands.push(s),s.getRenderCMD&&this._renderCMDs.push(s.getRenderCMD())}setRenderTarget(e,r,a,i=t.Color.BLACK,n=1){let s=Nt.create(e,r,a,!1,i,n,0,this);this._commands.push(s),s.getRenderCMD&&this._renderCMDs.push(s.getRenderCMD())}drawMesh(e,t,r,a,i){let n=vt.create(e,t,r,a,i,this);this._commands.push(n),n.getRenderCMD&&this._renderCMDs.push(n.getRenderCMD())}drawRender(e,t,r=0){let a=yt.create(e,t,r,this);this._commands.push(a),a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}drawRenderElement(e){let t=Pt.create(e);this._commands.push(t),t.getRenderCMD&&this._renderCMDs.push(t.getRenderCMD())}drawMeshInstance(e,r=0,a,i,n=0,s,o){if(!t.LayaGL.renderEngine.getCapable(t.RenderCapable.DrawElement_Instance))return null;var l=Lt.create(e,r,a,i,n,s,o,this);return this._commands.push(l),l.getRenderCMD&&this._renderCMDs.push(l.getRenderCMD()),l}addCustomCMD(e){e._commandBuffer=this,this._commands.push(e),e.getRenderCMD&&this._renderCMDs.push(e.getRenderCMD())}clear(){for(var e=0,t=this._commands.length;e<t;e++)this._commands[e].recover();this._commands.length=0,this._renderCMDs.length=0}}var Ot,bt;e.CameraClearFlags=void 0,(Ot=e.CameraClearFlags||(e.CameraClearFlags={}))[Ot.SolidColor=0]="SolidColor",Ot[Ot.Sky=1]="Sky",Ot[Ot.DepthOnly=2]="DepthOnly",Ot[Ot.Nothing=3]="Nothing",Ot[Ot.ColorOnly=4]="ColorOnly",e.CameraEventFlags=void 0,(bt=e.CameraEventFlags||(e.CameraEventFlags={}))[bt.BeforeForwardOpaque=0]="BeforeForwardOpaque",bt[bt.BeforeSkyBox=2]="BeforeSkyBox",bt[bt.BeforeTransparent=4]="BeforeTransparent",bt[bt.BeforeImageEffect=6]="BeforeImageEffect",bt[bt.AfterEveryThing=8]="AfterEveryThing";class Vt extends we{static get _updateMark(){return Y._instance._contextOBJ.cameraUpdateMask}static set _updateMark(e){Y._instance._contextOBJ.cameraUpdateMask=e}static drawRenderTextureByScene(e,t,r){if(!r)return null;Qt._updateMark++,t.parent?(t.sceneRenderableManager.renderUpdate(),t.skyRenderer.renderUpdate(Y._instance)):t._update(),t._prepareSceneToRender(),t._setCullCamera(e);let a=e.renderTarget;e.renderTarget=r;let i=e.scene;return e._scene=t,e.render(t),e.renderTarget=a,t.recaculateCullCamera(),t._componentDriver.callPostRender(),e._aftRenderMainPass(),e._scene=i,r}static getTexturePixel(e){let r=e.filterMode;e.filterMode=t.FilterMode.Point;let a,i=t.RenderTargetFormat.R8G8B8,n=e.width*e.height;switch(e.format){case t.TextureFormat.R32G32B32A32:case t.TextureFormat.R16G16B16A16:i=t.RenderTargetFormat.R32G32B32A32,a=new Float32Array(4*n);break;case t.TextureFormat.R32G32B32:case t.TextureFormat.R16G16B16:i=t.RenderTargetFormat.R32G32B32,a=new Float32Array(3*n);break;case t.TextureFormat.R5G6B5:case t.TextureFormat.R8G8B8:i=t.RenderTargetFormat.R8G8B8,a=new Uint8Array(3*n);break;default:i=t.RenderTargetFormat.R8G8B8A8,a=new Uint8Array(4*n)}let s=t.RenderTexture.createFromPool(e.width,e.height,i,t.RenderTargetFormat.None,!1,0,!1),o=new Ft;return o.blitScreenQuad(e,s),o.context=Y._instance,o._applyOne(),e.filterMode=r,s.getData(0,0,e.width,e.height,a),s.destroy(),a}static getTexturePixelAsync(e){let r=e.filterMode;e.filterMode=t.FilterMode.Point;let a,i=t.RenderTargetFormat.R8G8B8,n=e.width*e.height;switch(e.format){case t.TextureFormat.R32G32B32A32:case t.TextureFormat.R16G16B16A16:i=t.RenderTargetFormat.R32G32B32A32,a=new Float32Array(4*n);break;case t.TextureFormat.R32G32B32:case t.TextureFormat.R16G16B16:i=t.RenderTargetFormat.R32G32B32,a=new Float32Array(3*n);break;case t.TextureFormat.R5G6B5:case t.TextureFormat.R8G8B8:i=t.RenderTargetFormat.R8G8B8,a=new Uint8Array(3*n);break;default:i=t.RenderTargetFormat.R8G8B8A8,a=new Uint8Array(4*n)}let s=t.RenderTexture.createFromPool(e.width,e.height,i,t.RenderTargetFormat.None,!1,0,!1),o=new Ft;o.blitScreenQuad(e,s),o.context=Y._instance,o._applyOne(),e.filterMode=r;const l=s.getDataAsync(0,0,e.width,e.height,a);return s.destroy(),l}static drawTextureCubePixelByScene(e,r,a,i,n){let s,o,l=t.RenderTargetFormat.R8G8B8,h=a*a;switch(i){case t.TextureFormat.R32G32B32A32:case t.TextureFormat.R16G16B16A16:l=t.RenderTargetFormat.R32G32B32A32,h*=4,o=4;break;case t.TextureFormat.R32G32B32:case t.TextureFormat.R16G16B16:l=t.RenderTargetFormat.R32G32B32,h*=3,o=4;break;case t.TextureFormat.R5G6B5:case t.TextureFormat.R8G8B8:l=t.RenderTargetFormat.R8G8B8,h*=3,o=1;break;case t.TextureFormat.R8G8B8A8:l=t.RenderTargetFormat.R8G8B8A8,s=new Uint8Array(4*h),h*=4,o=1;break;default:throw new Error("Type is not supported")}let d=new t.RenderTexture(a,a,l,t.RenderTargetFormat.DEPTH_16,!1,0,!1,!1);e.fieldOfView=90,e.cullingMask=n;let c=[],u=[new t.Quaternion(0,1,0,0),new t.Quaternion(0,0,0,1),new t.Quaternion(0,.7071068,0,.7071068),new t.Quaternion(0,.7071068,0,-.7071068),new t.Quaternion(0,.7071068,-.7071068,0),new t.Quaternion(0,-.7071068,-.7071068,0)];for(var _=0;_<6;_++)e.transform.rotation=u[_],this.drawRenderTextureByScene(e,r,d),s=4==o?new Float32Array(h):new Uint8Array(h),c[_]=d.getData(0,0,a,a,s);return d.destroy(),c}static drawTextureCubeByScene(e,r,a,i,n,s=0){e.transform.position=r;let o=this.drawTextureCubePixelByScene(e,a,i,n,s);switch(n){case t.TextureFormat.R32G32B32A32:case t.TextureFormat.R16G16B16A16:t.TextureFormat.R32G32B32A32;break;case t.TextureFormat.R32G32B32:case t.TextureFormat.R16G16B16:t.TextureFormat.R32G32B32;break;case t.TextureFormat.R5G6B5:case t.TextureFormat.R8G8B8:t.TextureFormat.R8G8B8;break;case t.TextureFormat.R8G8B8A8:t.TextureFormat.R8G8B8A8;break;default:throw new Error("Type is not supported")}let l=new t.TextureCube(i,n,!0,!1);return l.setPixelsData(o,!1,!1),l}static __init__(){Vt.depthPass=new pt}set nearPlane(e){super.nearPlane=e,this._renderDataModule.nearplane=e}get nearPlane(){return this._nearPlane}set farPlane(e){super.farPlane=e,this._renderDataModule.farplane=e}get farPlane(){return this._farPlane}set fieldOfView(e){super.fieldOfView=e,this._renderDataModule.fieldOfView=e}get fieldOfView(){return this._fieldOfView}get aspectRatio(){if(0===this._aspectRatio){var e=this.viewport;return e.width/e.height}return this._aspectRatio}set aspectRatio(e){if(e<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._renderDataModule.aspectRatio=e,this._calculateProjectionMatrix()}get viewport(){return this._offScreenRenderTexture?this._calculationViewport(this._normalizedViewport,this._offScreenRenderTexture.width,this._offScreenRenderTexture.height):this._calculationViewport(this._normalizedViewport,this.clientWidth,this.clientHeight),this._viewport}set viewport(e){var t,r;this._offScreenRenderTexture?(t=this._offScreenRenderTexture.width,r=this._offScreenRenderTexture.height):(t=this.clientWidth,r=this.clientHeight),this._normalizedViewport.x=e.x/t,this._normalizedViewport.y=e.y/r,this._normalizedViewport.width=e.width/t,this._normalizedViewport.height=e.height/r,this._calculationViewport(this._normalizedViewport,t,r),this._calculateProjectionMatrix()}get clientWidth(){return t.ILaya.stage.needUpdateCanvasSize(),t.Config3D.customResolution?t.Config3D.pixelRatio*t.Config3D._resoluWidth|0:Y.clientWidth*t.Config3D.pixelRatio|0}get clientHeight(){return t.ILaya.stage.needUpdateCanvasSize(),t.Config3D.customResolution?t.Config3D.pixelRatio*t.Config3D._resoluHeight|0:Y.clientHeight*t.Config3D.pixelRatio|0}set msaa(e){t.LayaGL.renderEngine.getCapable(t.RenderCapable.MSAA)?this._msaa=e:this._msaa=!1}get msaa(){return this._msaa&&t.Stat.enablemsaa}set fxaa(e){this._fxaa=e}get fxaa(){return this._fxaa}get normalizedViewport(){return this._normalizedViewport}set normalizedViewport(e){var t,r;this._offScreenRenderTexture?(t=this._offScreenRenderTexture.width,r=this._offScreenRenderTexture.height):(t=this.clientWidth,r=this.clientHeight),this._normalizedViewport!==e&&e.cloneTo(this._normalizedViewport),this._calculationViewport(e,t,r),this._calculateProjectionMatrix()}get viewMatrix(){if(this._updateViewMatrix){var e=this.transform.getWorldLossyScale(),t=e.x,r=e.y,a=e.z,i=this._viewMatrix.elements;this.transform.worldMatrix.cloneTo(this._viewMatrix),i[0]/=t,i[1]/=t,i[2]/=t,i[4]/=r,i[5]/=r,i[6]/=r,i[8]/=a,i[9]/=a,i[10]/=a,this._viewMatrix.invert(this._viewMatrix),this._updateViewMatrix=!1,this.skyRenderElement._renderElementOBJ&&this.skyRenderElement.calculateViewMatrix(this._viewMatrix)}return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}set projectionMatrix(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}get projectionViewMatrix(){return t.Matrix4x4.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._renderDataModule.setProjectionViewMatrix(this._projectionViewMatrix),this._projectionViewMatrix}get boundFrustum(){return this._boundFrustum.matrix=this.projectionViewMatrix,this._boundFrustum}get renderTarget(){return this._offScreenRenderTexture}set renderTarget(e){var t=this._offScreenRenderTexture;t!==e&&(t&&(t._isCameraTarget=!1),e&&(e._isCameraTarget=!0),this._offScreenRenderTexture=e,this._calculateProjectionMatrix())}get postProcess(){return this._postProcess}set postProcess(e){this._postProcess=e}get enableHDR(){return this._enableHDR}set enableHDR(e){!e||t.LayaGL.renderEngine.getCapable(t.RenderCapable.RenderTextureFormat_R16G16B16A16)?this._enableHDR=e:console.warn("Camera:can't enable HDR in this device.")}get enableBuiltInRenderTexture(){return this._needBuiltInRenderTexture}set enableBuiltInRenderTexture(e){this._needBuiltInRenderTexture=e}get depthTextureMode(){return this._depthTextureMode}set depthTextureMode(e){this._depthTextureMode=e,t.LayaGL.renderEngine.getCapable(t.RenderCapable.RenderTextureFormat_Depth)||(this._depthTextureMode&=~t.DepthTextureMode.Depth)}set opaquePass(e){e!=this._opaquePass&&(e||(this._shaderValues.setTexture(we.OPAQUETEXTURE,t.Texture2D.blackTexture),this._shaderValues.setVector(we.OPAQUETEXTUREPARAMS,t.Vector4.ONE),this._opaqueTexture&&t.RenderTexture.recoverToPool(this._opaqueTexture),this._opaqueTexture=null),this._opaquePass=e)}get opaquePass(){return this._opaquePass}get depthTextureFormat(){return this._depthTextureFormat}set depthTextureFormat(e){this._depthTextureFormat=e}set enableBlitDepth(e){e!=this._canBlitDepth&&(this._canBlitDepth=e,this._cacheDepth=e,this._internalRenderTexture&&t.RenderTexture.recoverToPool(this._internalRenderTexture),this._internalRenderTexture=t.RenderTexture.createFromPool(this.viewport.width,this.viewport.height,this._getRenderTextureFormat(),this.depthTextureFormat,!1,this.msaa?4:1,this._canBlitDepth,this._needRenderGamma(this._getRenderTextureFormat())),e||this._cacheDepthTexture&&!this._cacheDepthTexture._inPool&&t.RenderTexture.recoverToPool(this._cacheDepthTexture))}get enableBlitDepth(){return this._canBlitDepth}get canblitDepth(){return this._canBlitDepth&&this._internalRenderTexture&&null!=this._internalRenderTexture.depthStencilFormat}constructor(r=0,a=.3,i=1e3){super(a,i),this._updateViewMatrix=!0,this._postProcess=null,this._enableHDR=!1,this._viewportParams=new t.Vector4,this._projectionParams=new t.Vector4,this._needBuiltInRenderTexture=!1,this._msaa=!1,this._fxaa=!1,this._offScreenRenderTexture=null,this._internalRenderTexture=null,this._canBlitDepth=!1,this._internalCommandBuffer=new Ft,this._depthTextureFormat=t.RenderTargetFormat.DEPTH_32,this._cameraEventCommandBuffer={},this._shadowCasterCommanBuffer=[],this._clusterPlaneCacheFlag=new t.Vector2(-1,-1),this._screenOffsetScale=new t.Vector4,this.enableRender=!0,this.clearFlag=e.CameraClearFlags.SolidColor,this.opaqueTextureSize=512,this._renderDataModule=E.Render3DModuleDataFactory.createCameraModuleData(),this._Render3DProcess=E.Render3DPassFactory.createRender3DProcess(),this._renderDataModule.transform=this.transform,this._viewMatrix=new t.Matrix4x4,this._projectionMatrix=new t.Matrix4x4,this._projectionViewMatrix=new t.Matrix4x4,this._viewport=new t.Viewport(0,0,0,0),this._normalizedViewport=new t.Viewport(0,0,1,1),this._rayViewport=new t.Viewport(0,0,0,0),this._aspectRatio=r,this._boundFrustum=new Je(new t.Matrix4x4),this.depthTextureMode=0,this.opaquePass=!1,this._calculateProjectionMatrix(),t.ILaya.stage.on(t.Event.RESIZE,this,this._onScreenSizeChanged),this.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged),this.opaquePass=!1,this._internalCommandBuffer.context=Y._instance,this._renderDataModule.farplane=this.farPlane,this._renderDataModule.nearplane=this.nearPlane,this._renderDataModule.fieldOfView=this.fieldOfView,this._renderDataModule.aspectRatio=this.aspectRatio}_calculationViewport(e,t,r){var a=e.x*t,i=e.y*r,n=a+Math.max(e.width*t,0),s=i+Math.max(e.height*r,0),o=Math.ceil(a),l=Math.ceil(i),h=Math.floor(n),d=Math.floor(s),c=o-a>=.5?Math.floor(a):o,u=l-i>=.5?Math.floor(i):l,_=n-h>=.5?Math.ceil(n):h,f=s-d>=.5?Math.ceil(s):d;this._viewport.x=c,this._viewport.y=u,this._viewport.width=_-c,this._viewport.height=f-u}_calculateProjectionMatrix(){if(!this._useUserProjectionMatrix){if(this._orthographic){var e=.5*this.orthographicVerticalSize,r=e*this.aspectRatio;t.Matrix4x4.createOrthoOffCenter(-r,r,-e,e,this.nearPlane,this.farPlane,this._projectionMatrix)}else t.Matrix4x4.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix);this.skyRenderElement._renderElementOBJ&&this.skyRenderElement.caluclateProjectionMatrix(this._projectionMatrix,this.aspectRatio,this.nearPlane,this.farPlane,this.fieldOfView,this.orthographic)}}_isLayerVisible(e){return 0!=(Math.pow(2,e)&this.cullingMask)}_onTransformChanged(e){(e&=fe.TRANSFORM_WORLDMATRIX)&&(this._updateViewMatrix=!0)}clone(){let e=super.clone();return e.clearFlag=this.clearFlag,this.clearColor.cloneTo(e.clearColor),e.clearColor=e.clearColor,e.viewport=this.viewport,this.normalizedViewport.cloneTo(e.normalizedViewport),e.enableHDR=this.enableHDR,e.farPlane=this.farPlane,e.nearPlane=this.nearPlane,e.fieldOfView=this.fieldOfView,e.orthographic=this.orthographic,e.orthographicVerticalSize=this.orthographicVerticalSize,e.opaquePass=this.opaquePass,e._cameraEventCommandBuffer=this._cameraEventCommandBuffer,e.opaquePass=this.opaquePass,e}_getCanvasWidth(){return this._offScreenRenderTexture?this._offScreenRenderTexture.width:this.clientWidth}_getCanvasHeight(){return this._offScreenRenderTexture?this._offScreenRenderTexture.height:this.clientHeight}_getRenderTexture(){return this._internalRenderTexture||this._offScreenRenderTexture}_needRenderGamma(e){switch(e){case t.RenderTargetFormat.R8G8B8:case t.RenderTargetFormat.R8G8B8A8:return!0;default:return!1}}_needInternalRenderTexture(){let e=this.enableBuiltInRenderTexture;if(this.renderTarget){if(this.msaa&&(e=e||!(this.renderTarget.samples>1)),this.enableHDR)switch(this.renderTarget.format){case t.TextureFormat.R16G16B16A16:case t.TextureFormat.R16G16B16:case t.TextureFormat.R32G32B32A32:case t.TextureFormat.R32G32B32:break;default:e=!0}this.postProcess&&this.postProcess.enable&&this.postProcess.effects.length>0&&(e=!0),1==this.normalizedViewport.width&&1==this.normalizedViewport.height&&0==this.normalizedViewport.x&&0==this.normalizedViewport.y||(e=!0)}return e}_getRenderTextureFormat(){return this._enableHDR?t.RenderTargetFormat.R16G16B16A16:t.RenderTargetFormat.R8G8B8A8}_updateCameraRenderData(e){this._prepareCameraToRender(),this._applyViewProject(this.viewMatrix,this._projectionMatrix,e.invertY),this._contextApply(e)}_prepareCameraToRender(){super._prepareCameraToRender();var e=this.viewport;this._viewportParams.setValue(e.x,e.y,e.width,e.height);let r=t.LayaGL.renderEngine._screenInvertY?!Y._instance.invertY:Y._instance.invertY;this._projectionParams.setValue(this._nearPlane,this._farPlane,r?-1:1,1/this.farPlane),this._shaderValues.setVector(we.VIEWPORT,this._viewportParams),this._shaderValues.setVector(we.PROJECTION_PARAMS,this._projectionParams)}_contextApply(e){e.viewMatrix=this.viewMatrix,e.projectionMatrix=this.projectionMatrix,e.projectionViewMatrix=this.projectionViewMatrix}_applyViewProject(e,r,a){var i;a?(t.Matrix4x4.multiply(we._invertYScaleMatrix,r,we._invertYProjectionMatrix),t.Matrix4x4.multiply(we._invertYProjectionMatrix,e,we._invertYProjectionViewMatrix),r=we._invertYProjectionMatrix,i=we._invertYProjectionViewMatrix):(t.Matrix4x4.multiply(r,e,this._projectionViewMatrix),this._renderDataModule.setProjectionViewMatrix(this._projectionViewMatrix),i=this._projectionViewMatrix),this._shaderValues.setMatrix4x4(we.VIEWMATRIX,e),this._shaderValues.setMatrix4x4(we.PROJECTMATRIX,r),this._shaderValues.setMatrix4x4(we.VIEWPROJECTMATRIX,i)}_updateClusterPlaneXY(){var e=this.fieldOfView,r=this.aspectRatio;if(this._clusterPlaneCacheFlag.x!==e||this._clusterPlaneCacheFlag.y!==r){var a=t.Config3D.lightClusterCount,i=a.x,n=a.y,s=i+1,o=n+1,l=this._clusterXPlanes,h=this._clusterYPlanes;if(!l){l=this._clusterXPlanes=new Array(s),h=this._clusterYPlanes=new Array(o);for(var d=0;d<s;d++)l[d]=new t.Vector3;for(d=0;d<o;d++)h[d]=new t.Vector3}var c=Math.tan(this.fieldOfView/2*Math.PI/180),u=this.aspectRatio*c,_=2*c/n,f=2*u/i;for(d=0;d<s;d++){var g=f*d-u,m=1/Math.sqrt(1+g*g);l[d].setValue(m,0,-g*m)}for(d=0;d<o;d++){g=c-_*d;var p=-1/Math.sqrt(1+g*g);h[d].setValue(0,p,-g*p)}this._clusterPlaneCacheFlag.x=e,this._clusterPlaneCacheFlag.y=r}}_addCasterShadowCommandBuffer(e){this._shadowCasterCommanBuffer.indexOf(e)<0&&this._shadowCasterCommanBuffer.push(e)}_removeCasterShadowCommandBuffer(e){var t=this._shadowCasterCommanBuffer.indexOf(e);-1!=t&&this._shadowCasterCommanBuffer.splice(t,1)}_preRenderMainPass(r,a,i,n){if(r.camera=this,r.cameraShaderValue=this._shaderValues,Vt._updateMark++,i&&!this._offScreenRenderTexture&&(this.clearFlag==e.CameraClearFlags.DepthOnly||this.clearFlag==e.CameraClearFlags.Nothing))if(t.RenderTexture.bindCanvasRender)t.RenderTexture.bindCanvasRender!=this._internalRenderTexture&&(this._internalCommandBuffer.clear(),this._internalCommandBuffer.blitScreenQuad(t.RenderTexture.bindCanvasRender,this._internalRenderTexture),this._internalCommandBuffer._applyOne());else if(this._enableHDR){var s=t.RenderTexture.createFromPool(n.width,n.height,t.RenderTargetFormat.R8G8B8,t.RenderTargetFormat.DEPTH_16,!1,1);s.filterMode=t.FilterMode.Bilinear,this._renderEngine.copySubFrameBuffertoTex(s._texture,0,0,0,n.x,Y.clientHeight-(n.y+n.height),n.width,n.height),this._internalCommandBuffer.clear(),this._internalCommandBuffer.blitScreenQuad(s,this._internalRenderTexture),this._internalCommandBuffer._apply(!0),t.RenderTexture.recoverToPool(s)}}get depthTexture(){return this._depthTexture}set depthTexture(e){this._depthTexture=e}get depthNormalTexture(){return this._depthNormalsTexture}set depthNormalTexture(e){this._depthNormalsTexture=e}_aftRenderMainPass(){this._cacheDepth&&this._internalRenderTexture?(this._cacheDepthTexture&&!this._cacheDepthTexture._inPool&&t.RenderTexture.recoverToPool(this._cacheDepthTexture),this._cacheDepthTexture=this._internalRenderTexture):this._internalRenderTexture&&t.RenderTexture.recoverToPool(this._internalRenderTexture)}_createOpaqueTexture(){if(!this._opaqueTexture){let e=this._getRenderTexture(),r=this.opaqueTextureSize;this._opaqueTexture=t.RenderTexture.createFromPool(r,r,e.colorFormat,t.RenderTargetFormat.None,!0,1,!1,!0),this._opaqueTexture.filterMode=t.FilterMode.Bilinear,this._opaqueTexture.wrapModeU=t.WrapMode.Clamp,this._opaqueTexture.wrapModeV=t.WrapMode.Clamp,this._shaderValues.setTexture(we.OPAQUETEXTURE,this._opaqueTexture);let a=new t.Vector4;a.x=this._opaqueTexture.width,a.y=this._opaqueTexture.height,a.z=this._opaqueTexture.maxMipmapLevel,this._shaderValues.setVector(we.OPAQUETEXTUREPARAMS,a)}}render(r){let a=Y._instance;a.scene=r,a.camera=this,r._setCullCamera(this);let i=this.viewport,n=this._needInternalRenderTexture();if(n){let e=this.msaa?4:1,r=this._getRenderTextureFormat(),a=this.depthTextureFormat,n=this._needRenderGamma(r),s=t.RenderTexture.createFromPool(i.width,i.height,r,a,!1,e,this.canblitDepth,n);s.filterMode=t.FilterMode.Bilinear,this._internalRenderTexture=s}else this._internalRenderTexture=null;this.opaquePass&&!this._opaqueTexture&&this._createOpaqueTexture(),a.invertY=!1;let s=this._getRenderTexture();s&&(a.invertY=!!s._isCameraTarget&&!t.LayaGL.renderEngine._screenInvertY),this._prepareCameraToRender(),this._applyViewProject(this.viewMatrix,this.projectionMatrix,a.invertY),this._contextApply(a),this.clearFlag==e.CameraClearFlags.Sky&&(r.skyRenderer.setRenderElement(this.skyRenderElement),this.skyRenderElement.renderpre(a)),r._componentDriver.callPreRender(),this._preRenderMainPass(a,r,n,i),t.Config3D._multiLighting&&ie.instance.update(this,r);var o=performance.now();this._Render3DProcess.fowardRender(a._contextOBJ,this),t.Stat.renderPassStatArray[t.RenderPassStatisticsInfo.T_CameraRender]+=performance.now()-o,r._componentDriver.callPostRender()}viewportPointToRay(e,r){Ut.setValue(e.x*t.ILaya.stage.clientScaleX,e.y*t.ILaya.stage.clientScaleY),this._rayViewport.x=this.viewport.x,this._rayViewport.y=this.viewport.y,this._rayViewport.width=this.viewport.width,this._rayViewport.height=this.viewport.height,St.calculateCursorRay(Ut,this._rayViewport,this._projectionMatrix,this.viewMatrix,null,r)}normalizedViewportPointToRay(e,r){var a=this.normalizedViewport;Ut.x=e.x*t.Config3D.pixelRatio*a.width,Ut.y=e.y*t.Config3D.pixelRatio*a.height,St.calculateCursorRay(Ut,this.viewport,this._projectionMatrix,this.viewMatrix,null,r)}worldToViewportPoint(e,r){t.Matrix4x4.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(e,this._projectionViewMatrix,r);var a=t.Config3D.pixelRatio;let i=(r.x-this.viewport.x)/a,n=(r.y-this.viewport.y)/a;r.x=i+this.viewport.x,r.y=n+this.viewport.y,r.x=r.x/t.ILaya.stage.clientScaleX|0,r.y=r.y/t.ILaya.stage.clientScaleY|0}worldToNormalizedViewportPoint(e,r){this.worldToViewportPoint(e,r),r.x=r.x/t.ILaya.stage.width,r.y=r.y/t.ILaya.stage.height}convertScreenCoordToOrthographicCoord(e,r){if(this._orthographic){var a=this.clientWidth,i=this.clientHeight,n=this.orthographicVerticalSize*this.aspectRatio/a,s=this.orthographicVerticalSize/i;return r.x=(-a/2+e.x*t.ILaya.stage.clientScaleX)*n,r.y=(i/2-e.y*t.ILaya.stage.clientScaleY)*s,r.z=(this.nearPlane-this.farPlane)*(e.z+1)/2-this.nearPlane,t.Vector3.transformCoordinate(r,this.transform.worldMatrix,r),!0}return!1}destroy(e=!0){this._shaderValues.destroy(),this._internalRenderTexture&&!this._internalRenderTexture._inPool&&t.RenderTexture.recoverToPool(this._internalRenderTexture),this._offScreenRenderTexture=null,this._opaqueTexture&&t.RenderTexture.recoverToPool(this._opaqueTexture),this._Render3DProcess.destroy(),this.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged),t.ILaya.stage.off(t.Event.RESIZE,this,this._onScreenSizeChanged),this._cameraEventCommandBuffer={},Y._instance.camera==this&&(Y._instance.cameraShaderValue=null,Y._instance.camera=null),super.destroy(e)}addCommandBuffer(e,t){var r=this._cameraEventCommandBuffer[e];r||(r=this._cameraEventCommandBuffer[e]=[]),r.indexOf(t)<0&&r.push(t),t._camera=this,t.casterShadow&&this._addCasterShadowCommandBuffer(t)}removeCommandBuffer(e,t){var r=this._cameraEventCommandBuffer[e];if(!r)throw"Camera:unknown event.";var a=r.indexOf(t);-1!=a&&r.splice(a,1),t.casterShadow&&this._removeCasterShadowCommandBuffer(t)}removeCommandBuffers(e){this._cameraEventCommandBuffer[e]&&(this._cameraEventCommandBuffer[e].length=0)}}Vt._context3DViewPortCatch=new t.Viewport(0,0,0,0),Vt._contextScissorPortCatch=new t.Vector4(0,0,0,0);const Ut=new t.Vector2;class Ht{static __init__(){Ht.shaderdata=t.LayaGL.renderDeviceFactory.createShaderData(null)}static create(e,t,r,a=null,i=null,n=null,s=0){var o;return(o=Ht._pool.length>0?Ht._pool.pop():new Ht)._source=e,o._dest=t,o._offsetScale=a,o.setshader(i,s,n),o._source&&o._texture_size.setValue(e.width,e.height,1/e.width,1/e.height),o._viewPort=r,o}constructor(){this._source=null,this._dest=null,this._offsetScale=null,this._texture_size=null,this._shader=null,this._shaderData=null,this._subShader=0,this._viewPort=null,this._transform3D=E.Render3DModuleDataFactory.createTransform(null),this._renderElement=new H,this._renderElement.setTransform(this._transform3D),this._renderElement.setGeometry(Rt.instance),this._renderElement._renderElementOBJ.isRender=!0,this._texture_size=new t.Vector4}set shaderData(e){this._shaderData=e||Ht.shaderdata,this._renderElement._renderElementOBJ.materialShaderData=this._shaderData}setshader(e,t,r){this._shader=e||Q._screenShader,this._subShader=t||0,this.shaderData=r,this._renderElement.renderSubShader=this._shader.getSubShaderAt(this._subShader)}run(){if(!this._source||!this._viewPort)return;var e=this._source,r=this._dest,a=this._shaderData;let i=Y._instance;var n=this._viewPort;let s=Y.clientHeight-n.y-n.height;t.LayaGL.renderEngine._screenInvertY?(i.changeViewport(n.x,n.y,n.width,n.height),i.changeScissor(n.x,n.y,n.width,n.height)):(i.changeViewport(n.x,s,n.width,n.height),i.changeScissor(n.x,s,n.width,n.height)),a.setTexture(Q.SCREENTEXTURE_ID,e),a.setVector(Q.SCREENTEXTUREOFFSETSCALE_ID,this._offsetScale||Ht._defaultOffsetScale),e&&a.setVector(Q.MAINTEXTURE_TEXELSIZE_ID,this._texture_size),r?a.removeDefine(Y.GammaCorrect):a.addDefine(Y.GammaCorrect),this._renderElement.setGeometry(Rt.InvertInstance),i.destTarget=r,i._contextOBJ.cameraUpdateMask=Vt._updateMark,i.drawRenderElement(this._renderElement._renderElementOBJ),t.Stat.blitDrawCall++}recover(){Ht._pool.push(this),this._source=null,this._dest=null,this._offsetScale=null,this._shader=null,this._shaderData=null,this._viewPort=null}}Ht._pool=[],Ht._defaultOffsetScale=new t.Vector4(0,0,1,1);class Gt{constructor(){this._sceneManagerOBJ=E.Render3DPassFactory.createSceneRenderManager()}get list(){return this._sceneManagerOBJ.list}set list(e){this._sceneManagerOBJ.list=e}get renderBaselist(){return this._sceneManagerOBJ.baseRenderList}addRenderObject(e){this._sceneManagerOBJ.addRenderObject(e)}removeRenderObject(e){this._sceneManagerOBJ.removeRenderObject(e)}removeMotionObject(e){this._sceneManagerOBJ.removeMotionObject(e)}updateMotionObjects(){this._sceneManagerOBJ.updateMotionObjects()}renderUpdate(){var e=Y._instance;let t=this._sceneManagerOBJ.list.elements;for(let r=0,a=this.list.length;r<a;r++)t[r].renderUpdate(e)}addMotionObject(e){this._sceneManagerOBJ.addMotionObject(e)}destroy(){this._sceneManagerOBJ.destroy()}}class kt{constructor(){this._UI3Dlist=new t.FastSinglelist}add(e){this._UI3Dlist.add(e)}remove(e){this._UI3Dlist.remove(e)}update(){let e=this._UI3Dlist.elements;for(var t=0,r=this._UI3Dlist.length;t<r;t++)e[t]._submitRT()}rayCast(e){let t=e.origin;this._UI3Dlist.clean(),this._UI3Dlist.elements.sort(((e,r)=>e._getCameraDistance(t)-r._getCameraDistance(t)));let r=this._UI3Dlist.elements;for(var a=0,i=this._UI3Dlist.length;a<i;a++){let t=r[a]._checkUIPos(e);if(t)return t}return null}destory(){this._UI3Dlist.destroy()}}var zt,Wt;e.FogMode=void 0,(zt=e.FogMode||(e.FogMode={}))[zt.Linear=0]="Linear",zt[zt.EXP=1]="EXP",zt[zt.EXP2=2]="EXP2";class Qt extends t.Sprite{static get _updateMark(){return Y._instance._contextOBJ.cameraUpdateMask}static set _updateMark(e){Y._instance._contextOBJ.cameraUpdateMask=e}static regManager(e,t){Qt.componentManagerMap.set(e,t)}static shaderValueInit(){Fe.SHADERDEFINE_FOG=t.Shader3D.getDefineByName("FOG"),Fe.SHADERDEFINE_FOG_LINEAR=t.Shader3D.getDefineByName("FOG_LINEAR"),Fe.SHADERDEFINE_FOG_EXP=t.Shader3D.getDefineByName("FOG_EXP"),Fe.SHADERDEFINE_FOG_EXP2=t.Shader3D.getDefineByName("FOG_EXP2"),Fe.SHADERDEFINE_DIRECTIONLIGHT=t.Shader3D.getDefineByName("DIRECTIONLIGHT"),Fe.SHADERDEFINE_POINTLIGHT=t.Shader3D.getDefineByName("POINTLIGHT"),Fe.SHADERDEFINE_SPOTLIGHT=t.Shader3D.getDefineByName("SPOTLIGHT"),Fe.SHADERDEFINE_SHADOW=t.Shader3D.getDefineByName("SHADOW"),Fe.SHADERDEFINE_SHADOW_CASCADE=t.Shader3D.getDefineByName("SHADOW_CASCADE"),Fe.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW=t.Shader3D.getDefineByName("SHADOW_SOFT_SHADOW_LOW"),Fe.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH=t.Shader3D.getDefineByName("SHADOW_SOFT_SHADOW_HIGH"),Fe.SHADERDEFINE_SHADOW_SPOT=t.Shader3D.getDefineByName("SHADOW_SPOT"),Fe.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW=t.Shader3D.getDefineByName("SHADOW_SPOT_SOFT_SHADOW_LOW"),Fe.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH=t.Shader3D.getDefineByName("SHADOW_SPOT_SOFT_SHADOW_HIGH"),Qt.FOGCOLOR=t.Shader3D.propertyNameToID("u_FogColor"),Qt.FOGPARAMS=t.Shader3D.propertyNameToID("u_FogParams"),Qt.DIRECTIONLIGHTCOUNT=t.Shader3D.propertyNameToID("u_DirationLightCount"),Qt.LIGHTBUFFER=t.Shader3D.propertyNameToID("u_LightBuffer"),Qt.CLUSTERBUFFER=t.Shader3D.propertyNameToID("u_LightClusterBuffer"),Qt.TIME=t.Shader3D.propertyNameToID("u_Time"),Qt.GIRotate=t.Shader3D.propertyNameToID("u_GIRotate");let r=Qt.sceneUniformMap=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Scene3D");r.addShaderUniform(Qt.TIME,"u_Time",e.ShaderDataType.Float),r.addShaderUniform(Qt.FOGPARAMS,"u_FogParams",e.ShaderDataType.Vector4),r.addShaderUniform(Qt.FOGCOLOR,"u_FogColor",e.ShaderDataType.Color),r.addShaderUniform(Qt.LIGHTBUFFER,"u_LightBuffer",e.ShaderDataType.Texture2D),r.addShaderUniform(Qt.CLUSTERBUFFER,"u_LightClusterBuffer",e.ShaderDataType.Texture2D),r.addShaderUniform(Qt.GIRotate,"u_GIRotate",e.ShaderDataType.Float),r.addShaderUniform(Qt.DIRECTIONLIGHTCOUNT,"u_DirationLightCount",e.ShaderDataType.Int),b.init(),P.init()}static legacyLightingValueInit(){Qt.LIGHTDIRECTION=t.Shader3D.propertyNameToID("u_DirLightDirection"),Qt.sceneUniformMap.addShaderUniform(Qt.LIGHTDIRECTION,"u_DirLightDirection",e.ShaderDataType.Vector3),Qt.LIGHTDIRCOLOR=t.Shader3D.propertyNameToID("u_DirLightColor"),Qt.sceneUniformMap.addShaderUniform(Qt.LIGHTDIRCOLOR,"u_DirLightColor",e.ShaderDataType.Vector3),Qt.LIGHTMODE=t.Shader3D.propertyNameToID("u_DirLightMode"),Qt.sceneUniformMap.addShaderUniform(Qt.LIGHTMODE,"u_DirLightMode",e.ShaderDataType.Int),Qt.POINTLIGHTPOS=t.Shader3D.propertyNameToID("u_PointLightPos"),Qt.sceneUniformMap.addShaderUniform(Qt.POINTLIGHTPOS,"u_PointLightPos",e.ShaderDataType.Vector3),Qt.POINTLIGHTRANGE=t.Shader3D.propertyNameToID("u_PointLightRange"),Qt.sceneUniformMap.addShaderUniform(Qt.POINTLIGHTRANGE,"u_PointLightRange",e.ShaderDataType.Float),Qt.POINTLIGHTCOLOR=t.Shader3D.propertyNameToID("u_PointLightColor"),Qt.sceneUniformMap.addShaderUniform(Qt.POINTLIGHTCOLOR,"u_PointLightColor",e.ShaderDataType.Vector3),Qt.POINTLIGHTMODE=t.Shader3D.propertyNameToID("u_PointLightMode"),Qt.sceneUniformMap.addShaderUniform(Qt.POINTLIGHTMODE,"u_PointLightMode",e.ShaderDataType.Int),Qt.SPOTLIGHTPOS=t.Shader3D.propertyNameToID("u_SpotLightPos"),Qt.sceneUniformMap.addShaderUniform(Qt.SPOTLIGHTPOS,"u_SpotLightPos",e.ShaderDataType.Vector3),Qt.SPOTLIGHTDIRECTION=t.Shader3D.propertyNameToID("u_SpotLightDirection"),Qt.sceneUniformMap.addShaderUniform(Qt.SPOTLIGHTDIRECTION,"u_SpotLightDirection",e.ShaderDataType.Vector3),Qt.SPOTLIGHTSPOTANGLE=t.Shader3D.propertyNameToID("u_SpotLightSpot"),Qt.sceneUniformMap.addShaderUniform(Qt.SPOTLIGHTSPOTANGLE,"u_SpotLightSpot",e.ShaderDataType.Float),Qt.SPOTLIGHTRANGE=t.Shader3D.propertyNameToID("u_SpotLightRange"),Qt.sceneUniformMap.addShaderUniform(Qt.SPOTLIGHTRANGE,"u_SpotLightRange",e.ShaderDataType.Float),Qt.SPOTLIGHTCOLOR=t.Shader3D.propertyNameToID("u_SpotLightColor"),Qt.sceneUniformMap.addShaderUniform(Qt.SPOTLIGHTCOLOR,"u_SpotLightColor",e.ShaderDataType.Vector3),Qt.SPOTLIGHTMODE=t.Shader3D.propertyNameToID("u_SpotLightMode"),Qt.sceneUniformMap.addShaderUniform(Qt.SPOTLIGHTMODE,"u_SpotLightMode",e.ShaderDataType.Int)}static __init__(){if(t.Config3D._multiLighting){const a=4;var e=t.Config3D.maxLightCount,r=t.Config3D.lightClusterCount;ie.instance=new ie(r.x,r.y,r.z,Math.min(t.Config3D.maxLightCount,t.Config3D._maxAreaLightCountPerClusterAverage)),Qt._lightTexture=K._createFloatTextureBuffer(a,e),Qt._lightTexture.lock=!0,Qt._lightPixles=new Float32Array(e*a*4)}Qt.shaderValueInit();var a=t.Shader3D._configDefineValues;t.Config3D._multiLighting||(a.add(t.Shader3D.SHADERDEFINE_LEGACYSINGALLIGHTING),Qt.legacyLightingValueInit()),Qt._shadowCasterPass=new mt,t.Config._uniformBlock&&a.add(t.Shader3D.SHADERDEFINE_ENUNIFORMBLOCK),t.LayaGL.renderEngine.getCapable(t.RenderCapable.TextureFormat_R32G32B32A32)&&a.add(t.Shader3D.SHADERDEFINE_FLOATTEXTURE),t.LayaGL.renderEngine.getCapable(t.RenderCapable.Texture_FloatLinearFiltering)&&a.add(t.Shader3D.SHADERDEFINE_FLOATTEXTURE_FIL_LINEAR)}static load(e,r){t.ILaya.loader.load(e).then((e=>{if(r){let a;if(e){let r=e.create();a=r instanceof t.Scene?r._scene3D:r}r.runWith([a])}}))}get scene2D(){return this._scene2D}get sceneRenderableManager(){return this._sceneRenderManager}set sceneRenderableManager(e){e.list=this._sceneRenderManager.list,this._sceneRenderManager=e}get enableFog(){return this._enableFog}set enableFog(e){this._enableFog!==e&&(this._enableFog=e,e?this._shaderValues.addDefine(Fe.SHADERDEFINE_FOG):this._shaderValues.removeDefine(Fe.SHADERDEFINE_FOG))}get fogMode(){return this._fogMode}set fogMode(t){switch(this._fogMode=t,t){case e.FogMode.Linear:this._shaderValues.addDefine(Fe.SHADERDEFINE_FOG_LINEAR),this._shaderValues.removeDefine(Fe.SHADERDEFINE_FOG_EXP),this._shaderValues.removeDefine(Fe.SHADERDEFINE_FOG_EXP2);break;case e.FogMode.EXP:this._shaderValues.addDefine(Fe.SHADERDEFINE_FOG_EXP),this._shaderValues.removeDefine(Fe.SHADERDEFINE_FOG_LINEAR),this._shaderValues.removeDefine(Fe.SHADERDEFINE_FOG_EXP2);break;case e.FogMode.EXP2:this._shaderValues.addDefine(Fe.SHADERDEFINE_FOG_EXP2),this._shaderValues.removeDefine(Fe.SHADERDEFINE_FOG_LINEAR),this._shaderValues.removeDefine(Fe.SHADERDEFINE_FOG_EXP)}}get fogColor(){return this._shaderValues.getColor(Qt.FOGCOLOR)}set fogColor(e){this._shaderValues.setColor(Qt.FOGCOLOR,e)}get fogStart(){return this._fogParams.x}set fogStart(e){this._fogParams.x=e,this.fogParams=this._fogParams}get fogEnd(){return this._fogParams.y}set fogEnd(e){this._fogParams.y=e,this.fogParams=this._fogParams}get fogDensity(){return this._fogParams.z}set fogDensity(e){this._fogParams.z=e,this.fogParams=this._fogParams}get fogParams(){return this._shaderValues.getVector(Qt.FOGPARAMS)}set fogParams(e){this._shaderValues.setVector(Qt.FOGPARAMS,e)}get GIRotate(){return this._shaderValues.getNumber(Qt.GIRotate)}set GIRotate(e){this._shaderValues.setNumber(Qt.GIRotate,e)}get ambientMode(){return this._sceneReflectionProb.ambientMode}set ambientMode(e){this._sceneReflectionProb.ambientMode=e}get sceneReflectionProb(){return this._sceneReflectionProb}set sceneReflectionProb(e){this._sceneReflectionProb=e}get ambientColor(){return this._sceneReflectionProb.ambientColor}set ambientColor(e){this._sceneReflectionProb.ambientColor=e}get ambientIntensity(){return this._sceneReflectionProb.ambientIntensity}set ambientIntensity(e){this._sceneReflectionProb.ambientIntensity=e}get reflectionIntensity(){return this._sceneReflectionProb.reflectionIntensity}set reflectionIntensity(e){this._sceneReflectionProb.reflectionIntensity=e}get ambientSH(){return this._sceneReflectionProb.ambientSH}set ambientSH(e){this._sceneReflectionProb.ambientSH=e}get iblTex(){return this._sceneReflectionProb.iblTex}set iblTex(e){this._sceneReflectionProb.iblTex=e}get iblTexRGBD(){return this._sceneReflectionProb.iblTexRGBD}set iblTexRGBD(e){this._sceneReflectionProb.iblTexRGBD=e}get skyRenderer(){return this._skyRenderer}get physicsSimulation(){return this._physicsManager}get timer(){return this._timer}set timer(e){this._timer=e}get lightmaps(){return this._lightmaps.slice()}set lightmaps(e){var t=this._lightmaps;if(t)for(var r=0,a=t.length;r<a;r++){(n=t[r]).lightmapColor&&n.lightmapColor._removeReference(),n.lightmapDirection&&n.lightmapDirection._removeReference()}if(e){var i=e.length;for(t.length=i,r=0;r<i;r++){var n;(n=e[r]).lightmapColor&&n.lightmapColor._addReference(),n.lightmapDirection&&n.lightmapDirection._addReference(),t[r]=n}}else t.length=0;this._sceneModuleData.lightmapDirtyFlag=Qt._updateMark}get shadowMapFrequency(){return this._ShadowMapupdateFrequency}set shadowMapFrequency(e){this._ShadowMapupdateFrequency=e}constructor(){super(),this._reflectionsSource=0,this._reflectionsResolution="256",this._reflectionsIblSamples=128,this._lightCount=0,this._pointLights=new Le,this._spotLights=new Le,this._directionLights=new Le,this._alternateLights=new Ne,this._lightmaps=[],this._skyRenderer=new Ie,this._time=0,this._physicsStepTime=0,this._sunColor=new t.Color(1,1,1),this._sundir=new t.Vector3,this._collsionTestList=[],this._key=new t.SubmitKey,this._cameraPool=[],this._UI3DManager=new kt,this.currentCreationLayer=Math.pow(2,0),this.enableLight=!0,this._ShadowMapupdateFrequency=1,this.componentElementMap=new Map,this._componentElementDatasMap={},this._nodeType=1,this._componentDriver=new t.ComponentDriver,this._timer=t.ILaya.timer,this._sceneModuleData=E.Render3DModuleDataFactory.createSceneModuleData(),t.LayaEnv.isConch&&2!=window.conchConfig.getGraphicsAPI()&&(this._nativeObj=new window.conchSubmitScene3D(this.renderSubmit.bind(this))),r.Laya3D.enablePhysics&&(this._physicsManager=r.Laya3D.PhysicsCreateUtil.createPhysicsManger(Qt.physicsSettings)),this._shaderValues=t.LayaGL.renderDeviceFactory.createShaderData(null),this._shaderValues.addDefines(t.Shader3D._configDefineValues),this._fogParams=new t.Vector4(300,1e3,.01,0),this.enableFog=!1,this.fogStart=300,this.fogEnd=1e3,this.fogDensity=.01,this.fogColor=new t.Color(.7,.7,.7),this.fogMode=e.FogMode.Linear,this.GIRotate=0,this._scene=this,this._sceneRenderManager=new Gt,t.Config3D.debugFrustumCulling,this._volumeManager=new O,this._UI3DManager=new kt,this.sceneReflectionProb=this._volumeManager.reflectionProbeManager.sceneReflectionProbe,this._sceneReflectionProb.reflectionIntensity=1,this.ambientColor=new t.Color(.212,.227,.259),Qt.componentManagerMap.forEach(((e,t)=>{let r=e;this.componentElementMap.set(t,new r)}))}get componentElementDatasMap(){return this._componentElementDatasMap}set componentElementDatasMap(e){this._componentElementDatasMap=e,this.componentElementMap.forEach(((e,t)=>{e.Init(this._componentElementDatasMap[t])}))}_update(){var e=this.timer.delta/1e3;if(this._time+=e,this._shaderValues.setNumber(Qt.TIME,this._time),t.LayaEnv.isPlaying&&(this._physicsStepTime+=e,this._physicsStepTime>Qt.physicsSettings.fixedTimeStep)){let e=this._physicsManager;r.Laya3D.enablePhysics&&t.Stat.enablePhysicsUpdate&&e.update(this._physicsStepTime),this._physicsStepTime=0}this._componentDriver.callStart(),this._componentDriver.callUpdate(),this._componentDriver.callLateUpdate(),this._componentDriver.callDestroy(),this._volumeManager.needreCaculateAllRenderObjects()?this._volumeManager.reCaculateAllRenderObjects(this._sceneRenderManager.list):this._volumeManager.handleMotionlist(),this.componentElementMap.forEach((t=>{t.update(e)})),this._sceneRenderManager.renderUpdate(),this.skyRenderer.renderUpdate(Y._instance),this._renderByEditor||this._UI3DManager.update()}_binarySearchIndexInCameraPool(e){for(var t,r=0,a=this._cameraPool.length-1;r<=a;){t=Math.floor((r+a)/2);var i=this._cameraPool[t]._renderingOrder;if(i==e._renderingOrder)return t;i>e._renderingOrder?a=t-1:r=t+1}return r}_getGroup(){return this._group}_setGroup(e){this._group=e}_onActive(){super._onActive(),t.ILaya.stage._scene3Ds.push(this)}_onInActive(){super._onInActive();var e=t.ILaya.stage._scene3Ds;e.splice(e.indexOf(this),1)}_prepareSceneToRender(){var e=this._shaderValues;if(t.Config3D._multiLighting&&t.Stat.enableMulLight){var r=Qt._lightTexture,a=Qt._lightPixles;const A=r.width,x=4*A;var i=0,n=t.Stat.enableLight?this._directionLights._length:0,s=this._directionLights._elements;if(n>0){var o=this._directionLights.getBrightestLight();this._mainDirectionLight=s[o],this._directionLights.normalLightOrdering(o);for(var l=0;l<n;l++,i++){var h=(D=s[l]).direction,d=x*i;(S=D._intensityColor).x=t.Color.gammaToLinearSpace(D.color.r),S.y=t.Color.gammaToLinearSpace(D.color.g),S.z=t.Color.gammaToLinearSpace(D.color.b),t.Vector3.scale(S,D._intensity,S),D.owner.transform.worldMatrix.getForward(h),t.Vector3.normalize(h,h),a[d]=S.x,a[d+1]=S.y,a[d+2]=S.z,a[d+3]=D._lightmapBakedType,a[d+4]=h.x,a[d+5]=h.y,a[d+6]=h.z,0==l&&(this._sunColor=D.color,this._sundir=h)}e.addDefine(Fe.SHADERDEFINE_DIRECTIONLIGHT)}else e.removeDefine(Fe.SHADERDEFINE_DIRECTIONLIGHT),this._mainDirectionLight=null;var c=t.Stat.enableLight?this._pointLights._length:0;if(c>0){var u=this._pointLights._elements,_=this._pointLights.getBrightestLight();this._mainPointLight=u[_],this._pointLights.normalLightOrdering(_);for(l=0;l<c;l++,i++){var f=(T=u[l]).owner.transform.position;d=x*i;(S=T._intensityColor).x=t.Color.gammaToLinearSpace(T.color.r),S.y=t.Color.gammaToLinearSpace(T.color.g),S.z=t.Color.gammaToLinearSpace(T.color.b),t.Vector3.scale(S,T._intensity,S),a[d]=S.x,a[d+1]=S.y,a[d+2]=S.z,a[d+3]=T.range,a[d+4]=f.x,a[d+5]=f.y,a[d+6]=f.z,a[d+7]=T._lightmapBakedType}e.addDefine(Fe.SHADERDEFINE_POINTLIGHT)}else e.removeDefine(Fe.SHADERDEFINE_POINTLIGHT),this._mainPointLight=null;var g=t.Stat.enableLight?this._spotLights._length:0;if(g>0){var m=this._spotLights._elements,p=this._spotLights.getBrightestLight();this._mainSpotLight=m[p],this._spotLights.normalLightOrdering(p);for(l=0;l<g;l++,i++){var S,E=m[l];h=E.direction,f=E.owner.transform.position,d=x*i;(S=E._intensityColor).x=t.Color.gammaToLinearSpace(E.color.r),S.y=t.Color.gammaToLinearSpace(E.color.g),S.z=t.Color.gammaToLinearSpace(E.color.b),t.Vector3.scale(S,E._intensity,S),E.owner.transform.worldMatrix.getForward(h),t.Vector3.normalize(h,h),a[d]=S.x,a[d+1]=S.y,a[d+2]=S.z,a[d+3]=E.range,a[d+4]=f.x,a[d+5]=f.y,a[d+6]=f.z,a[d+7]=E.spotAngle*Math.PI/180,a[d+8]=h.x,a[d+9]=h.y,a[d+10]=h.z,a[d+11]=E._lightmapBakedType}e.addDefine(Fe.SHADERDEFINE_SPOTLIGHT)}else e.removeDefine(Fe.SHADERDEFINE_SPOTLIGHT),this._mainSpotLight=null;i>0&&r.setSubPixelsData(0,0,A,i,a,0,!1,!1,!1),e.setTexture(Qt.LIGHTBUFFER,r),e.setInt(Qt.DIRECTIONLIGHTCOUNT,this._directionLights._length),e.setTexture(Qt.CLUSTERBUFFER,ie.instance._clusterTexture)}else{if(Qt.LIGHTDIRECTION||Qt.legacyLightingValueInit(),this._directionLights._length>0&&t.Stat.enableLight){var D=this._directionLights._elements[0];this._mainDirectionLight=D,D._intensityColor.x=t.Color.gammaToLinearSpace(D.color.r),D._intensityColor.y=t.Color.gammaToLinearSpace(D.color.g),D._intensityColor.z=t.Color.gammaToLinearSpace(D.color.b),t.Vector3.scale(D._intensityColor,D._intensity,D._intensityColor),D.owner.transform.worldMatrix.getForward(D.direction),t.Vector3.normalize(D.direction,D.direction),e.setVector3(Qt.LIGHTDIRCOLOR,D._intensityColor),e.setVector3(Qt.LIGHTDIRECTION,D.direction),e.setInt(Qt.LIGHTMODE,D._lightmapBakedType),0==l&&(this._sunColor=D.color,this._sundir=D.direction),e.addDefine(Fe.SHADERDEFINE_DIRECTIONLIGHT)}else e.removeDefine(Fe.SHADERDEFINE_DIRECTIONLIGHT);if(this._pointLights._length>0&&t.Stat.enableLight){var T=this._pointLights._elements[0];this._mainPointLight=T,T._intensityColor.x=t.Color.gammaToLinearSpace(T.color.r),T._intensityColor.y=t.Color.gammaToLinearSpace(T.color.g),T._intensityColor.z=t.Color.gammaToLinearSpace(T.color.b),t.Vector3.scale(T._intensityColor,T._intensity,T._intensityColor),e.setVector3(Qt.POINTLIGHTCOLOR,T._intensityColor),e.setVector3(Qt.POINTLIGHTPOS,T.owner.transform.position),e.setNumber(Qt.POINTLIGHTRANGE,T.range),e.setInt(Qt.POINTLIGHTMODE,T._lightmapBakedType),e.addDefine(Fe.SHADERDEFINE_POINTLIGHT)}else e.removeDefine(Fe.SHADERDEFINE_POINTLIGHT);if(this._spotLights._length>0&&t.Stat.enableLight){var A=this._spotLights._elements[0];this._mainSpotLight=A,A._intensityColor.x=t.Color.gammaToLinearSpace(A.color.r),A._intensityColor.y=t.Color.gammaToLinearSpace(A.color.g),A._intensityColor.z=t.Color.gammaToLinearSpace(A.color.b),t.Vector3.scale(A._intensityColor,A._intensity,A._intensityColor),e.setVector3(Qt.SPOTLIGHTCOLOR,A._intensityColor),e.setVector3(Qt.SPOTLIGHTPOS,A.owner.transform.position),A.owner.transform.worldMatrix.getForward(A.direction),t.Vector3.normalize(A.direction,A.direction),e.setVector3(Qt.SPOTLIGHTDIRECTION,A.direction),e.setNumber(Qt.SPOTLIGHTRANGE,A.range),e.setNumber(Qt.SPOTLIGHTSPOTANGLE,A.spotAngle*Math.PI/180),e.setInt(Qt.SPOTLIGHTMODE,A._lightmapBakedType),e.addDefine(Fe.SHADERDEFINE_SPOTLIGHT)}else e.removeDefine(Fe.SHADERDEFINE_SPOTLIGHT)}}get cullInfoCamera(){return this._cullInfoCamera}_setCullCamera(e){this._cullInfoCamera=e}recaculateCullCamera(){this._cullInfoCamera=this._cameraPool[0],this._cameraPool.forEach((e=>{this.cullInfoCamera.maxlocalYDistance<e.maxlocalYDistance&&(this._cullInfoCamera=e)}))}_addCamera(e){for(var t=this._binarySearchIndexInCameraPool(e),r=e._renderingOrder,a=this._cameraPool.length;t<a&&this._cameraPool[t]._renderingOrder<=r;)t++;this._cameraPool.splice(t,0,e)}_removeCamera(e){this._cameraPool.splice(this._cameraPool.indexOf(e),1)}_addRenderObject(e){this._sceneRenderManager.addRenderObject(e),e._inRenderList=!0,e._addReflectionProbeUpdate()}_removeRenderObject(e){e._inRenderList=!1,this._sceneRenderManager.removeRenderObject(e)}destroy(e=!0){if(!this._destroyed){super.destroy(e),this._nativeObj=null,this._skyRenderer.destroy(),this._skyRenderer=null,this._directionLights=null,this._pointLights=null,this._spotLights=null,this._alternateLights=null,Y._instance.scene==this&&(Y._instance.scene=null),this._shaderValues.destroy(),this._shaderValues=null,this.sceneRenderableManager.destroy(),this._sceneRenderManager=null,this._cameraPool=null,this._physicsManager&&this._physicsManager.destroy();var t=this._lightmaps;if(t)for(var r=0,a=t.length;r<a;r++){var i=t[r];i.lightmapColor&&i.lightmapColor._removeReference(),i.lightmapDirection&&i.lightmapDirection._removeReference()}this._lightmaps=null,this._volumeManager.destroy(),this._componentDriver.callDestroy()}}getComponentElementManager(e){return this.componentElementMap.get(e)}render(e){}renderSubmit(){if(!(this._children.length<=0||this._renderByEditor)){var e,r;for(this._prepareSceneToRender(),Qt._updateMark++,e=0,r=this._cameraPool.length;e<r;e++){var a=this._cameraPool[e];a.enableRender&&a.activeInHierarchy&&(a.renderTarget?a.enableBuiltInRenderTexture||(a.enableBuiltInRenderTexture=!1):a.enableBuiltInRenderTexture||(a.enableBuiltInRenderTexture=!0),a.render(this),a._offScreenRenderTexture||this.blitMainCanvans(a._internalRenderTexture,a.normalizedViewport,a),a._aftRenderMainPass())}t.Context.set2DRenderConfig(),t.RenderTexture.clearPool()}}blitMainCanvans(e,r,a){if(e){Qt.mainCavansViewPort.x=Y.clientWidth*r.x|0,Qt.mainCavansViewPort.y=Y.clientHeight*r.y|0,Qt.mainCavansViewPort.width=Y.clientWidth*r.width|0,Qt.mainCavansViewPort.height=Y.clientHeight*r.height|0,e.filterMode=t.FilterMode.Bilinear,a.fxaa&&Ht.shaderdata.addDefine(we.SHADERDEFINE_FXAA);var i=Ht.create(e,null,Qt.mainCavansViewPort,null,null,Ht.shaderdata);i.run(),i.recover(),t.RenderTexture2D._clear=!1,Ht.shaderdata.removeDefine(we.SHADERDEFINE_FXAA)}}reUse(e,t){return 0}setGlobalShaderValue(e,r,a){var i=t.Shader3D.propertyNameToID(e);this._shaderValues.setShaderData(i,r,a)}get fogRange(){return this._fogParams.y-this.fogParams.x}set fogRange(e){this._fogParams.y=e+this.fogParams.x,this.fogParams=this._fogParams}setlightmaps(e){for(var t=this._lightmaps,r=0,a=t.length;r<a;r++)t[r].lightmapColor._removeReference();if(!e)throw new Error("Scene3D: value value can't be null.");var i=e.length;for(t.length=i,r=0;r<i;r++){var n=e[r];n._addReference(),t[r]||(t[r]=new Pe),t[r].lightmapColor=n}}getlightmaps(){for(var e=new Array(this._lightmaps.length),t=0;t<this._lightmaps.length;t++)e[t]=this._lightmaps[t].lightmapColor;return e}}Qt.physicsSettings=new _e,Qt.mainCavansViewPort=new t.Viewport(0,0,1,1),Qt.componentManagerMap=new Map;class Yt extends xe{static __init__(){Yt.instance=new Yt}constructor(){super(t.MeshTopology.Triangles,t.DrawType.DrawElementInstance),this.instanceWorldMatrixData=new Float32Array(20*Yt.maxInstanceCount),this.instanceSimpleAnimatorData=new Float32Array(4*Yt.maxInstanceCount),this.indexFormat=t.IndexFormat.UInt16,this.instanceWorldMatrixBuffer=E.renderOBJCreate.createVertexBuffer3D(4*this.instanceWorldMatrixData.length,t.BufferUsage.Dynamic,!1),this.instanceWorldMatrixBuffer.vertexDeclaration=t.VertexMesh.instanceWorldMatrixDeclaration,this.instanceWorldMatrixBuffer.instanceBuffer=!0,this.instanceSimpleAnimatorBuffer=E.renderOBJCreate.createVertexBuffer3D(4*this.instanceSimpleAnimatorData.length,t.BufferUsage.Dynamic,!1),this.instanceSimpleAnimatorBuffer.vertexDeclaration=t.VertexMesh.instanceSimpleAnimatorDeclaration,this.instanceSimpleAnimatorBuffer.instanceBuffer=!0}_updateRenderParams(e){}}Yt.maxInstanceCount=1024;class Xt extends H{static create(){let e=Xt._pool.length>0?Xt._pool.pop():new Xt;return e._isInPool=!1,e.clear(),e}constructor(){super(),this._InvertFront=!1,this.setGeometry(new wt(null)),this._instanceBatchElementList=new t.FastSinglelist,this._isUpdataData=!0,this._invertFrontFace=!1}getInvertFront(){return this._invertFrontFace}set InvertFront(e){this._InvertFront=e}_createRenderElementOBJ(){}compileShader(e){this._subShader._passes}_renderUpdatePre(e){}updateInstanceData(e){}clear(){this._instanceBatchElementList.length=0}recover(){}}Xt.maxInstanceCount=1024,Xt._pool=[];class Kt extends xe{get indexCount(){return this._indexCount}constructor(e){super(t.MeshTopology.Triangles,t.DrawType.DrawElement),this.indexFormat=e.indexFormat,e.indexFormat!==t.IndexFormat.UInt32||t.LayaGL.renderEngine.getCapable(t.RenderCapable.Element_Index_Uint32)?(this._mesh=e,this._boneIndicesList=[],this._subIndexBufferStart=[],this._subIndexBufferCount=[],this.bufferState=e._bufferState):console.warn("SubMesh:this device do not support IndexFormat.UInt32.")}_setIndexRange(e,r,a=t.IndexFormat.UInt16){this._indexStart=e,this._indexCount=r,this._indexBuffer.canRead&&(a==t.IndexFormat.UInt16?this._indices=new Uint16Array(this._indexBuffer.getData().buffer,2*e,r):this._indices=new Uint32Array(this._indexBuffer.getData().buffer,4*e,r))}_getType(){return Kt._type}_prepareRender(e){return this._mesh._uploadVerticesData(),!0}_updateRenderParams(e){var r;switch(this._mesh._indexFormat){case t.IndexFormat.UInt32:r=4;break;case t.IndexFormat.UInt16:r=2;break;case t.IndexFormat.UInt8:r=1}if(this.clearRenderParams(),this._boneIndicesList&&this._boneIndicesList.length>1)for(var a=0,i=this._boneIndicesList.length;a<i;a++)this.setDrawElemenParams(this._subIndexBufferCount[a],this._subIndexBufferStart[a]*r);else this.setDrawElemenParams(this._indexCount,this._indexStart*r)}getIndices(){if(this._mesh._isReadable)return this._indices.slice();throw new t.NotReadableError}setIndices(e){this._indexBuffer.setData(e,this._indexStart,0,this._indexCount)}destroy(){this._destroyed||(super.destroy(),this._indexBuffer=null,this._vertexBuffer=null,this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null)}}Kt._type=xe._typeCounter++,e.EPhysicsCapable=void 0,(Wt=e.EPhysicsCapable||(e.EPhysicsCapable={}))[Wt.Physics_Gravity=0]="Physics_Gravity",Wt[Wt.Physics_StaticCollider=1]="Physics_StaticCollider",Wt[Wt.Physics_DynamicCollider=2]="Physics_DynamicCollider",Wt[Wt.Physics_CharacterCollider=3]="Physics_CharacterCollider",Wt[Wt.Physics_BoxColliderShape=4]="Physics_BoxColliderShape",Wt[Wt.Physics_SphereColliderShape=5]="Physics_SphereColliderShape",Wt[Wt.Physics_CapsuleColliderShape=6]="Physics_CapsuleColliderShape",Wt[Wt.Physics_CylinderColliderShape=7]="Physics_CylinderColliderShape",Wt[Wt.Physics_ConeColliderShape=8]="Physics_ConeColliderShape",Wt[Wt.Physics_MeshColliderShape=9]="Physics_MeshColliderShape",Wt[Wt.Physics_CompoundColliderShape=10]="Physics_CompoundColliderShape",Wt[Wt.Physics_CreateCorveMesh=11]="Physics_CreateCorveMesh",Wt[Wt.physics_heightFieldColliderShape=12]="physics_heightFieldColliderShape",Wt[Wt.Physics_Joint=13]="Physics_Joint",Wt[Wt.Physics_FixedJoint=14]="Physics_FixedJoint",Wt[Wt.Physics_SpringJoint=15]="Physics_SpringJoint",Wt[Wt.Physics_HingeJoint=16]="Physics_HingeJoint",Wt[Wt.Physics_D6Joint=17]="Physics_D6Joint";class Jt{constructor(e,t,r){this.subMeshIndex=e,this.batchIndex=t,this.batchBoneIndex=r}}class jt extends t.Resource{static load(e,r){t.ILaya.loader.load(e,r,null,t.Loader.MESH)}get inverseAbsoluteBindPoses(){return this._inverseBindPoses}get vertexCount(){return this._vertexCount}get indexCount(){return this._indexBuffer.indexCount}get subMeshCount(){return this._subMeshes.length}get bounds(){return this._bounds}set bounds(e){this._bounds!==e&&e.cloneTo(this._bounds)}get indexFormat(){return this._indexFormat}set indexFormat(e){this._indexFormat=e,this._subMeshes.forEach((t=>{t.indexFormat=e}))}constructor(e=!0){super(),this._minVerticesUpdate=-1,this._maxVerticesUpdate=-1,this._needUpdateBounds=!0,this._bufferState=new t.BufferState,this._instanceBufferStateType=0,this._vertexBuffer=null,this._indexBuffer=null,this._skinnedMatrixCaches=[],this._vertexCount=0,this._indexFormat=t.IndexFormat.UInt16,this._bounds=new w(new t.Vector3,new t.Vector3),this._isReadable=e,this._subMeshes=[],this.destroyedImmediately=t.Config.destroyResourceImmediatelyDefault}_getPositionElement(e){for(var r=e.vertexDeclaration._vertexElements,a=0,i=r.length;a<i;a++){var n=r[a];if(n._elementFormat===t.VertexElementFormat.Vector3&&n._elementUsage===t.VertexMesh.MESH_POSITION0)return n}return null}_getVerticeElementData(e,r){e.length=this._vertexCount;var a=this._vertexBuffer.vertexDeclaration,i=a.getVertexElementByUsage(r);if(i){var n=this._vertexBuffer.getUint8Data(),s=this._vertexBuffer.getFloat32Data(),o=a.vertexStride,l=o/4,h=i._offset,d=h/4;switch(r){case t.VertexMesh.MESH_TEXTURECOORDINATE0:case t.VertexMesh.MESH_TEXTURECOORDINATE1:for(var c=0;c<this._vertexCount;c++){var u=l*c+d;e[c]=new t.Vector2(s[u],s[u+1])}break;case t.VertexMesh.MESH_POSITION0:case t.VertexMesh.MESH_NORMAL0:for(c=0;c<this._vertexCount;c++){u=l*c+d;e[c]=new t.Vector3(s[u],s[u+1],s[u+2])}break;case t.VertexMesh.MESH_TANGENT0:case t.VertexMesh.MESH_BLENDWEIGHT0:for(c=0;c<this._vertexCount;c++){u=l*c+d;e[c]=new t.Vector4(s[u],s[u+1],s[u+2],s[u+3])}break;case t.VertexMesh.MESH_COLOR0:for(c=0;c<this._vertexCount;c++){u=l*c+d;e[c]=new t.Color(s[u],s[u+1],s[u+2],s[u+3])}break;case t.VertexMesh.MESH_BLENDINDICES0:for(c=0;c<this._vertexCount;c++){u=o*c+h;e[c]=new t.Vector4(n[u],n[u+1],n[u+2],n[u+3])}break;default:throw"Mesh:Unknown elementUsage."}}}_setVerticeElementData(e,r){var a=this._vertexBuffer.vertexDeclaration,i=a.getVertexElementByUsage(r);if(i){var n=this._vertexBuffer.getUint8Data(),s=this._vertexBuffer.getFloat32Data(),o=a.vertexStride,l=o/4,h=i._offset,d=h/4;switch(r){case t.VertexMesh.MESH_TEXTURECOORDINATE0:case t.VertexMesh.MESH_TEXTURECOORDINATE1:for(var c=0,u=e.length;c<u;c++){var _=l*c+d,f=e[c];s[_]=f.x,s[_+1]=f.y}break;case t.VertexMesh.MESH_POSITION0:case t.VertexMesh.MESH_NORMAL0:for(c=0,u=e.length;c<u;c++){_=l*c+d;var g=e[c];s[_]=g.x,s[_+1]=g.y,s[_+2]=g.z}break;case t.VertexMesh.MESH_TANGENT0:case t.VertexMesh.MESH_BLENDWEIGHT0:for(c=0,u=e.length;c<u;c++){_=l*c+d;var m=e[c];s[_]=m.x,s[_+1]=m.y,s[_+2]=m.z,s[_+3]=m.w}break;case t.VertexMesh.MESH_COLOR0:for(c=0,u=e.length;c<u;c++){_=l*c+d;var p=e[c];s[_]=p.r,s[_+1]=p.g,s[_+2]=p.b,s[_+3]=p.a}break;case t.VertexMesh.MESH_BLENDINDICES0:for(c=0,u=e.length;c<u;c++){_=o*c+h,m=e[c];n[_]=m.x,n[_+1]=m.y,n[_+2]=m.z,n[_+3]=m.w}break;default:throw"Mesh:Unknown elementUsage."}this._minVerticesUpdate=0,this._maxVerticesUpdate=Number.MAX_SAFE_INTEGER,this._vertexBuffer.setData(s.buffer,0,0,s.byteLength)}else console.warn("Mesh: the mesh don't have  this VertexElement.")}_disposeResource(){for(var e=0,t=this._subMeshes.length;e<t;e++)this._subMeshes[e].destroy();this._vertexBuffer&&this._vertexBuffer.destroy(),this._indexBuffer&&this._indexBuffer.destroy(),this._bufferState.destroy(),this._instanceBufferState&&this._instanceBufferState.destroy(),this._instanceWorldVertexBuffer&&this._instanceWorldVertexBuffer.destroy(),this._instanceSimpleAniVertexBuffer&&this._instanceSimpleAniVertexBuffer.destroy(),this._instanceLightMapVertexBuffer&&this._instanceLightMapVertexBuffer.destroy(),this.instanceLightMapScaleOffsetData&&(this.instanceLightMapScaleOffsetData=null),this._setCPUMemory(0),this._setGPUMemory(0),this._bufferState=null,this._instanceBufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._subMeshes=null,this._btTriangleMesh=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null,this.morphTargetData&&this.morphTargetData.destroy(),this.__convexMesh&&this.__convexMesh.destroy()}_setSubMeshes(e){this._subMeshes=e;for(var t=0,r=e.length;t<r;t++)e[t]._indexInMesh=t}_setBuffer(e,t){this._bufferState.applyState([e],t)}_setInstanceBuffer(){if(this._instanceBufferState)return;var e=this._instanceBufferState=new t.BufferState,r=this._instanceBufferStateType;let a=[];a.push(this._vertexBuffer);let i=this._instanceWorldVertexBuffer=E.renderOBJCreate.createVertexBuffer3D(16*Xt.maxInstanceCount*4,t.BufferUsage.Dynamic,!1);switch(i.vertexDeclaration=t.VertexMesh.instanceWorldMatrixDeclaration,i.instanceBuffer=!0,a.push(i),r){case jt.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR:let e=this._instanceSimpleAniVertexBuffer=E.renderOBJCreate.createVertexBuffer3D(4*Xt.maxInstanceCount*4,t.BufferUsage.Dynamic,!1);e.vertexDeclaration=t.VertexMesh.instanceSimpleAnimatorDeclaration,e.instanceBuffer=!0,a.push(e);break;case jt.MESH_INSTANCEBUFFER_TYPE_NORMAL:if(this.getVertexDeclaration().getVertexElementByUsage(t.VertexMesh.MESH_TEXTURECOORDINATE1)){let e=this._instanceLightMapVertexBuffer=E.renderOBJCreate.createVertexBuffer3D(4*Xt.maxInstanceCount*4,t.BufferUsage.Dynamic,!1);e.vertexDeclaration=t.VertexMesh.instanceLightMapScaleOffsetDeclaration,e.instanceBuffer=!0,this.instanceLightMapScaleOffsetData=new Float32Array(4*Xt.maxInstanceCount),a.push(e)}}e.applyState(a,this._indexBuffer)}_uploadVerticesData(){var e=this._minVerticesUpdate,t=this._maxVerticesUpdate;if(-1!==e&&-1!==t){var r=e;this._vertexBuffer.setData(this._vertexBuffer.getUint8Data().buffer,r,r,t-e),this._minVerticesUpdate=-1,this._maxVerticesUpdate=-1}}getSubMesh(e){return this._subMeshes[e]}getPositions(e){if(!this._isReadable)throw new t.NotReadableError;this._getVerticeElementData(e,t.VertexMesh.MESH_POSITION0)}setPositions(e){if(!this._isReadable)throw new t.NotReadableError;this._setVerticeElementData(e,t.VertexMesh.MESH_POSITION0),this._needUpdateBounds=!0}getColors(e){if(!this._isReadable)throw new t.NotReadableError;this._getVerticeElementData(e,t.VertexMesh.MESH_COLOR0)}setColors(e){if(!this._isReadable)throw new t.NotReadableError;this._setVerticeElementData(e,t.VertexMesh.MESH_COLOR0)}getUVs(e,r=0){if(!this._isReadable)throw new t.NotReadableError;switch(r){case 0:this._getVerticeElementData(e,t.VertexMesh.MESH_TEXTURECOORDINATE0);break;case 1:this._getVerticeElementData(e,t.VertexMesh.MESH_TEXTURECOORDINATE1);break;default:throw"Mesh:Invalid channel."}}setUVs(e,r=0){if(!this._isReadable)throw new t.NotReadableError;switch(r){case 0:this._setVerticeElementData(e,t.VertexMesh.MESH_TEXTURECOORDINATE0);break;case 1:this._setVerticeElementData(e,t.VertexMesh.MESH_TEXTURECOORDINATE1);break;default:throw"Mesh:Invalid channel."}}getNormals(e){if(!this._isReadable)throw new t.NotReadableError;this._getVerticeElementData(e,t.VertexMesh.MESH_NORMAL0)}setNormals(e){if(!this._isReadable)throw new t.NotReadableError;this._setVerticeElementData(e,t.VertexMesh.MESH_NORMAL0)}getTangents(e){if(!this._isReadable)throw new t.NotReadableError;this._getVerticeElementData(e,t.VertexMesh.MESH_TANGENT0)}setTangents(e){if(!this._isReadable)throw new t.NotReadableError;this._setVerticeElementData(e,t.VertexMesh.MESH_TANGENT0)}getBoneWeights(e){if(!this._isReadable)throw new t.NotReadableError;this._getVerticeElementData(e,t.VertexMesh.MESH_BLENDWEIGHT0)}setBoneWeights(e){if(!this._isReadable)throw new t.NotReadableError;this._setVerticeElementData(e,t.VertexMesh.MESH_BLENDWEIGHT0)}getBoneIndices(e){if(!this._isReadable)throw new t.NotReadableError;this._getVerticeElementData(e,t.VertexMesh.MESH_BLENDINDICES0)}setBoneIndices(e){if(!this._isReadable)throw new t.NotReadableError;this._setVerticeElementData(e,t.VertexMesh.MESH_BLENDINDICES0)}markAsUnreadbale(){this._uploadVerticesData(),this._vertexBuffer.markAsUnreadbale(),this._isReadable=!1}getVertexDeclaration(){return this._vertexBuffer.vertexDeclaration}getVertices(){if(this._isReadable)return this._vertexBuffer.getUint8Data().buffer.slice(0);throw new t.NotReadableError}setVertices(e){this._vertexBuffer.setData(e),this._needUpdateBounds=!0}getIndices(){if(this._isReadable)return this._indexBuffer.getData().slice();throw new t.NotReadableError}setIndices(e){var r;e instanceof Uint32Array?r=t.IndexFormat.UInt32:e instanceof Uint16Array?r=t.IndexFormat.UInt16:e instanceof Uint8Array&&(r=t.IndexFormat.UInt8);var a=this._indexBuffer;this._indexFormat===r&&a.indexCount===e.length||(a.destroy(),this._indexBuffer=a=E.renderOBJCreate.createIndexBuffer3D(r,e.length,t.BufferUsage.Static,this._isReadable)),a.setData(e),this.indexFormat=r}calculateBounds(){if(!this._isReadable)throw new t.NotReadableError;if(this._needUpdateBounds){var e=qt,r=Zt;e.x=e.y=e.z=Number.MAX_VALUE,r.x=r.y=r.z=-Number.MAX_VALUE;for(var a=this._vertexBuffer,i=this._getPositionElement(a),n=a.getFloat32Data(),s=a.vertexDeclaration.vertexStride/4,o=i._offset/4,l=0,h=n.length;l<h;l+=s){var d=l+o,c=n[d],u=n[d+1],_=n[d+2];e.x=Math.min(e.x,c),e.y=Math.min(e.y,u),e.z=Math.min(e.z,_),r.x=Math.max(r.x,c),r.y=Math.max(r.y,u),r.z=Math.max(r.z,_)}this._bounds.setMin(e),this._bounds.setMax(r),this._needUpdateBounds=!1}}getCorveMesh(){if(null==this._convexMesh)return null;let t=r.Laya3D._PhysicsCreateUtil;return null==this.__convexMesh&&t&&t.getPhysicsCapable(e.EPhysicsCapable.Physics_CreateCorveMesh)&&(this.__convexMesh=t.createCorveMesh(this)),this.__convexMesh}cloneTo(e){var r=this._vertexBuffer,a=E.renderOBJCreate.createVertexBuffer3D(r._byteLength,r.bufferUsage,r.canRead);a.vertexDeclaration=r.vertexDeclaration,a.setData(r.getUint8Data().slice().buffer),e._vertexBuffer=a,e._vertexCount=this._vertexCount;var i,n=this._indexBuffer,s=E.renderOBJCreate.createIndexBuffer3D(t.IndexFormat.UInt16,n.indexCount,n.bufferUsage,n.canRead);s.setData(n.getData().slice()),e._indexBuffer=s,e._setBuffer(e._vertexBuffer,s),e._instanceBufferStateType=this._instanceBufferStateType,e._setCPUMemory(this.cpuMemory),e._setGPUMemory(this.gpuMemory);var o=this._boneNames;if(o){var l=e._boneNames=[];for(i=0;i<o.length;i++)l[i]=o[i]}var h=this._inverseBindPoses;if(h){var d=e._inverseBindPoses=[];for(i=0;i<h.length;i++)d[i]=h[i]}if(this._inverseBindPosesBuffer){let t=this._inverseBindPosesBuffer.byteLength;e._inverseBindPosesBuffer=new ArrayBuffer(t),new Uint8Array(e._inverseBindPosesBuffer).set(new Uint8Array(this._inverseBindPosesBuffer))}var c=this._skinnedMatrixCaches.length;for(e._skinnedMatrixCaches.length=c,i=0;i<c;i++){var u=this._skinnedMatrixCaches[i];u&&(e._skinnedMatrixCaches[i]=new Jt(u.subMeshIndex,u.batchIndex,u.batchBoneIndex))}for(i=0;i<this.subMeshCount;i++){var _=this._subMeshes[i],f=_._subIndexBufferStart,g=_._subIndexBufferCount,m=_._boneIndicesList,p=new Kt(e);p._subIndexBufferStart.length=f.length,p._subIndexBufferCount.length=g.length,p._boneIndicesList.length=m.length;for(var S=0;S<f.length;S++)p._subIndexBufferStart[S]=f[S];for(S=0;S<g.length;S++)p._subIndexBufferCount[S]=g[S];for(S=0;S<m.length;S++)p._boneIndicesList[S]=new Uint16Array(m[S]);p._indexBuffer=s,p._indexStart=_._indexStart,p._indexCount=_._indexCount,p._indices=new Uint16Array(s.getData().buffer,2*_._indexStart,_._indexCount);var D=e._vertexBuffer;p._vertexBuffer=D,e._subMeshes.push(p)}e._setSubMeshes(e._subMeshes),this.morphTargetData&&(e.morphTargetData=this.morphTargetData.clone())}clone(){var e=new jt;return this.cloneTo(e),e}}jt.MESH_INSTANCEBUFFER_TYPE_NORMAL=0,jt.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR=1;const qt=new t.Vector3,Zt=new t.Vector3;class $t{static __init__(){}static _createMesh(e,r,a){var i=new jt,n=new Kt(i),s=E.renderOBJCreate.createVertexBuffer3D(4*r.length,t.BufferUsage.Static,!0);s.vertexDeclaration=e,s.setData(r.buffer),i._vertexBuffer=s,i._vertexCount=s._byteLength/e.vertexStride;var o=E.renderOBJCreate.createIndexBuffer3D(t.IndexFormat.UInt16,a.length,t.BufferUsage.Static,!0);o.setData(a),i._indexBuffer=o,i._setBuffer(s,o),n._vertexBuffer=s,n._indexBuffer=o,n._setIndexRange(0,o.indexCount);var l=n._subIndexBufferStart,h=n._subIndexBufferCount,d=n._boneIndicesList;l.length=1,h.length=1,d.length=1,l[0]=0,h[0]=o.indexCount;var c=[];c.push(n),i._setSubMeshes(c),i.calculateBounds();var u=s._byteLength+o._byteLength;return i._setCPUMemory(u),i._setGPUMemory(u),i}static createBox(e=1,r=1,a=1){var i=t.VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),n=e/2,s=r/2,o=a/2,l=new Float32Array([-n,s,-o,0,1,0,0,0,n,s,-o,0,1,0,1,0,n,s,o,0,1,0,1,1,-n,s,o,0,1,0,0,1,-n,-s,-o,0,-1,0,0,1,n,-s,-o,0,-1,0,1,1,n,-s,o,0,-1,0,1,0,-n,-s,o,0,-1,0,0,0,-n,s,-o,-1,0,0,0,0,-n,s,o,-1,0,0,1,0,-n,-s,o,-1,0,0,1,1,-n,-s,-o,-1,0,0,0,1,n,s,-o,1,0,0,1,0,n,s,o,1,0,0,0,0,n,-s,o,1,0,0,0,1,n,-s,-o,1,0,0,1,1,-n,s,o,0,0,1,0,0,n,s,o,0,0,1,1,0,n,-s,o,0,0,1,1,1,-n,-s,o,0,0,1,0,1,-n,s,-o,0,0,-1,1,0,n,s,-o,0,0,-1,0,0,n,-s,-o,0,0,-1,0,1,-n,-s,-o,0,0,-1,1,1]),h=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);return $t._createMesh(i,l,h)}static createCapsule(e=.5,r=2,a=16,i=32){var n,s,o=(a+1)*(i+1)*2+2*(i+1),l=3*a*(i+1)*2*2+2*i*3,h=t.VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),d=h.vertexStride/4,c=new Float32Array(o*d),u=new Uint16Array(l),_=Math.PI/2/a,f=2*Math.PI/i,g=r/2-e,m=0,p=0,S=0,E=0,D=0,T=0;for(n=0;n<=a;n++)for(s=0;s<=i;s++)m=e*Math.cos(n*_)*Math.cos(s*f+Math.PI),p=e*Math.sin(n*_),S=e*Math.cos(n*_)*Math.sin(s*f+Math.PI),c[E++]=m,c[E++]=p+g,c[E++]=S,c[E++]=m,c[E++]=p,c[E++]=S,c[E++]=1-s/i,c[E++]=(1-n/a)*(Math.PI*e/2/(r+Math.PI*e)),n<a&&(u[D++]=n*(i+1)+s+(i+1),u[D++]=n*(i+1)+s,u[D++]=n*(i+1)+s+1,u[D++]=n*(i+1)+s+i,u[D++]=n*(i+1)+s,u[D++]=n*(i+1)+s+(i+1));for(T+=(a+1)*(i+1),n=0;n<=a;n++)for(s=0;s<=i;s++)m=e*Math.cos(n*_)*Math.cos(s*f+Math.PI),p=e*Math.sin(-n*_),S=e*Math.cos(n*_)*Math.sin(s*f+Math.PI),c[E++]=m,c[E++]=p-g,c[E++]=S,c[E++]=m,c[E++]=p,c[E++]=S,c[E++]=1-s/i,c[E++]=(n/a*(Math.PI*e/2)+(r+Math.PI*e/2))/(r+Math.PI*e),n<a&&(u[D++]=T+n*(i+1)+s,u[D++]=T+n*(i+1)+s+(i+1),u[D++]=T+n*(i+1)+s+1,u[D++]=T+n*(i+1)+s,u[D++]=T+n*(i+1)+s+i,u[D++]=T+n*(i+1)+s+(i+1));for(T+=(a+1)*(i+1),s=0;s<=i;s++)m=e*Math.cos(s*f+Math.PI),p=g,S=e*Math.sin(s*f+Math.PI),c[E++]=m,c[E+8*(i+1)-1]=m,c[E++]=p,c[E+8*(i+1)-1]=-p,c[E++]=S,c[E+8*(i+1)-1]=S,c[E++]=m,c[E+8*(i+1)-1]=m,c[E++]=0,c[E+8*(i+1)-1]=0,c[E++]=S,c[E+8*(i+1)-1]=S,c[E++]=1-1*s/i,c[E+8*(i+1)-1]=1-1*s/i,c[E++]=Math.PI*e/2/(r+Math.PI*e),c[E+8*(i+1)-1]=(Math.PI*e/2+r)/(r+Math.PI*e);for(s=0;s<i;s++)u[D++]=s+T+(i+1),u[D++]=s+T+1,u[D++]=s+T,u[D++]=s+T+(i+1),u[D++]=s+T+(i+1)+1,u[D++]=s+T+1;return T+=2*(i+1),$t._createMesh(h,c,u)}static createCone(e=.5,r=1,a=32){for(var i,n=a+1+1+2*(a+1),s=6*a+3*a,o=t.VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),l=o.vertexStride/4,h=new Float32Array(n*l),d=new Uint16Array(s),c=2*Math.PI/a,u=r/2,_=0,f=0,g=0,m=0,p=0,S=new t.Vector3,E=new t.Vector3(0,-1,0),D=new t.Vector3(0,u,0),T=new t.Vector3,A=new t.Vector3,x=new t.Quaternion,R=new t.Vector3,M=0,C=0,I=0;I<=a;I++)_=I*c,g=Math.cos(_+Math.PI)*e,m=u,p=Math.sin(_+Math.PI)*e,h[M++]=0,h[M+8*(a+1)-1]=g,h[M++]=m,h[M+8*(a+1)-1]=-m,h[M++]=0,h[M+8*(a+1)-1]=p,S.x=g,S.y=0,S.z=p,T.x=g,T.y=-m,T.z=p,t.Vector3.subtract(T,D,A),t.Vector3.normalize(A,A),i=Math.acos(t.Vector3.dot(E,A)),t.Vector3.cross(E,A,R),t.Vector3.normalize(R,R),t.Quaternion.createFromAxisAngle(R,i,x),t.Vector3.normalize(S,S),t.Vector3.transformQuat(S,x,S),t.Vector3.normalize(S,S),h[M++]=S.x,h[M+8*(a+1)-1]=S.x,h[M++]=S.y,h[M+8*(a+1)-1]=S.y,h[M++]=S.z,h[M+8*(a+1)-1]=S.z,h[M++]=1-1*I/a,h[M+8*(a+1)-1]=1-1*I/a,h[M++]=0,h[M+8*(a+1)-1]=1;M+=8*(a+1);for(var v=0;v<a;v++)d[C++]=v+f+(a+1),d[C++]=v+f+1,d[C++]=v+f,d[C++]=v+f+(a+1),d[C++]=v+f+(a+1)+1,d[C++]=v+f+1;f+=2*(a+1);for(var y=0;y<=a;y++)0===y&&(h[M++]=0,h[M++]=-u,h[M++]=0,h[M++]=0,h[M++]=-1,h[M++]=0,h[M++]=.5,h[M++]=.5),_=y*c,g=Math.cos(_+Math.PI)*e,m=-u,p=Math.sin(_+Math.PI)*e,h[M++]=g,h[M++]=m,h[M++]=p,h[M++]=0,h[M++]=-1,h[M++]=0,h[M++]=.5+.5*Math.cos(_),h[M++]=.5+.5*Math.sin(_);for(var B=0;B<a;B++)d[C++]=0+f,d[C++]=B+2+f,d[C++]=B+1+f;return f+=a+1+1,$t._createMesh(o,h,d)}static createCylinder(e=.5,r=2,a=32){for(var i=a+1+1+2*(a+1)+(a+1+1),n=3*a+6*a+3*a,s=t.VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),o=s.vertexStride/4,l=new Float32Array(i*o),h=new Uint16Array(n),d=2*Math.PI/a,c=r/2,u=0,_=0,f=0,g=0,m=0,p=0,S=0,E=0;E<=a;E++)0===E&&(l[p++]=0,l[p++]=c,l[p++]=0,l[p++]=0,l[p++]=1,l[p++]=0,l[p++]=.5,l[p++]=.5),u=E*d,f=Math.cos(u)*e,g=c,m=Math.sin(u)*e,l[p++]=f,l[p++]=g,l[p++]=m,l[p++]=0,l[p++]=1,l[p++]=0,l[p++]=.5+.5*Math.cos(u),l[p++]=.5+.5*Math.sin(u);for(var D=0;D<a;D++)h[S++]=0,h[S++]=D+1,h[S++]=D+2;_+=a+1+1;for(var T=0;T<=a;T++)u=T*d,f=Math.cos(u+Math.PI)*e,g=c,m=Math.sin(u+Math.PI)*e,l[p++]=f,l[p+8*(a+1)-1]=f,l[p++]=g,l[p+8*(a+1)-1]=-g,l[p++]=m,l[p+8*(a+1)-1]=m,l[p++]=f,l[p+8*(a+1)-1]=f,l[p++]=0,l[p+8*(a+1)-1]=0,l[p++]=m,l[p+8*(a+1)-1]=m,l[p++]=1-1*T/a,l[p+8*(a+1)-1]=1-1*T/a,l[p++]=0,l[p+8*(a+1)-1]=1;p+=8*(a+1);for(var A=0;A<a;A++)h[S++]=A+_+(a+1),h[S++]=A+_+1,h[S++]=A+_,h[S++]=A+_+(a+1),h[S++]=A+_+(a+1)+1,h[S++]=A+_+1;_+=2*(a+1);for(var x=0;x<=a;x++)0===x&&(l[p++]=0,l[p++]=-c,l[p++]=0,l[p++]=0,l[p++]=-1,l[p++]=0,l[p++]=.5,l[p++]=.5),u=x*d,f=Math.cos(u+Math.PI)*e,g=-c,m=Math.sin(u+Math.PI)*e,l[p++]=f,l[p++]=g,l[p++]=m,l[p++]=0,l[p++]=-1,l[p++]=0,l[p++]=.5+.5*Math.cos(u),l[p++]=.5+.5*Math.sin(u);for(var R=0;R<a;R++)h[S++]=0+_,h[S++]=R+2+_,h[S++]=R+1+_;return _+=a+1+1,$t._createMesh(s,l,h)}static createPlane(e=10,r=10,a=10,i=10){for(var n=(a+1)*(i+1),s=new Uint16Array(a*i*2*3),o=t.VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),l=o.vertexStride/4,h=new Float32Array(n*l),d=e/2,c=r/2,u=e/a,_=r/i,f=0,g=0;g<=i;g++)for(var m=0;m<=a;m++)h[f++]=m*u-d,h[f++]=0,h[f++]=g*_-c,h[f++]=0,h[f++]=1,h[f++]=0,h[f++]=1*m/a,h[f++]=1*g/i;var p=0;for(g=0;g<i;g++)for(m=0;m<a;m++)s[p++]=(g+1)*(a+1)+m,s[p++]=g*(a+1)+m,s[p++]=(g+1)*(a+1)+m+1,s[p++]=g*(a+1)+m,s[p++]=g*(a+1)+m+1,s[p++]=(g+1)*(a+1)+m+1;return $t._createMesh(o,h,s)}static createQuad(e=1,r=1){var a=t.VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),i=e/2,n=r/2,s=new Float32Array([-i,n,0,0,0,1,0,0,i,n,0,0,0,1,1,0,-i,-n,0,0,0,1,0,1,i,-n,0,0,0,1,1,1]),o=new Uint16Array([0,1,2,3,2,1]);return $t._createMesh(a,s,o)}static createSphere(e=.5,r=32,a=32){var i=(r+1)*(a+1),n=3*r*(a+1)*2,s=new Uint16Array(n),o=t.VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),l=o.vertexStride/4,h=new Float32Array(i*l),d=Math.PI/r,c=2*Math.PI/a,u=0;i=0,n=0;for(var _=0;_<r+1;_++)for(var f=Math.sin(_*d),g=Math.cos(_*d),m=0;m<a+1;m++){var p=f*Math.sin(m*c+1*Math.PI/2),S=f*Math.cos(m*c+1*Math.PI/2);h[i+0]=p*e,h[i+1]=g*e,h[i+2]=S*e,h[i+3]=p,h[i+4]=g,h[i+5]=S,h[i+6]=m/a,h[i+7]=_/r,i+=l,_!=r-1&&(s[n++]=u+(a+1),s[n++]=u,s[n++]=u+1,s[n++]=u+a,s[n++]=u,s[n++]=u+(a+1),u++)}return $t._createMesh(o,h,s)}}var er="#define SHADER_NAME BlitVS\nvarying vec2 v_Texcoord0;void main(){gl_Position=vec4(u_OffsetScale.x*2.0-1.0+(a_PositionTexcoord.x+1.0)*u_OffsetScale.z,(1.0-((u_OffsetScale.y*2.0-1.0+(-a_PositionTexcoord.y+1.0)*u_OffsetScale.w)+1.0)/2.0)*2.0-1.0,0.0,1.0);v_Texcoord0=a_PositionTexcoord.zw;}",tr='#define SHADER_NAME BlitFS\n#include "Color.glsl";\n#include "FastApproximateAntiAliasing.glsl";\nvarying vec2 v_Texcoord0;void main(){\n#ifdef FXAA\ngl_FragColor=FXAAMain(u_MainTex,v_Texcoord0,u_MainTex_TexelSize.zw);\n#else\nvec4 mainColor=texture2D(u_MainTex,v_Texcoord0);\n#ifdef Gamma_u_MainTex\nmainColor=gammaToLinear(mainColor);\n#endif\ngl_FragColor=mainColor;\n#endif\ngl_FragColor=outputTransform(gl_FragColor);}';class rr{static init(){t.Shader3D.addInclude("FastApproximateAntiAliasing.glsl","#if !defined(FXAA_lib)\n#define FXAA_lib\n#ifdef FXAA\n#define EDGE_THRESHOLD_MIN 0.0312\n#define EDGE_THRESHOLD_MAX 0.125\n#define QUALITY(q) ((q) < 5 ? 1.0 : ((q) > 5 ? ((q) < 10 ? 2.0 : ((q) < 11 ? 4.0 : 8.0)) : 1.5))\n#define ITERATIONS 12\n#define SUBPIXEL_QUALITY 0.75\nfloat rgb2luma(in vec3 rgb){return dot(rgb,vec3(0.299,0.587,0.114));}vec3 textureOffsetbyScreenSize(in sampler2D mainTex,in vec2 uv,in vec2 offset,in vec2 inverseScreenSize){vec2 sampleruv=uv+inverseScreenSize*offset;return texture2D(mainTex,sampleruv).rgb;}vec4 FXAAMain(in sampler2D mainTex,in vec2 texuv,in vec2 inverseScreenSize){vec4 mainColor=texture2D(mainTex,texuv);vec3 colorCenter=mainColor.rgb;float lumaCenter=rgb2luma(colorCenter);float lumaDown=rgb2luma(textureOffsetbyScreenSize(mainTex,texuv,vec2(0,-1),inverseScreenSize));float lumaUp=rgb2luma(textureOffsetbyScreenSize(mainTex,texuv,vec2(0,1),inverseScreenSize));float lumaLeft=rgb2luma(textureOffsetbyScreenSize(mainTex,texuv,vec2(-1,0),inverseScreenSize));float lumaRight=rgb2luma(textureOffsetbyScreenSize(mainTex,texuv,vec2(1,0),inverseScreenSize));float lumaMin=min(lumaCenter,min(min(lumaDown,lumaUp),min(lumaLeft,lumaRight)));float lumaMax=max(lumaCenter,max(max(lumaDown,lumaUp),max(lumaLeft,lumaRight)));float lumaRange=lumaMax-lumaMin;if(lumaRange<max(EDGE_THRESHOLD_MIN,lumaMax*EDGE_THRESHOLD_MAX)){return mainColor;}float lumaDownLeft=rgb2luma(textureOffsetbyScreenSize(mainTex,texuv,vec2(-1,-1),inverseScreenSize));float lumaUpRight=rgb2luma(textureOffsetbyScreenSize(mainTex,texuv,vec2(1,1),inverseScreenSize));float lumaUpLeft=rgb2luma(textureOffsetbyScreenSize(mainTex,texuv,vec2(-1,1),inverseScreenSize));float lumaDownRight=rgb2luma(textureOffsetbyScreenSize(mainTex,texuv,vec2(1,-1),inverseScreenSize));float lumaDownUp=lumaDown+lumaUp;float lumaLeftRight=lumaLeft+lumaRight;float lumaLeftCorners=lumaDownLeft+lumaUpLeft;float lumaDownCorners=lumaDownLeft+lumaDownRight;float lumaRightCorners=lumaDownRight+lumaUpRight;float lumaUpCorners=lumaUpRight+lumaUpLeft;float edgeHorizontal=abs(-2.0*lumaLeft+lumaLeftCorners)+abs(-2.0*lumaCenter+lumaDownUp)*2.0+abs(-2.0*lumaRight+lumaRightCorners);float edgeVertical=abs(-2.0*lumaUp+lumaUpCorners)+abs(-2.0*lumaCenter+lumaLeftRight)*2.0+abs(-2.0*lumaDown+lumaDownCorners);bool isHorizontal=(edgeHorizontal>=edgeVertical);float stepLength=isHorizontal ? inverseScreenSize.y : inverseScreenSize.x;float luma1=isHorizontal ? lumaDown : lumaLeft;float luma2=isHorizontal ? lumaUp : lumaRight;float gradient1=luma1-lumaCenter;float gradient2=luma2-lumaCenter;bool is1Steepest=abs(gradient1)>=abs(gradient2);float gradientScaled=0.25*max(abs(gradient1),abs(gradient2));float lumaLocalAverage=0.0;if(is1Steepest){stepLength=-stepLength;lumaLocalAverage=0.5*(luma1+lumaCenter);}else{lumaLocalAverage=0.5*(luma2+lumaCenter);}vec2 currentUv=texuv;if(isHorizontal){currentUv.y+=stepLength*0.5;}else{currentUv.x+=stepLength*0.5;}vec2 offset=isHorizontal ? vec2(inverseScreenSize.x,0.0): vec2(0.0,inverseScreenSize.y);vec2 uv1=currentUv-offset*QUALITY(0);vec2 uv2=currentUv+offset*QUALITY(0);float lumaEnd1=rgb2luma(textureOffsetbyScreenSize(mainTex,uv1,vec2(0.0,0.0),inverseScreenSize));float lumaEnd2=rgb2luma(textureOffsetbyScreenSize(mainTex,uv2,vec2(0.0,0.0),inverseScreenSize));lumaEnd1-=lumaLocalAverage;lumaEnd2-=lumaLocalAverage;bool reached1=abs(lumaEnd1)>=gradientScaled;bool reached2=abs(lumaEnd2)>=gradientScaled;bool reachedBoth=reached1&&reached2;if(!reached1){uv1-=offset*QUALITY(1);}if(!reached2){uv2+=offset*QUALITY(1);}if(!reachedBoth){for(int i=2;i<ITERATIONS;i++){if(!reached1){lumaEnd1=rgb2luma(textureOffsetbyScreenSize(mainTex,uv1,vec2(0.0,0.0),inverseScreenSize));lumaEnd1=lumaEnd1-lumaLocalAverage;}if(!reached2){lumaEnd2=rgb2luma(textureOffsetbyScreenSize(mainTex,uv2,vec2(0.0,0.0),inverseScreenSize));lumaEnd2=lumaEnd2-lumaLocalAverage;}reached1=abs(lumaEnd1)>=gradientScaled;reached2=abs(lumaEnd2)>=gradientScaled;reachedBoth=reached1&&reached2;if(!reached1){uv1-=offset*QUALITY(i);}if(!reached2){uv2+=offset*QUALITY(i);}if(reachedBoth){break;}}}float distance1=isHorizontal ?(texuv.x-uv1.x):(texuv.y-uv1.y);float distance2=isHorizontal ?(uv2.x-texuv.x):(uv2.y-texuv.y);bool isDirection1=distance1<distance2;float distanceFinal=min(distance1,distance2);float edgeThickness=(distance1+distance2);bool isLumaCenterSmaller=lumaCenter<lumaLocalAverage;bool correctVariation1=(lumaEnd1<0.0)!=isLumaCenterSmaller;bool correctVariation2=(lumaEnd2<0.0)!=isLumaCenterSmaller;bool correctVariation=isDirection1 ? correctVariation1 : correctVariation2;float pixelOffset=-distanceFinal/edgeThickness+0.5;float finalOffset=correctVariation ? pixelOffset : 0.0;float lumaAverage=(1.0/12.0)*(2.0*(lumaDownUp+lumaLeftRight)+lumaLeftCorners+lumaRightCorners);float subPixelOffset1=clamp(abs(lumaAverage-lumaCenter)/lumaRange,0.0,1.0);float subPixelOffset2=(-2.0*subPixelOffset1+3.0)*subPixelOffset1*subPixelOffset1;float subPixelOffsetFinal=subPixelOffset2*subPixelOffset2*SUBPIXEL_QUALITY;finalOffset=max(finalOffset,subPixelOffsetFinal);vec2 finalUv=texuv;if(isHorizontal){finalUv.y+=finalOffset*stepLength;}else{finalUv.x+=finalOffset*stepLength;}return texture2D(mainTex,finalUv);}\n#endif\n#endif\n");let r={a_PositionTexcoord:[t.VertexMesh.MESH_POSITION0,e.ShaderDataType.Vector4]},i={u_OffsetScale:e.ShaderDataType.Vector4,u_MainTex:e.ShaderDataType.Texture2D,u_MainTex_TexelSize:e.ShaderDataType.Vector4},n=t.Shader3D.add("BlitScreen");n.shaderType=t.ShaderFeatureType.PostProcess;let s=new t.SubShader(r,i);n.addSubShader(s);let o=s.addShaderPass(er,tr);o.statefirst=!0;let l=o.renderState;l.depthTest=a.DEPTHTEST_ALWAYS,l.depthWrite=!1,l.cull=a.CULL_NONE,l.blend=a.BLEND_DISABLE;let h=t.Shader3D.add("BlitScreen_Transparnet");n.shaderType=t.ShaderFeatureType.PostProcess;let d=new t.SubShader(r,i);h.addSubShader(d);let c=d.addShaderPass(er,tr);o.statefirst=!0,l=c.renderState,l.depthTest=a.DEPTHTEST_ALWAYS,l.depthWrite=!1,l.cull=a.CULL_NONE,l.blend=a.BLEND_ENABLE_ALL,l.srcBlend=a.BLENDPARAM_SRC_ALPHA,l.dstBlend=a.BLENDPARAM_ONE_MINUS_SRC_ALPHA}}var ar='#define SHADER_NAME DepthVS\n#include "DepthVertex.glsl";\nvoid main(){Vertex vertex;getVertexParams(vertex);mat4 worldMat=getWorldMatrix();vec4 pos=(worldMat*vec4(vertex.positionOS,1.0));vec3 positionWS=pos.xyz/pos.w;mat4 normalMat=transpose(inverse(worldMat));vec3 normalWS=normalize((normalMat*vec4(vertex.normalOS,0.0)).xyz);vec4 positionCS=DepthPositionCS(positionWS,normalWS);gl_Position=remapPositionZ(positionCS);}',ir='#define SHADER_NAME DepthFS\n#include "DepthFrag.glsl";\nvoid main(){gl_FragColor=getDepthColor();}';class nr{static init(){let r={UnlitBlock:{u_AlbedoColor:e.ShaderDataType.Color,u_TilingOffset:e.ShaderDataType.Vector4},u_AlbedoTexture:e.ShaderDataType.Texture2D,u_AlphaTestValue:e.ShaderDataType.Float},a={u_AlbedoColor:t.Color.WHITE,u_TilingOffset:new t.Vector4(1,1,0,0),u_AlphaTestValue:.5},i=t.Shader3D.add("Unlit",!0,!1);i.shaderType=t.ShaderFeatureType.D3;let n=new t.SubShader(t.SubShader.DefaultAttributeMap,r,a);i.addSubShader(n),n.addShaderPass('\n#define SHADER_NAME UnlitVS\n#include "Math.glsl";\n#include "Scene.glsl";\n#include "SceneFogInput.glsl";\n#include "Camera.glsl";\n#include "Sprite3DVertex.glsl";\n#include "VertexCommon.glsl";\n#ifdef UV\nvarying vec2 v_Texcoord0;\n#endif\n#ifdef COLOR\nvarying vec4 v_VertexColor;\n#endif\nvoid main(){Vertex vertex;getVertexParams(vertex);\n#ifdef UV\nv_Texcoord0=transformUV(vertex.texCoord0,u_TilingOffset);\n#endif\n#ifdef COLOR\nv_VertexColor=vertex.vertexColor;\n#endif\nmat4 worldMat=getWorldMatrix();vec4 pos=(worldMat*vec4(vertex.positionOS,1.0));vec3 positionWS=pos.xyz/pos.w;gl_Position=getPositionCS(positionWS);gl_Position=remapPositionZ(gl_Position);\n#ifdef FOG\nFogHandle(gl_Position.z);\n#endif\n}','\n#define SHADER_NAME UNLITFS\n#include "Color.glsl";\n#include "Scene.glsl";\n#include "SceneFog.glsl";\n#include "Camera.glsl";\n#include "Sprite3DFrag.glsl";\n#ifdef UV\nvarying vec2 v_Texcoord0;\n#endif\n#ifdef COLOR\nvarying vec4 v_VertexColor;\n#endif\nvoid main(){vec3 color=u_AlbedoColor.rgb;float alpha=u_AlbedoColor.a;\n#ifdef COLOR\n#ifdef ENABLEVERTEXCOLOR\nvec4 vertexColor=v_VertexColor;color*=vertexColor.rgb;alpha*=vertexColor.a;\n#endif\n#endif\n#ifdef UV\nvec2 uv=v_Texcoord0;\n#ifdef ALBEDOTEXTURE\nvec4 albedoSampler=texture2D(u_AlbedoTexture,uv);\n#ifdef Gamma_u_AlbedoTexture\nalbedoSampler=gammaToLinear(albedoSampler);\n#endif\ncolor*=albedoSampler.rgb;alpha*=albedoSampler.a;\n#endif\n#endif\n#ifdef ALPHATEST\nif(alpha<u_AlphaTestValue)discard;\n#endif\n#ifdef FOG\ncolor=scenUnlitFog(color);\n#endif\ngl_FragColor=vec4(color,alpha);gl_FragColor=outputTransform(gl_FragColor);}'),n.addShaderPass(ar,ir,"ShadowCaster")}}class sr{static init(){t.Shader3D.addInclude("BlinnPhongCommon.glsl","#if !defined(BlinnPhongCommon_lib)\n#define BlinnPhongCommon_lib\nvarying vec3 v_PositionWS;varying vec3 v_NormalWS;varying vec3 v_TangentWS;varying vec3 v_BiNormalWS;\n#ifdef UV\nvarying vec2 v_Texcoord0;\n#endif\n#ifdef UV1\n#ifdef LIGHTMAP\nvarying vec2 v_Texcoord1;\n#endif\n#endif\n#ifdef COLOR\nvarying vec4 v_VertexColor;\n#endif\nstruct PixelParams{vec3 positionWS;vec3 normalWS;vec3 tangentWS;vec3 biNormalWS;mat3 TBN;\n#ifdef UV\nvec2 uv0;\n#endif\n#ifdef UV1\n#ifdef LIGHTMAP\nvec2 uv1;\n#endif\n#endif\n#ifdef COLOR\nvec4 vertexColor;\n#endif\n};\n#endif\n"),t.Shader3D.addInclude("BlinnPhongVertex.glsl",'#if !defined(BlinnPhongVertex_lib)\n#define BlinnPhongVertex_lib\n#include "ShadingVertex.glsl";\nvoid initPixelParams(inout PixelParams params,in Vertex vertex){shadingPixelParams(params,vertex);sharePixelParams(params);}\n#endif\n'),t.Shader3D.addInclude("BlinnPhongFrag.glsl",'#if !defined(BlinnPhongFrag_lib)\n#define BlinnPhongFrag_lib\n#include "BlinnPhongLighting.glsl";\n#include "ShadingFrag.glsl";\nvoid getPixelInfo(inout PixelInfo info,const in PixelParams pixel,const in Surface surface){info.positionWS=pixel.positionWS;info.vertexNormalWS=pixel.normalWS;\n#ifdef TANGENT\ninfo.normalWS=normalize(pixel.TBN*surface.normalTS);\n#else\ninfo.normalWS=pixel.normalWS;\n#endif\ninfo.viewDir=normalize(u_CameraPos-info.positionWS);\n#ifdef LIGHTMAP\n#ifdef UV1\ninfo.lightmapUV=pixel.uv1;\n#endif\n#endif\n}vec3 BlinnPhongLighting(const in Surface surface,const in PixelParams pixel){PixelInfo info;getPixelInfo(info,pixel,surface);vec3 positionWS=info.positionWS;vec3 normalWS=info.normalWS;vec3 v=info.viewDir;vec3 lightColor=vec3(0.0,0.0,0.0);\n#ifdef DIRECTIONLIGHT\nfor(int i=0;i<CalculateLightCount;i++){if(i>=DirectionCount)break;DirectionLight directionLight=getDirectionLight(i,positionWS);if(directionLight.lightMode!=LightMode_Mix){Light light=getLight(directionLight);lightColor+=BlinnPhongLighting(surface,light,info)*light.attenuation;}}\n#endif\n#if defined(POINTLIGHT) || defined(SPOTLIGHT)\nivec4 clusterInfo=getClusterInfo(u_View,u_Viewport,positionWS,gl_FragCoord,u_ProjectionParams);\n#endif\n#ifdef POINTLIGHT\nfor(int i=0;i<CalculateLightCount;i++){\n#ifdef BREAK_TEXTURE_SAMPLE\nif(i>=clusterInfo.x)break;\n#endif\nPointLight pointLight=getPointLight(i,clusterInfo,positionWS);if(pointLight.lightMode!=LightMode_Mix){Light light=getLight(pointLight,normalWS,positionWS);\n#ifndef BREAK_TEXTURE_SAMPLE\nif(i<clusterInfo.x)\n#endif\nlightColor+=BlinnPhongLighting(surface,light,info)*light.attenuation;}}\n#endif\n#ifdef SPOTLIGHT\nfor(int i=0;i<CalculateLightCount;i++){\n#ifdef BREAK_TEXTURE_SAMPLE\nif(i>=clusterInfo.y)break;\n#endif\nSpotLight spotLight=getSpotLight(i,clusterInfo,positionWS);if(spotLight.lightMode!=LightMode_Mix){Light light=getLight(spotLight,normalWS,positionWS);\n#ifndef BREAK_TEXTURE_SAMPLE\nif(i<clusterInfo.y)\n#endif\nlightColor+=BlinnPhongLighting(surface,light,info)*light.attenuation;}}\n#endif\nvec3 giColor=BlinnPhongGI(surface,info);return lightColor+giColor;}\n#endif\n');let r={u_AlphaTestValue:e.ShaderDataType.Float,u_TilingOffset:e.ShaderDataType.Vector4,u_DiffuseColor:e.ShaderDataType.Color,u_DiffuseTexture:e.ShaderDataType.Texture2D,u_AlbedoIntensity:e.ShaderDataType.Float,u_MaterialSpecular:e.ShaderDataType.Color,u_SpecularTexture:e.ShaderDataType.Texture2D,u_Shininess:e.ShaderDataType.Float,u_NormalTexture:e.ShaderDataType.Texture2D},a={u_AlbedoIntensity:1,u_DiffuseColor:t.Color.WHITE,u_MaterialSpecular:t.Color.WHITE,u_Shininess:.078125,u_AlphaTestValue:.5,u_TilingOffset:new t.Vector4(1,1,0,0)},i=t.Shader3D.add("BLINNPHONG",!0,!0);i.shaderType=t.ShaderFeatureType.D3;let n=new t.SubShader(t.SubShader.DefaultAttributeMap,r,a);i.addSubShader(n),n.addShaderPass('#define SHADER_NAME BlinnPhongVS\n#include "Math.glsl";\n#include "Scene.glsl";\n#include "SceneFogInput.glsl";\n#include "Camera.glsl";\n#include "Sprite3DVertex.glsl";\n#include "VertexCommon.glsl";\n#include "BlinnPhongVertex.glsl";\nvoid main(){Vertex vertex;getVertexParams(vertex);PixelParams pixel;initPixelParams(pixel,vertex);gl_Position=getPositionCS(pixel.positionWS);gl_Position=remapPositionZ(gl_Position);\n#ifdef FOG\nFogHandle(gl_Position.z);\n#endif\n}','#define SHADER_NAME BlinnPhongFS\n#include "Color.glsl";\n#include "Scene.glsl";\n#include "SceneFog.glsl";\n#include "Camera.glsl";\n#include "Sprite3DFrag.glsl";\n#include "BlinnPhongFrag.glsl";\nvoid getBinnPhongSurfaceParams(inout Surface surface,in PixelParams pixel){\n#ifdef UV\nvec2 uv=transformUV(pixel.uv0,u_TilingOffset);\n#else\nvec2 uv=vec2(0.0);\n#endif\nsurface.diffuseColor=u_DiffuseColor.rgb;surface.alpha=u_DiffuseColor.a;\n#ifdef COLOR\n#ifdef ENABLEVERTEXCOLOR\nsurface.diffuseColor*=pixel.vertexColor.xyz;surface.alpha*=pixel.vertexColor.a;\n#endif\n#endif\n#ifdef DIFFUSEMAP\nvec4 diffuseSampler=texture2D(u_DiffuseTexture,uv);\n#ifdef Gamma_u_DiffuseTexture\ndiffuseSampler=gammaToLinear(diffuseSampler);\n#endif\nsurface.diffuseColor*=u_DiffuseColor.rgb*diffuseSampler.rgb*u_AlbedoIntensity;surface.alpha*=diffuseSampler.a;\n#endif\nsurface.diffuseColor*=u_AlbedoIntensity;surface.normalTS=vec3(0.0,0.0,1.0);\n#ifdef NORMALMAP\nvec3 normalSampler=texture2D(u_NormalTexture,uv).rgb;normalSampler=normalize(normalSampler*2.0-1.0);normalSampler.y*=-1.0;surface.normalTS=normalSampler;\n#endif\n#ifdef SPECULARMAP\nvec4 specularSampler=texture2D(u_SpecularTexture,uv);\n#ifdef Gamma_u_SpecularTexture\nspecularSampler=gammaToLinear(specularSampler);\n#endif\nsurface.gloss=specularSampler.rgb;\n#else\n#ifdef DIFFUSEMAP\nsurface.gloss=vec3(diffuseSampler.a);\n#else\nsurface.gloss=vec3(1.0,1.0,1.0);\n#endif\n#endif\nsurface.specularColor=u_MaterialSpecular.rgb;surface.shininess=u_Shininess;}void main(){PixelParams pixel;getPixelParams(pixel);Surface surface;getBinnPhongSurfaceParams(surface,pixel);\n#ifdef ALPHATEST\nif(surface.alpha<u_AlphaTestValue){discard;}\n#endif\nvec3 surfaceColor=vec3(0.0);surfaceColor=BlinnPhongLighting(surface,pixel);\n#ifdef FOG\nsurfaceColor=sceneLitFog(surfaceColor);\n#endif\ngl_FragColor=vec4(surfaceColor,surface.alpha);gl_FragColor=outputTransform(gl_FragColor);}'),n.addShaderPass(ar,ir,"ShadowCaster"),n.addShaderPass('#define SHADER_NAME BlinnPhongDephtNormalVS\n#include "Math.glsl";\n#include "Camera.glsl";\n#include "Sprite3DVertex.glsl";\n#include "VertexCommon.glsl";\n#include "BlinnPhongVertex.glsl";\nvarying vec4 v_PositionCS;void main(){Vertex vertex;getVertexParams(vertex);PixelParams pixel;initPixelParams(pixel,vertex);vec4 positionCS=getPositionCS(pixel.positionWS);v_PositionCS=positionCS;gl_Position=positionCS;gl_Position=remapPositionZ(gl_Position);}','#define SHADER_NAME BlinnPhongDephtNormalFS\n#include "Color.glsl";\n#include "Scene.glsl";\n#include "Camera.glsl";\n#include "Sprite3DFrag.glsl";\n#include "ShadingFrag.glsl";\n#include "DepthNormalFrag.glsl";\nvarying vec4 v_PositionCS;void main(){PixelParams pixel;getPixelParams(pixel);vec3 normalWS=pixel.normalWS;\n#ifdef NORMALMAP\n#ifdef UV\nvec2 uv=transformUV(pixel.uv0,u_TilingOffset);vec3 normalSampler=texture2D(u_NormalTexture,uv).rgb;normalSampler=normalize(normalSampler*2.0-1.0);normalSampler.y*=-1.0;vec3 normalTS=normalSampler;normalWS=normalize(pixel.TBN*normalTS);\n#endif\n#endif\nvec4 positionCS=v_PositionCS;vec4 dephtNormal=encodeDepthNormal(positionCS,normalWS);gl_FragColor=dephtNormal;}',"DepthNormal")}}class or{static init(){let r={u_AlbedoColor:e.ShaderDataType.Color,u_TilingOffset:e.ShaderDataType.Vector4,u_NormalScale:e.ShaderDataType.Float,u_Metallic:e.ShaderDataType.Float,u_Smoothness:e.ShaderDataType.Float,u_OcclusionStrength:e.ShaderDataType.Float,u_AlphaTestValue:e.ShaderDataType.Float,u_EmissionColor:e.ShaderDataType.Color,u_EmissionIntensity:e.ShaderDataType.Float,u_AlbedoTexture:e.ShaderDataType.Texture2D,u_NormalTexture:e.ShaderDataType.Texture2D,u_OcclusionTexture:e.ShaderDataType.Texture2D,u_EmissionTexture:e.ShaderDataType.Texture2D,u_MetallicGlossTexture:e.ShaderDataType.Texture2D,u_AnisotropyStrength:e.ShaderDataType.Float,u_AnisotropyTexture:e.ShaderDataType.Texture2D,u_AnisotropyRotation:e.ShaderDataType.Float,u_ClearCoatFactor:e.ShaderDataType.Float,u_ClearCoatTexture:e.ShaderDataType.Texture2D,u_ClearCoatRoughness:e.ShaderDataType.Float,u_ClearCoatRoughnessTexture:e.ShaderDataType.Texture2D,u_ClearCoatNormalTexture:e.ShaderDataType.Texture2D,u_DetailAlbedoTexture:e.ShaderDataType.Texture2D,u_DetailNormalTexture:e.ShaderDataType.Texture2D,u_DetailNormalScale:e.ShaderDataType.Float,u_DetailTillingOffset:e.ShaderDataType.Vector4},a={u_AlbedoColor:t.Color.WHITE,u_TilingOffset:new t.Vector4(1,1,0,0),u_DetailTillingOffset:new t.Vector4(1,1,0,0),u_NormalScale:1,u_DetailNormalScale:1,u_Metallic:0,u_Smoothness:.5,u_OcclusionStrength:1,u_EmissionColor:t.Color.WHITE,u_EmissionIntensity:1,u_AlphaTestValue:.5,u_AnisotropyStrength:0,u_AnisotropyRotation:0,u_ClearCoatFactor:0,u_ClearCoatRoughness:0},i=t.Shader3D.add("PBR",!0,!0);i.shaderType=t.ShaderFeatureType.D3,i._surportVolumetricGI=!0;let n=new t.SubShader(t.SubShader.DefaultAttributeMap,r,a);i.addSubShader(n),n.addShaderPass('#define SHADER_NAME PBRStandardVS\n#include "Math.glsl";\n#include "Scene.glsl";\n#include "SceneFogInput.glsl";\n#include "Camera.glsl";\n#include "Sprite3DVertex.glsl";\n#include "VertexCommon.glsl";\n#include "PBRVertex.glsl";\n#if defined(DETAILTEXTURE) || defined(DETAILNORMAL)\nvarying vec2 v_DetailUV;\n#endif\nvoid main(){Vertex vertex;getVertexParams(vertex);PixelParams pixel;initPixelParams(pixel,vertex);\n#if defined(DETAILTEXTURE) || defined(DETAILNORMAL)\n#ifdef UV\nv_DetailUV=transformUV(vertex.texCoord0,u_DetailTillingOffset);\n#else\nv_DetailUV=vec2(0.0);\n#endif\n#endif\ngl_Position=getPositionCS(pixel.positionWS);gl_Position=remapPositionZ(gl_Position);\n#ifdef FOG\nFogHandle(gl_Position.z);\n#endif\n}','#define SHADER_NAME PBRStandardFS\n#include "Color.glsl";\n#include "Scene.glsl";\n#include "SceneFog.glsl";\n#include "Camera.glsl";\n#include "Sprite3DFrag.glsl";\n#include "PBRMetallicFrag.glsl";\n#if defined(DETAILTEXTURE) || defined(DETAILNORMAL)\nvarying vec2 v_DetailUV;\n#define ColorSpaceDouble vec3(4.59479380, 4.59479380, 4.59479380);\nvec3 BlendNormals(vec3 n1,vec3 n2){return normalize(vec3(n1.xy+n2.xy,n1.z*n2.z));}\n#endif\nvoid initSurfaceInputs(inout SurfaceInputs inputs,const in PixelParams pixel){\n#ifdef UV\nvec2 uv=transformUV(pixel.uv0,u_TilingOffset);\n#else\nvec2 uv=vec2(0.0);\n#endif\ninputs.diffuseColor=u_AlbedoColor.rgb;inputs.alpha=u_AlbedoColor.a;\n#ifdef COLOR\n#ifdef ENABLEVERTEXCOLOR\ninputs.diffuseColor*=pixel.vertexColor.xyz;inputs.alpha*=pixel.vertexColor.a;\n#endif\n#endif\ninputs.alphaTest=u_AlphaTestValue;\n#ifdef ALBEDOTEXTURE\nvec4 albedoSampler=texture2D(u_AlbedoTexture,uv);\n#ifdef Gamma_u_AlbedoTexture\nalbedoSampler=gammaToLinear(albedoSampler);\n#endif\ninputs.diffuseColor*=albedoSampler.rgb;inputs.alpha*=albedoSampler.a;\n#endif\n#ifdef DETAILTEXTURE\nvec3 detailSampler=texture2D(u_DetailAlbedoTexture,v_DetailUV).rgb;\n#ifdef Gamma_u_DetailAlbedoTexture\ndetailSampler=gammaToLinear(detailSampler);\n#endif\ndetailSampler*=ColorSpaceDouble;inputs.diffuseColor*=detailSampler;\n#endif\ninputs.normalTS=vec3(0.0,0.0,1.0);\n#ifdef NORMALTEXTURE\nvec3 normalSampler=texture2D(u_NormalTexture,uv).rgb;normalSampler=normalize(normalSampler*2.0-1.0);normalSampler.y*=-1.0;inputs.normalTS=normalScale(normalSampler,u_NormalScale);\n#endif\n#ifdef DETAILNORMAL\nvec3 detailnormalSampler=texture2D(u_DetailNormalTexture,v_DetailUV).rgb;detailnormalSampler=normalize(detailnormalSampler*2.0-1.0);detailnormalSampler.y*=-1.0;detailnormalSampler=normalScale(detailnormalSampler,u_DetailNormalScale);inputs.normalTS=BlendNormals(inputs.normalTS,detailnormalSampler);\n#endif\ninputs.metallic=u_Metallic;inputs.smoothness=u_Smoothness;\n#ifdef METALLICGLOSSTEXTURE\nvec4 metallicSampler=texture2D(u_MetallicGlossTexture,uv);\n#ifdef Gamma_u_MetallicGlossTexture\nmetallicSampler=gammaToLinear(metallicSampler);\n#endif\ninputs.metallic=metallicSampler.x;\n#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n#ifdef ALBEDOTEXTURE\ninputs.smoothness=(albedoSampler.a*u_Smoothness);\n#endif\n#else\ninputs.smoothness=(metallicSampler.a*u_Smoothness);\n#endif\n#endif\ninputs.occlusion=1.0;\n#ifdef OCCLUSIONTEXTURE\nvec4 occlusionSampler=texture2D(u_OcclusionTexture,uv);\n#ifdef Gamma_u_OcclusionTexture\nocclusionSampler=gammaToLinear(occlusionSampler);\n#endif\nfloat occlusion=occlusionSampler.g;inputs.occlusion=(1.0-u_OcclusionStrength)+occlusion*u_OcclusionStrength;\n#endif\ninputs.emissionColor=vec3(0.0);\n#ifdef EMISSION\ninputs.emissionColor=u_EmissionColor.rgb*u_EmissionIntensity;\n#ifdef EMISSIONTEXTURE\nvec4 emissionSampler=texture2D(u_EmissionTexture,uv);\n#ifdef Gamma_u_EmissionTexture\nemissionSampler=gammaToLinear(emissionSampler);\n#endif\ninputs.emissionColor*=emissionSampler.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\ninputs.clearCoat=u_ClearCoatFactor;inputs.clearCoatRoughness=u_ClearCoatRoughness;\n#ifdef CLEARCOATMAP\nvec4 clearCoatSampler=texture2D(u_ClearCoatTexture,uv);inputs.clearCoat*=clearCoatSampler.r;\n#endif\n#ifdef CLEARCOAT_ROUGHNESSMAP\nvec4 clearcoatSampleRoughness=texture2D(u_ClearCoatRoughnessTexture,uv);inputs.clearCoatRoughness*=clearcoatSampleRoughness.g;\n#endif\n#ifdef CLEARCOAT_NORMAL\nvec3 clearCoatNormalSampler=texture2D(u_ClearCoatNormalTexture,uv).rgb;clearCoatNormalSampler=normalize(clearCoatNormalSampler*2.0-1.0);clearCoatNormalSampler.y*=-1.0;inputs.clearCoatNormalTS=clearCoatNormalSampler;\n#endif\n#endif\n#ifdef ANISOTROPIC\ninputs.anisotropy=u_AnisotropyStrength;vec2 direction=vec2(1.0,0.0);\n#ifdef ANISOTROPYMAP\nvec3 anisotropySampler=texture2D(u_AnisotropyTexture,uv).rgb;inputs.anisotropy*=anisotropySampler.b;direction=anisotropySampler.xy*2.0-1.0;\n#endif\nvec2 anisotropyRotation=vec2(cos(u_AnisotropyRotation),sin(u_AnisotropyRotation));mat2 rotationMatrix=mat2(anisotropyRotation.x,anisotropyRotation.y,-anisotropyRotation.y,anisotropyRotation.x);inputs.anisotropyDirection=rotationMatrix*direction;\n#endif\n}void main(){PixelParams pixel;getPixelParams(pixel);SurfaceInputs inputs;initSurfaceInputs(inputs,pixel);vec4 surfaceColor=PBR_Metallic_Flow(inputs,pixel);\n#ifdef FOG\nsurfaceColor.rgb=sceneLitFog(surfaceColor.rgb);\n#endif\ngl_FragColor=surfaceColor;gl_FragColor=outputTransform(gl_FragColor);}'),n.addShaderPass(ar,ir,"ShadowCaster"),n.addShaderPass('#define SHADER_NAME PBRStandardDepthNormalVS\n#include "Math.glsl";\n#include "Camera.glsl";\n#include "Sprite3DVertex.glsl";\n#include "VertexCommon.glsl";\n#include "PBRVertex.glsl";\nvarying vec4 v_PositionCS;void main(){Vertex vertex;getVertexParams(vertex);PixelParams pixel;initPixelParams(pixel,vertex);sharePixelParams(pixel);vec4 positionCS=getPositionCS(pixel.positionWS);v_PositionCS=positionCS;gl_Position=positionCS;gl_Position=remapPositionZ(gl_Position);}','#define SHADER_NAME PBRStandardDepthNormalFS\n#include "Color.glsl";\n#include "Scene.glsl";\n#include "Camera.glsl";\n#include "Sprite3DFrag.glsl";\n#include "ShadingFrag.glsl";\n#include "DepthNormalFrag.glsl";\nvarying vec4 v_PositionCS;void main(){PixelParams pixel;getPixelParams(pixel);vec3 normalWS=pixel.normalWS;\n#ifdef NORMALTEXTURE\n#ifdef UV\nvec2 uv=transformUV(pixel.uv0,u_TilingOffset);vec3 normalSampler=texture2D(u_NormalTexture,uv).rgb;normalSampler=normalize(normalSampler*2.0-1.0);normalSampler.y*=-1.0;vec3 normalTS=normalScale(normalSampler,u_NormalScale);normalWS=normalize(pixel.TBN*normalTS);\n#endif\n#endif\nvec4 positionCS=v_PositionCS;vec4 dephtNormal=encodeDepthNormal(positionCS,normalWS);gl_FragColor=dephtNormal;}',"DepthNormal")}}class lr{static init(){let r={a_Position:[t.VertexMesh.MESH_POSITION0,e.ShaderDataType.Vector4]},i={u_TintColor:e.ShaderDataType.Color,u_Exposure:e.ShaderDataType.Float,u_Rotation:e.ShaderDataType.Float,u_CubeTexture:e.ShaderDataType.TextureCube},n={u_TintColor:new t.Color(.5,.5,.5,.5),u_Exposure:1,u_Rotation:0},s=t.Shader3D.add("SkyBox");s.shaderType=t.ShaderFeatureType.Sky;let o=new t.SubShader(r,i,n);s.addSubShader(o);let l=o.addShaderPass('#define SHADER_NAME SkyBoxVS\n#include "SkyCommon.glsl";\nvarying vec3 v_Texcoord;void main(){v_Texcoord=vec3(-a_Position.x,a_Position.yz);vec4 position=rotateAroundYInDegrees(a_Position,u_Rotation);gl_Position=u_SkyProjectionViewMat*position;gl_Position=remapSkyPositionZ(gl_Position);}','#define SHADER_NAME SkyBoxFS\n#include "Color.glsl";\nvarying vec3 v_Texcoord;const vec4 c_ColorSpace=vec4(4.59479380,4.59479380,4.59479380,2.0);void main(){vec3 uv=v_Texcoord;vec4 cubeSampler=textureCube(u_CubeTexture,uv);\n#ifdef Gamma_u_CubeTexture\ncubeSampler=gammaToLinear(cubeSampler);\n#endif\nvec3 color=cubeSampler.rgb*u_TintColor.rgb*pow(u_Exposure,2.2)*c_ColorSpace.rgb;gl_FragColor=vec4(color,1.0);gl_FragColor=outputTransform(gl_FragColor);}');l.renderState.depthTest=a.DEPTHTEST_LEQUAL,l.renderState.cull=t.CullMode.Back,l.renderState.depthWrite=!1,l.renderState.stencilWrite=!1,l.statefirst=!0}}class hr{static init(){let r={a_Position:[t.VertexMesh.MESH_POSITION0,e.ShaderDataType.Vector4]},i={u_SunSize:e.ShaderDataType.Float,u_SunSizeConvergence:e.ShaderDataType.Float,u_AtmosphereThickness:e.ShaderDataType.Float,u_SkyTint:e.ShaderDataType.Color,u_GroundTint:e.ShaderDataType.Color,u_Exposure:e.ShaderDataType.Float},n={u_SunSize:.04,u_SunSizeConvergence:5,u_AtmosphereThickness:1,u_SkyTint:new t.Color(.5,.5,.5,1),u_GroundTint:new t.Color(.369,.349,.341,1),u_Exposure:1.3},s=t.Shader3D.add("SkyProcedural");s.shaderType=t.ShaderFeatureType.Sky;let o=new t.SubShader(r,i,n);s.addSubShader(o);let l=o.addShaderPass('#define SHADER_NAME SkyProceduralVS\n#include "SkyCommon.glsl";\n#define OUTER_RADIUS 1.025\n#define RAYLEIGH (mix(0.0, 0.0025, pow(u_AtmosphereThickness,2.5)))\n#define MIE 0.0010\n#define SUN_BRIGHTNESS 20.0\n#define MAX_SCATTER 50.0\nconst float SKY_GROUND_THRESHOLD=0.02;const float outerRadius=OUTER_RADIUS;const float outerRadius2=OUTER_RADIUS*OUTER_RADIUS;const float innerRadius=1.0;const float innerRadius2=1.0;const float cameraHeight=0.0001;const float HDSundiskIntensityFactor=15.0;const float simpleSundiskIntensityFactor=27.0;const float sunScale=400.0*SUN_BRIGHTNESS;const float kmESun=MIE*SUN_BRIGHTNESS;const float km4PI=MIE*4.0*3.14159265;const float scale=1.0/(OUTER_RADIUS-1.0);const float scaleDepth=0.25;const float scaleOverScaleDepth=(1.0/(OUTER_RADIUS-1.0))/0.25;const float samples=2.0;const vec3 c_DefaultScatteringWavelength=vec3(0.65,0.57,0.475);const vec3 c_VariableRangeForScatteringWavelength=vec3(0.15,0.15,0.15);varying vec3 v_GroundColor;varying vec3 v_SkyColor;\n#ifdef SUN_HIGH_QUALITY\nvarying vec3 v_Vertex;\n#elif defined(SUN_SIMPLE)\nvarying vec3 v_RayDir;\n#else\nvarying float v_SkyGroundFactor;\n#endif\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\nvarying vec3 v_SunColor;\n#endif\nfloat getRayleighPhase(vec3 light,vec3 ray){float eyeCos=dot(light,ray);return 0.75+0.75*eyeCos*eyeCos;}float scaleAngle(float inCos){float x=1.0-inCos;return 0.25*exp(-0.00287+x*(0.459+x*(3.83+x*(-6.80+x*5.25))));}void main(){gl_Position=u_SkyProjectionViewMat*a_Position;vec3 skyTintInGammaSpace=pow(u_SkyTint.xyz,vec3(0.45));vec3 scatteringWavelength=mix(c_DefaultScatteringWavelength-c_VariableRangeForScatteringWavelength,c_DefaultScatteringWavelength+c_VariableRangeForScatteringWavelength,vec3(1.0)-skyTintInGammaSpace);vec3 invWavelength=1.0/pow(scatteringWavelength,vec3(4.0));float krESun=RAYLEIGH*SUN_BRIGHTNESS;float kr4PI=RAYLEIGH*4.0*3.14159265;vec3 cameraPos=vec3(0.0,innerRadius+cameraHeight,0.0);vec3 eyeRay=normalize(a_Position.xyz);float far=0.0;vec3 cIn,cOut;if(eyeRay.y>=0.0){far=sqrt(outerRadius2+innerRadius2*eyeRay.y*eyeRay.y-innerRadius2)-innerRadius*eyeRay.y;float height=innerRadius+cameraHeight;float depth=exp(scaleOverScaleDepth*-cameraHeight);float startAngle=dot(eyeRay,cameraPos)/height;float startOffset=depth*scaleAngle(startAngle);float sampleLength=far/samples;float scaledLength=sampleLength*scale;vec3 sampleRay=eyeRay*sampleLength;vec3 samplePoint=cameraPos+sampleRay*0.5;vec3 frontColor=vec3(0.0);{float height=length(samplePoint);float depth=exp(scaleOverScaleDepth*(innerRadius-height));float lightAngle=dot(-u_SunLight_direction,samplePoint)/height;float cameraAngle=dot(eyeRay,samplePoint)/height;float scatter=(startOffset+depth*(scaleAngle(lightAngle)-scaleAngle(cameraAngle)));vec3 attenuate=exp(-clamp(scatter,0.0,MAX_SCATTER)*(invWavelength*kr4PI+km4PI));frontColor+=attenuate*(depth*scaledLength);samplePoint+=sampleRay;}{float height=length(samplePoint);float depth=exp(scaleOverScaleDepth*(innerRadius-height));float lightAngle=dot(-u_SunLight_direction,samplePoint)/height;float cameraAngle=dot(eyeRay,samplePoint)/height;float scatter=(startOffset+depth*(scaleAngle(lightAngle)-scaleAngle(cameraAngle)));vec3 attenuate=exp(-clamp(scatter,0.0,MAX_SCATTER)*(invWavelength*kr4PI+km4PI));frontColor+=attenuate*(depth*scaledLength);samplePoint+=sampleRay;}cIn=frontColor*(invWavelength*krESun);cOut=frontColor*kmESun;}else{far=(-cameraHeight)/(min(-0.001,eyeRay.y));vec3 pos=cameraPos+far*eyeRay;float depth=exp((-cameraHeight)*(1.0/scaleDepth));float cameraAngle=dot(-eyeRay,pos);float lightAngle=dot(-u_SunLight_direction,pos);float cameraScale=scaleAngle(cameraAngle);float lightScale=scaleAngle(lightAngle);float cameraOffset=depth*cameraScale;float temp=lightScale+cameraScale;float sampleLength=far/samples;float scaledLength=sampleLength*scale;vec3 sampleRay=eyeRay*sampleLength;vec3 samplePoint=cameraPos+sampleRay*0.5;vec3 frontColor=vec3(0.0,0.0,0.0);vec3 attenuate;{float height=length(samplePoint);float depth=exp(scaleOverScaleDepth*(innerRadius-height));float scatter=depth*temp-cameraOffset;attenuate=exp(-clamp(scatter,0.0,MAX_SCATTER)*(invWavelength*kr4PI+km4PI));frontColor+=attenuate*(depth*scaledLength);samplePoint+=sampleRay;}cIn=frontColor*(invWavelength*krESun+kmESun);cOut=clamp(attenuate,0.0,1.0);}\n#ifdef SUN_HIGH_QUALITY\nv_Vertex=-a_Position.xyz;\n#elif defined(SUN_SIMPLE)\nv_RayDir=-eyeRay;\n#else\nv_SkyGroundFactor=-eyeRay.y/SKY_GROUND_THRESHOLD;\n#endif\nv_GroundColor=u_Exposure*(cIn+u_GroundTint.xyz*cOut);v_SkyColor=u_Exposure*(cIn*getRayleighPhase(-u_SunLight_direction,-eyeRay));float lightColorIntensity=clamp(length(u_SunLight_color.xyz),0.25,1.0);\n#ifdef SUN_HIGH_QUALITY\nv_SunColor=HDSundiskIntensityFactor*clamp(cOut,0.0,1.0)*u_SunLight_color.xyz/lightColorIntensity;\n#elif defined(SUN_SIMPLE)\nv_SunColor=simpleSundiskIntensityFactor*clamp(cOut*sunScale,0.0,1.0)*u_SunLight_color.xyz/lightColorIntensity;\n#endif\ngl_Position=remapSkyPositionZ(gl_Position);}','#define SHADER_NAME SkyProceduralFS\n#include "Color.glsl";\nconst float MIE_G=-0.990;const float MIE_G2=0.9801;const float SKY_GROUND_THRESHOLD=0.02;uniform vec3 u_SunLight_direction;varying vec3 v_GroundColor;varying vec3 v_SkyColor;\n#ifdef SUN_HIGH_QUALITY\nvarying vec3 v_Vertex;\n#elif defined(SUN_SIMPLE)\nvarying vec3 v_RayDir;\n#else\nvarying float v_SkyGroundFactor;\n#endif\n#if defined(SUN_HIGH_QUALITY) || defined(SUN_SIMPLE)\nvarying vec3 v_SunColor;\n#endif\nfloat getMiePhase(float eyeCos,float eyeCos2){float temp=1.0+MIE_G2-2.0*MIE_G*eyeCos;temp=pow(temp,pow(u_SunSize,0.65)*10.0);temp=max(temp,1.0e-4);temp=1.5*((1.0-MIE_G2)/(2.0+MIE_G2))*(1.0+eyeCos2)/temp;return temp;}float calcSunAttenuation(vec3 lightPos,vec3 ray){\n#ifdef SUN_HIGH_QUALITY\nfloat focusedEyeCos=pow(clamp(dot(lightPos,ray),0.0,1.0),u_SunSizeConvergence);return getMiePhase(-focusedEyeCos,focusedEyeCos*focusedEyeCos);\n#else\nvec3 delta=lightPos-ray;float dist=length(delta);float spot=1.0-smoothstep(0.0,u_SunSize,dist);return spot*spot;\n#endif\n}void main(){vec3 col=vec3(0.0,0.0,0.0);\n#ifdef SUN_HIGH_QUALITY\nvec3 ray=normalize(v_Vertex);float y=ray.y/SKY_GROUND_THRESHOLD;\n#elif defined(SUN_SIMPLE)\nvec3 ray=v_RayDir;float y=ray.y/SKY_GROUND_THRESHOLD;\n#else\nfloat y=v_SkyGroundFactor;\n#endif\ncol=mix(v_SkyColor,v_GroundColor,clamp(y,0.0,1.0));\n#if defined(SUN_HIGH_QUALITY) || defined(SUN_SIMPLE)\nif(y<0.0)col+=v_SunColor*calcSunAttenuation(-u_SunLight_direction,-ray);\n#endif\ngl_FragColor=vec4(col,1.0);gl_FragColor=outputTransform(gl_FragColor);}');l.renderState.depthTest=a.DEPTHTEST_LEQUAL,l.renderState.cull=t.CullMode.Back,l.renderState.depthWrite=!1,l.renderState.stencilWrite=!1,l.statefirst=!0}}var dr,cr,ur,_r,fr,gr,mr,pr,Sr;class Er{static init(){let r={a_Position:[t.VertexMesh.MESH_POSITION0,e.ShaderDataType.Vector4]},i={u_TintColor:e.ShaderDataType.Color,u_Rotation:e.ShaderDataType.Float,u_Texture:e.ShaderDataType.Texture2D,u_Exposure:e.ShaderDataType.Float},n={u_TintColor:new t.Color(.5,.5,.5,1),u_Exposure:1.3,u_Rotation:0,u_Texture:t.Texture2D.grayTexture},s=t.Shader3D.add("SkyPanoramic");s.shaderType=t.ShaderFeatureType.Sky;let o=new t.SubShader(r,i,n);s.addSubShader(o);let l=o.addShaderPass('#define SHADER_NAME SkyPanoramicVS\n#include "SkyCommon.glsl";\nvarying vec3 v_Texcoord;varying vec2 v_Image180ScaleAndCutoff;varying vec4 v_Layout3DScaleAndOffset;void main(){vec4 position=rotateAroundYInDegrees(a_Position,u_Rotation);v_Texcoord=vec3(-a_Position.x,-a_Position.y,a_Position.z);v_Image180ScaleAndCutoff=vec2(1.0,1.0);v_Layout3DScaleAndOffset=vec4(0,0,1,1);gl_Position=u_SkyProjectionViewMat*position;gl_Position=remapSkyPositionZ(gl_Position);}','#define SHADER_NAME SkyPanoramicVS\n#include "Color.glsl";\nvarying vec3 v_Texcoord;varying vec2 v_Image180ScaleAndCutoff;varying vec4 v_Layout3DScaleAndOffset;const vec4 c_ColorSpace=vec4(4.59479380,4.59479380,4.59479380,2.0);vec2 ToRadialCoords(vec3 coords){vec3 normalizedCoords=normalize(coords);float latitude=acos(normalizedCoords.y);float longitude=atan(normalizedCoords.z,normalizedCoords.x);vec2 sphereCoords=vec2(longitude,latitude)*vec2(0.5/PI,1.0/PI);return vec2(0.5,1.0)-sphereCoords;}void main(){vec2 tc=ToRadialCoords(v_Texcoord);if(tc.x>v_Image180ScaleAndCutoff.y)gl_FragColor=vec4(0,0,0,1);tc.x=mod(tc.x*v_Image180ScaleAndCutoff.x,1.0);tc=(tc+v_Layout3DScaleAndOffset.xy)*v_Layout3DScaleAndOffset.zw;mediump vec4 tex=texture2D(u_Texture,tc);\n#ifdef Gamma_u_Texture\ntex=gammaToLinear(tex);\n#endif\nmediump vec3 c=tex.xyz;c=c*u_TintColor.rgb*c_ColorSpace.rgb;c*=pow(u_Exposure,2.2);gl_FragColor=vec4(c,1.0);gl_FragColor=outputTransform(gl_FragColor);}');l.renderState.depthTest=a.DEPTHTEST_LEQUAL,l.renderState.cull=t.CullMode.Back,l.renderState.depthWrite=!1,l.renderState.stencilWrite=!1,l.statefirst=!0}}class Dr{static __init__(){t.Shader3D.addInclude("Utils.glsl","#if !defined(Utils_lib)\n#define Utils_lib\n#endif\n"),t.Shader3D.addInclude("BakedBoneMatrixSampler.glsl","#if !defined(BakeBoneAnimSampler_lib)\n#define BakeBoneAnimSampler_lib\nmat4 loadBakedMatMatrix(float FramePos,float boneIndices,float offset){vec2 uv;float PixelPos=FramePos+boneIndices*4.0;float halfOffset=offset*0.5;float uvoffset=PixelPos/u_SimpleAnimatorTextureSize;uv.y=floor(uvoffset)*offset+halfOffset;uv.x=mod(float(PixelPos),u_SimpleAnimatorTextureSize)*offset+halfOffset;vec4 mat0row=texture2D(u_SimpleAnimatorTexture,uv);uv.x+=offset;vec4 mat1row=texture2D(u_SimpleAnimatorTexture,uv);uv.x+=offset;vec4 mat2row=texture2D(u_SimpleAnimatorTexture,uv);uv.x+=offset;vec4 mat3row=texture2D(u_SimpleAnimatorTexture,uv);mat4 m=mat4(mat0row.x,mat0row.y,mat0row.z,mat0row.w,mat1row.x,mat1row.y,mat1row.z,mat1row.w,mat2row.x,mat2row.y,mat2row.z,mat2row.w,mat3row.x,mat3row.y,mat3row.z,mat3row.w);return m;}\n#endif\n"),t.Shader3D.addInclude("MorphTarget.glsl","#if !defined(MorphTarget_lib)\n#define MorphTarget_lib\n#ifdef GRAPHICS_API_GLES3\nuniform sampler2DArray u_MorphTargetsTex;uniform vec4 u_MorphParams;uniform vec4 u_MorphAttrOffset;\n#define Morph_TexWidth u_MorphParams.x\n#define Morph_TexHeight u_MorphParams.y\n#define Morph_AttributeNum u_MorphParams.z\n#define Morph_TargetNum u_MorphParams.w\n#define Morph_PositionOffset u_MorphAttrOffset.x\n#define Morph_NormalOffset u_MorphAttrOffset.y\n#define Morph_TangentOffset u_MorphAttrOffset.z\nuniform vec4 u_MorphActiveTargets[MORPH_MAX_COUNT];uniform int u_MorphTargetActiveCount;\n#define MORPH_ACTIVE_COUNT u_MorphTargetActiveCount\nvec4 sampleMorphTargets(in int vertexID,in float targetID){int v=vertexID/int(Morph_TexWidth);int u=vertexID-v*int(Morph_TexWidth);vec3 uvw=vec3((float(u)+0.5)/Morph_TexWidth,(float(v)+0.5)/Morph_TexHeight,targetID);return texture(u_MorphTargetsTex,uvw);}vec3 positionMorph(in vec3 position){int vertexID=gl_VertexID*int(Morph_AttributeNum)+int(Morph_PositionOffset);for(int i=0;i<MORPH_ACTIVE_COUNT;i++){float index=u_MorphActiveTargets[i].x;float weight=u_MorphActiveTargets[i].y;position+=sampleMorphTargets(vertexID,index).xyz*weight;}return position;}vec3 normalMorph(in vec3 normal){int vertexID=gl_VertexID*int(Morph_AttributeNum)+int(Morph_NormalOffset);for(int i=0;i<MORPH_ACTIVE_COUNT;i++){float index=u_MorphActiveTargets[i].x;float weight=u_MorphActiveTargets[i].y;normal+=sampleMorphTargets(vertexID,index).xyz*weight;}return normal;}vec4 tangentMorph(in vec4 tangent){int vertexID=gl_VertexID*int(Morph_AttributeNum)+int(Morph_TangentOffset);for(int i=0;i<MORPH_ACTIVE_COUNT;i++){float index=u_MorphActiveTargets[i].x;float weight=u_MorphActiveTargets[i].y;vec4 sampleTangent=sampleMorphTargets(vertexID,index);tangent.xyz+=sampleTangent.xyz*weight*tangent.w*sampleTangent.w;}return tangent;}\n#endif\n#endif\n"),t.Shader3D.addInclude("VertexCommon.glsl",'#if !defined(VertexCommon_lib)\n#define VertexCommon_lib\n#ifdef MORPHTARGETS\n#include "MorphTarget.glsl";\n#endif\nstruct Vertex{vec3 positionOS;vec3 normalOS;\n#ifdef TANGENT\nvec4 tangentOS;\n#endif\n#ifdef UV\nvec2 texCoord0;\n#endif\n#ifdef UV1\nvec2 texCoord1;\n#endif\n#ifdef COLOR\nvec4 vertexColor;\n#endif\n#ifdef LIGHTMAP\nvec4 lightmapScaleOffset;\n#endif LIGHTMAP\n};vec4 getVertexPosition(){vec4 position=a_Position;\n#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_POSITION\n#ifdef GRAPHICS_API_GLES3\nposition.xyz=positionMorph(position.xyz);\n#endif\n#endif\n#endif\nreturn position;}vec3 getVertexNormal(){vec3 normal=a_Normal.xyz;\n#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_NORMAL\n#ifdef GRAPHICS_API_GLES3\nnormal.xyz=normalMorph(normal);\n#endif\n#endif\n#endif\nreturn normal;}\n#ifdef TANGENT\nvec4 getVertexTangent(){vec4 tangent=a_Tangent0;\n#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TANGENT\n#ifdef GRAPHICS_API_GLES3\ntangent=tangentMorph(tangent);\n#endif\n#endif\n#endif\nreturn tangent;}\n#endif\n#ifdef LIGHTMAP\n#ifndef GPU_INSTANCE\nuniform vec4 u_LightmapScaleOffset;\n#endif\nvec4 getLightmapScaleOffset(){\n#ifdef GPU_INSTANCE\nreturn a_LightmapScaleOffset;\n#else\nreturn u_LightmapScaleOffset;\n#endif\n}\n#endif\nvoid getVertexParams(inout Vertex vertex){vertex.positionOS=getVertexPosition().xyz;vertex.normalOS=getVertexNormal();\n#ifdef TANGENT\nvertex.tangentOS=getVertexTangent();\n#endif\n#ifdef UV\nvertex.texCoord0=a_Texcoord0;\n#endif\n#ifdef UV1\nvertex.texCoord1=a_Texcoord1;\n#endif\n#ifdef COLOR\nvertex.vertexColor=vec4(pow(a_Color.rgb,vec3(2.2)),a_Color.a);\n#endif\n#ifdef LIGHTMAP\nvertex.lightmapScaleOffset=getLightmapScaleOffset();\n#endif LIGHTMAP\n}\n#endif\n'),t.Shader3D.addInclude("ShadingCommon.glsl","#if !defined(ShadingCommon_lib)\n#define ShadingCommon_lib\nvarying vec3 v_PositionWS;varying vec3 v_NormalWS;varying vec3 v_TangentWS;varying vec3 v_BiNormalWS;\n#ifdef UV\nvarying vec2 v_Texcoord0;\n#endif\n#ifdef UV1\n#ifdef LIGHTMAP\nvarying vec2 v_Texcoord1;\n#endif\n#endif\n#ifdef COLOR\nvarying vec4 v_VertexColor;\n#endif\nstruct PixelParams{vec3 positionWS;vec3 normalWS;vec3 tangentWS;vec3 biNormalWS;mat3 TBN;\n#ifdef UV\nvec2 uv0;\n#endif\n#ifdef UV1\n#ifdef LIGHTMAP\nvec2 uv1;\n#endif\n#endif\n#ifdef COLOR\nvec4 vertexColor;\n#endif\n};\n#endif\n"),t.Shader3D.addInclude("ShadingVertex.glsl",'#if !defined(ShadingVertex_lib)\n#define ShadingVertex_lib\n#include "ShadingCommon.glsl";\nvoid sharePixelParams(const in PixelParams params){v_PositionWS=params.positionWS;v_NormalWS=params.normalWS;v_TangentWS=params.tangentWS;v_BiNormalWS=params.biNormalWS;\n#ifdef UV\nv_Texcoord0=params.uv0;\n#endif\n#ifdef UV1\n#ifdef LIGHTMAP\nv_Texcoord1=params.uv1;\n#endif LIGHTMAP\n#endif\n#ifdef COLOR\nv_VertexColor=params.vertexColor;\n#endif\n}void shadingPixelParams(inout PixelParams params,in Vertex vertex){mat4 worldMat=getWorldMatrix();vec4 pos=(worldMat*vec4(vertex.positionOS,1.0));params.positionWS=pos.xyz/pos.w;mat3 normalMat=transpose(inverse(mat3(worldMat)));params.normalWS=normalize((normalMat*vertex.normalOS).xyz);\n#ifdef TANGENT\nparams.tangentWS=normalize((normalMat*vertex.tangentOS.xyz).xyz);params.tangentWS*=WorldInvertFront;params.biNormalWS=normalize(cross(params.normalWS,params.tangentWS)*sign(vertex.tangentOS.w));\n#else\nparams.tangentWS=vec3(1.0,0.0,0.0);params.tangentWS*=WorldInvertFront;params.biNormalWS=normalize(cross(params.normalWS,params.tangentWS));\n#endif\n#ifdef UV\nparams.uv0=vertex.texCoord0;\n#endif\n#ifdef UV1\n#ifdef LIGHTMAP\nparams.uv1=tranformLightMapUV(vertex.texCoord1,vertex.lightmapScaleOffset);\n#endif LIGHTMAP\n#endif\n#ifdef COLOR\nparams.vertexColor=vertex.vertexColor;\n#endif\n}\n#endif\n'),t.Shader3D.addInclude("ShadingFrag.glsl",'#if !defined(ShadingFrag_lib)\n#define ShadingFrag_lib\n#include "ShadingCommon.glsl";\n#define _InvertNormal (float(gl_FrontFacing) * 2.0 - 1.0);\nvoid getPixelParams(inout PixelParams params){params.positionWS=v_PositionWS;float invertN=_InvertNormal;params.normalWS=normalize(v_NormalWS*invertN);params.tangentWS=normalize(v_TangentWS*invertN);params.biNormalWS=normalize(v_BiNormalWS*invertN);params.TBN=mat3(params.tangentWS,params.biNormalWS,params.normalWS);\n#ifdef UV\nparams.uv0=v_Texcoord0;\n#endif\n#ifdef UV1\n#ifdef LIGHTMAP\nparams.uv1=v_Texcoord1;\n#endif\n#endif\n#ifdef COLOR\nparams.vertexColor=v_VertexColor;\n#endif\n}\n#endif\n'),t.Shader3D.addInclude("OutputTransform.glsl","#if !defined(OutputTransform_lib)\n#define OutputTransform_lib\nvec3 gammaCorrect(in vec3 color,float gammaValue){return pow(color,vec3(gammaValue));}vec4 gammaCorrect(in vec4 color){float gammaValue=1.0/2.2;return vec4(gammaCorrect(color.rgb,gammaValue),color.a);}vec4 outputTransform(in vec4 color){\n#ifdef GAMMACORRECT\nreturn gammaCorrect(color);\n#else\nreturn color;\n#endif\n}\n#endif\n"),t.Shader3D.addInclude("Scene.glsl","#if !defined(SceneCommon_lib)\n#define SceneCommon_lib\n#ifdef ENUNIFORMBLOCK\nuniform Scene3D{float u_Time;vec4 u_FogParams;vec4 u_FogColor;float u_GIRotate;int u_DirationLightCount;};\n#else\nuniform float u_Time;uniform vec4 u_FogParams;uniform vec4 u_FogColor;uniform float u_GIRotate;uniform mediump int u_DirationLightCount;\n#endif\n#endif\n"),t.Shader3D.addInclude("Camera.glsl","#if !defined(CameraCommon_lib)\n#define CameraCommon_lib\n#ifdef ENUNIFORMBLOCK\nuniform BaseCamera{vec3 u_CameraPos;mat4 u_View;mat4 u_Projection;mat4 u_ViewProjection;vec3 u_CameraDirection;vec3 u_CameraUp;vec4 u_Viewport;vec4 u_ProjectionParams;vec4 u_OpaqueTextureParams;vec4 u_ZBufferParams;};\n#else\nuniform vec3 u_CameraPos;uniform mat4 u_View;uniform mat4 u_Projection;uniform mat4 u_ViewProjection;uniform vec3 u_CameraDirection;uniform vec3 u_CameraUp;uniform vec4 u_Viewport;uniform vec4 u_ProjectionParams;uniform vec4 u_OpaqueTextureParams;uniform vec4 u_ZBufferParams;\n#endif\nuniform sampler2D u_CameraDepthTexture;uniform sampler2D u_CameraDepthNormalsTexture;uniform sampler2D u_CameraOpaqueTexture;vec4 getPositionCS(in vec3 positionWS){return u_ViewProjection*vec4(positionWS,1.0);}vec3 getViewDirection(in vec3 positionWS){return normalize(u_CameraPos-positionWS);}vec4 remapPositionZ(vec4 position){\n#ifdef BLITSCREEN_INVERTY\nposition.y=-position.y;\n#endif\n#ifdef REMAP_Z\nposition.z=position.z*2.0-position.w;\n#endif\nreturn position;}\n#endif\n"),t.Shader3D.addInclude("SkyCommon.glsl","#if !defined(SkyCommon_lib)\n#define SkyCommon_lib\nuniform vec3 u_SunLight_direction;uniform vec4 u_SunLight_color;uniform mat4 u_SkyViewMat;uniform mat4 u_SkyProjectionMat;uniform mat4 u_SkyProjectionViewMat;vec4 remapSkyPositionZ(in vec4 position){position.z=position.w;\n#ifdef BLITSCREEN_INVERTY\nposition.y=-position.y;\n#endif\nreturn position;}const float c_deg2ang=3.141593/180.0;vec4 rotateAroundYInDegrees(vec4 vertex,float deg){float angle=deg*c_deg2ang;float sina=sin(angle);float cosa=cos(angle);mat2 m=mat2(cosa,-sina,sina,cosa);return vec4(m*vertex.xz,vertex.yw).xzyw;}\n#endif\n"),t.Shader3D.addInclude("Sprite3DCommon.glsl","#if !defined(Sprite3DCommon_lib)\n#define Sprite3DCommon_lib\nuniform mat4 u_WorldMat;uniform vec4 u_WorldInvertFront;\n#ifdef GPU_INSTANCE\n#define WorldInvertFront a_WorldInvertFront.x\n#define NodeCustomData0 a_WorldInvertFront.y\n#define NodeCustomData1 a_WorldInvertFront.z\n#define NodeCustomData2 a_WorldInvertFront.w\n#else\n#define WorldInvertFront u_WorldInvertFront.x\n#define NodeCustomData0 u_WorldInvertFront.y\n#define NodeCustomData1 u_WorldInvertFront.z\n#define NodeCustomData2 u_WorldInvertFront.w\n#endif\nvec2 tranformLightMapUV(in vec2 texcoord,in vec4 tilingOffset){vec2 lightMapUV=vec2(texcoord.x,1.0-texcoord.y)*tilingOffset.xy+tilingOffset.zw;lightMapUV.y=1.0-lightMapUV.y;return lightMapUV;}vec2 transformUV(in vec2 texcoord,in vec4 tilingOffset){vec2 uv=texcoord*tilingOffset.xy+tilingOffset.zw*vec2(1.0,-1.0)+vec2(0.0,1.0-tilingOffset.y);return uv;}\n#endif\n"),t.Shader3D.addInclude("Sprite3DVertex.glsl",'#if !defined(Sprite3DVertex_lib)\n#define Sprite3DVertex_lib\n#include "Sprite3DCommon.glsl";\n#ifdef BONE\nuniform mat4 u_Bones[24];\n#ifdef SIMPLEBONE\nuniform vec4 u_SimpleAnimatorParams;uniform sampler2D u_SimpleAnimatorTexture;uniform float u_SimpleAnimatorTextureSize;\n#include "BakedBoneMatrixSampler.glsl";\n#endif\n#endif\nmat4 getWorldMatrix(){\n#ifdef GPU_INSTANCE\nmat4 worldMat=a_WorldMat;\n#else\nmat4 worldMat=u_WorldMat;\n#endif\n#ifdef BONE\n#ifdef SIMPLEBONE\n#ifdef GPU_INSTANCE\nfloat currentPixelPos=a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n#else\nfloat currentPixelPos=u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n#endif\nfloat offset=1.0/u_SimpleAnimatorTextureSize;mat4 skinTrans=loadBakedMatMatrix(currentPixelPos,a_BoneIndices.x,offset)*a_BoneWeights.x;skinTrans+=loadBakedMatMatrix(currentPixelPos,a_BoneIndices.y,offset)*a_BoneWeights.y;skinTrans+=loadBakedMatMatrix(currentPixelPos,a_BoneIndices.z,offset)*a_BoneWeights.z;skinTrans+=loadBakedMatMatrix(currentPixelPos,a_BoneIndices.w,offset)*a_BoneWeights.w;worldMat=worldMat*skinTrans;\n#else\nivec4 boneIndex=ivec4(a_BoneIndices);mat4 skinTrans=u_Bones[boneIndex.x]*a_BoneWeights.x;skinTrans+=u_Bones[boneIndex.y]*a_BoneWeights.y;skinTrans+=u_Bones[boneIndex.z]*a_BoneWeights.z;skinTrans+=u_Bones[boneIndex.w]*a_BoneWeights.w;worldMat=worldMat*skinTrans;\n#endif\n#endif\nreturn worldMat;}vec2 getSimpleBoneCustomData(){vec2 custom;\n#ifdef BONE\n#ifdef SIMPLEBONE\n#ifdef GPU_INSTANCE\ncustom=a_SimpleTextureParams.zw;\n#else\ncustom=u_SimpleAnimatorParams.zw;\n#endif\n#endif\n#endif\nreturn custom;}\n#endif\n'),t.Shader3D.addInclude("Sprite3DFrag.glsl",'#if !defined(Sprite3DFrag_lib)\n#define Sprite3DFrag_lib\n#include "Sprite3DCommon.glsl";\n#endif\n'),t.Shader3D.addInclude("DepthVertex.glsl",'#if !defined(DepthVertex_lib)\n#define DepthVertex_lib\n#include "Math.glsl";\n#include "Scene.glsl";\n#include "Camera.glsl";\n#include "Sprite3DVertex.glsl";\n#include "VertexCommon.glsl";\n#if defined(SHADOW) || defined(SHADOW_SPOT)\n#ifndef DEPTHPASS\n#include "ShadowCommon.glsl"\nvec3 applyShadowBias(vec3 positionWS,vec3 normalWS,vec3 lightDirection){float invNdotL=1.0-clamp(dot(-lightDirection,normalWS),0.0,1.0);float scale=invNdotL*u_ShadowBias.y;positionWS+=-lightDirection*u_ShadowBias.xxx;positionWS+=normalWS*vec3(scale);return positionWS;}\n#endif\n#endif\n#ifdef DEPTHPASS\n#include "Camera.glsl";\n#endif\nvec4 DepthPositionCS(in vec3 positionWS,in vec3 normalWS){\n#ifdef DEPTHPASS\nvec4 positionCS=u_ViewProjection*vec4(positionWS,1.0);\n#endif\n#ifdef SHADOW\n#ifndef DEPTHPASS\npositionWS=applyShadowBias(positionWS,normalWS,u_ShadowLightDirection);vec4 positionCS=u_ViewProjection*vec4(positionWS,1.0);positionCS.z=max(positionCS.z,0.0);\n#endif\n#endif\n#ifdef SHADOW_SPOT\n#ifndef DEPTHPASS\nvec4 positionCS=u_ViewProjection*vec4(positionWS,1.0);positionCS.z=positionCS.z-u_ShadowBias.x/positionCS.w;positionCS.z=max(positionCS.z,0.0);\n#endif\n#endif\nreturn positionCS;}\n#endif\n'),t.Shader3D.addInclude("DepthFrag.glsl","#if !defined(DepthFrag_lib)\n#define DepthFrag_lib\nvec4 getDepthColor(){return vec4(0.0);}\n#endif\n"),t.Shader3D.addInclude("DepthNormalUtil.glsl","#define SAMPLE_DEPTH_TEXTURE(textureName, coord2) (texture2D(textureName, coord2).r)\nvec2 EncodeViewNormalStereo(vec3 n){n.z=abs(n.z);float kScale=1.7777;vec2 enc;enc=n.xy/(n.z+1.0);enc/=kScale;enc=enc*0.5+0.5;return enc;}vec3 DecodeViewNormalStereo(vec4 enc4){float kScale=1.7777;vec3 nn=enc4.xyz*vec3(2.0*kScale,2.0*kScale,0.0)+vec3(-kScale,-kScale,1.0);float g=2.0/dot(nn.xyz,nn.xyz);vec3 n;n.xy=g*nn.xy;n.z=g-1.0;return n;}vec2 EncodeFloatRG(float v){vec2 kEncodeMul=vec2(1.0,255.0);float kEncodeBit=1.0/255.0;vec2 enc=kEncodeMul*v;enc=fract(enc);enc.x-=enc.y*kEncodeBit;return enc;}float DecodeFloatRG(vec2 enc){vec2 kDecodeDot=vec2(1.0,1.0/255.0);return dot(enc,kDecodeDot);}vec4 EncodeDepthNormal(float depth,vec3 normals){vec4 encode;encode.xy=EncodeViewNormalStereo(normals);encode.zw=EncodeFloatRG(depth);return encode;}void DecodeDepthNormal(vec4 enc,out float depth,out vec3 normal){depth=DecodeFloatRG(enc.zw);normal=DecodeViewNormalStereo(enc);}vec4 depthNormalsFragment(vec4 depthNormal){return EncodeDepthNormal(depthNormal.w,depthNormal.xyz);}float Linear01Depth(float z,vec4 zbufferParams){return 1.0/(zbufferParams.x*z+zbufferParams.y);}float LinearEyeDepth(float z,vec4 zbufferParams){return 1.0/(zbufferParams.z*z+zbufferParams.w);}"),t.Shader3D.addInclude("DepthNormalFrag.glsl",'#if !defined(DepthNormalFrag_lib)\n#define DepthNormalFrag_lib\n#include "DepthNormalUtil.glsl";\nvec4 encodeDepthNormal(const in vec4 positionCS,const in vec3 normalWS){float depth=(positionCS.z*2.0-positionCS.w)*u_ProjectionParams.w;vec3 normalVS=mat3(u_View)*normalWS;return EncodeDepthNormal(depth,normalVS);}\n#endif\n'),t.Shader3D.addInclude("SceneFog.glsl","#if !defined(SceneFog_lib)\n#define SceneFog_lib\n#ifdef FOG\nvarying float v_fogFactor;float getFogFactor(){return v_fogFactor;}vec3 scenUnlitFog(in vec3 color){float lerpFact=getFogFactor();\n#ifdef ADDTIVEFOG\nlerpFact=clamp(lerpFact,0.0,1.0);return mix(vec3(0.0),color,lerpFact);\n#else\nlerpFact=clamp(lerpFact,0.0,1.0);return mix(u_FogColor.rgb,color,lerpFact);\n#endif\n}vec3 sceneLitFog(in vec3 color){float lerpFact=getFogFactor();lerpFact=clamp(lerpFact,0.0,1.0);return mix(u_FogColor.rgb,color,lerpFact);}\n#endif\n#endif\n"),t.Shader3D.addInclude("SceneFogInput.glsl","#if !defined(SceneFog_lib)\n#define SceneFog_lib\n#ifdef FOG\nvarying float v_fogFactor;void FogHandle(in float fact){float lerpFact=0.0;\n#ifdef FOG_EXP\nlerpFact=fact*(u_FogParams.z/log(2.0));lerpFact=exp2(-lerpFact);\n#elif defined(FOG_EXP2)\nlerpFact=fact*(u_FogParams.z/sqrt(log(2.0)));lerpFact=exp2(-lerpFact);\n#else\nlerpFact=(-1.0*fact/(u_FogParams.y-u_FogParams.x)+u_FogParams.y/(u_FogParams.y-u_FogParams.x));\n#endif\nv_fogFactor=lerpFact;}\n#endif\n#endif\n"),t.Shader3D.addInclude("ShadowCommon.glsl","#if !defined(ShadowCommon_lib)\n#define ShadowCommon_lib\n#ifndef GRAPHICS_API_GLES3\n#define NO_NATIVE_SHADOWMAP\n#endif\n#if defined(NO_NATIVE_SHADOWMAP)\n#define TEXTURE2D_SHADOW(textureName) uniform mediump sampler2D textureName\n#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) (texture2D(textureName, coord3.xy).r < coord3.z ? 0.0 : 1.0)\n#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2D shadowMap\n#else\n#define TEXTURE2D_SHADOW(textureName) uniform mediump sampler2DShadow textureName\n#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) textureLod(textureName, coord3, 0.0)\n#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2DShadow shadowMap\n#endif\n#if defined(SHADOW) || defined(SHADOW_SPOT)\n#ifdef ENUNIFORMBLOCK\nuniform Shadow{vec3 u_ShadowLightDirection;vec4 u_ShadowBias;vec4 u_ShadowSplitSpheres[4];mat4 u_ShadowMatrices[4];vec4 u_ShadowMapSize;vec4 u_ShadowParams;vec4 u_SpotShadowMapSize;mat4 u_SpotViewProjectMatrix;};TEXTURE2D_SHADOW(u_ShadowMap);TEXTURE2D_SHADOW(u_SpotShadowMap);\n#else\nuniform vec3 u_ShadowLightDirection;uniform vec4 u_ShadowBias;uniform vec4 u_ShadowSplitSpheres[4];uniform mat4 u_ShadowMatrices[4];uniform vec4 u_ShadowMapSize;uniform vec4 u_ShadowParams;uniform vec4 u_SpotShadowMapSize;uniform mat4 u_SpotViewProjectMatrix;TEXTURE2D_SHADOW(u_ShadowMap);TEXTURE2D_SHADOW(u_SpotShadowMap);\n#endif\n#endif\n#endif\n"),t.Shader3D.addInclude("ShadowSampleTent.glsl","float sampleShadowGetIRTriangleTexelArea(float triangleHeight){return triangleHeight-0.5;}void sampleShadowGetTexelAreasTent3x3(float offset,out vec4 computedArea,out vec4 computedAreaUncut){float a=offset+0.5;float offsetSquaredHalved=a*a*0.5;computedAreaUncut.x=computedArea.x=offsetSquaredHalved-offset;computedAreaUncut.w=computedArea.w=offsetSquaredHalved;computedAreaUncut.y=sampleShadowGetIRTriangleTexelArea(1.5-offset);float clampedOffsetLeft=min(offset,0.0);float areaOfSmallLeftTriangle=clampedOffsetLeft*clampedOffsetLeft;computedArea.y=computedAreaUncut.y-areaOfSmallLeftTriangle;computedAreaUncut.z=sampleShadowGetIRTriangleTexelArea(1.5+offset);float clampedOffsetRight=max(offset,0.0);float areaOfSmallRightTriangle=clampedOffsetRight*clampedOffsetRight;computedArea.z=computedAreaUncut.z-areaOfSmallRightTriangle;}void sampleShadowGetTexelWeightsTent5x5(float offset,out vec3 texelsWeightsA,out vec3 texelsWeightsB){vec4 areaFrom3texelTriangle;vec4 areaUncutFrom3texelTriangle;sampleShadowGetTexelAreasTent3x3(offset,areaFrom3texelTriangle,areaUncutFrom3texelTriangle);texelsWeightsA.x=0.16*(areaFrom3texelTriangle.x);texelsWeightsA.y=0.16*(areaUncutFrom3texelTriangle.y);texelsWeightsA.z=0.16*(areaFrom3texelTriangle.y+1.0);texelsWeightsB.x=0.16*(areaFrom3texelTriangle.z+1.0);texelsWeightsB.y=0.16*(areaUncutFrom3texelTriangle.z);texelsWeightsB.z=0.16*(areaFrom3texelTriangle.w);}void sampleShadowComputeSamplesTent5x5(vec4 shadowMapTextureTexelSize,vec2 coord,out float fetchesWeights[9],out vec2 fetchesUV[9]){vec2 tentCenterInTexelSpace=coord.xy*shadowMapTextureTexelSize.zw;vec2 centerOfFetchesInTexelSpace=floor(tentCenterInTexelSpace+0.5);vec2 offsetFromTentCenterToCenterOfFetches=tentCenterInTexelSpace-centerOfFetchesInTexelSpace;vec3 texelsWeightsUA,texelsWeightsUB;vec3 texelsWeightsVA,texelsWeightsVB;sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.x,texelsWeightsUA,texelsWeightsUB);sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.y,texelsWeightsVA,texelsWeightsVB);vec3 fetchesWeightsU=vec3(texelsWeightsUA.xz,texelsWeightsUB.y)+vec3(texelsWeightsUA.y,texelsWeightsUB.xz);vec3 fetchesWeightsV=vec3(texelsWeightsVA.xz,texelsWeightsVB.y)+vec3(texelsWeightsVA.y,texelsWeightsVB.xz);vec3 fetchesOffsetsU=vec3(texelsWeightsUA.y,texelsWeightsUB.xz)/fetchesWeightsU.xyz+vec3(-2.5,-0.5,1.5);vec3 fetchesOffsetsV=vec3(texelsWeightsVA.y,texelsWeightsVB.xz)/fetchesWeightsV.xyz+vec3(-2.5,-0.5,1.5);fetchesOffsetsU*=shadowMapTextureTexelSize.xxx;fetchesOffsetsV*=shadowMapTextureTexelSize.yyy;vec2 bilinearFetchOrigin=centerOfFetchesInTexelSpace*shadowMapTextureTexelSize.xy;fetchesUV[0]=bilinearFetchOrigin+vec2(fetchesOffsetsU.x,fetchesOffsetsV.x);fetchesUV[1]=bilinearFetchOrigin+vec2(fetchesOffsetsU.y,fetchesOffsetsV.x);fetchesUV[2]=bilinearFetchOrigin+vec2(fetchesOffsetsU.z,fetchesOffsetsV.x);fetchesUV[3]=bilinearFetchOrigin+vec2(fetchesOffsetsU.x,fetchesOffsetsV.y);fetchesUV[4]=bilinearFetchOrigin+vec2(fetchesOffsetsU.y,fetchesOffsetsV.y);fetchesUV[5]=bilinearFetchOrigin+vec2(fetchesOffsetsU.z,fetchesOffsetsV.y);fetchesUV[6]=bilinearFetchOrigin+vec2(fetchesOffsetsU.x,fetchesOffsetsV.z);fetchesUV[7]=bilinearFetchOrigin+vec2(fetchesOffsetsU.y,fetchesOffsetsV.z);fetchesUV[8]=bilinearFetchOrigin+vec2(fetchesOffsetsU.z,fetchesOffsetsV.z);fetchesWeights[0]=fetchesWeightsU.x*fetchesWeightsV.x;fetchesWeights[1]=fetchesWeightsU.y*fetchesWeightsV.x;fetchesWeights[2]=fetchesWeightsU.z*fetchesWeightsV.x;fetchesWeights[3]=fetchesWeightsU.x*fetchesWeightsV.y;fetchesWeights[4]=fetchesWeightsU.y*fetchesWeightsV.y;fetchesWeights[5]=fetchesWeightsU.z*fetchesWeightsV.y;fetchesWeights[6]=fetchesWeightsU.x*fetchesWeightsV.z;fetchesWeights[7]=fetchesWeightsU.y*fetchesWeightsV.z;fetchesWeights[8]=fetchesWeightsU.z*fetchesWeightsV.z;}"),t.Shader3D.addInclude("ShadowSampler.glsl",'\n#if !defined(ShadowSampler_lib)\n#define ShadowSampler_lib\n#ifdef RECEIVESHADOW\n#include "ShadowSampleTent.glsl";\n#include "ShadowCommon.glsl"\n#define ShadowStrength u_ShadowParams.x\n#define SpotShadowStrength u_ShadowParams.y\n#ifdef SHADOW\n#define CALCULATE_SHADOWS\nvarying vec4 v_ShadowCoord;\n#endif\n#ifdef SHADOW_SPOT\n#define CALCULATE_SPOTSHADOWS\nvarying vec4 v_SpotShadowCoord;\n#endif\nfloat sampleShdowMapFiltered4(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowMapSize){float attenuation;vec4 attenuation4;vec2 offset=shadowMapSize.xy/2.0;vec3 shadowCoord0=shadowCoord+vec3(-offset,0.0);vec3 shadowCoord1=shadowCoord+vec3(offset.x,-offset.y,0.0);vec3 shadowCoord2=shadowCoord+vec3(-offset.x,offset.y,0.0);vec3 shadowCoord3=shadowCoord+vec3(offset,0.0);attenuation4.x=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord0);attenuation4.y=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord1);attenuation4.z=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord2);attenuation4.w=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord3);attenuation=dot(attenuation4,vec4(0.25));return attenuation;}float sampleShdowMapFiltered9(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowmapSize){float attenuation;float fetchesWeights[9];vec2 fetchesUV[9];sampleShadowComputeSamplesTent5x5(shadowmapSize,shadowCoord.xy,fetchesWeights,fetchesUV);attenuation=fetchesWeights[0]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[0].xy,shadowCoord.z));attenuation+=fetchesWeights[1]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[1].xy,shadowCoord.z));attenuation+=fetchesWeights[2]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[2].xy,shadowCoord.z));attenuation+=fetchesWeights[3]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[3].xy,shadowCoord.z));attenuation+=fetchesWeights[4]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[4].xy,shadowCoord.z));attenuation+=fetchesWeights[5]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[5].xy,shadowCoord.z));attenuation+=fetchesWeights[6]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[6].xy,shadowCoord.z));attenuation+=fetchesWeights[7]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[7].xy,shadowCoord.z));attenuation+=fetchesWeights[8]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[8].xy,shadowCoord.z));return attenuation;}\n#endif\n#if defined(CALCULATE_SHADOWS)\n#ifdef SHADOW_CASCADE\nmediump int computeCascadeIndex(in vec3 positionWS){vec3 fromCenter0=positionWS-u_ShadowSplitSpheres[0].xyz;vec3 fromCenter1=positionWS-u_ShadowSplitSpheres[1].xyz;vec3 fromCenter2=positionWS-u_ShadowSplitSpheres[2].xyz;vec3 fromCenter3=positionWS-u_ShadowSplitSpheres[3].xyz;mediump vec4 comparison=vec4(dot(fromCenter0,fromCenter0)<u_ShadowSplitSpheres[0].w,dot(fromCenter1,fromCenter1)<u_ShadowSplitSpheres[1].w,dot(fromCenter2,fromCenter2)<u_ShadowSplitSpheres[2].w,dot(fromCenter3,fromCenter3)<u_ShadowSplitSpheres[3].w);comparison.yzw=clamp(comparison.yzw-comparison.xyz,0.0,1.0);mediump vec4 indexCoefficient=vec4(4.0,3.0,2.0,1.0);mediump int index=4-int(dot(comparison,indexCoefficient));return index;}\n#endif\nvec4 getShadowCoord(in vec3 positionWS){\n#ifdef SHADOW_CASCADE\nmediump int cascadeIndex=computeCascadeIndex(positionWS);\n#ifdef GRAPHICS_API_GLES3\nmat4 shadowMat=u_ShadowMatrices[cascadeIndex];\n#else\nmat4 shadowMat;if(cascadeIndex==0){shadowMat=u_ShadowMatrices[0];}else if(cascadeIndex==1){shadowMat=u_ShadowMatrices[1];}else if(cascadeIndex==2){shadowMat=u_ShadowMatrices[2];}else{shadowMat=u_ShadowMatrices[3];}\n#endif\nreturn shadowMat*vec4(positionWS,1.0);\n#else\nreturn u_ShadowMatrices[0]*vec4(positionWS,1.0);\n#endif\n}float sampleShadowmap(in vec4 shadowCoord){float attenuation=1.0;vec3 coord=shadowCoord.xyz/shadowCoord.w;vec4 shadowmapSize=u_ShadowMapSize;{\n#if defined(SHADOW_SOFT_SHADOW_HIGH)\nattenuation=sampleShdowMapFiltered9(u_ShadowMap,coord,shadowmapSize);\n#elif defined(SHADOW_SOFT_SHADOW_LOW)\nattenuation=sampleShdowMapFiltered4(u_ShadowMap,coord,shadowmapSize);\n#else\nattenuation=SAMPLE_TEXTURE2D_SHADOW(u_ShadowMap,coord);\n#endif\nattenuation=mix(1.0,attenuation,ShadowStrength);}if(coord.z>0.0&&coord.z<1.0)return attenuation;return 1.0;}\n#endif\n#if defined(CALCULATE_SPOTSHADOWS)\nvec4 getSpotShadowCoord(in vec3 positionWS){vec4 coordinate=u_SpotViewProjectMatrix*vec4(positionWS,1.0);return coordinate;}float sampleSpotShadowmap(vec4 shadowCoord){float attenuation=1.0;vec3 coord=shadowCoord.xyz/shadowCoord.w;coord.xy=coord.xy*0.5+0.5;vec4 shadowmapSize=u_SpotShadowMapSize;\n#if defined(SHADOW_SPOT_SOFT_SHADOW_HIGH)\nattenuation=sampleShdowMapFiltered9(u_SpotShadowMap,coord,shadowmapSize);\n#elif defined(SHADOW_SPOT_SOFT_SHADOW_LOW)\nattenuation=sampleShdowMapFiltered4(u_SpotShadowMap,coord,shadowmapSize);\n#else\nattenuation=SAMPLE_TEXTURE2D_SHADOW(u_SpotShadowMap,coord);\n#endif\nattenuation=mix(1.0,attenuation,SpotShadowStrength);if(coord.z>0.0&&coord.z<1.0)return attenuation;return 1.0;}\n#endif\n#endif\n'),t.Shader3D.addInclude("Lighting.glsl",'#if !defined(Lighting_lib)\n#define Lighting_lib\n#include "ShadowSampler.glsl";\nstruct Light{vec3 color;vec3 dir;float attenuation;};struct DirectionLight{vec3 color;vec3 direction;float attenuation;int lightMode;};struct PointLight{vec3 color;vec3 position;float range;float attenuation;int lightMode;};struct SpotLight{vec3 color;vec3 position;float range;vec3 direction;float spot;float attenuation;int lightMode;};\n#define LightMode_Mix 0\n#define LightMode_RealTime 1\nint getAttenuationByMode(float lightMapMode){\n#ifdef LIGHTMAP\nreturn int(lightMapMode);\n#else\n#ifdef VOLUMETRICGI\nreturn int(lightMapMode);\n#endif\n#endif\nreturn LightMode_RealTime;}\n#if defined(DIRECTIONLIGHT) || defined(POINTLIGHT) || defined(SPOTLIGHT)\n#define LIGHTING\nfloat attenuation(in vec3 L,in float invLightRadius){float fRatio=clamp(length(L)*invLightRadius,0.0,1.0);fRatio*=fRatio;return 1.0/(1.0+25.0*fRatio)*clamp(4.0*(1.0-fRatio),0.0,1.0);}Light getLight(in DirectionLight directionLight){Light light;light.color=directionLight.color;light.dir=directionLight.direction;light.attenuation=directionLight.attenuation;return light;}Light getLight(in PointLight pointLight,in vec3 normalWS,in vec3 positionWS){vec3 lightDirection=positionWS-pointLight.position;float rangeAttenuate=attenuation(lightDirection,1.0/pointLight.range);Light light;light.color=pointLight.color*rangeAttenuate;light.dir=normalize(lightDirection);light.attenuation=pointLight.attenuation;return light;}Light getLight(in SpotLight spotLight,in vec3 normalWS,in vec3 positionWS){vec3 lightDirection=positionWS-spotLight.position;vec3 normalizeLightDir=normalize(lightDirection);vec2 cosAngles=cos(vec2(spotLight.spot,spotLight.spot*0.5)*0.5);float dirAttenuate=dot(spotLight.direction,normalizeLightDir);dirAttenuate*=smoothstep(cosAngles.x,cosAngles.y,dirAttenuate);float rangeAttenuate=attenuation(lightDirection,1.0/spotLight.range);Light light;light.color=spotLight.color*rangeAttenuate*dirAttenuate;light.dir=normalizeLightDir;light.attenuation=spotLight.attenuation;return light;}\n#ifdef LEGACYSINGLELIGHTING\n#define CalculateLightCount 1\n#define DirectionCount 1\n#ifdef DIRECTIONLIGHT\nuniform vec3 u_DirLightColor;uniform vec3 u_DirLightDirection;uniform int u_DirLightMode;\n#endif\n#ifdef POINTLIGHT\nuniform vec3 u_PointLightColor;uniform vec3 u_PointLightPos;uniform float u_PointLightRange;uniform int u_PointLightMode;\n#endif\n#ifdef SPOTLIGHT\nuniform vec3 u_SpotLightPos;uniform vec3 u_SpotLightColor;uniform vec3 u_SpotLightDirection;uniform float u_SpotLightRange;uniform float u_SpotLightSpot;uniform int u_SpotLightMode;\n#endif\n#else\n#define CalculateLightCount MAX_LIGHT_COUNT\n#define DirectionCount u_DirationLightCount\nuniform sampler2D u_LightBuffer;\n#if defined(POINTLIGHT) || defined(SPOTLIGHT)\nconst int c_ClusterBufferWidth=CLUSTER_X_COUNT*CLUSTER_Y_COUNT;int c_ClusterBufferHeight=CLUSTER_Z_COUNT*(1+int(ceil(float(MAX_LIGHT_COUNT_PER_CLUSTER)/4.0)));const int c_ClusterBufferFloatWidth=c_ClusterBufferWidth*4;uniform sampler2D u_LightClusterBuffer;int getLightIndex(in int offset,in int index){int totalOffset=offset+index;int row=totalOffset/c_ClusterBufferFloatWidth;int lastRowFloat=totalOffset-row*c_ClusterBufferFloatWidth;int col=lastRowFloat/4;vec2 uv=vec2((float(col)+0.5)/float(c_ClusterBufferWidth),(float(row)+0.5)/float(c_ClusterBufferHeight));vec4 texPixel=texture2D(u_LightClusterBuffer,uv);int pixelComponent=lastRowFloat-col*4;\n#ifdef GRAPHICS_API_GLES3\nreturn int(texPixel[pixelComponent]);\n#else\nif(pixelComponent==0)return int(texPixel.x);else if(pixelComponent==1)return int(texPixel.y);else if(pixelComponent==2)return int(texPixel.z);else return int(texPixel.w);\n#endif\n}\n#endif\n#endif\n#ifdef DIRECTIONLIGHT\nDirectionLight getDirectionLight(in int index,in vec3 positionWS){DirectionLight light;\n#ifdef LEGACYSINGLELIGHTING\nlight.color=u_DirLightColor;light.direction=u_DirLightDirection;light.attenuation=1.0;light.lightMode=getAttenuationByMode(float(u_DirLightMode));\n#else\nfloat v=(float(index)+0.5)/float(CalculateLightCount);vec4 p1=texture2D(u_LightBuffer,vec2(0.125,v));vec4 p2=texture2D(u_LightBuffer,vec2(0.375,v));light.color=p1.rgb;light.direction=p2.rgb;light.attenuation=1.0;light.lightMode=getAttenuationByMode(p1.a);\n#endif\n#if defined(CALCULATE_SHADOWS)\nif(index==0){vec4 shadowCoord=getShadowCoord(positionWS);float shadowAttenuation=sampleShadowmap(shadowCoord);light.attenuation=shadowAttenuation;}\n#endif\nreturn light;}\n#endif\n#if defined(POINTLIGHT) || defined(SPOTLIGHT)\nivec4 getClusterInfo(mat4 viewMatrix,vec4 viewport,vec3 positionWS,vec4 fragCoord,vec4 projectParams){\n#ifdef LEGACYSINGLELIGHTING\nreturn ivec4(1,1,0,0);\n#else\nvec3 viewPos=vec3(viewMatrix*vec4(positionWS,1.0));int clusterXIndex=int(floor(fragCoord.x/(float(viewport.z)/float(CLUSTER_X_COUNT))));int clusterYIndex=int(floor((viewport.w*(projectParams.z<0.0 ? 0.0 : 1.0)-fragCoord.y*projectParams.z)/(float(viewport.w)/float(CLUSTER_Y_COUNT))));float zSliceParam=float(CLUSTER_Z_COUNT)/log2(projectParams.y/projectParams.x);int clusterZIndex=int(floor(log2(-viewPos.z)*zSliceParam-log2(projectParams.x)*zSliceParam));vec2 uv=vec2((float(clusterXIndex+clusterYIndex*CLUSTER_X_COUNT)+0.5)/float(c_ClusterBufferWidth),(float(clusterZIndex)+0.5)/float(c_ClusterBufferHeight));vec4 clusterPixel=texture2D(u_LightClusterBuffer,uv);return ivec4(clusterPixel);\n#endif\n}\n#endif\n#ifdef POINTLIGHT\nPointLight getPointLight(in int index,in ivec4 clusterInfo,in vec3 positionWS){PointLight light;\n#ifdef LEGACYSINGLELIGHTING\nlight.color=u_PointLightColor;light.position=u_PointLightPos;light.range=u_PointLightRange;light.attenuation=1.0;light.lightMode=getAttenuationByMode(float(u_PointLightMode));\n#else\nint indexOffset=clusterInfo.z*c_ClusterBufferFloatWidth+clusterInfo.w;int pointIndex=getLightIndex(indexOffset,index);float v=(float(pointIndex)+0.5)/float(CalculateLightCount);vec4 p1=texture2D(u_LightBuffer,vec2(0.125,v));vec4 p2=texture2D(u_LightBuffer,vec2(0.375,v));light.color=p1.rgb;light.range=p1.a;light.position=p2.rgb;light.attenuation=1.0;light.lightMode=getAttenuationByMode(p2.a);\n#endif\nreturn light;}\n#endif\n#ifdef SPOTLIGHT\nSpotLight getSpotLight(in int index,in ivec4 clusterInfo,in vec3 positionWS){SpotLight light;\n#ifdef LEGACYSINGLELIGHTING\nlight.color=u_SpotLightColor;light.position=u_SpotLightPos;light.range=u_SpotLightRange;light.direction=u_SpotLightDirection;light.spot=u_SpotLightSpot;light.attenuation=1.0;light.lightMode=getAttenuationByMode(float(u_SpotLightMode));\n#else\nint indexOffset=clusterInfo.z*c_ClusterBufferFloatWidth+clusterInfo.w;int spotIndex=getLightIndex(indexOffset,index+clusterInfo.x);float v=(float(spotIndex)+0.5)/float(CalculateLightCount);vec4 p1=texture2D(u_LightBuffer,vec2(0.125,v));vec4 p2=texture2D(u_LightBuffer,vec2(0.375,v));vec4 p3=texture2D(u_LightBuffer,vec2(0.625,v));light.color=p1.rgb;light.range=p1.a;light.position=p2.rgb;light.spot=p2.a;light.direction=p3.rgb;light.attenuation=1.0;light.lightMode=getAttenuationByMode(p3.a);\n#endif\n#if defined(CALCULATE_SPOTSHADOWS)\nif(index==0){vec4 shadowCoord=getSpotShadowCoord(positionWS);float shadowAttenuation=sampleSpotShadowmap(shadowCoord);light.attenuation=shadowAttenuation;}\n#endif\nreturn light;}\n#endif\n#endif\n#endif\n'),t.Shader3D.addInclude("globalIllumination.glsl",'#if !defined(globalIllumination_lib)\n#define globalIllumination_lib\n#ifdef ENUNIFORMBLOCK\nuniform ReflectionProbe{vec4 u_AmbientColor;vec3 u_IblSH[9];float u_IBLRoughnessLevel;float u_AmbientIntensity;float u_ReflectionIntensity;};uniform samplerCube u_IBLTex;\n#else\nuniform vec4 u_AmbientColor;uniform vec3 u_IblSH[9];uniform samplerCube u_IBLTex;uniform float u_IBLRoughnessLevel;uniform float u_AmbientIntensity;uniform float u_ReflectionIntensity;\n#endif\n#ifdef VOLUMETRICGI\n#include "VolumetricGI.glsl";\n#endif\nvec3 rotateByYAixs(in vec3 normal){float co=cos(u_GIRotate);float si=sin(u_GIRotate);float x=normal.x*co-normal.z*si;float z=normal.x*si+normal.z*co;return vec3(x,normal.y,z);}vec4 rotateByYAixs(in vec4 normal){float co=cos(u_GIRotate);float si=sin(u_GIRotate);float x=normal.x*co-normal.z*si;float z=normal.x*si+normal.z*co;return vec4(x,normal.y,z,normal.w);}\n#ifdef GI_IBL\nvec3 diffuseIrradiance(in vec3 normalWS){vec3 n=normalWS*vec3(-1.0,1.0,1.0);n=rotateByYAixs(n);return max(u_IblSH[0]+u_IblSH[1]*n.y+u_IblSH[2]*n.z+u_IblSH[3]*n.x+u_IblSH[4]*(n.y*n.x)+u_IblSH[5]*(n.y*n.z)+u_IblSH[6]*(3.0*n.z*n.z-1.0)+u_IblSH[7]*(n.z*n.x)+u_IblSH[8]*(n.x*n.x-n.y*n.y),0.0)*u_AmbientIntensity;}vec3 diffuseIrradiance(in vec3 normalWS,in vec3 positionWS,in vec3 viewDir){\n#ifdef VOLUMETRICGI\nvec3 surfaceBias=VolumetricGISurfaceBias(normalWS,viewDir);return VolumetricGIVolumeIrradiance(positionWS,surfaceBias,normalWS)*u_AmbientIntensity;\n#else\nreturn diffuseIrradiance(normalWS);\n#endif\n}vec3 specularRadiance(in vec3 r,in float perceptualRoughness){float lod=u_IBLRoughnessLevel*perceptualRoughness*(2.0-perceptualRoughness);vec3 reflectDir=r*vec3(-1.0,1.0,1.0);reflectDir=rotateByYAixs(reflectDir);\n#ifdef LOD_TEXTURE_SAMPLE\nvec4 reflectSampler=textureCubeLodEXT(u_IBLTex,reflectDir,lod);\n#else\nvec4 reflectSampler=textureLod(u_IBLTex,reflectDir,lod);\n#endif\n#ifdef IBL_RGBD\nreturn decodeRGBD(reflectSampler)*u_ReflectionIntensity;\n#else\nreturn reflectSampler.rgb*u_ReflectionIntensity;\n#endif\n}\n#endif\n#ifdef GI_LEGACYIBL\nuniform vec4 u_AmbientSHAr;uniform vec4 u_AmbientSHAg;uniform vec4 u_AmbientSHAb;uniform vec4 u_AmbientSHBr;uniform vec4 u_AmbientSHBg;uniform vec4 u_AmbientSHBb;uniform vec4 u_AmbientSHC;\n#define LAYA_SPECCUBE_LOD_STEPS 6.0\nuniform samplerCube u_ReflectTexture;uniform vec4 u_ReflectCubeHDRParams;vec3 shEvalLinearL0L1(in vec4 normal){vec3 x;x.r=dot(u_AmbientSHAr,normal);x.g=dot(u_AmbientSHAg,normal);x.b=dot(u_AmbientSHAb,normal);return x;}vec3 shEvalLinearL2(in vec4 normal){vec3 x1,x2;vec4 vB=normal.xyzz*normal.yzzx;x1.r=dot(u_AmbientSHBr,vB);x1.g=dot(u_AmbientSHBg,vB);x1.b=dot(u_AmbientSHBb,vB);float vC=normal.x*normal.x-normal.y*normal.y;x2=u_AmbientSHC.rgb*vC;return x1+x2;}vec3 diffuseIrradiance(in vec3 normalWS){vec4 normal=vec4(-normalWS.x,normalWS.yz,1.0);normal=rotateByYAixs(normal);vec3 ambientContrib=shEvalLinearL0L1(normal);ambientContrib+=shEvalLinearL2(normal);vec3 ambient=max(vec3(0.0),ambientContrib);return ambient*u_AmbientIntensity;}vec3 diffuseIrradiance(in vec3 normalWS,in vec3 positionWS,in vec3 viewDir){\n#ifdef VOLUMETRICGI\nvec3 surfaceBias=VolumetricGISurfaceBias(normalWS,viewDir);return VolumetricGIVolumeIrradiance(positionWS,surfaceBias,normalWS)*u_AmbientIntensity;\n#else\nreturn diffuseIrradiance(normalWS);\n#endif\n}vec3 specularRadiance(in vec3 r,in float perceptualRoughness){float roughness=perceptualRoughness*(1.7-0.7*perceptualRoughness);r*=vec3(-1.0,1.0,1.0);r=rotateByYAixs(r);float lod=roughness*LAYA_SPECCUBE_LOD_STEPS;vec4 rgbm=textureCubeLodEXT(u_ReflectTexture,r,lod);float range=u_ReflectCubeHDRParams.x;vec3 color=decodeRGBM(rgbm,range);color=gammaToLinear(color);return color*u_ReflectionIntensity;}\n#endif\n#ifndef GI_IBL\n#ifndef GI_LEGACYIBL\nvec3 diffuseIrradiance(in vec3 normalWS){return u_AmbientColor.rgb*u_AmbientIntensity;}vec3 diffuseIrradiance(in vec3 normalWS,in vec3 positionWS,in vec3 viewDir){return diffuseIrradiance(normalWS);}vec3 specularRadiance(in vec3 r,in float perceptualRoughness){return u_AmbientColor.rgb*u_ReflectionIntensity;}\n#endif\n#endif\n#ifdef LIGHTMAP\n#ifdef UV1\n#define USELIGHTMAP\n#endif\nuniform sampler2D u_LightMap;\n#ifdef LIGHTMAP_DIRECTIONAL\nuniform sampler2D u_LightMapDirection;vec3 DecodeDirectionalLightmap(in vec2 lightmapUV,in vec3 bakeColor,in vec3 normalWS){vec4 dirLightmap=texture2D(u_LightMapDirection,lightmapUV);vec3 lightdir=normalize(dirLightmap.xyz-vec3(0.5));float halfLambert=clamp(dot(normalWS,lightdir),0.0,1.0)*0.5+0.5;return bakeColor*halfLambert/max(dirLightmap.w,0.001);}\n#endif\nvec3 getBakedLightmapColor(in vec2 lightmapUV,in vec3 normalWS){vec4 lightmapSampler=texture2D(u_LightMap,lightmapUV);lightmapSampler.rgb=decodeRGBM(lightmapSampler,5.0);lightmapSampler=gammaToLinear(lightmapSampler);\n#ifdef LIGHTMAP_DIRECTIONAL\nlightmapSampler.rgb=DecodeDirectionalLightmap(lightmapUV,lightmapSampler.rgb,normalWS);\n#endif\nreturn lightmapSampler.rgb;}\n#endif\n#ifdef SPECCUBE_BOX_PROJECTION\nuniform vec3 u_SpecCubeProbePosition;uniform vec3 u_SpecCubeBoxMax;uniform vec3 u_SpecCubeBoxMin;vec3 getBoxProjectionReflectedVector(vec3 r,vec3 positionWS){vec3 boxCenter=u_SpecCubeProbePosition;vec3 boxMin=u_SpecCubeBoxMin;vec3 boxMax=u_SpecCubeBoxMax;vec3 nr=normalize(r);vec3 rbmax=boxMax-positionWS;vec3 rbmin=boxMin-positionWS;vec3 select=step(vec3(0.0),r);vec3 rbminmax=mix(rbmin,rbmax,select)/nr;float scalar=vecmin(rbminmax);vec3 boxr=nr*scalar+positionWS-boxCenter;return boxr;}\n#endif\n#endif\n'),t.Shader3D.addInclude("Oct.glsl","#if !defined(Oct_lib)\n#define Oct_lib\nfloat signNotZero(in float k){return k>=0.0 ? 1.0 :-1.0;}vec2 signNotZero(in vec2 v){return vec2(signNotZero(v.x),signNotZero(v.y));}vec2 octEncode(in vec3 v){float l1norm=abs(v.x)+abs(v.y)+abs(v.z);vec2 result=v.xy*(1.0/l1norm);if(v.z<0.0){result=(1.0-abs(result.yx))*signNotZero(result.xy);}return result;}vec3 finalDecode(float x,float y){vec3 v=vec3(x,y,1.0-abs(x)-abs(y));if(v.z<0.0){v.xy=(1.0-abs(v.yx))*signNotZero(v.xy);}return normalize(v);}vec2 textureCoordFromDirection(in vec3 dir,vec4 outSize,vec4 gridSize){vec2 uv=(octEncode(normalize(dir)))*0.5+0.5;uv=uv*(outSize.xy-vec2(2.0,2.0))*outSize.zw+outSize.zw;uv=gridSize.xy*(1.0/gridSize.zw)+uv*(1.0/gridSize.zw);return uv;}\n#endif\n"),t.Shader3D.addInclude("GridHelpers.glsl","#if !defined(GridHelpers_lib)\n#define GridHelpers_lib\nint imod(int x,int y){\n#ifdef GRAPHICS_API_GLES3\nreturn x % y;\n#else\nreturn x-(x/y)*y;\n#endif\n}int gridCoordToProbeIndex(in ivec3 probeCoords,const in ivec3 probeCounts){return probeCoords.x+probeCoords.y*probeCounts.x+probeCoords.z*probeCounts.x*probeCounts.y;}ivec3 probeIndexToGridcoord(in int probeIndex,const in ivec3 probeCounts){ivec3 iPos;iPos.x=imod(probeIndex,probeCounts.x);iPos.y=imod(probeIndex,(probeCounts.x*probeCounts.y))/probeCounts.x;iPos.z=probeIndex/(probeCounts.x*probeCounts.y);return iPos;}vec3 gridCoordToPosition(in ivec3 coord,const in vec3 probeStep,const in vec3 probeStartPosition){return(vec3(coord)+0.5)*probeStep+probeStartPosition;}ivec3 baseGridCoord(in vec3 position,in vec3 probeStep,in vec3 probeStartPosition,in ivec3 probeCounts){probeStartPosition+=0.5*probeStep;return ivec3(clamp(vec3((position-probeStartPosition)/probeStep),vec3(0,0,0),vec3(probeCounts)-vec3(1,1,1)));}\n#endif\n"),t.Shader3D.addInclude("VolumetricGI.glsl",'\n#if !defined(VolumetricGI_lib)\n#define VolumetricGI_lib\n#include "Oct.glsl";\n#include "GridHelpers.glsl";\n#ifdef ENUNIFORMBLOCK\nuniform VolumetricGIProbe{vec3 u_VolGIProbeCounts;vec3 u_VolGIProbeStep;vec3 u_VolGIProbeStartPosition;vec4 u_VolGIProbeParams;};uniform sampler2D u_ProbeIrradiance;uniform sampler2D u_ProbeDistance;\n#else\nuniform vec3 u_VolGIProbeCounts;uniform vec3 u_VolGIProbeStep;uniform vec3 u_VolGIProbeStartPosition;uniform vec4 u_VolGIProbeParams;uniform sampler2D u_ProbeIrradiance;uniform sampler2D u_ProbeDistance;\n#endif\nstruct VolumetricGI{vec3 probeCounts;vec3 probeStep;vec3 probeStartPosition;vec4 probeParams;};vec2 porbeGridCoordToTextureGridCoord(in ivec3 porbeGridCoord,in ivec3 probeCounts,in vec2 textureGridSize){int probeIndex=gridCoordToProbeIndex(porbeGridCoord,probeCounts);ivec2 index;index.x=imod(probeIndex,(probeCounts.x*probeCounts.y));index.y=probeIndex/(probeCounts.x*probeCounts.y);vec2 textureGridCoord=vec2(index);textureGridCoord.y=textureGridCoord.y;return textureGridCoord;}vec3 VolumetricGISurfaceBias(in vec3 surfaceNormal,in vec3 cameraDirection){return surfaceNormal*u_VolGIProbeParams.z+cameraDirection*u_VolGIProbeParams.w;}vec3 VolumetricGIVolumeIrradiance(in vec3 worldPosition,in vec3 surfaceBias,in vec3 direction){ivec3 porbeCounts=ivec3(u_VolGIProbeCounts);vec3 probeStep=u_VolGIProbeStep;vec3 probeStartPosition=u_VolGIProbeStartPosition;vec2 volumeCounts=vec2(porbeCounts.x*porbeCounts.y,porbeCounts.z);vec4 irradianceTexels=vec4(u_VolGIProbeParams.x,u_VolGIProbeParams.x,1.0/u_VolGIProbeParams.x,1.0/u_VolGIProbeParams.x);vec4 distanceTexels=vec4(u_VolGIProbeParams.y,u_VolGIProbeParams.y,1.0/u_VolGIProbeParams.y,1.0/u_VolGIProbeParams.y);ivec3 maxGridCoord=porbeCounts-ivec3(1);vec3 irradiance=vec3(0.0);float accumulatedWeights=0.0;vec3 biasedWorldPosition=worldPosition+surfaceBias;ivec3 baseProbeCoords=baseGridCoord(biasedWorldPosition,probeStep,probeStartPosition,porbeCounts);vec3 baseProbeWorldPosition=gridCoordToPosition(baseProbeCoords,probeStep,probeStartPosition);vec3 gridSpaceDistance=biasedWorldPosition-baseProbeWorldPosition;vec3 alpha=clamp(gridSpaceDistance/probeStep,vec3(0.0),vec3(1.0));for(int probeIndex=0;probeIndex<8;probeIndex++){ivec3 adjacentProbeOffset=ivec3(imod(probeIndex,2),imod((probeIndex/2),2),imod((probeIndex/4),2));ivec3 adjacentProbeCoords=ivec3(clamp(vec3(baseProbeCoords+adjacentProbeOffset),vec3(0),vec3(maxGridCoord)));vec3 adjacentProbeWorldPosition=gridCoordToPosition(adjacentProbeCoords,probeStep,probeStartPosition);vec3 worldPosToAdjProbe=normalize(adjacentProbeWorldPosition-worldPosition);vec3 biasedPosToAdjProbe=normalize(adjacentProbeWorldPosition-biasedWorldPosition);float biasedPosToAdjProbeDist=distance(adjacentProbeWorldPosition,biasedWorldPosition);vec3 trilinear=max(vec3(0.001),mix(1.0-alpha,alpha,vec3(adjacentProbeOffset)));float trilinearWeight=trilinear.x*trilinear.y*trilinear.z;float weight=1.0;float warpShading=(dot(worldPosToAdjProbe,direction)+1.0)*0.5;weight*=(warpShading*warpShading)*0.2;vec2 textureGridCoord=porbeGridCoordToTextureGridCoord(adjacentProbeCoords,porbeCounts,volumeCounts);vec2 probeTextureUV=textureCoordFromDirection(-biasedPosToAdjProbe,distanceTexels,vec4(textureGridCoord,volumeCounts));vec3 filteredDistance=texture2D(u_ProbeDistance,probeTextureUV).xyz;float variance=abs(filteredDistance.x*filteredDistance.x-filteredDistance.y);float chebyshevWeight=1.0;if(biasedPosToAdjProbeDist>filteredDistance.x){float v=biasedPosToAdjProbeDist-filteredDistance.x;chebyshevWeight=variance/(variance+(v*v));chebyshevWeight=max(chebyshevWeight*chebyshevWeight*chebyshevWeight,0.0);}if(filteredDistance.z<1.0){chebyshevWeight=1.0;}weight*=max(0.05,chebyshevWeight);weight=max(0.000001,weight);const float crushThreshold=0.2;if(weight<crushThreshold){weight*=(weight*weight)*(1.0/(crushThreshold*crushThreshold));}weight*=trilinearWeight;probeTextureUV=textureCoordFromDirection(direction,irradianceTexels,vec4(textureGridCoord,volumeCounts));vec3 probeIrradiance=linearToGamma(texture2D(u_ProbeIrradiance,probeTextureUV).rgb);irradiance+=(probeIrradiance*weight);accumulatedWeights+=weight;}if(accumulatedWeights==0.0){return vec3(0.0);}irradiance*=(1.0/accumulatedWeights);irradiance=gammaToLinear(irradiance);return irradiance;}\n#endif\n'),t.Shader3D.addInclude("BlinnPhongLighting.glsl",'#if !defined(BlinnPhongLighting_lib)\n#define BlinnPhongLighting_lib\n#include "Lighting.glsl";\n#include "globalIllumination.glsl";\nstruct PixelInfo{vec3 positionWS;vec3 vertexNormalWS;vec3 normalWS;vec3 viewDir;\n#ifdef LIGHTMAP\n#ifdef UV1\nvec2 lightmapUV;\n#endif\n#endif\n};struct Surface{vec3 diffuseColor;vec3 specularColor;float shininess;vec3 gloss;vec3 normalTS;float alpha;float alphaClip;};vec3 BlinnPhongLighting(in Surface surface,in Light light,in PixelInfo pixel){vec3 l=normalize(-light.dir);vec3 v=pixel.viewDir;vec3 normalWS=pixel.normalWS;vec3 diffuseColor=surface.diffuseColor;float shininess=surface.shininess;vec3 specularColor=surface.specularColor;vec3 gloss=surface.gloss;float ndl=max(0.0,dot(normalWS,l));vec3 lightDiffuse=light.color*diffuseColor*ndl;mediump vec3 h=normalize(v+l);lowp float ndh=max(0.0,dot(h,normalWS));float specularIntensity=pow(ndh,shininess*128.0);vec3 lightSpecular=light.color*specularColor*specularIntensity*gloss;return lightDiffuse+lightSpecular;}vec3 BlinnPhongGI(const in Surface surface,const in PixelInfo info){vec3 indirect=vec3(0.0);\n#ifdef LIGHTMAP\n#ifdef UV1\nvec2 lightmapUV=info.lightmapUV;vec3 bakedColor=getBakedLightmapColor(lightmapUV,info.normalWS);indirect=bakedColor*surface.diffuseColor;\n#endif\n#else\nvec3 n=info.normalWS;indirect=diffuseIrradiance(n)*surface.diffuseColor;\n#endif\nreturn indirect;}\n#endif\n'),t.Shader3D.addInclude("PBRLighting.glsl",'#if !defined(PBRLighting_lib)\n#define PBRLighting_lib\n#include "Lighting.glsl";\n#if !defined(GL_FRAGMENT_PRECISION_HIGH)\n#define MIN_PERCEPTUAL_ROUGHNESS 0.089\n#define MIN_ROUGHNESS 0.007921\n#else\n#define MIN_PERCEPTUAL_ROUGHNESS 0.045\n#define MIN_ROUGHNESS 0.002025\n#endif\n#define MIN_N_DOT_V 1e-4\n#include "BRDF.glsl";\nstruct PixelInfo{vec3 positionWS;vec3 vertexNormalWS;vec3 normalWS;vec3 tangentWS;vec3 biNormalWS;vec3 viewDir;float NoV;vec3 dfg;vec3 energyCompensation;\n#ifdef IRIDESCENCE\nvec3 iridescenceFresnel;\n#endif\n#ifdef CLEARCOAT\nvec3 clearCoatNormal;float clearCoatNoV;\n#endif\n#ifdef SHEEN\nfloat sheenScaling;float sheenDfg;\n#endif\n#ifdef ANISOTROPIC\nvec3 anisotropicT;vec3 anisotropicB;float ToV;float BoV;float at;float ab;\n#endif\n#ifdef THICKNESS\nvec4 worldScale;\n#endif\n#ifdef LIGHTMAP\n#ifdef UV1\nvec2 lightmapUV;\n#endif\n#endif\n};struct Surface{vec3 diffuseColor;float alpha;vec3 f0;vec3 f90;float roughness;float perceptualRoughness;float occlusion;\n#ifdef EMISSION\nvec3 emissionColor;\n#endif\nvec3 normalTS;float ior;\n#ifdef CLEARCOAT\nfloat clearCoat;float clearCoatRoughness;float clearCoatPerceptualRoughness;\n#ifdef CLEARCOAT_NORMAL\nvec3 clearCoatNormalTS;\n#endif\n#endif\n#ifdef ANISOTROPIC\nfloat anisotropy;vec2 anisotropyDirection;\n#endif\n#ifdef IRIDESCENCE\nfloat iridescence;float iridescenceIor;float iridescenceThickness;\n#endif\n#ifdef SHEEN\nvec3 sheenColor;float sheenRoughness;float sheenPerceptualRoughness;\n#endif\n#ifdef TRANSMISSION\nfloat transmission;\n#endif\n#ifdef THICKNESS\nfloat thickness;vec3 attenuationColor;float attenuationDistance;\n#endif\n};struct LightParams{vec3 l;vec3 h;float NoL;float NoH;float LoH;float VoH;\n#ifdef CLEARCOAT\nfloat clearCoatNoH;float clearCoatNoL;\n#endif\n#ifdef ANISOTROPIC\nfloat ToL;float BoL;\n#endif\n};void initLightParams(inout LightParams params,const in PixelInfo pixel,const in Light light){vec3 v=pixel.viewDir;vec3 n=pixel.normalWS;vec3 l=normalize(-light.dir);params.l=l;vec3 h=SafeNormalize(v+l);params.h=h;params.NoL=saturate(dot(n,l));params.NoH=saturate(dot(n,h));params.LoH=saturate(dot(l,h));params.VoH=saturate(dot(v,h));\n#ifdef CLEARCOAT\nparams.clearCoatNoL=saturate(dot(pixel.clearCoatNormal,l));params.clearCoatNoH=saturate(dot(pixel.clearCoatNormal,h));\n#endif\n#ifdef ANISOTROPIC\nvec3 t=pixel.anisotropicT;vec3 b=pixel.anisotropicB;params.ToL=dot(t,l);params.BoL=dot(b,l);\n#endif\n}vec3 prefilteredDFG_LUT(float roughness,float NoV){vec2 samplePoint=clamp(vec2(NoV,roughness),vec2(0.0,0.0),vec2(1.0,1.0));samplePoint.y=1.0-samplePoint.y;\n#if defined(FLOATTEXTURE) && defined(FLOATTEXTURE_FIL_LINEAR)\nreturn(texture2D(u_IBLDFG,samplePoint)).rgb;\n#else\nreturn decodeRGBD(texture2D(u_IBLDFG,samplePoint));\n#endif\n}vec2 EnvBRDFApproxLazarov(float roughness,float NoV){vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*NoV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return AB;}float dielectricSpecularToF0(float specular){return 0.08*specular;}float dielectricF0ToIor(float f0){return 2.0/(1.0-sqrt(min(f0,0.99)))-1.0;}float dielectricIorToF0(float ior){return pow2((ior-1.0)/(ior+1.0));}vec3 computeF0(vec3 f0,vec3 baseColor,float metallic){return mix(f0,baseColor,metallic);}vec3 computeF90(vec3 f0){return vec3(saturate(dot(f0,vec3(50.0*0.33))));}vec3 computeDiffuse(vec3 baseColor,float metallic){return(1.0-metallic)*baseColor;}float specularAA(float roughness,in vec3 normalWS){\n#if !defined(GRAPHICS_API_GLES3) && !defined(GL_OES_standard_derivatives)\nreturn roughness;\n#else\nvec3 du=dFdx(normalWS);vec3 dv=dFdy(normalWS);float specularAAVariance=0.15;float specularAAThreshold=0.04;float variance=specularAAVariance*(dot(du,du)+dot(dv,dv));float kernelRoughness=min(2.0*variance,specularAAThreshold);float squareRoughness=saturate(roughness*roughness+kernelRoughness);return sqrt(squareRoughness);\n#endif\n}vec3 diffuseLobe(in Surface surface,const in PixelInfo pixel,const in LightParams lightParams){return surface.diffuseColor*Fd_Lambert();}vec3 specularLobe(const in Surface surface,const in PixelInfo pixel,const in LightParams lightParams){float roughness=surface.roughness;float D=distribution(roughness,lightParams.NoH,lightParams.h,pixel.normalWS);float V=visibility(roughness,pixel.NoV,lightParams.NoL);vec3 F=fresnel(surface.f0,surface.f90,lightParams.LoH);return(D*V)*F;}\n#ifdef IRIDESCENCE\nvec3 iridescenceDiffuseLobe(in Surface surface,const in PixelInfo pixel,const in LightParams lightParams){vec3 f0=surface.f0;vec3 f90=vec3(1.0);vec3 iridescenceFresnel=pixel.iridescenceFresnel;float iridescence=surface.iridescence;float VoH=lightParams.VoH;return surface.diffuseColor*Fd_IridescenceLambert(f0,f90,iridescenceFresnel,iridescence,VoH);}vec3 iridescenceSpecularLobe(const in Surface surface,const in PixelInfo pixel,const in LightParams lightParams){float roughness=surface.roughness;float D=distribution(roughness,lightParams.NoH,lightParams.h,pixel.normalWS);float V=visibility(roughness,pixel.NoV,lightParams.NoL);float iridescenceFactor=surface.iridescence;vec3 iridescenceFresnel=pixel.iridescenceFresnel;vec3 F=mix(fresnel(surface.f0,lightParams.LoH),iridescenceFresnel,vec3(iridescenceFactor));return(D*V)*F;}\n#endif\n#ifdef CLEARCOAT\nfloat clearCoatLobe(const in Surface surface,const in PixelInfo pixel,const in LightParams lightParams){float roughness=surface.clearCoatRoughness;float clearCoat=surface.clearCoat;vec3 n=pixel.clearCoatNormal;vec3 h=lightParams.h;float LoH=lightParams.LoH;float clearCoatNoH=lightParams.clearCoatNoH;float D=distribution(roughness,clearCoatNoH,h,n);float V=V_kelemen(LoH);return D*V;}\n#endif\n#ifdef SHEEN\nvec3 sheenLobe(const in Surface surface,const in PixelInfo pixel,const in LightParams lightParams){float roughness=surface.sheenRoughness;float NoV=pixel.NoV;float NoH=lightParams.NoH;float NoL=lightParams.NoL;float D=D_Charlie(roughness,NoH);float V=V_Neubelt(NoV,NoL);return D*V*surface.sheenColor;}\n#endif\n#ifdef ANISOTROPIC\nvec3 anisotropyLobe(const in Surface surface,const in PixelInfo pixel,const in LightParams lightParams){float anisotropy=surface.anisotropy;float at=pixel.at;float ab=pixel.ab;vec3 anisotropicT=pixel.anisotropicT;vec3 anisotropicB=pixel.anisotropicB;float NoV=pixel.NoV;float ToV=pixel.ToV;float BoV=pixel.BoV;vec3 h=lightParams.h;float NoL=lightParams.NoL;float NoH=lightParams.NoH;float VoH=lightParams.VoH;float ToL=lightParams.ToL;float BoL=lightParams.BoL;float V=V_SmithGGXCorrelated_Anisotropic(at,ab,ToV,BoV,ToL,BoL,NoV,NoL);float D=D_GGX_Anisotropic(NoH,h,anisotropicT,anisotropicB,at,ab);vec3 F=fresnel(surface.f0,surface.f90,lightParams.LoH);return V*D*F;}\n#endif\nvec3 PBRLighting(const in Surface surface,const in PixelInfo pixel,const in Light light){LightParams lightParams;initLightParams(lightParams,pixel,light);float NoL=lightParams.NoL;\n#ifdef IRIDESCENCE\nvec3 Fd=iridescenceDiffuseLobe(surface,pixel,lightParams);vec3 Fr=iridescenceSpecularLobe(surface,pixel,lightParams);\n#elif defined(ANISOTROPIC)\nvec3 Fd=diffuseLobe(surface,pixel,lightParams);vec3 Fr=anisotropyLobe(surface,pixel,lightParams);\n#else\nvec3 Fd=diffuseLobe(surface,pixel,lightParams);vec3 Fr=specularLobe(surface,pixel,lightParams);\n#endif\n#ifdef TRANSMISSION\nFd*=1.0-surface.transmission;\n#endif\nvec3 shading=(Fd+Fr*pixel.energyCompensation);\n#ifdef SHEEN\nvec3 fSheen=sheenLobe(surface,pixel,lightParams);shading*=pixel.sheenScaling;shading+=fSheen;\n#endif\n#ifdef CLEARCOAT\nfloat clearCoatNoL=lightParams.clearCoatNoL;float LoH=lightParams.LoH;float FccClearCoat=F_Schlick(0.04,1.0,LoH)*surface.clearCoat;float attenuation=1.0-FccClearCoat;shading*=attenuation*NoL;float clearcoat=clearCoatLobe(surface,pixel,lightParams)*FccClearCoat;shading+=clearcoat*clearCoatNoL;NoL=1.0;\n#endif\nreturn shading*light.color*NoL;}\n#include "PBRGI.glsl";\n#endif\n'),_.init(),rr.init(),nr.init(),or.init(),sr.init(),lr.init(),hr.init(),Er.init(),t.Shader3D.SHADERDEFINE_LEGACYSINGALLIGHTING=t.Shader3D.getDefineByName("LEGACYSINGLELIGHTING"),t.Shader3D.SHADERDEFINE_ENUNIFORMBLOCK=t.Shader3D.getDefineByName("ENUNIFORMBLOCK"),t.Shader3D.SHADERDEFINE_FLOATTEXTURE=t.Shader3D.getDefineByName("FLOATTEXTURE"),t.Shader3D.SHADERDEFINE_FLOATTEXTURE_FIL_LINEAR=t.Shader3D.getDefineByName("FLOATTEXTURE_FIL_LINEAR"),t.Shader3D.SHADERDEFINE_BLITSCREEN_INVERTY=t.Shader3D.getDefineByName("BLITSCREEN_INVERTY"),t.Shader3D.SHADERDEFINE_REMAP_POSITIONZ=t.Shader3D.getDefineByName("REMAP_Z"),t.Shader3D.SHADERDEFINE_LOD_TEXTURE_SAMPLE=t.Shader3D.getDefineByName("LOD_TEXTURE_SAMPLE")}}class Tr{}class Ar extends H{setSkinData(e){this._renderElementOBJ.skinnedData=e}constructor(){super()}_createRenderElementOBJ(){this._renderElementOBJ=E.Render3DPassFactory.createSkinRenderElement()}_render(e){}}class xr extends k{static __init__(){Tr.SHADERDEFINE_BONE=t.Shader3D.getDefineByName("BONE"),Tr.SHADERDEFINE_SIMPLEBONE=t.Shader3D.getDefineByName("SIMPLEBONE");const r=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("SkinSprite3D");xr.BONES=t.Shader3D.propertyNameToID("u_Bones"),r.addShaderUniform(xr.BONES,"u_Bones",e.ShaderDataType.Buffer)}get _bones(){return this.__bones}set _bones(e){this.__bones=e,this._isISkinRenderNode()&&this._ownerSkinRenderNode.setBones(e)}get localBounds(){return this._localBounds}set localBounds(e){this._localBounds=e,this.geometryBounds=this._localBounds}get rootBone(){return this._cacheRootBone}set rootBone(e){if(this._cacheRootBone!=e){this._cacheRootBone?this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this.owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),e?(e.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._baseRenderNode.transform=e.transform):(this.owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._baseRenderNode.transform=this.owner.transform),this._cacheRootBone=e,this._onWorldMatNeedChange(fe.TRANSFORM_WORLDPOSITION|fe.TRANSFORM_WORLDQUATERNION|fe.TRANSFORM_WORLDSCALE);let a=this._renderElements.length;for(var r=0;r<a;r++){this._renderElements[r].setTransform(e.transform)}this._isISkinRenderNode()&&this._ownerSkinRenderNode.setRootBoneTransfom(this._cacheRootBone)}this._baseRenderNode.transform=this.rootBone?this.rootBone.transform:this.owner.transform}get bones(){return this._bones}set bones(e){this._bones=e}constructor(){super(),this.__bones=[],this._worldParams=new t.Vector4,this.localBounds=new w(t.Vector3.ZERO,t.Vector3.ZERO),this._baseRenderNode.shaderData.addDefine(Tr.SHADERDEFINE_BONE),this._baseRenderNode.renderNodeType=e.BaseRenderType.SkinnedMeshRender}_createBaseRenderNode(){return this._ownerSkinRenderNode=E.Render3DModuleDataFactory.createSkinRenderNode(),this._ownerSkinRenderNode}_getcommonUniformMap(){return["Sprite3D","SkinSprite3D"]}_needRender(e,r){return!!t.Stat.enableSkin&&super._needRender(e,r)}_createRenderElement(){return new Ar}_isISkinRenderNode(){return this._ownerSkinRenderNode.setCacheMesh}_onSkinMeshChange(e){if(e&&this._mesh!=e){this._changeVertexDefine(e),this._changeMorphData(e),this._mesh=e,this._isISkinRenderNode()&&this._ownerSkinRenderNode.setCacheMesh(e);var t=e.subMeshCount;this._renderElements.length=t;let a=this.sharedMaterials;a.length=t;for(var r=0;r<t;r++){let t=this._renderElements[r];t||(t=this._renderElements[r]=this._createRenderElement(),this._cacheRootBone?t.setTransform(this._cacheRootBone.transform):t.setTransform(this.owner._transform),t.render=this),a[r]=a[r]||i.defaultMaterial,t.setGeometry(e.getSubMesh(r))}this.sharedMaterials=a,this.boundsChange=!0}else e||(this._renderElements.length=0,this._mesh=null,this._changeVertexDefine(null),this._changeMorphData(null),this.boundsChange=!1);this._meshChange=!0}_onMeshChange(e){if(this._onSkinMeshChange(e),this._setRenderElements(),e){this._cacheMesh=e;var t=e.subMeshCount;this._skinnedData=[];for(var r=0;r<t;r++){for(var a=e.getSubMesh(r)._boneIndicesList,i=a.length,n=this._skinnedData[r]=[],s=0;s<i;s++)n[s]=new Float32Array(16*a[s].length);this._renderElements[r].setSkinData(n)}this._isISkinRenderNode()&&this._ownerSkinRenderNode.setSkinnedData(this._skinnedData)}}_setBelongScene(e){super._setBelongScene(e),this._isISkinRenderNode()&&this._ownerSkinRenderNode.setOwnerTransform(this.owner)}_setUnBelongScene(){super._setUnBelongScene()}_statAdd(){t.Stat.renderNode++,t.Stat.skinRenderNode++}_statRemove(){t.Stat.renderNode--,t.Stat.skinRenderNode--}renderUpdate(e){super.renderUpdate(e),this._isISkinRenderNode()&&this._ownerSkinRenderNode.computeSkinnedData()}_cloneTo(e){let t=(e,t,r)=>{let a=((e,t)=>{let r=[],a=e;for(;a;)a instanceof x&&r.push(a),a=a.parent;let i=t;for(;i&&-1==r.indexOf(i);)i=i.parent;return i})(e,t);if(!a)return null;let i=[];K._getHierarchyPath(a,e,i);let n=[];K._getHierarchyPath(a,t,n);let s=K._getParentNodeByHierarchyPath(r,i);return s?K._getNodeByHierarchyPath(s,n):null};var r=this.rootBone;if(r){let a=t(this.owner,this.rootBone,e.owner);e.rootBone=a||r}var a=this.bones,i=e.bones;let n=i.length=a.length;for(var s=0;s<n;s++){let r=a[s];i[s]=t(this.owner,r,e.owner)}e.bones=e.bones;var o=this.localBounds;o&&o.cloneTo(e.localBounds),e.localBounds&&(e.localBounds=e.localBounds),super._cloneTo(e)}_onDestroy(){this._cacheRootBone?!this._cacheRootBone._destroyed&&this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this.owner&&!this.owner._destroyed&&this.owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),super._onDestroy()}}class Rr extends xr{get simpleAnimatorTexture(){return this._simpleAnimatorTexture}set simpleAnimatorTexture(e){this._simpleAnimatorTexture=e,this._simpleAnimatorTextureSize=e.width,this._baseRenderNode.shaderData.setTexture(Mr.SIMPLE_SIMPLEANIMATORTEXTURE,e),this._baseRenderNode.shaderData.setNumber(Mr.SIMPLE_SIMPLEANIMATORTEXTURESIZE,this._simpleAnimatorTextureSize)}get simpleAnimatorOffset(){return this._simpleAnimatorOffset}set simpleAnimatorOffset(e){e.cloneTo(this._simpleAnimatorOffset)}_isISkinRenderNode(){return null}constructor(){super(),this._simpleAnimatorParams=new t.Vector4,this._simpleAnimatorOffset=new t.Vector2,this._baseRenderNode.shaderData.addDefine(Tr.SHADERDEFINE_SIMPLEBONE),this._baseRenderNode.shaderData.addDefine(Tr.SHADERDEFINE_BONE),this._baseRenderNode.renderNodeType=e.BaseRenderType.SimpleSkinRender,this._baseRenderNode.shaderData.setVector(Mr.SIMPLE_SIMPLEANIMATORPARAMS,new t.Vector4)}_createBaseRenderNode(){return this._ownerSimpleRenderNode=E.Render3DModuleDataFactory.createSimpleSkinRenderNode(),this._ownerSimpleRenderNode}_getcommonUniformMap(){return["Sprite3D","SimpleSkinnedMesh"]}_computeSkinnedData(){this._computeAnimatorParamsData()}renderUpdate(e){super.renderUpdate(e),this._computeSkinnedData()}_createRenderElement(){return new G}_computeAnimatorParamsData(){this._cacheMesh&&(this._simpleAnimatorParams.x=this._simpleAnimatorOffset.x,this._simpleAnimatorParams.y=Math.round(this._simpleAnimatorOffset.y)*this._bonesNums*4,this._ownerSimpleRenderNode.setSimpleAnimatorParams(this._simpleAnimatorParams))}setCustomData(e,t=0){this._simpleAnimatorParams.z=e,this._simpleAnimatorParams.w=t,this._ownerSimpleRenderNode.setSimpleAnimatorParams(this._simpleAnimatorParams)}_onMeshChange(e){this._onSkinMeshChange(e),e&&(this._cacheMesh=e,this._setRenderElements())}_cloneTo(e){e.simpleAnimatorOffset=this.simpleAnimatorOffset,e.simpleAnimatorTexture=this.simpleAnimatorTexture,e._bonesNums=this._bonesNums,super._cloneTo(e)}_onDestroy(){this._cacheRootBone&&!this._cacheRootBone._destroyed&&this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._simpleAnimatorTexture=null,super._onDestroy()}}class Mr extends B{static __init__(){Mr.SIMPLE_SIMPLEANIMATORTEXTURE=t.Shader3D.propertyNameToID("u_SimpleAnimatorTexture"),Mr.SIMPLE_SIMPLEANIMATORPARAMS=t.Shader3D.propertyNameToID("u_SimpleAnimatorParams"),Mr.SIMPLE_SIMPLEANIMATORTEXTURESIZE=t.Shader3D.propertyNameToID("u_SimpleAnimatorTextureSize");const r=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("SimpleSkinnedMesh");r.addShaderUniform(Mr.SIMPLE_SIMPLEANIMATORTEXTURE,"u_SimpleAnimatorTexture",e.ShaderDataType.Texture2D),r.addShaderUniform(Mr.SIMPLE_SIMPLEANIMATORPARAMS,"u_SimpleAnimatorParams",e.ShaderDataType.Vector4),r.addShaderUniform(Mr.SIMPLE_SIMPLEANIMATORTEXTURESIZE,"u_SimpleAnimatorTextureSize",e.ShaderDataType.Float)}get meshFilter(){return this._meshFilter}get simpleSkinnedMeshRenderer(){return this._render}constructor(e=null,t=null){super(t),this._meshFilter=this.addComponent(A),this._render=this.addComponent(Rr),e&&(this._meshFilter.sharedMesh=e)}destroy(e=!0){this._destroyed||(super.destroy(e),this._meshFilter.destroy())}}Mr._tempArray0=[];class Cr extends t.Material{static __init__(){Cr.TINTCOLOR=t.Shader3D.propertyNameToID("u_TintColor"),Cr.EXPOSURE=t.Shader3D.propertyNameToID("u_Exposure"),Cr.ROTATION=t.Shader3D.propertyNameToID("u_Rotation"),Cr.TEXTURE=t.Shader3D.propertyNameToID("u_Texture"),Cr.TEXTURE_HDR_PARAMS=t.Shader3D.propertyNameToID("u_Texture_HDR_params")}get tintColor(){return this.getColorByIndex(Cr.TINTCOLOR)}set tintColor(e){this.setColorByIndex(Cr.TINTCOLOR,e)}get exposure(){return this.getFloatByIndex(Cr.EXPOSURE)}set exposure(e){this.setFloatByIndex(Cr.EXPOSURE,e)}get rotation(){return this.getFloatByIndex(Cr.ROTATION)}set rotation(e){this.setFloatByIndex(Cr.ROTATION,e)}get panoramicTexture(){return this.getTextureByIndex(Cr.TEXTURE)}set panoramicTexture(e){this.setTextureByIndex(Cr.TEXTURE,e)}constructor(){super(),this._textureHDRParams=new t.Vector4(1,0,0,1),this.setShaderName("SkyPanoramic"),this.setColorByIndex(Cr.TINTCOLOR,new t.Color(.5,.5,.5,.5)),this.setFloatByIndex(Cr.ROTATION,0),this.setVector4ByIndex(Cr.TEXTURE_HDR_PARAMS,this._textureHDRParams),this.exposure=1.3}}class Ir extends t.Material{static __initDefine__(){Ir.COLOR=t.Shader3D.propertyNameToID("u_Color")}get color(){return this._shaderValues.getVector(Ir.COLOR)}set color(e){this._shaderValues.setVector(Ir.COLOR,e)}constructor(){super(),this.setShaderName("LineShader"),this._shaderValues.setVector(Ir.COLOR,new t.Vector4(1,1,1,1))}clone(){var e=new Ir;return this.cloneTo(e),e}}e.EPhysicsStatisticsInfo=void 0,(dr=e.EPhysicsStatisticsInfo||(e.EPhysicsStatisticsInfo={}))[dr.C_PhysicsEventCount=0]="C_PhysicsEventCount",dr[dr.FrameClearCount=1]="FrameClearCount",dr[dr.C_PhysicaDynamicRigidBody=2]="C_PhysicaDynamicRigidBody",dr[dr.C_PhysicaStaticRigidBody=3]="C_PhysicaStaticRigidBody",dr[dr.C_PhysicaKinematicRigidBody=4]="C_PhysicaKinematicRigidBody",dr[dr.C_PhysicaCharacterController=5]="C_PhysicaCharacterController",dr[dr.C_PhysicsJoint=6]="C_PhysicsJoint",dr[dr.Count=7]="Count";class vr{static initStatisticsInfo(){for(let t=0;t<e.EPhysicsStatisticsInfo.Count;t++)this._PhysicsStatisticsInfo.set(t,0);vr.enableStatistics&&vr.autoFrameClear&&t.ILaya.timer.frameLoop(1,null,vr.clearStatisticsInfo)}static addStatisticsInfo(e,t){vr.enableStatistics&&vr._PhysicsStatisticsInfo.set(e,vr._PhysicsStatisticsInfo.get(e)+t)}static getStatisticsInfo(e){let t=0;return vr.enableStatistics&&(t=vr._PhysicsStatisticsInfo.get(e)),t}static clearStatisticsInfo(){if(vr.enableStatistics)for(let t=0;t<e.EPhysicsStatisticsInfo.FrameClearCount;t++)vr._PhysicsStatisticsInfo.set(t,0)}static stopAndClearAllStatisticsInfo(){for(let t=0;t<e.EPhysicsStatisticsInfo.Count;t++)this._PhysicsStatisticsInfo.set(t,0);vr.enableStatistics&&vr.autoFrameClear&&t.ILaya.timer.clear(null,vr.clearStatisticsInfo)}}vr._PhysicsStatisticsInfo=new Map,vr.enableStatistics=!1,vr.autoFrameClear=!1;class yr{constructor(){this.source=null,this.indirectTarget=null,this.destination=null,this.camera=null,this.compositeShaderData=null,this.command=null,this.deferredReleaseTextures=[]}createRTByContextReleaseTexture(e,t,r,a,i=!1,n=1,s=!1,o=!1){let l=this.deferredReleaseTextures.length;for(let h=0;h<l;h++){let d=this.deferredReleaseTextures[h];if(d.width==e&&d.height==t&&d.colorFormat==r&&d.depthStencilFormat==a&&d._generateMipmap==i&&d.multiSamples==n&&d.generateDepthTexture==s&&d._gammaSpace==o){d._inPool=!1;let e=this.deferredReleaseTextures[l-1];return this.deferredReleaseTextures[h]=e,this.deferredReleaseTextures.length-=1,d}}return null}}class Br{static __init__(){Br.SHADERDEFINE_BLOOM_LOW=t.Shader3D.getDefineByName("BLOOM_LOW"),Br.SHADERDEFINE_BLOOM=t.Shader3D.getDefineByName("BLOOM"),Br.SHADERDEFINE_FINALPASS=t.Shader3D.getDefineByName("FINALPASS"),Br.SHADERVALUE_MAINTEX=t.Shader3D.propertyNameToID("u_MainTex"),Br.SHADERVALUE_BLOOMTEX=t.Shader3D.propertyNameToID("u_BloomTex"),Br.SHADERVALUE_AUTOEXPOSURETEX=t.Shader3D.propertyNameToID("u_AutoExposureTex"),Br.SHADERVALUE_BLOOM_DIRTTEX=t.Shader3D.propertyNameToID("u_Bloom_DirtTex"),Br.SHADERVALUE_BLOOMTEX_TEXELSIZE=t.Shader3D.propertyNameToID("u_BloomTex_TexelSize"),Br.SHADERVALUE_BLOOM_DIRTTILEOFFSET=t.Shader3D.propertyNameToID("u_Bloom_DirtTileOffset"),Br.SHADERVALUE_BLOOM_SETTINGS=t.Shader3D.propertyNameToID("u_Bloom_Settings"),Br.SHADERVALUE_BLOOM_COLOR=t.Shader3D.propertyNameToID("u_Bloom_Color")}recaculateCameraFlag(){this._depthtextureFlag=t.DepthTextureMode.None;let e=this.effects.length;for(let t=0;t<e;t++)this._depthtextureFlag|=this.effects[t].getCameraDepthTextureModeFlag()}constructor(){this._compositeShader=t.Shader3D.find("PostProcessComposite"),this._compositeShaderData=t.LayaGL.renderDeviceFactory.createShaderData(null),this._effects=[],this._enable=!0,this._enableColorGrad=!1,this._context=new yr,this._context.compositeShaderData=this._compositeShaderData,this._context.command=new Ft,this._depthtextureFlag=0}get enable(){return this._enable}set enable(e){this._enable=e}set commandContext(e){this._context.command._context=e}get effects(){return this._effects}set effects(e){this.clearEffect();for(var t=0,r=e.length;t<r;t++)e[t]&&this.addEffect(e[t])}get cameraDepthTextureMode(){return this._depthtextureFlag}_init(e){this._context.camera=e,this._context.command._camera=e}_render(e){this._init(e);let r=this._context;var a=(e=r.camera).viewport,i=e._needInternalRenderTexture(),n=i?e._internalRenderTexture:t.RenderTexture.createFromPool(e._offScreenRenderTexture.width,e._offScreenRenderTexture.height,e._getRenderTextureFormat(),t.RenderTargetFormat.None,!1,1,!1,!0),s=t.RenderTexture.createFromPool(n.width,n.height,e._getRenderTextureFormat(),t.RenderTargetFormat.None,!1,1,!1,!0),o=[t.RenderTexture.createFromPool(n.width,n.height,e._getRenderTextureFormat(),t.RenderTargetFormat.None,!1,1,!1,!0),t.RenderTexture.createFromPool(n.width,n.height,e._getRenderTextureFormat(),t.RenderTargetFormat.None,!1,1,!1,!0)];r.command.clear(),r.source=s,r.indirectTarget=s,r.destination=2==this._effects.length?o[0]:n,r.compositeShaderData.clearDefine(),i?r.command.blitScreenTriangle(e._internalRenderTexture,s):r.command.blitScreenTriangle(e._offScreenRenderTexture,s),r.compositeShaderData.setTexture(Br.SHADERVALUE_AUTOEXPOSURETEX,t.Texture2D.whiteTexture),this._enableColorGrad&&this._ColorGradEffect._buildLUT();for(var l=0,h=this._effects.length;l<h;l++)this._effects[l].active?(this._effects[l].render(r),l==h-2?(r.indirectTarget=r.destination,r.destination=n):(r.indirectTarget=r.destination,r.destination=o[(l+1)%2])):l==h-1&&r.command.blitScreenTriangle(r.indirectTarget,n);if(this._compositeShaderData.addDefine(Br.SHADERDEFINE_FINALPASS),e._offScreenRenderTexture&&i){r.destination=e._offScreenRenderTexture;var d=e._getCanvasWidth(),c=e._getCanvasHeight();t.LayaGL.renderEngine._screenInvertY?e._screenOffsetScale.setValue(a.x/d,a.y/c,a.width/d,a.height/c):e._screenOffsetScale.setValue(a.x/d,1-a.y/c,a.width/d,-a.height/c),r.command.blitScreenTriangle(n,e._offScreenRenderTexture,e._screenOffsetScale,null,this._compositeShaderData,0)}i&&t.RenderTexture.recoverToPool(n),t.RenderTexture.recoverToPool(s),t.RenderTexture.recoverToPool(o[0]),t.RenderTexture.recoverToPool(o[1]);var u=r.deferredReleaseTextures;for(l=0,h=u.length;l<h;l++)t.RenderTexture.recoverToPool(u[l]);u.length=0}addEffect(e){e.singleton&&this.getEffect(e.constructor)?console.error("无法增加已经存在的Effect"):(!this._enableColorGrad||e instanceof t.ColorGradEffect?this._effects.push(e):this._effects.splice(this._effects.length-1,0,e),this.recaculateCameraFlag(),e.effectInit(this))}getEffect(e){let t=this._effects.length;for(let r=0;r<t;r++){let t=this._effects[r];if(t instanceof e)return t}return null}removeEffect(e){var t=this._effects.indexOf(e);-1!==t&&(this._effects.splice(t,1),e.release(this),this.recaculateCameraFlag())}clearEffect(){let e=this.effects.length-1;for(;e>=0;e--)this.removeEffect(this.effects[e]);this._effects.length=0}_applyPostProcessCommandBuffers(){this._context.command._apply()}}class wr{static get PhysicsCreateUtil(){return this._PhysicsCreateUtil}static set PhysicsCreateUtil(e){e&&!wr._PhysicsCreateUtil&&(wr._PhysicsCreateUtil=e,wr._enablePhysics=!0)}static get enablePhysics(){return wr._enablePhysics}static _changeWebGLSize(e,t){Y.clientWidth=e,Y.clientHeight=t}static __init__(){t.Config3D._multiLighting=t.Config3D.enableMultiLight&&t.LayaGL.renderEngine.getCapable(t.RenderCapable.TextureFormat_R32G32B32A32),t.Config3D.maxLightCount>2048&&(t.Config3D.maxLightCount=2048,console.warn("Config3D: maxLightCount must less equal 2048."));let e=t.Config3D.lightClusterCount;(e.x>128||e.y>128||e.z>128)&&(e.setValue(Math.min(e.x,128),Math.min(e.y,128),Math.min(e.z,128)),console.warn("Config3D: lightClusterCount X and Y、Z must less equal 128."));let a=4*Math.floor(2048/t.Config3D.lightClusterCount.z-1);a<t.Config3D.maxLightCount&&console.warn("Config3D: if the area light(PointLight、SpotLight) count is large than "+a+",maybe the far away culster will ingonre some light."),t.Config3D._maxAreaLightCountPerClusterAverage=Math.min(a,t.Config3D.maxLightCount),r.Scene3D=Qt,r.Laya3D=wr,Me.__init__(),W.__init__(),Yt.__init__(),Dr.__init__(),f.__init__(),g.__init__(),Cr.__init__(),$t.__init__(),x.__init__(),B.__init__(),z.__init__(),xr.__init__(),pt.__init__(),Mr.__init__(),Br.__init__(),Qt.__init__(),mt.__init__(),we.__init__(),U.__init__(),k.__init__(),Ie.__init__(),Vt.__init__(),ht.init(),Y.__init__(),i.__initDefine__(),p.__initDefine__(),S.__initDefine__(),m.__initDefine__(),Q.__init__(),Ht.__init__(),i.defaultMaterial=new i,i.defaultMaterial.lock=!0,S.defaultMaterial=new S,S.defaultMaterial.lock=!0;let n=new S;n.lock=!0,n.enableVertexColor=!0,Ir.defaultMaterial=n,Re.__init__(),Ce.__init__(),Rt.__init__()}static __initPhysics__(){return wr._PhysicsCreateUtil?(wr._enablePhysics=!0,vr.initStatisticsInfo(),t.PlayerConfig.physics3D&&Object.assign(Qt.physicsSettings,t.PlayerConfig.physics3D),wr._PhysicsCreateUtil.initialize()):(wr._enablePhysics=!1,Promise.resolve())}}wr._enablePhysics=!1,window.Laya3D=wr,t.Laya.addInitCallback((()=>wr.__initPhysics__())),e.D6MotionType=void 0,(cr=e.D6MotionType||(e.D6MotionType={}))[cr.eX=0]="eX",cr[cr.eY=1]="eY",cr[cr.eZ=2]="eZ",cr[cr.eTWIST=3]="eTWIST",cr[cr.eSWING1=4]="eSWING1",cr[cr.eSWING2=5]="eSWING2",e.D6Axis=void 0,(ur=e.D6Axis||(e.D6Axis={}))[ur.eLOCKED=0]="eLOCKED",ur[ur.eLIMITED=1]="eLIMITED",ur[ur.eFREE=2]="eFREE",e.D6Drive=void 0,(_r=e.D6Drive||(e.D6Drive={}))[_r.eX=0]="eX",_r[_r.eY=1]="eY",_r[_r.eZ=2]="eZ",_r[_r.eSWING=3]="eSWING",_r[_r.eTWIST=4]="eTWIST",_r[_r.eSLERP=5]="eSLERP",e.ECharacterCapable=void 0,(fr=e.ECharacterCapable||(e.ECharacterCapable={}))[fr.Charcater_Gravity=0]="Charcater_Gravity",fr[fr.Charcater_CollisionGroup=1]="Charcater_CollisionGroup",fr[fr.Charcater_WorldPosition=2]="Charcater_WorldPosition",fr[fr.Charcater_Move=3]="Charcater_Move",fr[fr.Charcater_Jump=4]="Charcater_Jump",fr[fr.Charcater_StepOffset=5]="Charcater_StepOffset",fr[fr.Character_UpDirection=6]="Character_UpDirection",fr[fr.Character_FallSpeed=7]="Character_FallSpeed",fr[fr.Character_SlopeLimit=8]="Character_SlopeLimit",fr[fr.Character_PushForce=9]="Character_PushForce",fr[fr.Character_Radius=10]="Character_Radius",fr[fr.Character_Height=11]="Character_Height",fr[fr.Character_offset=12]="Character_offset",fr[fr.Character_Skin=13]="Character_Skin",fr[fr.Character_minDistance=14]="Character_minDistance",fr[fr.Character_EventFilter=15]="Character_EventFilter",fr[fr.Character_SimulateGravity=16]="Character_SimulateGravity",e.EColliderCapable=void 0,(gr=e.EColliderCapable||(e.EColliderCapable={}))[gr.Collider_CollisionGroup=0]="Collider_CollisionGroup",gr[gr.Collider_Friction=1]="Collider_Friction",gr[gr.Collider_RollingFriction=2]="Collider_RollingFriction",gr[gr.Collider_Restitution=3]="Collider_Restitution",gr[gr.Collider_AllowTrigger=4]="Collider_AllowTrigger",gr[gr.Collider_DynamicFriction=5]="Collider_DynamicFriction",gr[gr.Collider_StaticFriction=6]="Collider_StaticFriction",gr[gr.Collider_BounceCombine=7]="Collider_BounceCombine",gr[gr.Collider_FrictionCombine=8]="Collider_FrictionCombine",gr[gr.Collider_EventFilter=9]="Collider_EventFilter",gr[gr.Collider_CollisionDetectionMode=10]="Collider_CollisionDetectionMode",gr[gr.RigidBody_CanKinematic=11]="RigidBody_CanKinematic",gr[gr.RigidBody_AllowSleep=12]="RigidBody_AllowSleep",gr[gr.RigidBody_Gravity=13]="RigidBody_Gravity",gr[gr.RigidBody_LinearDamp=14]="RigidBody_LinearDamp",gr[gr.RigidBody_AngularDamp=15]="RigidBody_AngularDamp",gr[gr.RigidBody_LinearVelocity=16]="RigidBody_LinearVelocity",gr[gr.RigidBody_AngularVelocity=17]="RigidBody_AngularVelocity",gr[gr.RigidBody_Mass=18]="RigidBody_Mass",gr[gr.RigidBody_WorldPosition=19]="RigidBody_WorldPosition",gr[gr.RigidBody_WorldOrientation=20]="RigidBody_WorldOrientation",gr[gr.RigidBody_InertiaTensor=21]="RigidBody_InertiaTensor",gr[gr.RigidBody_MassCenter=22]="RigidBody_MassCenter",gr[gr.RigidBody_MaxAngularVelocity=23]="RigidBody_MaxAngularVelocity",gr[gr.RigidBody_MaxDepenetrationVelocity=24]="RigidBody_MaxDepenetrationVelocity",gr[gr.RigidBody_SleepThreshold=25]="RigidBody_SleepThreshold",gr[gr.RigidBody_SleepAngularVelocity=26]="RigidBody_SleepAngularVelocity",gr[gr.RigidBody_SolverIterations=27]="RigidBody_SolverIterations",gr[gr.RigidBody_AllowDetectionMode=28]="RigidBody_AllowDetectionMode",gr[gr.RigidBody_AllowKinematic=29]="RigidBody_AllowKinematic",gr[gr.RigidBody_AllowCharacter=30]="RigidBody_AllowCharacter",gr[gr.RigidBody_LinearFactor=31]="RigidBody_LinearFactor",gr[gr.RigidBody_AngularFactor=32]="RigidBody_AngularFactor",gr[gr.RigidBody_ApplyForce=33]="RigidBody_ApplyForce",gr[gr.RigidBody_ClearForce=34]="RigidBody_ClearForce",gr[gr.RigidBody_ApplyForceWithOffset=35]="RigidBody_ApplyForceWithOffset",gr[gr.RigidBody_ApplyTorque=36]="RigidBody_ApplyTorque",gr[gr.RigidBody_ApplyImpulse=37]="RigidBody_ApplyImpulse",gr[gr.RigidBody_ApplyTorqueImpulse=38]="RigidBody_ApplyTorqueImpulse",e.EJointCapable=void 0,(mr=e.EJointCapable||(e.EJointCapable={}))[mr.Joint_Anchor=0]="Joint_Anchor",mr[mr.Joint_ConnectAnchor=1]="Joint_ConnectAnchor";class Lr{get indexType(){return this._indexType}get indexTypeByteCount(){return this._indexTypeByteCount}get indexCount(){return this._indexCount}get canRead(){return this._canRead}constructor(e,r,a=t.BufferUsage.Static,i=!1){switch(this._indexType=t.IndexFormat.UInt16,this._deviceBuffer=t.LayaGL.renderDeviceFactory.createIndexBuffer(a),this._deviceBuffer.indexType=this._indexType=e,this._deviceBuffer.indexCount=this._indexCount=r,this._canRead=i,this.bufferUsage=a,e){case t.IndexFormat.UInt32:this._indexTypeByteCount=4;break;case t.IndexFormat.UInt16:this._indexTypeByteCount=2;break;case t.IndexFormat.UInt8:this._indexTypeByteCount=1;break;default:throw new Error("unknown index type: "+e)}var n=this._indexTypeByteCount*r;if(this._byteLength=n,this._deviceBuffer._setIndexDataLength(n),i)switch(e){case t.IndexFormat.UInt32:this._buffer=new Uint32Array(r);break;case t.IndexFormat.UInt16:this._buffer=new Uint16Array(r);break;case t.IndexFormat.UInt8:this._buffer=new Uint8Array(r)}}setData(e,r=0,a=0,i=4294967295){var n=this._indexTypeByteCount;if(0!==a||4294967295!==i)switch(this._indexType){case t.IndexFormat.UInt32:e=new Uint32Array(e.buffer,a*n,i);break;case t.IndexFormat.UInt16:e=new Uint16Array(e.buffer,a*n,i);break;case t.IndexFormat.UInt8:e=new Uint8Array(e.buffer,a*n,i)}if(this._deviceBuffer._setIndexData(e,r*n),this._canRead)if(0!==r||0!==a||4294967295!==i){var s=this._buffer.length-r;if(i>s&&(i=s),typeof e==typeof this._buffer&&e.length==i)this._buffer.set(e,r);else for(var o=0;o<i;o++)this._buffer[r+o]=e[o]}else this._buffer=e}getData(){if(this._canRead)return this._buffer;throw new t.NotReadableError}destroy(){this._deviceBuffer.destroy(),this._buffer=null,this._byteLength=0,this._indexCount=0}}class Nr{get vertexDeclaration(){return this._deviceBuffer.vertexDeclaration}set vertexDeclaration(e){this._deviceBuffer.vertexDeclaration=e}get instanceBuffer(){return this._deviceBuffer.instanceBuffer}set instanceBuffer(e){this._deviceBuffer.instanceBuffer=e}get canRead(){return this._canRead}constructor(e,r,a=!1){this._float32Reader=null,this._deviceBuffer=t.LayaGL.renderDeviceFactory.createVertexBuffer(r),this._canRead=a,this._byteLength=e,this._deviceBuffer.setDataLength(e),this.bufferUsage=r,this._canRead&&(this._buffer=new Uint8Array(e),this._float32Reader=new Float32Array(this._buffer.buffer))}setData(e,t=0,r=0,a=Number.MAX_SAFE_INTEGER){if(this._deviceBuffer.setData(e,t,r,a),0!==r||a!==Number.MAX_SAFE_INTEGER){var i=new Uint8Array(e,r,a);this._canRead&&this._buffer.set(i,t)}else this._canRead&&this._buffer.set(new Uint8Array(e),t)}getUint8Data(){if(this._canRead)return this._buffer;throw new t.NotReadableError}getFloat32Data(){if(this._canRead)return this._float32Reader;throw new t.NotReadableError}markAsUnreadbale(){this._canRead=!1,this._buffer=null,this._float32Reader=null}destroy(){this._deviceBuffer.destroy(),this._buffer=null,this._float32Reader=null,this._byteLength=0}}class Pr{createVertexBuffer3D(e,t,r=!1){return new Nr(e,t,r)}createIndexBuffer3D(e,r,a=t.BufferUsage.Static,i=!1){return new Lr(e,r,a,i)}}t.Laya.addBeforeInitCallback((()=>{E.renderOBJCreate||(E.renderOBJCreate=new Pr)}));e.RenderCMDType=void 0,(pr=e.RenderCMDType||(e.RenderCMDType={}))[pr.DrawNode=0]="DrawNode",pr[pr.DrawElement=1]="DrawElement",pr[pr.Blit=2]="Blit",pr[pr.ChangeData=3]="ChangeData",pr[pr.ChangeShaderDefine=4]="ChangeShaderDefine",pr[pr.ChangeViewPort=5]="ChangeViewPort",pr[pr.ChangeRenderTarget=6]="ChangeRenderTarget";class Fr{constructor(e,t,r,a,i){this._destroyed=!1,this._id=Fr._idCounter++,this.cluster=e,this.index=t,this.size=r,this._alignedSize=a,this.offset=a*t,this.user=i,this.uploadNum=0,this.moved=!1}needUpload(){this.cluster._addUploadBlock(this.index),!this.moved&&this.uploadNum++>this.cluster.manager.uploadThreshold&&this.cluster.manager._addOptimizeBufferPos(this.cluster)}destroy(){return this._destroyed?(console.warn("UniformBufferBlock: object alreay destroyed!"),!1):(this._destroyed=!0,this.cluster=null,this.user=null,!0)}}Fr._idCounter=0;class Or{constructor(e,t,r){this._inManagerUpdateArray=!1,this._sn=0,this._id=0,this._destroyed=!1,this._blocks=[],this._holeNum=0,this._expand=16,this._id=Or._idCounter++,this.manager=r,this._blockSize=e,this._blockNum=t,this._totalSize=e*t,this._needUpload=new Array(t).fill(!1),this.data=new ArrayBuffer(this._totalSize),this._move=new Uint8Array(this._blockSize),this.buffer=this.manager.createGPUBuffer(this._totalSize),this.manager.statisGPUMemory(this._totalSize)}get usedNum(){return this._blocks.length}_expandBuffer(){let e=this._blockNum;if(this._blockNum+=this._expand,this._blockNum>this.manager.clusterMaxBlock&&(this._blockNum=this.manager.clusterMaxBlock),e=this._blockNum-e,e<1)return!1;this._totalSize=this._blockSize*this._blockNum;const t=this._blockSize*this._expand;this._needUpload=this._needUpload.concat(new Array(e).fill(!1));const r=new ArrayBuffer(this._totalSize);return new Uint8Array(r).set(new Uint8Array(this.data)),this.data=r,this.buffer=this.manager.createGPUBuffer(this._totalSize),this.manager.statisGPUMemory(t),this._blocks.forEach((e=>e&&e.user.notifyGPUBufferChange("expand"))),!0}_moveBlock(e){const t=this._blocks.length;if(e>=t)return!1;const r=new Uint8Array(this.data),a=this._blockSize;for(let i=e+1;i<t;i++){const e=i*a,t=e+a,n=e-a;r.copyWithin(n,e,t),this._needUpload[i-1]=this._needUpload[i],this._blocks[i-1]=this._blocks[i],this._blocks[i-1]&&(this._blocks[i-1].index--,this._blocks[i-1].offset-=a,this._blocks[i-1].user.notifyGPUBufferChange("moveBlock"))}return this._blocks.length--,!0}_createBufferBlock(e,t,r,a){return new Fr(this,e,t,r,a)}getBlock(e,t){const r=br(e,this.manager.byteAlign);if(r!==this._blockSize)return console.warn("WebGPUBufferCluster: 获取内存块时, 长度错误!"),null;const a=this._getBlockWithExpand(),i=this._createBufferBlock(a,e,r,t);return this._blocks[a]=i,i}freeBlock(e){const t=this._blocks.indexOf(e);return-1!==t&&(t===this._blocks.length-1?this._blocks.length--:(this._blocks[t]=null,this._holeNum++),e.destroy(),this._holeNum>this.manager.removeHoleThreshold&&(this.manager._addRemoveHoleCluster(this),this._holeNum=0),!0)}upload(){var e;let t=0,r=0,a=!1,i=-1,n=-1,s=0,o=0;for(let l=0,h=this._blocks.length;l<h;l++)this._needUpload[l]?(-1===i&&(i=l),n=l,a=!0,this._needUpload[l]=!1,null===(e=this._blocks[l])||void 0===e||e.user.updateOver()):a&&(s=i*this._blockSize,o=(n-i+1)*this._blockSize,this.manager.writeBuffer(this.buffer,this.data,s,o),t++,r+=o,i=-1,n=-1,a=!1);a&&(s=i*this._blockSize,o=(n-i+1)*this._blockSize,this.manager.writeBuffer(this.buffer,this.data,s,o),t++,r+=o),this.manager.statisUpload(t,r)}_addUploadBlock(e){this._needUpload[e]=!0,this._inManagerUpdateArray||this.manager._addUpdateArray(this)}optimize(){let e=!1;for(let t=0,r=this._blocks.length;t<r;t++){const r=this._blocks[t];if(r&&!r.moved&&r.uploadNum>this.manager.uploadThreshold&&t>0){const a=this._blockSize,i=new Uint8Array(this.data);this._move.set(new Uint8Array(this.data,a*t,a));for(let e=t-1;e>=0;e--){const t=e*a,r=t+a,n=t+a;i.copyWithin(n,t,r),this._needUpload[e+1]=this._needUpload[e],this._blocks[e+1]=this._blocks[e],this._blocks[e+1]&&(this._blocks[e+1].index++,this._blocks[e+1].offset+=a,this._blocks[e+1].user.notifyGPUBufferChange("optimize"))}i.set(this._move),r.index=0,r.offset=0,r.moved=!0,this._blocks[0]=r,this._blocks[0].user.notifyGPUBufferChange("optimize"),e=!0,this.manager._enableStat&&this.manager._stat.moveNum++}}return e}removeHole(){let e=!1;for(let t=this._blocks.length-1;t>-1;t--)this._blocks[t]||this._moveBlock(t)&&(e=!0,this.manager._enableStat&&this.manager._stat.moveNum++);return this._holeNum=0,e}clear(e){this._blocks.forEach((e=>e&&e.destroy())),this._blocks.length=0,null!=e&&e>0&&e!==this._blockNum?(this._blockNum=e,this._totalSize=this._blockSize*this._blockNum,this.buffer=this.manager.createGPUBuffer(this._totalSize),this.data=new ArrayBuffer(this._totalSize)):(this._blockNum=0,this._totalSize=0,this.buffer=null,this.data=null),this._needUpload.length=this._blockNum,this._needUpload.fill(!1)}_getBlockWithExpand(){for(let e=this._blocks.length-1;e>-1;e--)if(!this._blocks[e])return this._holeNum--,e;return this._blocks.length<this._blockNum||this._expandBuffer(),this._blocks.length}destroy(){var e;return this._destroyed?(console.warn("UniformBufferCluster: object alreay destroyed!"),!1):(this.clear(),null!==(e=this.buffer.destroy)&&void 0!==e||this.buffer.destroy(),this.manager.statisGPUMemory(-this._totalSize),this._destroyed=!0,!0)}}function br(e,t){return((e+t-1)/t|0)*t}Or._idCounter=0;class Vr{constructor(){this.moveNum=0,this.uploadNum=0,this.uploadByte=0,this.timeCostAvg=0,this.timeCostSum=0,this.timeCostCount=0}}class Ur{constructor(e,t,r){this._destroyed=!1,this.uploadNum=0,this.data=new ArrayBuffer(e),this.buffer=t.getBufferAlone(e),this._manager=t,this._size=e,this._alignedSize=br(e,t.byteAlign),this.user=r,t.aloneBuffers.push(this)}upload(){let e;this._manager._enableStat&&(e=performance.now()),this.uploadNum++,this._manager.writeBuffer(this.buffer,this.data,0,this._size),this._manager._enableStat&&(this._manager.statisUpload(1,this._size),this._manager.statisTimeCostAvg(performance.now()-e))}destroy(){return this._destroyed?(console.warn("UniformBufferAlone: object alreay destroyed!"),!1):(this.data=null,this.buffer.destroy&&this.buffer.destroy(),this._manager.statisGPUMemory(-this._size),this._manager.aloneBuffers.splice(this._manager.aloneBuffers.indexOf(this),1),this._destroyed=!0,!0)}}class Hr{constructor(e,t,r,a){this.destroyed=!1,this.name=e,this._strId="",this._items=new Map,this._itemNum=0,this.data=a,this._size=t,this.manager=r,this.needUpload=!1,r._useBigBuffer?(this.bufferBlock=r.getBlock(t,this),this.offset=this.bufferBlock.offset):this.bufferAlone=this._createBufferAlone(t,r)}_createBufferAlone(e,t){return new Ur(e,t,this)}updateOver(){this.needUpload=!1}notifyGPUBufferChange(){const e=this.bufferBlock.offset-this.offset;this.offset=this.bufferBlock.offset,this._items.forEach((t=>{const r=Hr._typeArray(t.type);t.view=new r(this.bufferBlock.cluster.data,t.view.byteOffset+e,t.size/r.BYTES_PER_ELEMENT)})),this.clearGPUBufferBind(),this.needUpload=!0}clearGPUBufferBind(){}addUniform(e,t,r,a,i,n,s,o){this._items.has(e)||(this._items.set(e,this._getUniformItem(t,Hr._typeArray(r),r,a,i,n,s,o)),this._strId.length>0&&(this._strId+="|"),this._strId+=e,this._itemNum++)}setUniformData(e,t){const r=this._items.get(e);if(r)if(this.needUpload=!0,1==r.count)switch(r.type){case"int":case"float":r.view[0]=t;break;case"vec2":r.view[0]=t.x,r.view[1]=t.y;break;case"vec3":r.view[0]=t.x,r.view[1]=t.y,r.view[2]=t.z;break;case"vec4":r.view[0]=t.x,r.view[1]=t.y,r.view[2]=t.z,r.view[3]=t.w;break;case"mat3":for(let e=0;e<3;e++)r.view[4*e+0]=t.elements[3*e+0],r.view[4*e+1]=t.elements[3*e+1],r.view[4*e+2]=t.elements[3*e+2];break;case"mat4":r.view.set(t.elements)}else{const e=r.count*r.elements,a=r.size/r.count/r.view.BYTES_PER_ELEMENT;for(let i=0,n=0;i<e;i+=r.elements,n+=a)r.view.set(t.subarray(i,i+r.elements),n)}}setBool(e,t){const r=this._items.get(e);r&&(r.view[0]=t?1:0,this.needUpload=!0)}setBoolArray(e,t){const r=this._items.get(e);if(r){for(let e=0,a=Math.min(r.count,t.length);e<a;e++)r.view[e]=t[e]?1:0;this.needUpload=!0}}setInt(e,t){const r=this._items.get(e);r&&(r.view[0]=t,this.needUpload=!0)}setIntArray(e,t){const r=this._items.get(e);if(r){for(let e=0,a=Math.min(r.count,t.length);e<a;e++)r.view[e]=t[e];this.needUpload=!0}}setFloat(e,t){const r=this._items.get(e);r&&(r.view[0]=t,this.needUpload=!0)}setFloatArray(e,t){const r=this._items.get(e);if(r){for(let e=0,a=Math.min(r.count,t.length);e<a;e++)r.view[e]=t[e];this.needUpload=!0}}setVector2(e,t){const r=this._items.get(e);r&&(r.view[0]=t.x,r.view[1]=t.y,this.needUpload=!0)}setVector2Array(e,t){const r=this._items.get(e);if(r){for(let e=0,a=Math.min(r.count,t.length);e<a;e++)r.view[2*e+0]=t[e].x,r.view[2*e+1]=t[e].y;this.needUpload=!0}}setVector3(e,t){const r=this._items.get(e);r&&(r.view[0]=t.x,r.view[1]=t.y,r.view[2]=t.z,this.needUpload=!0)}setVector3Array(e,t){const r=this._items.get(e);if(r){for(let e=0,a=Math.min(r.count,t.length);e<a;e++)r.view[4*e+0]=t[e].x,r.view[4*e+1]=t[e].y,r.view[4*e+2]=t[e].z;this.needUpload=!0}}setVector4(e,t){const r=this._items.get(e);r&&(r.view[0]=t.x,r.view[1]=t.y,r.view[2]=t.z,r.view[3]=t.w,this.needUpload=!0)}setVector4Array(e,t){const r=this._items.get(e);if(r){for(let e=0,a=Math.min(r.count,t.length);e<a;e++)r.view[4*e+0]=t[e].x,r.view[4*e+1]=t[e].y,r.view[4*e+2]=t[e].z,r.view[4*e+3]=t[e].w;this.needUpload=!0}}setMatrix3x3(e,t){const r=this._items.get(e);if(r){for(let e=0;e<3;e++)r.view[4*e+0]=t.elements[3*e+0],r.view[4*e+1]=t.elements[3*e+1],r.view[4*e+2]=t.elements[3*e+2];this.needUpload=!0}}setMatrix3x3Array(e,t){const r=this._items.get(e);if(r){for(let e=0,a=Math.min(r.count,t.length);e<a;e++)for(let a=0;a<3;a++)r.view[16*e+4*a+0]=t[e].elements[3*a+0],r.view[16*e+4*a+1]=t[e].elements[3*a+1],r.view[16*e+4*a+2]=t[e].elements[3*a+2];this.needUpload=!0}}setMatrix4x4(e,t){const r=this._items.get(e);r&&(r.view.set(t.elements),this.needUpload=!0)}setMatrix4x4Array(e,t){const r=this._items.get(e);if(r){for(let e=0,a=Math.min(r.count,t.length);e<a;e++)r.view.set(t[e].elements,16*e);this.needUpload=!0}}setBuffer(e,t){this.setUniformData(e,t)}getUniform(e){return this._items.get(e)}hasUniform(e){return this._items.has(e)}isMe(e){return this._strId===e}upload(){this.needUpload&&(this.manager._useBigBuffer?this.bufferBlock.needUpload():this.bufferAlone.upload(),this.needUpload=!1)}clear(){this.manager._useBigBuffer?new Uint8Array(this.bufferBlock.cluster.data).fill(0,this.bufferBlock.offset,this.bufferBlock.offset+this.bufferBlock.size):new Uint8Array(this.bufferAlone.data).fill(0),this._strId="",this._items.clear(),this._itemNum=0,this.needUpload=!1}destroy(){return this.destroyed?(console.warn("UniformBufferUser: object alreay destroyed!"),!1):(this.manager._useBigBuffer?this.manager.freeBlock(this.bufferBlock):this.bufferAlone.destroy(),this.destroyed=!0,!0)}_getUniformItem(e,t,r,a,i,n,s,o){let l;return l=this.manager._useBigBuffer?new t(this.bufferBlock.cluster.data,this.bufferBlock.offset+a,n/t.BYTES_PER_ELEMENT):new t(this.bufferAlone.data,a,n/t.BYTES_PER_ELEMENT),{name:e,view:l,type:r,align:i,size:n,elements:s,count:o}}static _typeArray(e){return"int"===e?Int32Array:Float32Array}}class Gr{constructor(){this._ownerPath=[],this._propertys=[],this._keyFrames=[]}get ownerPathCount(){return this._ownerPath.length}get propertyCount(){return this._propertys.length}get keyFramesCount(){return this._keyFrames.length}_setOwnerPathCount(e){this._ownerPath.length=e}_setOwnerPathByIndex(e,t){this._ownerPath[e]=t}_joinOwnerPath(e){return this._ownerPath.join(e)}_setPropertyCount(e){this._propertys.length=e}_setPropertyByIndex(e,t){this._propertys[e]=t}_joinProperty(e){return this._propertys.join(e)}_setKeyframeCount(e){this._keyFrames.length=e}_setKeyframeByIndex(e,t){this._keyFrames[e]=t}getOwnerPathByIndex(e){return this._ownerPath[e]}getPropertyByIndex(e){return this._propertys[e]}getKeyframeByIndex(e){return this._keyFrames[e]}}class kr{constructor(){}}class zr{static READ_DATA(){zr._DATA.offset=zr._reader.getUint32(),zr._DATA.size=zr._reader.getUint32()}static READ_BLOCK(){for(var e=zr._BLOCK.count=zr._reader.getUint16(),t=zr._BLOCK.blockStarts=[],r=zr._BLOCK.blockLengths=[],a=0;a<e;a++)t.push(zr._reader.getUint32()),r.push(zr._reader.getUint32())}static READ_STRINGS(){var e=zr._reader.getUint32(),t=zr._reader.getUint16(),r=zr._reader.pos;zr._reader.pos=e+zr._DATA.offset;for(var a=0;a<t;a++)zr._strings[a]=zr._reader.readUTFString();zr._reader.pos=r}static parse(e,t){zr._animationClip=e,zr._reader=t,zr.READ_DATA(),zr.READ_BLOCK(),zr.READ_STRINGS();for(var r=0,a=zr._BLOCK.count;r<a;r++){var i=t.getUint16(),n=zr._strings[i],s=zr["READ_"+n];if(null==s)throw new Error("model file err,no this function:"+i+" "+n);s.call(null)}}static READ_ANIMATIONS(){var e,r,a,i=zr._reader,n=[],s=i.getUint16();for(n.length=s,e=0;e<s;e++)n[e]=i.getFloat32();var o=zr._animationClip;o.name=zr._strings[i.getUint16()];var l=o._duration=i.getFloat32();o.islooping=!!i.getByte(),o._frameRate=i.getInt16();var h=i.getInt16(),d=o._nodes;d.count=h;var c=o._nodesMap={},u=o._nodesDic={};for(e=0;e<h;e++){a=new Gr,d.setNodeByIndex(e,a),a._indexInList=e;var _=a.type=i.getUint8(),f=i.getUint16();for(a._setOwnerPathCount(f),r=0;r<f;r++)a._setOwnerPathByIndex(r,zr._strings[i.getUint16()]);var g=a._joinOwnerPath("/"),m=c[g];m||(c[g]=m=[]),m.push(a),a.propertyOwner=zr._strings[i.getUint16()];var p=i.getUint16();for(a._setPropertyCount(p),r=0;r<p;r++)a._setPropertyByIndex(r,zr._strings[i.getUint16()]);var S=g+"."+a.propertyOwner+"."+a._joinProperty(".");u[S]=a,a.fullPath=S;var E=i.getUint16();for(a._setKeyframeCount(E),r=0;r<E;r++)switch(_){case 0:var D=new t.FloatKeyframe;a._setKeyframeByIndex(r,D),D.time=n[i.getUint16()],D.inTangent=i.getFloat32(),D.outTangent=i.getFloat32(),D.value=i.getFloat32();break;case 1:case 3:case 4:var T=new t.Vector3Keyframe;a._setKeyframeByIndex(r,T),T.time=n[i.getUint16()];var A=T.inTangent,x=T.outTangent,R=T.value;A.x=i.getFloat32(),A.y=i.getFloat32(),A.z=i.getFloat32(),x.x=i.getFloat32(),x.y=i.getFloat32(),x.z=i.getFloat32(),R.x=i.getFloat32(),R.y=i.getFloat32(),R.z=i.getFloat32();break;case 2:var M=new t.QuaternionKeyframe;a._setKeyframeByIndex(r,M),M.time=n[i.getUint16()];var C=M.inTangent,I=M.outTangent,v=M.value;C.x=i.getFloat32(),C.y=i.getFloat32(),C.z=i.getFloat32(),C.w=i.getFloat32(),I.x=i.getFloat32(),I.y=i.getFloat32(),I.z=i.getFloat32(),I.w=i.getFloat32(),v.x=i.getFloat32(),v.y=i.getFloat32(),v.z=i.getFloat32(),v.w=i.getFloat32();break;default:throw new Error("AnimationClipParser03:unknown type.")}}var y=i.getUint16();for(e=0;e<y;e++){var B=new kr;B.time=Math.min(l,i.getFloat32()),B.eventName=zr._strings[i.getUint16()];var w=[],L=i.getUint16();for(L>0&&(B.params=w=[]),r=0;r<L;r++){switch(i.getByte()){case 0:w.push(!!i.getByte());break;case 1:w.push(i.getInt32());break;case 2:w.push(i.getFloat32());break;case 3:w.push(zr._strings[i.getUint16()]);break;default:throw new Error("unknown type.")}}o.addEvent(B)}}}zr._strings=[],zr._BLOCK={count:0},zr._DATA={offset:0,size:0},e.KeyFrameValueType=void 0,(Sr=e.KeyFrameValueType||(e.KeyFrameValueType={}))[Sr.None=-1]="None",Sr[Sr.Float=0]="Float",Sr[Sr.Position=1]="Position",Sr[Sr.Rotation=2]="Rotation",Sr[Sr.Scale=3]="Scale",Sr[Sr.RotationEuler=4]="RotationEuler",Sr[Sr.Vector2=5]="Vector2",Sr[Sr.Vector3=6]="Vector3",Sr[Sr.Vector4=7]="Vector4",Sr[Sr.Color=8]="Color",Sr[Sr.Boolean=9]="Boolean";class Wr{constructor(){this.indexInList=-1,this.referenceCount=0,this.updateMark=-1,this.type=-1,this.fullPath=null,this.nodePath=null,this.propertyOwner=null,this.property=null,this.defaultValue=null,this.value=null,this.crossFixedValue=null,this.isMaterial=!1}saveCrossFixedValue(){if(this.propertyOwner)switch(this.type){case 0:this.crossFixedValue=this.value;break;case 1:case 3:case 4:case 2:this.value.cloneTo(this.crossFixedValue);break;default:throw new Error("Animator:unknown type.")}}animatorDataSetCallBack(){this.callBackOwner[this.callbackFun].apply(this.callBackOwner,this.callParams)}getCallbackNode(){if(this.propertyOwner&&this.callbackFunData){let e=this.callbackFunData.split(".");this.callBackOwner=this.propertyOwner;for(let t=0,r=e.length-1;t<r;t++)this.callBackOwner=this.callBackOwner[e[t]];this.callbackFun=e[e.length-1]}}}class Qr{static READ_DATA(){Qr._DATA.offset=Qr._reader.getUint32(),Qr._DATA.size=Qr._reader.getUint32()}static READ_BLOCK(){for(var e=Qr._BLOCK.count=Qr._reader.getUint16(),t=Qr._BLOCK.blockStarts=[],r=Qr._BLOCK.blockLengths=[],a=0;a<e;a++)t.push(Qr._reader.getUint32()),r.push(Qr._reader.getUint32())}static READ_STRINGS(){var e=Qr._reader.getUint32(),t=Qr._reader.getUint16(),r=Qr._reader.pos;Qr._reader.pos=e+Qr._DATA.offset;for(var a=0;a<t;a++)Qr._strings[a]=Qr._reader.readUTFString();Qr._reader.pos=r}static parse(e,t,r){Qr._animationClip=e,Qr._reader=t,Qr._version=r,Qr.READ_DATA(),Qr.READ_BLOCK(),Qr.READ_STRINGS();for(var a=0,i=Qr._BLOCK.count;a<i;a++){var n=t.getUint16(),s=Qr._strings[n],o=Qr["READ_"+s];if(null==o)throw new Error("model file err,no this function:"+n+" "+s);o.call(null)}Qr._version=null,Qr._reader=null,Qr._animationClip=null}static READ_ANIMATIONS(){var r,a,i,n=Qr._reader,s=[],o=n.getUint16();for(s.length=o,r=0;r<o;r++)s[r]=n.getFloat32();var l=Qr._animationClip;l.name=Qr._strings[n.getUint16()];var h=l._duration=n.getFloat32();l.islooping=!!n.getByte(),l._frameRate=n.getInt16();var d=n.getInt16(),c=l._nodes;c.count=d;var u=l._nodesMap={},_=l._nodesDic={};for(r=0;r<d;r++){if(i=new Gr,"LAYAANIMATION:WEIGHT_05"==Qr._version){1==n.getByte()&&(i.propertyChangePath=Qr._strings[n.getUint16()]),1==n.getByte()&&(i.callbackFunData=Qr._strings[n.getUint16()]);let e=n.getUint8(),t=null;for(a=0;a<e;a++)null==t&&(t=[]),t.push(Qr._strings[n.getUint16()]);i.callParams=t}c.setNodeByIndex(r,i),i._indexInList=r;var f=i.type=n.getUint8(),g=n.getUint16();for(i._setOwnerPathCount(g),a=0;a<g;a++)i._setOwnerPathByIndex(a,Qr._strings[n.getUint16()]);var m=i._joinOwnerPath("/"),p=u[m];p||(u[m]=p=[]),p.push(i),i.propertyOwner=Qr._strings[n.getUint16()];var S=n.getUint16();for(i._setPropertyCount(S),a=0;a<S;a++)i._setPropertyByIndex(a,Qr._strings[n.getUint16()]);var E=m+"."+i.propertyOwner+"."+i._joinProperty(".");_[E]=i,i.fullPath=E,i.nodePath=m;var D=n.getUint16();switch(i._setKeyframeCount(D),Qr._version){case"LAYAANIMATION:04":for(a=0;a<D;a++)switch(f){case e.KeyFrameValueType.Float:var T=new t.FloatKeyframe;i._setKeyframeByIndex(a,T),T.time=s[n.getUint16()],T.inTangent=n.getFloat32(),T.outTangent=n.getFloat32(),T.value=n.getFloat32();break;case e.KeyFrameValueType.Position:case e.KeyFrameValueType.Scale:case e.KeyFrameValueType.RotationEuler:case e.KeyFrameValueType.Vector3:var A=new t.Vector3Keyframe;i._setKeyframeByIndex(a,A),A.time=s[n.getUint16()];var x=A.inTangent,R=A.outTangent,M=A.value;x.x=n.getFloat32(),x.y=n.getFloat32(),x.z=n.getFloat32(),R.x=n.getFloat32(),R.y=n.getFloat32(),R.z=n.getFloat32(),M.x=n.getFloat32(),M.y=n.getFloat32(),M.z=n.getFloat32();break;case e.KeyFrameValueType.Rotation:var C=new t.QuaternionKeyframe;i._setKeyframeByIndex(a,C),C.time=s[n.getUint16()];var I=C.inTangent,v=C.outTangent,y=C.value;I.x=n.getFloat32(),I.y=n.getFloat32(),I.z=n.getFloat32(),I.w=n.getFloat32(),v.x=n.getFloat32(),v.y=n.getFloat32(),v.z=n.getFloat32(),v.w=n.getFloat32(),y.x=n.getFloat32(),y.y=n.getFloat32(),y.z=n.getFloat32(),y.w=n.getFloat32();break;case e.KeyFrameValueType.Vector2:var B=new t.Vector2Keyframe;i._setKeyframeByIndex(a,B),B.time=s[n.getUint16()];var w=B.inTangent,L=B.outTangent,N=B.value;w.x=n.getFloat32(),w.y=n.getFloat32(),L.x=n.getFloat32(),L.y=n.getFloat32(),N.x=n.getFloat32(),N.y=n.getFloat32();break;case e.KeyFrameValueType.Vector4:case e.KeyFrameValueType.Color:var P=new t.Vector4Keyframe;i._setKeyframeByIndex(a,P),P.time=s[n.getUint16()];var F=P.inTangent,O=P.outTangent,b=P.value;F.x=n.getFloat32(),F.y=n.getFloat32(),F.z=n.getFloat32(),F.w=n.getFloat32(),O.x=n.getFloat32(),O.y=n.getFloat32(),O.z=n.getFloat32(),O.w=n.getFloat32(),b.x=n.getFloat32(),b.y=n.getFloat32(),b.z=n.getFloat32(),b.w=n.getFloat32();break;default:throw new Error("AnimationClipParser04:unknown type.")}break;case"LAYAANIMATION:WEIGHT_04":case"LAYAANIMATION:WEIGHT_05":for(a=0;a<D;a++){let r=1;switch(f){case e.KeyFrameValueType.Boolean:let o=new t.BooleanKeyframe;i._setKeyframeByIndex(a,o),o.time=s[n.getUint16()],o.value=1==n.getByte();break;case e.KeyFrameValueType.Float:T=new t.FloatKeyframe;i._setKeyframeByIndex(a,T),T.time=s[n.getUint16()],T.inTangent=n.getFloat32(),T.outTangent=n.getFloat32(),T.value=n.getFloat32(),T.weightedMode=n.getUint8(),"LAYAANIMATION:WEIGHT_05"==Qr._version?(t.WeightedMode.In!=T.weightedMode&&t.WeightedMode.Both!=T.weightedMode||(T.inWeight=n.getFloat32()),t.WeightedMode.Out!=T.weightedMode&&t.WeightedMode.Both!=T.weightedMode||(T.outWeight=n.getFloat32())):(T.inWeight=n.getFloat32(),T.outWeight=n.getFloat32());break;case e.KeyFrameValueType.Position:case e.KeyFrameValueType.Scale:case e.KeyFrameValueType.RotationEuler:case e.KeyFrameValueType.Vector3:A=new t.Vector3Keyframe(!0);i._setKeyframeByIndex(a,A),A.time=s[n.getUint16()];x=A.inTangent,R=A.outTangent,M=A.value;let l=A.weightedMode,h=A.inWeight,d=A.outWeight;x.x=n.getFloat32(),x.y=n.getFloat32(),x.z=n.getFloat32(),R.x=n.getFloat32(),R.y=n.getFloat32(),R.z=n.getFloat32(),M.x=n.getFloat32(),M.y=n.getFloat32(),M.z=n.getFloat32(),"LAYAANIMATION:WEIGHT_05"==Qr._version&&(r=n.getByte()),1==r&&(l.x=n.getUint8(),l.y=n.getUint8(),l.z=n.getUint8(),h.x=n.getFloat32(),h.y=n.getFloat32(),h.z=n.getFloat32(),d.x=n.getFloat32(),d.y=n.getFloat32(),d.z=n.getFloat32());break;case e.KeyFrameValueType.Rotation:C=new t.QuaternionKeyframe(!0);i._setKeyframeByIndex(a,C),C.time=s[n.getUint16()];I=C.inTangent,v=C.outTangent,y=C.value;let c=C.weightedMode,u=C.inWeight,_=C.outWeight;I.x=n.getFloat32(),I.y=n.getFloat32(),I.z=n.getFloat32(),I.w=n.getFloat32(),v.x=n.getFloat32(),v.y=n.getFloat32(),v.z=n.getFloat32(),v.w=n.getFloat32(),y.x=n.getFloat32(),y.y=n.getFloat32(),y.z=n.getFloat32(),y.w=n.getFloat32(),"LAYAANIMATION:WEIGHT_05"==Qr._version&&(r=n.getByte()),1==r&&(c.x=n.getUint8(),c.y=n.getUint8(),c.z=n.getUint8(),c.w=n.getUint8(),u.x=n.getFloat32(),u.y=n.getFloat32(),u.z=n.getFloat32(),u.w=n.getFloat32(),_.x=n.getFloat32(),_.y=n.getFloat32(),_.z=n.getFloat32(),_.w=n.getFloat32());break;case e.KeyFrameValueType.Vector2:B=new t.Vector2Keyframe(!0);i._setKeyframeByIndex(a,B),B.time=s[n.getUint16()];w=B.inTangent,L=B.outTangent,N=B.value;let f=B.weightedMode,g=B.inWeight,m=B.outWeight;w.x=n.getFloat32(),w.y=n.getFloat32(),L.x=n.getFloat32(),L.y=n.getFloat32(),N.x=n.getFloat32(),N.y=n.getFloat32(),"LAYAANIMATION:WEIGHT_05"==Qr._version&&(r=n.getByte()),1==r&&(f.x=n.getUint8(),f.y=n.getUint8(),g.x=n.getFloat32(),g.y=n.getFloat32(),m.x=n.getFloat32(),m.y=n.getFloat32());break;case e.KeyFrameValueType.Vector4:case e.KeyFrameValueType.Color:P=new t.Vector4Keyframe(!0);i._setKeyframeByIndex(a,P),P.time=s[n.getUint16()];F=P.inTangent,O=P.outTangent,b=P.value;var V=P.weightedMode,U=P.inWeight,H=P.outWeight;F.x=n.getFloat32(),F.y=n.getFloat32(),F.z=n.getFloat32(),F.w=n.getFloat32(),O.x=n.getFloat32(),O.y=n.getFloat32(),O.z=n.getFloat32(),O.w=n.getFloat32(),b.x=n.getFloat32(),b.y=n.getFloat32(),b.z=n.getFloat32(),b.w=n.getFloat32(),"LAYAANIMATION:WEIGHT_05"==Qr._version&&(r=n.getByte()),1==r&&(V.x=n.getUint8(),V.y=n.getUint8(),V.z=n.getUint8(),V.w=n.getUint8(),U.x=n.getFloat32(),U.y=n.getFloat32(),U.z=n.getFloat32(),U.w=n.getFloat32(),H.x=n.getFloat32(),H.y=n.getFloat32(),H.z=n.getFloat32(),H.w=n.getFloat32());break;default:throw"AnimationClipParser04:unknown type."}}break;case"LAYAANIMATION:COMPRESSION_04":for(a=0;a<D;a++)switch(f){case e.KeyFrameValueType.Float:T=new t.FloatKeyframe,i._setKeyframeByIndex(a,T),T.time=s[n.getUint16()],T.inTangent=t.HalfFloatUtils.convertToNumber(n.getUint16()),T.outTangent=t.HalfFloatUtils.convertToNumber(n.getUint16()),T.value=t.HalfFloatUtils.convertToNumber(n.getUint16());break;case e.KeyFrameValueType.Position:case e.KeyFrameValueType.Scale:case e.KeyFrameValueType.RotationEuler:case e.KeyFrameValueType.Vector3:A=new t.Vector3Keyframe,i._setKeyframeByIndex(a,A),A.time=s[n.getUint16()],x=A.inTangent,R=A.outTangent,M=A.value,x.x=t.HalfFloatUtils.convertToNumber(n.getUint16()),x.y=t.HalfFloatUtils.convertToNumber(n.getUint16()),x.z=t.HalfFloatUtils.convertToNumber(n.getUint16()),R.x=t.HalfFloatUtils.convertToNumber(n.getUint16()),R.y=t.HalfFloatUtils.convertToNumber(n.getUint16()),R.z=t.HalfFloatUtils.convertToNumber(n.getUint16()),M.x=t.HalfFloatUtils.convertToNumber(n.getUint16()),M.y=t.HalfFloatUtils.convertToNumber(n.getUint16()),M.z=t.HalfFloatUtils.convertToNumber(n.getUint16());break;case e.KeyFrameValueType.Rotation:C=new t.QuaternionKeyframe,i._setKeyframeByIndex(a,C),C.time=s[n.getUint16()],I=C.inTangent,v=C.outTangent,y=C.value,I.x=t.HalfFloatUtils.convertToNumber(n.getUint16()),I.y=t.HalfFloatUtils.convertToNumber(n.getUint16()),I.z=t.HalfFloatUtils.convertToNumber(n.getUint16()),I.w=t.HalfFloatUtils.convertToNumber(n.getUint16()),v.x=t.HalfFloatUtils.convertToNumber(n.getUint16()),v.y=t.HalfFloatUtils.convertToNumber(n.getUint16()),v.z=t.HalfFloatUtils.convertToNumber(n.getUint16()),v.w=t.HalfFloatUtils.convertToNumber(n.getUint16()),y.x=t.HalfFloatUtils.convertToNumber(n.getUint16()),y.y=t.HalfFloatUtils.convertToNumber(n.getUint16()),y.z=t.HalfFloatUtils.convertToNumber(n.getUint16()),y.w=t.HalfFloatUtils.convertToNumber(n.getUint16());break;case e.KeyFrameValueType.Vector2:B=new t.Vector2Keyframe;i._setKeyframeByIndex(a,B),B.time=s[n.getUint16()];w=B.inTangent,L=B.outTangent,N=B.value;w.x=t.HalfFloatUtils.convertToNumber(n.getUint16()),w.y=t.HalfFloatUtils.convertToNumber(n.getUint16()),L.x=t.HalfFloatUtils.convertToNumber(n.getUint16()),L.y=t.HalfFloatUtils.convertToNumber(n.getUint16()),N.x=t.HalfFloatUtils.convertToNumber(n.getUint16()),N.y=t.HalfFloatUtils.convertToNumber(n.getUint16());break;case e.KeyFrameValueType.Vector4:case e.KeyFrameValueType.Color:P=new t.Vector4Keyframe;i._setKeyframeByIndex(a,P),P.time=s[n.getUint16()];F=P.inTangent,O=P.outTangent,b=P.value;F.x=t.HalfFloatUtils.convertToNumber(n.getUint16()),F.y=t.HalfFloatUtils.convertToNumber(n.getUint16()),F.z=t.HalfFloatUtils.convertToNumber(n.getUint16()),F.w=t.HalfFloatUtils.convertToNumber(n.getUint16()),O.x=t.HalfFloatUtils.convertToNumber(n.getUint16()),O.y=t.HalfFloatUtils.convertToNumber(n.getUint16()),O.z=t.HalfFloatUtils.convertToNumber(n.getUint16()),O.w=t.HalfFloatUtils.convertToNumber(n.getUint16()),b.x=t.HalfFloatUtils.convertToNumber(n.getUint16()),b.y=t.HalfFloatUtils.convertToNumber(n.getUint16()),b.z=t.HalfFloatUtils.convertToNumber(n.getUint16()),b.w=t.HalfFloatUtils.convertToNumber(n.getUint16());break;default:throw"AnimationClipParser04:unknown type."}}}var G=n.getUint16();for(r=0;r<G;r++){var k=new kr;k.time=Math.min(h,n.getFloat32()),k.eventName=Qr._strings[n.getUint16()];var z=[],W=n.getUint16();for(W>0&&(k.params=z=[]),a=0;a<W;a++){switch(n.getByte()){case 0:z.push(!!n.getByte());break;case 1:z.push(n.getInt32());break;case 2:z.push(n.getFloat32());break;case 3:z.push(Qr._strings[n.getUint16()]);break;default:throw new Error("unknown type.")}}l.addEvent(k)}}}Qr._strings=[],Qr._BLOCK={count:0},Qr._DATA={offset:0,size:0};class Yr{get count(){return this._nodes.length}set count(e){this._nodes.length=e}constructor(){this._nodes=[]}getNodeByIndex(e){return this._nodes[e]}setNodeByIndex(e,t){this._nodes[e]=t}}class Xr extends t.Resource{static _parse(e){var r=new Xr,a=new t.Byte(e),i=a.readUTFString();switch(i){case"LAYAANIMATION:03":zr.parse(r,a);break;case"LAYAANIMATION:04":case"LAYAANIMATION:COMPRESSION_04":case"LAYAANIMATION:WEIGHT_04":case"LAYAANIMATION:WEIGHT_05":Qr.parse(r,a,i);break;default:throw new Error("unknown animationClip version.")}return r}static load(e,r){t.ILaya.loader.load(e,r,null,t.Loader.ANIMATIONCLIP)}duration(){return this._duration}constructor(){super(),this._duration=0,this._frameRate=0,this._nodes=new Yr,this.islooping=!1,this._animationEvents=[]}_weightModeHermite(e,r){return 0==(e&t.WeightedMode.Out)&&0==(r&t.WeightedMode.In)}_hermiteInterpolate(e,t,r,a){var i=e.outTangent,n=t.inTangent;if(Number.isFinite(i)&&Number.isFinite(n)){var s=r*r,o=s*r,l=o-2*s+r,h=o-s,d=-2*o+3*s;return(2*o-3*s+1)*e.value+l*i*a+h*n*a+d*t.value}return e.value}_hermiteInterpolateVector3(e,t,r,a,i){var n=e.value,s=e.outTangent,o=t.value,l=t.inTangent,h=r*r,d=h*r,c=2*d-3*h+1,u=d-2*h+r,_=d-h,f=-2*d+3*h,g=s.x,m=l.x;!e.weightedMode||this._weightModeHermite(e.weightedMode.x,t.weightedMode.x)?Number.isFinite(g)&&Number.isFinite(m)?i.x=c*n.x+u*g*a+_*m*a+f*o.x:i.x=n.x:i.x=this._hermiteCurveSplineWeight(e.value.x,e.time,e.outWeight.x,e.outTangent.x,t.value.x,t.time,t.inWeight.x,t.inTangent.x,r),g=s.y,m=l.y,!e.weightedMode||this._weightModeHermite(e.weightedMode.y,t.weightedMode.y)?Number.isFinite(g)&&Number.isFinite(m)?i.y=c*n.y+u*g*a+_*m*a+f*o.y:i.y=n.y:i.y=this._hermiteCurveSplineWeight(e.value.y,e.time,e.outWeight.y,e.outTangent.y,t.value.y,t.time,t.inWeight.y,t.inTangent.y,r),g=s.z,m=l.z,!e.weightedMode||this._weightModeHermite(e.weightedMode.z,t.weightedMode.z)?Number.isFinite(g)&&Number.isFinite(m)?i.z=c*n.z+u*g*a+_*m*a+f*o.z:i.z=n.z:i.z=this._hermiteCurveSplineWeight(e.value.z,e.time,e.outWeight.z,e.outTangent.z,t.value.z,t.time,t.inWeight.z,t.inTangent.z,r)}_hermiteInterpolateQuaternion(e,t,r,a,i){var n=e.value,s=e.outTangent,o=t.value,l=t.inTangent,h=r*r,d=h*r,c=2*d-3*h+1,u=d-2*h+r,_=d-h,f=-2*d+3*h,g=s.x,m=l.x;!e.weightedMode||this._weightModeHermite(e.weightedMode.x,t.weightedMode.x)?Number.isFinite(g)&&Number.isFinite(m)?i.x=c*n.x+u*g*a+_*m*a+f*o.x:i.x=n.x:i.x=this._hermiteCurveSplineWeight(e.value.x,e.time,e.outWeight.x,e.outTangent.x,t.value.x,t.time,t.inWeight.x,t.inTangent.x,r),g=s.y,m=l.y,!e.weightedMode||this._weightModeHermite(e.weightedMode.y,t.weightedMode.y)?Number.isFinite(g)&&Number.isFinite(m)?i.y=c*n.y+u*g*a+_*m*a+f*o.y:i.y=n.y:i.y=this._hermiteCurveSplineWeight(e.value.y,e.time,e.outWeight.y,e.outTangent.y,t.value.y,t.time,t.inWeight.y,t.inTangent.y,r),g=s.z,m=l.z,!e.weightedMode||this._weightModeHermite(e.weightedMode.z,t.weightedMode.z)?Number.isFinite(g)&&Number.isFinite(m)?i.z=c*n.z+u*g*a+_*m*a+f*o.z:i.z=n.z:i.z=this._hermiteCurveSplineWeight(e.value.z,e.time,e.outWeight.z,e.outTangent.z,t.value.z,t.time,t.inWeight.z,t.inTangent.z,r),g=s.w,m=l.w,!e.weightedMode||this._weightModeHermite(e.weightedMode.w,t.weightedMode.w)?Number.isFinite(g)&&Number.isFinite(m)?i.w=c*n.w+u*g*a+_*m*a+f*o.w:i.w=n.w:i.w=this._hermiteCurveSplineWeight(e.value.w,e.time,e.outWeight.w,e.outTangent.w,t.value.w,t.time,t.inWeight.w,t.inTangent.w,r)}_hermiteInterpolateVector4(e,t,r,a,i){var n=e.value,s=e.outTangent,o=t.value,l=t.inTangent,h=r*r,d=h*r,c=2*d-3*h+1,u=d-2*h+r,_=d-h,f=-2*d+3*h,g=s.x,m=l.x;!e.weightedMode||this._weightModeHermite(e.weightedMode.x,t.weightedMode.x)?Number.isFinite(g)&&Number.isFinite(m)?i.x=c*n.x+u*g*a+_*m*a+f*o.x:i.x=n.x:i.x=this._hermiteCurveSplineWeight(e.value.x,e.time,e.outWeight.x,e.outTangent.x,t.value.x,t.time,t.inWeight.x,t.inTangent.x,r),g=s.y,m=l.y,!e.weightedMode||this._weightModeHermite(e.weightedMode.y,t.weightedMode.y)?Number.isFinite(g)&&Number.isFinite(m)?i.y=c*n.y+u*g*a+_*m*a+f*o.y:i.y=n.y:i.y=this._hermiteCurveSplineWeight(e.value.y,e.time,e.outWeight.y,e.outTangent.y,t.value.y,t.time,t.inWeight.y,t.inTangent.y,r),g=s.z,m=l.z,!e.weightedMode||this._weightModeHermite(e.weightedMode.z,t.weightedMode.z)?Number.isFinite(g)&&Number.isFinite(m)?i.z=c*n.z+u*g*a+_*m*a+f*o.z:i.z=n.z:i.z=this._hermiteCurveSplineWeight(e.value.z,e.time,e.outWeight.z,e.outTangent.z,t.value.z,t.time,t.inWeight.z,t.inTangent.z,r),g=s.w,m=l.w,!e.weightedMode||this._weightModeHermite(e.weightedMode.w,t.weightedMode.w)?Number.isFinite(g)&&Number.isFinite(m)?i.w=c*n.w+u*g*a+_*m*a+f*o.w:i.w=n.w:i.w=this._hermiteCurveSplineWeight(e.value.w,e.time,e.outWeight.w,e.outTangent.w,t.value.w,t.time,t.inWeight.w,t.inTangent.w,r)}_hermiteInterpolateVector2(e,t,r,a,i){var n=e.value,s=e.outTangent,o=t.value,l=t.inTangent,h=r*r,d=h*r,c=2*d-3*h+1,u=d-2*h+r,_=d-h,f=-2*d+3*h,g=s.x,m=l.x;!e.weightedMode||this._weightModeHermite(e.weightedMode.x,t.weightedMode.x)?Number.isFinite(g)&&Number.isFinite(m)?i.x=c*n.x+u*g*a+_*m*a+f*o.x:i.x=n.x:i.x=this._hermiteCurveSplineWeight(e.value.x,e.time,e.outWeight.x,e.outTangent.x,t.value.x,t.time,t.inWeight.x,t.inTangent.x,r),g=s.y,m=l.y,!e.weightedMode||this._weightModeHermite(e.weightedMode.y,t.weightedMode.y)?Number.isFinite(g)&&Number.isFinite(m)?i.y=c*n.y+u*g*a+_*m*a+f*o.y:i.y=n.y:i.y=this._hermiteCurveSplineWeight(e.value.y,e.time,e.outWeight.y,e.outTangent.y,t.value.y,t.time,t.inWeight.y,t.inTangent.y,r)}_hermiteCurveSplineWeight(e,t,r,a,i,n,s,o,l){let h=222e-18,d=l,c=e,u=r,_=s,f=n-t,g=i-c;g=Math.max(Math.abs(g),h)*(g<0?-1:1);let m=a,p=o;if(!Number.isFinite(m)||!Number.isFinite(p))return e;m=m*f/g,p=p*f/g;let S=1-_,E=.5,D=0;if(Math.abs(u-.33333334)<1e-4&&Math.abs(_-.33333334)<1e-4)E=d,D=1-E;else for(;;){D=1-E;let e=3*D*D*E*u+3*D*E*E*S+E*E*E-d;if(Math.abs(e)<=2.5*h)break;let t=3*D*D*u+6*D*E*(S-u)+3*E*E*(1-S),r=6*D*(S-2*u)+6*E*(1-2*S+u);E-=(6*e*t*t-3*e*e*r)/(6*t*t*t-6*e*t*r+e*e*(18*u-18*S+6))}return(3*D*D*E*u*m+3*D*E*E*(1-_*p)+E*E*E)*g+c}_curveInterpolate(e,t,r,a){return!e.weightedMode||this._weightModeHermite(e.weightedMode,t.weightedMode)?this._hermiteInterpolate(e,t,r,a):this._hermiteCurveSplineWeight(e.value,e.time,e.outWeight,e.outTangent,t.value,t.time,t.inWeight,t.inTangent,r)}_evaluateClipDatasRealTime(r,a,i,n,s,o,l){for(var h=0,d=r.count;h<d;h++){var c,u=r.getNodeByIndex(h),_=u.type,f=u._keyFrames,g=f.length,m=i[h];if(!l||l.getTransformActive(u.nodePath)){if(s)for(-1!==m&&a<f[m].time&&(m=-1,i[h]=m),c=m+1;c<g&&!(f[c].time>a);)m++,c++,i[h]=m;else for((c=m+1)!==g&&a>f[c].time&&(m=g-1,i[h]=m),c=m+1;m>-1&&!(f[m].time<a);)m--,c--,i[h]=m;var p=c===g;switch(_){case e.KeyFrameValueType.Boolean:o[h]=-1!==m?f[m].value:f[0].value;break;case e.KeyFrameValueType.Float:if(-1!==m){var S=f[m];if(p)o[h]=S.value;else{var E,D=f[c],T=D.time-S.time;E=0!==T?(a-S.time)/T:0,o[h]=this._curveInterpolate(S,D,E,T)}}else o[h]=f[0].value;n&&(o[h]=o[h]-f[0].value);break;case e.KeyFrameValueType.Position:case e.KeyFrameValueType.RotationEuler:case e.KeyFrameValueType.Vector3:var A=o[h];if(this._evaluateFrameNodeVector3DatasRealTime(f,m,p,a,A),n){var x=f[0].value;A.x-=x.x,A.y-=x.y,A.z-=x.z}break;case e.KeyFrameValueType.Rotation:var R=o[h];if(this._evaluateFrameNodeQuaternionDatasRealTime(f,m,p,a,R),n){var M=Xr._tempQuaternion0,C=f[0].value;K.quaternionConjugate(C,M),t.Quaternion.multiply(M,R,R)}break;case e.KeyFrameValueType.Scale:A=o[h],this._evaluateFrameNodeVector3DatasRealTime(f,m,p,a,A),n&&(x=f[0].value,A.x/=x.x,A.y/=x.y,A.z/=x.z);break;case e.KeyFrameValueType.Vector2:var I=o[h];if(this._evaluateFrameNodeVector2DatasRealTime(f,m,p,a,I),n){var v=f[0].value;I.x-=v.x,I.y-=v.y}break;case e.KeyFrameValueType.Vector4:case e.KeyFrameValueType.Color:var y=o[h];if(this._evaluateFrameNodeVector4DatasRealTime(f,m,p,a,y),n){var B=f[0].value;y.x-=B.x,y.y-=B.y,y.z-=B.z,y.w-=B.w}break;default:throw new Error("AnimationClip:unknown node type.")}}}}_evaluateFrameNodeVector3DatasRealTime(e,t,r,a,i){if(-1!==t){var n=e[t];if(r){var s=n.value;i.x=s.x,i.y=s.y,i.z=s.z}else{var o,l=e[t+1],h=n.time,d=l.time-h;o=0!==d?(a-h)/d:0,this._hermiteInterpolateVector3(n,l,o,d,i)}}else{var c=e[0].value;i.x=c.x,i.y=c.y,i.z=c.z}}_evaluateFrameNodeVector2DatasRealTime(e,t,r,a,i){if(-1!==t){var n=e[t];if(r){var s=n.value;i.x=s.x,i.y=s.y}else{var o,l=e[t+1],h=n.time,d=l.time-h;o=0!==d?(a-h)/d:0,this._hermiteInterpolateVector2(n,l,o,d,i)}}else{var c=e[0].value;i.x=c.x,i.y=c.y}}_evaluateFrameNodeVector4DatasRealTime(e,t,r,a,i){if(-1!==t){var n=e[t];if(r){var s=n.value;i.x=s.x,i.y=s.y,i.z=s.z}else{var o,l=e[t+1],h=n.time,d=l.time-h;o=0!==d?(a-h)/d:0,this._hermiteInterpolateVector4(n,l,o,d,i)}}else{var c=e[0].value;i.x=c.x,i.y=c.y,i.z=c.z}}_evaluateFrameNodeQuaternionDatasRealTime(e,t,r,a,i){if(-1!==t){var n=e[t];if(r){var s=n.value;i.x=s.x,i.y=s.y,i.z=s.z,i.w=s.w}else{var o,l=e[t+1],h=n.time,d=l.time-h;o=0!==d?(a-h)/d:0,this._hermiteInterpolateQuaternion(n,l,o,d,i)}}else{var c=e[0].value;i.x=c.x,i.y=c.y,i.z=c.z,i.w=c.w}}_binarySearchEventIndex(e){for(var t,r=0,a=this._animationEvents.length-1;r<=a;){t=Math.floor((r+a)/2);var i=this._animationEvents[t].time;if(i==e)return t;i>e?a=t-1:r=t+1}return r}addEvent(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)}_disposeResource(){this._nodes=null,this._nodesMap=null}}Xr._tempQuaternion0=new t.Quaternion;class Kr extends x{get color(){return this._light.color}set color(e){this._light.color=e}get mode(){return this._light.lightmapBakedType}set mode(e){this._light.lightmapBakedType=e}get intensity(){return this._light.intensity}set intensity(e){this._light.intensity=e}get shadowMode(){return this._light.shadowMode}set shadowMode(e){this._light.shadowMode=e}get shadowDistance(){return this._light.shadowDistance}set shadowDistance(e){this._light.shadowDistance=e}get shadowResolution(){return this._light.shadowResolution}set shadowResolution(e){this._light.shadowResolution=e}get shadowDepthBias(){return this._light.shadowDepthBias}set shadowDepthBias(e){this._light.shadowDepthBias=e}get shadowNormalBias(){return this._light.shadowNormalBias}set shadowNormalBias(e){this._light.shadowNormalBias=e}get shadowStrength(){return this._light.shadowStrength}set shadowStrength(e){this._light.shadowStrength=e}get shadowNearPlane(){return this._light.shadowNearPlane}set shadowNearPlane(e){this._light.shadowNearPlane=e}get lightmapBakedType(){return this._light.lightmapBakedType}set lightmapBakedType(e){this._light.lightmapBakedType=e}get lightWorldMatrix(){return this._light.lightWorldMatrix}constructor(){super()}_cloneTo(e,t,r){super._cloneTo(e,t,r),e.color=this.color.clone(),e.intensity=this.intensity,e.lightmapBakedType=this.lightmapBakedType}_addToLightQueue(){}_removeFromLightQueue(){}}class Jr extends t.Material{get color(){return this.getColorByIndex(S.ALBEDOCOLOR)}set color(e){this.setColorByIndex(S.ALBEDOCOLOR,e)}get texture(){return this.getTextureByIndex(S.ALBEDOTEXTURE)}set texture(e){e?this.addDefine(S.SHADERDEFINE_ALBEDOTEXTURE):this.removeDefine(S.SHADERDEFINE_ALBEDOTEXTURE),this.setTextureByIndex(S.ALBEDOTEXTURE,e)}get tilingOffset(){return this.getVector4ByIndex(S.TILINGOFFSET)}set tilingOffset(e){e?this.setVector4ByIndex(S.TILINGOFFSET,e):this.getVector4ByIndex(S.TILINGOFFSET).setValue(1,1,0,0)}constructor(){super(),this.setShaderName("Unlit"),this.setVector4ByIndex(S.TILINGOFFSET,new t.Vector4(1,1,0,0)),this.setColorByIndex(S.ALBEDOCOLOR,new t.Color(1,1,1,1)),this.renderMode=Jr.RENDERMODE_ADDTIVE}clone(){var e=new Jr;return this.cloneTo(e),e}set renderMode(e){switch(e){case Jr.RENDERMODE_ADDTIVE:this.renderQueue=t.Material.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=a.CULL_NONE,this.blend=a.BLEND_ENABLE_ALL,this.blendSrc=a.BLENDPARAM_SRC_ALPHA,this.blendDst=a.BLENDPARAM_ONE,this.depthTest=a.DEPTHTEST_LEQUAL,this.addDefine(t.Material.SHADERDEFINE_ADDTIVEFOG);break;case Jr.RENDERMODE_ALPHABLENDED:this.renderQueue=t.Material.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=a.CULL_NONE,this.blend=a.BLEND_ENABLE_ALL,this.blendSrc=a.BLENDPARAM_SRC_ALPHA,this.blendDst=a.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=a.DEPTHTEST_LEQUAL,this.removeDefine(t.Material.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("unknown renderMode: "+e)}}}Jr.RENDERMODE_ADDTIVE=0,Jr.RENDERMODE_ALPHABLENDED=1;class jr extends t.Material{static __initDefine__(){jr.SHADERDEFINE_DETAIL_NUM1=t.Shader3D.getDefineByName("ExtendTerrain_DETAIL_NUM1"),jr.SHADERDEFINE_DETAIL_NUM2=t.Shader3D.getDefineByName("ExtendTerrain_DETAIL_NUM2"),jr.SHADERDEFINE_DETAIL_NUM3=t.Shader3D.getDefineByName("ExtendTerrain_DETAIL_NUM3"),jr.SHADERDEFINE_DETAIL_NUM4=t.Shader3D.getDefineByName("ExtendTerrain_DETAIL_NUM4"),jr.SHADERDEFINE_DETAIL_NUM5=t.Shader3D.getDefineByName("ExtendTerrain_DETAIL_NUM5"),jr.SPLATALPHATEXTURE=t.Shader3D.propertyNameToID("u_SplatAlphaTexture"),jr.DIFFUSETEXTURE1=t.Shader3D.propertyNameToID("u_DiffuseTexture1"),jr.DIFFUSETEXTURE2=t.Shader3D.propertyNameToID("u_DiffuseTexture2"),jr.DIFFUSETEXTURE3=t.Shader3D.propertyNameToID("u_DiffuseTexture3"),jr.DIFFUSETEXTURE4=t.Shader3D.propertyNameToID("u_DiffuseTexture4"),jr.DIFFUSETEXTURE5=t.Shader3D.propertyNameToID("u_DiffuseTexture5"),jr.DIFFUSESCALEOFFSET1=t.Shader3D.propertyNameToID("u_DiffuseScaleOffset1"),jr.DIFFUSESCALEOFFSET2=t.Shader3D.propertyNameToID("u_DiffuseScaleOffset2"),jr.DIFFUSESCALEOFFSET3=t.Shader3D.propertyNameToID("u_DiffuseScaleOffset3"),jr.DIFFUSESCALEOFFSET4=t.Shader3D.propertyNameToID("u_DiffuseScaleOffset4"),jr.DIFFUSESCALEOFFSET5=t.Shader3D.propertyNameToID("u_DiffuseScaleOffset5")}get splatAlphaTexture(){return this._shaderValues.getTexture(jr.SPLATALPHATEXTURE)}set splatAlphaTexture(e){this._shaderValues.setTexture(jr.SPLATALPHATEXTURE,e)}get diffuseTexture1(){return this._shaderValues.getTexture(jr.DIFFUSETEXTURE1)}set diffuseTexture1(e){this._shaderValues.setTexture(jr.DIFFUSETEXTURE1,e),this._setDetailNum(1)}get diffuseTexture2(){return this._shaderValues.getTexture(jr.DIFFUSETEXTURE2)}set diffuseTexture2(e){this._shaderValues.setTexture(jr.DIFFUSETEXTURE2,e),this._setDetailNum(2)}get diffuseTexture3(){return this._shaderValues.getTexture(jr.DIFFUSETEXTURE3)}set diffuseTexture3(e){this._shaderValues.setTexture(jr.DIFFUSETEXTURE3,e),this._setDetailNum(3)}get diffuseTexture4(){return this._shaderValues.getTexture(jr.DIFFUSETEXTURE4)}set diffuseTexture4(e){this._shaderValues.setTexture(jr.DIFFUSETEXTURE4,e),this._setDetailNum(4)}get diffuseTexture5(){return this._shaderValues.getTexture(jr.DIFFUSETEXTURE5)}set diffuseTexture5(e){this._shaderValues.setTexture(jr.DIFFUSETEXTURE5,e),this._setDetailNum(5)}set diffuseScaleOffset1(e){this._shaderValues.setVector(jr.DIFFUSESCALEOFFSET1,e)}set diffuseScaleOffset2(e){this._shaderValues.setVector(jr.DIFFUSESCALEOFFSET2,e)}set diffuseScaleOffset3(e){this._shaderValues.setVector(jr.DIFFUSESCALEOFFSET3,e)}set diffuseScaleOffset4(e){this._shaderValues.setVector(jr.DIFFUSESCALEOFFSET4,e)}set diffuseScaleOffset5(e){this._shaderValues.setVector(jr.DIFFUSESCALEOFFSET5,e)}set renderMode(e){switch(e){case jr.RENDERMODE_OPAQUE:this.renderQueue=t.Material.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=a.CULL_BACK,this.blend=a.BLEND_DISABLE,this.depthTest=a.DEPTHTEST_LESS;break;case jr.RENDERMODE_TRANSPARENT:this.renderQueue=t.Material.RENDERQUEUE_OPAQUE,this.depthWrite=!1,this.cull=a.CULL_BACK,this.blend=a.BLEND_ENABLE_ALL,this.blendSrc=a.BLENDPARAM_SRC_ALPHA,this.blendDst=a.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=a.DEPTHTEST_LEQUAL;break;default:throw new Error("unknown renderMode: "+e)}}constructor(){super(),this.setShaderName("ExtendTerrain"),this.renderMode=jr.RENDERMODE_OPAQUE}_setDetailNum(e){switch(e){case 1:this._shaderValues.addDefine(jr.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._shaderValues.addDefine(jr.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._shaderValues.addDefine(jr.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._shaderValues.addDefine(jr.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._shaderValues.addDefine(jr.SHADERDEFINE_DETAIL_NUM5),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(jr.SHADERDEFINE_DETAIL_NUM4)}}clone(){var e=new jr;return this.cloneTo(e),e}}jr.RENDERMODE_OPAQUE=1,jr.RENDERMODE_TRANSPARENT=2;class qr extends B{get meshFilter(){return this._meshFilter}get skinnedMeshRenderer(){return this._render}constructor(e=null,t=null){super(t),this._meshFilter=this.addComponent(A),this._render=this.addComponent(xr),e&&(this._meshFilter.sharedMesh=e)}destroy(e=!0){this._destroyed||(super.destroy(e),this._meshFilter.destroy())}}qr._tempArray0=[];class Zr{constructor(){this._coefficients=new Float32Array(27)}getCoefficient(e,t){return this._coefficients[9*e+t]}setCoefficient(e,t,r){this._coefficients[9*e+t]=r}setCoefficients(e,t,r,a,i,n,s,o,l,h){var d=9*e;this._coefficients[d]=t,this._coefficients[++d]=r,this._coefficients[++d]=a,this._coefficients[++d]=i,this._coefficients[++d]=n,this._coefficients[++d]=s,this._coefficients[++d]=o,this._coefficients[++d]=l,this._coefficients[++d]=h}cloneTo(e){if(this!==e)for(var t=this._coefficients,r=e._coefficients,a=0;a<27;a++)r[a]=t[a]}}Zr._default=new Zr;const $r=new Float32Array(9),ea=new Float32Array(9),ta=new Float32Array(9);class ra{static surfaceArea(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static uv2Dir(e,r,a,i){switch(a){case t.TextureCubeFace.PositiveX:i.x=1,i.y=-r,i.z=-e;break;case t.TextureCubeFace.NegativeX:i.x=-1,i.y=-r,i.z=e;break;case t.TextureCubeFace.PositiveY:i.x=e,i.y=1,i.z=r;break;case t.TextureCubeFace.NegativeY:i.x=e,i.y=-1,i.z=-r;break;case t.TextureCubeFace.PositiveZ:i.x=e,i.y=-r,i.z=1;break;case t.TextureCubeFace.NegativeZ:i.x=-e,i.y=-r,i.z=-1}}static sh_eval_9(e,t,r,a){const i=Math.sqrt,n=Math.PI;switch(e){case 0:return.5*i(1/n);case 1:return.5*-r*i(3/n);case 2:return.5*a*i(3/n);case 3:return.5*-t*i(3/n);case 4:return t*r*.5*i(15/n);case 5:return-r*a*.5*i(15/n);case 6:return.25*(3*a*a-1)*i(5/n);case 7:return-t*a*.5*i(15/n);case 8:return.25*(t*t-r*r)*i(15/n);default:return 0}}static CalCubemapSH(e,r,a,i=!0){let n=a,s=a,o=$r.fill(0),l=ea.fill(0),h=ta.fill(0),d=new t.Vector3;for(let a=0;a<6;a++){let c=e[a];for(let e=0;e<s;e++)for(let u=0;u<n;u++){let _=(u+.5)/n*2-1,f=(e+.5)/s*2-1,g=1/n,m=1/s,p=_-g,S=f-m,E=_+g,D=f+m,T=this.surfaceArea(p,S)-this.surfaceArea(p,D)-this.surfaceArea(E,S)+this.surfaceArea(E,D);this.uv2Dir(_,f,a,d),t.Vector3.normalize(d,d);let A=(u+e*n)*r,x=c[A],R=c[A+1],M=c[A+2];i&&(x=t.Color.gammaToLinearSpace(x),R=t.Color.gammaToLinearSpace(R),M=t.Color.gammaToLinearSpace(M));for(let e=0;e<this.SH_Count;e++){let t=this.sh_eval_9(e,d.x,d.y,d.z);o[e]+=x*t*T,l[e]+=R*t*T,h[e]+=M*t*T}}}let c=new Zr;for(let e=0;e<this.SH_Count;e++){let t=this.k[e],r=o[e];c.setCoefficient(0,e,r*t);let a=l[e];c.setCoefficient(1,e,a*t);let i=h[e];c.setCoefficient(2,e,i*t)}return c}static CalGradientSH(e,r,a,i=!0){console.time("Gradient SH");let n=this._tempSkyPixels,s=this._tempEquatorPixels,o=this._tempGroundPixels;const l=(e,r,a)=>{let i=new t.Color(r.x,r.y,r.z,1);a&&i.toLinear(i);let n=Math.min(i.r,1),s=Math.min(i.g,1),o=Math.min(i.b,1);for(let t=0;t<e.length;t+=3)e[t]=n,e[t+1]=s,e[t+2]=o};l(n,e,i),l(s,r,i),l(o,a,i);let h=[];h[t.TextureCubeFace.PositiveY]=n,h[t.TextureCubeFace.NegativeY]=o,h[t.TextureCubeFace.PositiveX]=s,h[t.TextureCubeFace.NegativeX]=s,h[t.TextureCubeFace.PositiveZ]=s,h[t.TextureCubeFace.NegativeZ]=s;let d=ra.CalCubemapSH(h,3,this.GradientSimulateSize,!1);return console.timeEnd("Gradient SH"),d}}ra.k=[.28209479177387814,-.32573500793527993,.32573500793527993,-.32573500793527993,.2731371076480198,-.2731371076480198,.07884789131313,-.2731371076480198,.1365685538240099],ra.GradientSimulateSize=3,ra.SH_Count=9,ra._tempSkyPixels=new Float32Array(ra.GradientSimulateSize*ra.GradientSimulateSize*3),ra._tempEquatorPixels=new Float32Array(ra.GradientSimulateSize*ra.GradientSimulateSize*3),ra._tempGroundPixels=new Float32Array(ra.GradientSimulateSize*ra.GradientSimulateSize*3);class aa{constructor(e,t){this.min=e,this.max=t}_rotateExtents(e,t,r){var a=e.x,i=e.y,n=e.z,s=t.elements;r.x=Math.abs(s[0]*a)+Math.abs(s[4]*i)+Math.abs(s[8]*n),r.y=Math.abs(s[1]*a)+Math.abs(s[5]*i)+Math.abs(s[9]*n),r.z=Math.abs(s[2]*a)+Math.abs(s[6]*i)+Math.abs(s[10]*n)}getCorners(e){e.length=8;var r=this.min.x,a=this.min.y,i=this.min.z,n=this.max.x,s=this.max.y,o=this.max.z;e[0]=new t.Vector3(r,s,o),e[1]=new t.Vector3(n,s,o),e[2]=new t.Vector3(n,a,o),e[3]=new t.Vector3(r,a,o),e[4]=new t.Vector3(r,s,i),e[5]=new t.Vector3(n,s,i),e[6]=new t.Vector3(n,a,i),e[7]=new t.Vector3(r,a,i)}getCenter(e){t.Vector3.add(this.min,this.max,e),t.Vector3.scale(e,.5,e)}getExtent(e){t.Vector3.subtract(this.max,this.min,e),t.Vector3.scale(e,.5,e)}setCenterAndExtent(e,r){t.Vector3.subtract(e,r,this.min),t.Vector3.add(e,r,this.max)}tranform(e,r){var a=ia,i=na;this.getCenter(a),this.getExtent(i),t.Vector3.transformCoordinate(a,e,a),this._rotateExtents(i,e,i),r.setCenterAndExtent(a,i)}toDefault(){this.min.toDefault(),this.max.toDefault()}static createfromPoints(e,r){if(null==e)throw new Error("points");var a=r.min,i=r.max;a.x=Number.MAX_VALUE,a.y=Number.MAX_VALUE,a.z=Number.MAX_VALUE,i.x=-Number.MAX_VALUE,i.y=-Number.MAX_VALUE,i.z=-Number.MAX_VALUE;for(var n=0,s=e.length;n<s;++n)t.Vector3.min(a,e[n],a),t.Vector3.max(i,e[n],i)}static merge(e,r,a){t.Vector3.min(e.min,r.min,a.min),t.Vector3.max(e.max,r.max,a.max)}cloneTo(e){this.min.cloneTo(e.min),this.max.cloneTo(e.max)}clone(){var e=new aa(new t.Vector3,new t.Vector3);return this.cloneTo(e),e}}const ia=new t.Vector3,na=new t.Vector3;class sa extends lt{get direction(){return this._direction}set direction(e){e.cloneTo(this.direction),this._dataModule.setDirection(this._direction)}get shadowCascadesMode(){return this._dataModule.shadowCascadesMode}set shadowCascadesMode(e){this._dataModule.shadowCascadesMode=e}get shadowTwoCascadeSplits(){return this._dataModule.shadowTwoCascadeSplits}set shadowTwoCascadeSplits(e){this._dataModule.shadowTwoCascadeSplits=e}get shadowFourCascadeSplits(){return this._shadowFourCascadeSplits}set shadowFourCascadeSplits(e){if(e.x>e.y||e.y>e.z||e.z>1)throw"DiretionLight:Invalid value.";e.cloneTo(this._shadowFourCascadeSplits),this._dataModule.setShadowFourCascadeSplits(this._shadowFourCascadeSplits)}constructor(){super(),this._direction=new t.Vector3,this._shadowTwoCascadeSplits=1/3,this._shadowFourCascadeSplits=new t.Vector3,this._lightType=e.LightType.Directional,this.shadowCascadesMode=e.ShadowCascadesMode.NoCascades,this.shadowFourCascadeSplits=new t.Vector3(1/15,.2,7/15),this.shadowTwoCascadeSplits=1/3}_creatModuleData(){this._dataModule=E.Render3DModuleDataFactory.createDirectLight()}_addToLightQueue(){this.owner.scene._directionLights.add(this)}_removeFromLightQueue(){this.owner.scene._directionLights.remove(this)}}class oa extends lt{get range(){return this._range}set range(e){this._range=e,this._dataModule.range=e}constructor(){super(),this._lightType=e.LightType.Point,this.range=6}_creatModuleData(){this._dataModule=E.Render3DModuleDataFactory.createPointLight()}_addToLightQueue(){this.owner.scene._pointLights.add(this)}_removeFromLightQueue(){this.owner.scene._pointLights.remove(this)}_cloneTo(t){super._cloneTo(t),t.range=this.range,t._lightType=e.LightType.Point}}class la extends lt{get direction(){return this._direction}set direction(e){e.cloneTo(this.direction),this._dataModule.setDirection(this._direction)}get spotAngle(){return this._dataModule.spotAngle}set spotAngle(e){this._dataModule.spotAngle=Math.max(Math.min(e,179),0)}get range(){return this._dataModule.spotRange}set range(e){this._dataModule.spotRange=e}constructor(){super(),this.spotAngle=30,this.range=10,this._direction=new t.Vector3,this._lightType=e.LightType.Spot}_creatModuleData(){this._dataModule=E.Render3DModuleDataFactory.createSpotLight()}_addToLightQueue(){this.owner.scene._spotLights.add(this)}_removeFromLightQueue(){this.owner.scene._spotLights.remove(this)}_cloneTo(e){super._cloneTo(e),e.range=this.range,e.spotAngle=this.spotAngle}}var ha;e.AreaShape=void 0,(ha=e.AreaShape||(e.AreaShape={}))[ha.rectangle=0]="rectangle",ha[ha.ellipse=1]="ellipse";class da extends lt{constructor(){super(),this._lightType=e.LightType.Area,this._lightmapBakedType=e.LightMode.bakeOnly,this._spread=90,this._maxBounces=1024,this._size=new t.Vector2(1,1),this._areaShape=e.AreaShape.rectangle,this._power=100}_creatModuleData(){this._dataModule={transform:null,range:0,shadowResolution:1,shadowDistance:1,shadowMode:null,shadowStrength:1,shadowDepthBias:1,shadowNormalBias:1,shadowNearPlane:1}}get lightmapBakedType(){return e.LightMode.bakeOnly}set lightmapBakedType(t){this._lightmapBakedType=e.LightMode.bakeOnly}get shape(){return this._areaShape}set shape(e){this._areaShape=e}get power(){return this._power}set power(e){this._power=e}get size(){return this._size}set size(e){e&&e.cloneTo(this._size)}get spread(){return this._spread}set spread(e){this._spread=Math.min(Math.max(0,e),180)}get maxBounces(){return this._maxBounces}set maxBounces(e){this._maxBounces=e}_addToLightQueue(){}_removeFromLightQueue(){}}const ca=new t.Vector3;class ua{constructor(e){this._mincullRate=e,this._renders=[],this._cachSprite3D=[]}get mincullRate(){return this._mincullRate}set mincullRate(e){this._mincullRate=e}set group(e){if(e!=this._group){if(this._group)for(let e=0,r=this._renders.length;e<r;e++){let r=this._renders[e];r.owner.transform.off(t.Event.TRANSFORM_CHANGED,this._group._updateRecaculateFlag),r._LOD=-1}this._group=e;for(let e=0,r=this._renders.length;e<r;e++){let r=this._renders[e];r.owner.transform.on(t.Event.TRANSFORM_CHANGED,this._group,this._group._updateRecaculateFlag),r._LOD=this._lodIndex}}}get renders(){return this._cachSprite3D}set renders(e){this._cachSprite3D=e;for(var t=0,r=e.length;t<r;t++)this.addNode(e[t])}addNode(e){if(!e)return;let r=e;if(r._isRenderNode>0){let a=r.components;for(let e of a)e instanceof U&&-1==this._renders.indexOf(e)&&this._renders.push(e);this._group&&e.transform.on(t.Event.TRANSFORM_CHANGED,this._group,this._group._updateRecaculateFlag)}for(var a=0,i=e.numChildren;a<i;a++)this.addNode(e.getChildAt(a))}removeNode(r){let a=r;if(a._isRenderNode>0){let i,n=a.components;for(let a of n)a instanceof U&&-1==(i=this._renders.indexOf(a))&&(this._renders.splice(i,1),a.setRenderbitFlag(e.RenderBitFlag.RenderBitFlag_CullFlag,!1),this._group&&r.transform.off(t.Event.TRANSFORM_CHANGED,this._group._updateRecaculateFlag))}for(var i=0,n=r.numChildren;i<n;i++)this.removeNode(r.getChildAt(i))}removeAllRender(){this._renders.forEach((t=>{t.setRenderbitFlag(e.RenderBitFlag.RenderBitFlag_CullFlag,!1)}))}}class _a extends t.Component{constructor(){super(),this._needcaculateBounds=!1,this._lods=[],this._visialIndex=-1,this._bounds=new w,this._lodPosition=new t.Vector3,this.runInEditor=!0}shadowCullPass(){return!1}get visialIndex(){return this._visialIndex}get lods(){return this._lods}set lods(e){this._lods=e;for(var t=0,r=this._lods.length;t<r;t++){let e=this._lods[t];e._lodIndex=t,e.group=this}this._updateRecaculateFlag(),this._lodCount=this._lods.length}get nowRate(){return this._nowRate}get bounds(){return this.recalculateBounds(),this._bounds}_onEnable(){super._onEnable();for(var e=0,t=this._lods.length;e<t;e++)this._setLODinvisible(e);this._visialIndex=-1,this._applyVisibleRate(1)}_onDisable(){super._onDisable(),this._lods.forEach((e=>{e.removeAllRender()}))}_applyVisibleRate(e){for(var t=0;t<this._lodCount;t++){if(e>this._lods[t].mincullRate)return-1==t?(this._setLODvisible(t),void(this._visialIndex=t)):t==this._visialIndex?void 0:(-1!=this._visialIndex&&this._setLODinvisible(this._visialIndex),this._setLODvisible(t),void(this._visialIndex=t))}-1!=this._visialIndex&&(this._setLODinvisible(this._visialIndex),this._visialIndex=-1)}_setLODvisible(t){let r=this._lods[t];for(var a=0,i=r._renders.length;a<i;a++)r._renders[a].setRenderbitFlag(e.RenderBitFlag.RenderBitFlag_CullFlag,!1)}_setLODinvisible(t){let r=this._lods[t];for(var a=0,i=r._renders.length;a<i;a++)r._renders[a].setRenderbitFlag(e.RenderBitFlag.RenderBitFlag_CullFlag,!0)}onDestroy(){this._lods.forEach((e=>{let t=e._renders;for(var r=0;r<t.length;r++)e.removeNode(t[r].owner)}))}_updateRecaculateFlag(){this._needcaculateBounds=!0}_cloneTo(e){super._cloneTo(e);let t=(e,t,r)=>{let a=((e,t)=>{let r=[],a=e;for(;a;)a instanceof x&&r.push(a),a=a.parent;let i=t;for(;i&&-1==r.indexOf(i);)i=i.parent;return i})(e,t);if(!a)return null;let i=[];K._getHierarchyPath(a,e,i);let n=[];K._getHierarchyPath(a,t,n);let s=K._getParentNodeByHierarchyPath(r,i);return s?K._getNodeByHierarchyPath(s,n):null},r=[];for(let a=0,i=this._lodCount;a<i;a++){let i=this._lods[a],n=new ua(i.mincullRate);r.push(n),i._renders.forEach((r=>{let a=t(this.owner,r.owner,e.owner);a&&n.addNode(a)}))}e.lods=r}recalculateBounds(){if(!this._needcaculateBounds)return;let e=!0;for(let t=0,r=this._lods.length;t<r;t++){this._lods[t]._renders.forEach((t=>{e?(t.bounds.cloneTo(this._bounds),e=!1):w.merge(this._bounds,t.bounds,this._bounds)}))}this._lodPosition=this._bounds._imp.getCenter();let t=this._bounds.getExtent();this._size=2*Math.max(t.x,t.y,t.z),this._needcaculateBounds=!1}onPreRender(){this.recalculateBounds();let e=this.owner.scene.cullInfoCamera,r=e.maxlocalYDistance,a=e.boundFrustum;t.Vector3.subtract(this._lodPosition,e.transform.position,ca);let i=ca.length();if(i>e.farPlane||0==a.containsPoint(this._lodPosition))return;let n=i/e.farPlane*r,s=this._size/n;this._nowRate=s,this._applyVisibleRate(s)}}class fa{constructor(){this.startPosition=new t.Vector3,this.endPosition=new t.Vector3,this.startColor=new t.Color,this.endColor=new t.Color,this.startNormal=new t.Vector3,this.endNormal=new t.Vector3}cloneTo(e){this.startPosition.cloneTo(e.startPosition),this.endPosition.cloneTo(e.endPosition),this.startColor.cloneTo(e.startColor),this.endColor.cloneTo(e.endColor),this.startNormal.cloneTo(e.startPosition),this.endNormal.cloneTo(e.endPosition)}}class ga extends xe{constructor(e,r){super(t.MeshTopology.Lines,t.DrawType.DrawArray),this._floatCountPerVertices=10,this._minUpdate=Number.MAX_VALUE,this._maxUpdate=Number.MIN_VALUE,this._floatBound=new Float32Array(6),this._calculateBound=!0,this._maxLineCount=0,this._lineCount=0;var a=2*r;this._ownerRender=e,this._maxLineCount=r,this._vertices=new Float32Array(a*this._floatCountPerVertices),this._vertexBuffer=E.renderOBJCreate.createVertexBuffer3D(W.vertexDeclaration.vertexStride*a,t.BufferUsage.Static,!1),this._vertexBuffer.vertexDeclaration=W.vertexDeclaration;var i=new t.BufferState;this.bufferState=i,this.bufferState.applyState([this._vertexBuffer],null);var n=ma,s=pa;n.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._bounds=new w(n,s)}_getType(){return ga._type}_resizeLineData(e){var r=2*e,a=this._vertices;this._vertexBuffer.destroy(),this._maxLineCount=e;var i=r*this._floatCountPerVertices;this._vertices=new Float32Array(i),this._vertexBuffer=E.renderOBJCreate.createVertexBuffer3D(W.vertexDeclaration.vertexStride*r,t.BufferUsage.Static,!1),this._vertexBuffer.vertexDeclaration=W.vertexDeclaration,i<a.length?(this._vertices.set(new Float32Array(a.buffer,0,i)),this._vertexBuffer.setData(this._vertices.buffer,0,0,4*i)):(this._vertices.set(a),this._vertexBuffer.setData(this._vertices.buffer,0,0,4*a.length)),this.bufferState.applyState([this._vertexBuffer],null),this._minUpdate=Number.MAX_VALUE,this._maxUpdate=Number.MIN_VALUE}_updateLineVertices(e,r,a,i,n,s=null,o=null){r&&(this._vertices[e+0]=r.x,this._vertices[e+1]=r.y,this._vertices[e+2]=r.z),i&&(this._vertices[e+3]=i.r,this._vertices[e+4]=i.g,this._vertices[e+5]=i.b,this._vertices[e+6]=i.a),s&&(this._vertices[e+7]=s.x,this._vertices[e+8]=s.y,this._vertices[e+9]=s.z),a&&(this._vertices[e+10]=a.x,this._vertices[e+11]=a.y,this._vertices[e+12]=a.z),n&&(this._vertices[e+13]=n.r,this._vertices[e+14]=n.g,this._vertices[e+15]=n.b,this._vertices[e+16]=n.a),o&&(this._vertices[e+17]=o.x,this._vertices[e+18]=o.y,this._vertices[e+19]=o.z),this._minUpdate=Math.min(this._minUpdate,e),this._maxUpdate=Math.max(this._maxUpdate,e+2*this._floatCountPerVertices);var l=this._bounds,h=this._floatBound,d=l.getMin(),c=l.getMax();t.Vector3.min(d,r,d),t.Vector3.min(d,a,d),t.Vector3.max(c,r,c),t.Vector3.max(c,a,c),l.setMin(d),l.setMax(c),h[0]=d.x,h[1]=d.y,h[2]=d.z,h[3]=c.x,h[4]=c.y,h[5]=c.z,this._ownerRender.boundsChange=!0}_reCalculateBound(){if(this._calculateBound){var e=this._vertices,t=ma,r=pa;t.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var a=0;a<2*this._lineCount;++a){var i=this._floatCountPerVertices*a,n=e[i+0],s=e[i+1],o=e[i+2];t.x=Math.min(n,t.x),t.y=Math.min(s,t.y),t.z=Math.min(o,t.z),r.x=Math.max(n,r.x),r.y=Math.max(s,r.y),r.z=Math.max(o,r.z)}this._bounds.setMin(t),this._bounds.setMax(r);var l=this._floatBound;l[0]=t.x,l[1]=t.y,l[2]=t.z,l[3]=r.x,l[4]=r.y,l[5]=r.z,this._calculateBound=!1}}_removeLineData(e){var t=2*this._floatCountPerVertices,r=e+1,a=e*t,i=this._vertices,n=new Float32Array(i.buffer,r*t*4,(this._lineCount-r)*t);i.set(n,a),this._minUpdate=Math.min(this._minUpdate,a),this._maxUpdate=Math.max(this._maxUpdate,a+n.length),this._lineCount--;var s=this._floatBound,o=i[a],l=i[a+1],h=i[a+2],d=i[a+7],c=i[a+8],u=i[a+9],_=s[0],f=s[1],g=s[2],m=s[3],p=s[4],S=s[5];o!==_&&o!==m&&l!==f&&l!==p&&h!==g&&h!==S&&d!==_&&d!==m&&c!==f&&c!==p&&u!==g&&u!==S||(this._calculateBound=!0)}_updateLineData(e,t,r,a,i,n=null,s=null){var o=2*this._floatCountPerVertices;this._updateLineVertices(e*o,t,r,a,i,n,s),this._calculateBound=!0}_updateLineDatas(e,t){for(var r=2*this._floatCountPerVertices,a=t.length,i=0;i<a;i++){var n=t[i];this._updateLineVertices((e+i)*r,n.startPosition,n.endPosition,n.startColor,n.endColor,n.startNormal,n.endNormal)}this._calculateBound=t.length>0}_getLineData(e,t){var r=t.startPosition,a=t.startColor,i=t.endPosition,n=t.endColor,s=t.startNormal,o=t.endNormal,l=this._vertices,h=e*this._floatCountPerVertices*2;r.x=l[h+0],r.y=l[h+1],r.z=l[h+2],a.r=l[h+3],a.g=l[h+4],a.b=l[h+5],a.a=l[h+6],s.x=l[h+7],s.y=l[h+8],s.z=l[h+9],i.x=l[h+10],i.y=l[h+11],i.z=l[h+12],n.r=l[h+13],n.g=l[h+14],n.b=l[h+15],n.a=l[h+16],o.x=l[h+17],o.y=l[h+18],o.z=l[h+19]}_prepareRender(e){return!0}_updateRenderParams(e){this.clearRenderParams(),this._minUpdate!==Number.MAX_VALUE&&this._maxUpdate!==Number.MIN_VALUE&&(this._vertexBuffer.setData(this._vertices.buffer,4*this._minUpdate,4*this._minUpdate,4*(this._maxUpdate-this._minUpdate)),this._minUpdate=Number.MAX_VALUE,this._maxUpdate=Number.MIN_VALUE),this._lineCount>0&&this.setDrawArrayParams(0,2*this._lineCount)}destroy(){this._destroyed||(super.destroy(),this.bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferState=null,this._vertexBuffer=null,this._vertices=null)}}ga._type=xe._typeCounter++;const ma=new t.Vector3,pa=new t.Vector3;class Sa extends U{constructor(){super(),this._isRenderActive=!1,this._isInRenders=!1,this._needUpdatelines=!1,this._lines=[],this._projectionViewWorldMatrix=new t.Matrix4x4,this._pixelLineFilter=new ga(this,20),this._baseRenderNode.shaderData.addDefine(D.SHADERDEFINE_COLOR),this.geometryBounds=this._pixelLineFilter._bounds}get bounds(){return this._pixelLineFilter._reCalculateBound(),super.bounds}get pixelLinesDatas(){return this._needUpdatelines&&this._updateLineDatas(),this._lines}set pixelLinesDatas(e){this.clear(),e.length>this._pixelLineFilter._maxLineCount&&(e=e.slice(0,this._pixelLineFilter._maxLineCount),console.warn("reach max line count")),this.addLines(e)}get maxLineCount(){return this._pixelLineFilter._maxLineCount}set maxLineCount(e){this._pixelLineFilter._resizeLineData(e),this._pixelLineFilter._lineCount=Math.min(this._pixelLineFilter._lineCount,e)}get lineCount(){return this._pixelLineFilter._lineCount}_onAdded(){super._onAdded(),this._changeRenderObjects(0,Ir.defaultMaterial)}_onEnable(){this._isRenderActive=!0,0!=this._pixelLineFilter._lineCount&&(this.owner.scene._addRenderObject(this),this._isInRenders=!0),this._setBelongScene(this.owner.scene)}_onDisable(){this._pixelLineFilter&&0!=this._pixelLineFilter._lineCount&&this._isRenderActive&&(this.owner.scene._removeRenderObject(this),this._isInRenders=!1),this._isRenderActive=!1,this._setUnBelongScene()}_createBaseRenderNode(){return E.Render3DModuleDataFactory.createMeshRenderNode()}renderUpdate(e){this._renderElements.forEach(((t,r)=>{var a,i;t._renderElementOBJ.isRender=t._geometry._prepareRender(e),t._geometry._updateRenderParams(e);let n=null!==(a=this.sharedMaterial)&&void 0!==a?a:S.defaultMaterial;n=null!==(i=this.sharedMaterials[r])&&void 0!==i?i:n,t.material=n,t._renderElementOBJ.materialRenderQueue=n.renderQueue}))}_changeRenderObjects(e,t){var r=this._renderElements;t||(t=Ir.defaultMaterial);var a=r[e];a||(a=r[e]=new H),a.setTransform(this.owner._transform),a.setGeometry(this._pixelLineFilter),a.render=this,a.material=t,this._setRenderElements()}_pixelLinesDataChange(e){if(null!=e){let t=parseInt(e),r=this._lines[t];r&&this.setLine(t,r.startPosition,r.endPosition,r.startColor,r.endColor)}}addLine(e,t,r,a){if(this._pixelLineFilter._lineCount===this._pixelLineFilter._maxLineCount)throw new Error("reach max line count");this._pixelLineFilter._updateLineData(this._pixelLineFilter._lineCount++,e,t,r,a),this._isRenderActive&&!this._isInRenders&&this._pixelLineFilter._lineCount>0&&(this.owner.scene&&this.owner.scene._addRenderObject(this),this._isInRenders=!0),this._needUpdatelines=!0}addLineWithNormal(e,t,r,a,i,n){if(this._pixelLineFilter._lineCount===this._pixelLineFilter._maxLineCount)throw new Error("reach max line count");this._pixelLineFilter._updateLineData(this._pixelLineFilter._lineCount++,e,t,r,a,i,n),this._isRenderActive&&!this._isInRenders&&this._pixelLineFilter._lineCount>0&&(this.owner.scene&&this.owner.scene._addRenderObject(this),this._isInRenders=!0),this._needUpdatelines=!0}addLines(e){var t=this._pixelLineFilter._lineCount,r=e.length;if(t+r>this._pixelLineFilter._maxLineCount)throw new Error("reach max line count");this._pixelLineFilter._updateLineDatas(t,e),this._pixelLineFilter._lineCount+=r,this.boundsChange=!0,this._isRenderActive&&!this._isInRenders&&this._pixelLineFilter._lineCount>0&&(this.owner.scene&&this.owner.scene._addRenderObject(this),this._isInRenders=!0),this._needUpdatelines=!0}removeLine(e){if(!(e<this._pixelLineFilter._lineCount))throw new t.OutOfRangeError(e);this._pixelLineFilter._removeLineData(e),this._isRenderActive&&this._isInRenders&&0==this._pixelLineFilter._lineCount&&(this.owner.scene&&this.owner.scene._removeRenderObject(this),this._isInRenders=!1),this._needUpdatelines=!0}setLine(e,r,a,i,n){if(!(e<this._pixelLineFilter._lineCount))throw new t.OutOfRangeError(e);{this._pixelLineFilter._updateLineData(e,r,a,i,n);let t=this._lines[e];t&&(i.cloneTo(t.startColor),n.cloneTo(t.endColor),r.cloneTo(t.startPosition),a.cloneTo(t.endPosition))}}setLineWithNormal(e,r,a,i,n,s,o){if(!(e<this._pixelLineFilter._lineCount))throw new t.OutOfRangeError(e);{this._pixelLineFilter._updateLineData(e,r,a,i,n,s,o);let t=this._lines[e];t&&(i.cloneTo(t.startColor),n.cloneTo(t.endColor),r.cloneTo(t.startPosition),a.cloneTo(t.endPosition),s&&s.cloneTo(t.startNormal),o&&o.cloneTo(t.endNormal))}}getLine(e,r){if(!(e<this.lineCount))throw new t.OutOfRangeError(e);this._pixelLineFilter._getLineData(e,r)}_updateLineDatas(){let e=this.lineCount;this._lines=[];for(let t=0;t<e;t++){let e=new fa;this.getLine(t,e),this._lines.push(e)}this._needUpdatelines=!1}clear(){this._pixelLineFilter._lineCount=0,this._isRenderActive&&this._isInRenders&&(this.owner.scene&&this.owner.scene._removeRenderObject(this),this._isInRenders=!1)}_onDestroy(){this._pixelLineFilter.destroy(),this._pixelLineFilter=null,super._onDestroy()}_cloneTo(e){super._cloneTo(e),e.maxLineCount=this.maxLineCount;const t=this.lineCount;let r=new fa;for(let a=0,i=t;a<i;a++)this.getLine(a,r),e.addLine(r.startPosition,r.endPosition,r.startColor,r.endColor)}}class Ea{get currentState(){return this._currentState}set currentState(e){this._currentState=e,this._currentState.curTransition=null}get normalizedTime(){return this._normalizedTime}get duration(){return this._duration}get animatorState(){return this._currentState}constructor(){this._currentState=null}_resetPlayState(e,t){this._finish=!1,this._playEventIndex=0,this._startPlayTime=e,this._elapsedTime=e,this._lastIsFront=!0,this._normalizedTime=this._elapsedTime/t;var r=this._normalizedTime%1;this._normalizedPlayTime=r<0?r+1:r}_cloneTo(e){e._finish=this._finish,e._startPlayTime=this._startPlayTime,e._playEventIndex=this._playEventIndex,e._elapsedTime=this._elapsedTime,e._normalizedTime=this._normalizedTime,e._normalizedPlayTime=this._normalizedPlayTime,e._lastIsFront=this._lastIsFront}}class Da{get defaultState(){return this._defaultState}set defaultState(e){this._defaultState=e}get avatarMask(){return this._avatarMask}set avatarMask(e){this._avatarMask=e}get defaultStateName(){return this._defaultState?this._defaultState.name:null}set defaultStateName(e){if(this._defaultState=this.getAnimatorState(e),null==this._defaultState)if(0==this._states.length)this._defaultStateNameCatch=e;else for(var t=this._states.length-1;t>=0;t--)if(this._states[t].name==e){this._defaultState=this._states[t];break}}get states(){return this._states}set states(e){if(this._states!==e){if(this._states.length>0){let t=this._states.filter((t=>-1==e.indexOf(t)));for(let e of t)this.removeState(e)}if(e.length>0){let t=e.filter((e=>-1==this._states.indexOf(e)));for(let e of t)this.addState(e)}this._states.length=0,this._states.push(...e)}}constructor(e){this._referenceCount=0,this._playType=-1,this._crossDuration=-1,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwners=[],this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this._states=[],this._playStateInfo=new Ea,this._crossPlayStateInfo=new Ea,this.blendingMode=Da.BLENDINGMODE_OVERRIDE,this.defaultWeight=1,this.playOnWake=!0,this.enable=!0,this.name=e}_removeClip(e,t,r){var a=r._clip,i=e[t];if(e.splice(t,1),this._animator){var n=a._nodes,s=i._nodeOwners;a._removeReference();for(var o=0,l=n.count;o<l;o++)this._animator._removeKeyframeNodeOwner(s,n.getNodeByIndex(o))}}_getReferenceCount(){return this._referenceCount}_addReference(e=1){for(var t=0,r=this._states.length;t<r;t++)this._states[t]._addReference(e);this._referenceCount+=e}_removeReference(e=1){for(var t=0,r=this._states.length;t<r;t++)this._states[t]._removeReference(e);this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}getCurrentPlayState(){return this._playStateInfo}getAnimatorState(e){var t;for(let r=0;r<this._states.length;r++)if(this._states[r].name==e){t=this._states[r];break}return t||null}addState(e){var t=e.name;if(this.getAnimatorState(t))throw new Error("AnimatorControllerLayer:this stat's name has exist.");this._states.push(e),t==this._defaultStateNameCatch&&(this._defaultState=e,this._defaultStateNameCatch=null),this._animator&&(e._clip&&e._clip._addReference(),this._animator._getOwnersByClip(e))}removeState(e){for(var t=this._states,r=-1,a=0,i=t.length;a<i;a++)if(t[a]===e){r=a;break}-1!==r&&this._removeClip(t,r,e)}destroy(){this._clearReference(),this._states=[],this._playStateInfo=null,this._crossPlayStateInfo=null,this._defaultState=null}cloneTo(e){e.name=this.name,e.blendingMode=this.blendingMode,e.defaultWeight=this.defaultWeight,e.playOnWake=this.playOnWake,this.avatarMask&&(e.avatarMask=this._avatarMask.clone())}clone(){var e=new Da(this.name);return this.cloneTo(e),e}}Da.BLENDINGMODE_OVERRIDE=0,Da.BLENDINGMODE_ADDTIVE=1;class Ta{static getAnimatorResource(e,r){return"simpleSkinnedMeshRenderer"===r?e.getComponent(Rr):e.getComponent(t.ClassUtils.getClass(r))}}class Aa extends t.Component{get controller(){return this._controller}set controller(e){this._controller&&this._controller._removeReference(),this._controller=e,e&&(e._addReference(),e.updateTo(this))}get speed(){return this._speed}set speed(e){this._speed=e}set updateMode(e){this._updateMode=e}set lowUpdateDelty(e){this._lowUpdateDelty=e}get controllerLayerCount(){return this._controllerLayers.length}get animatorParams(){return this._animatorParams}set animatorParams(e){this._animatorParams=e}get sleep(){return this._finishSleep}set sleep(e){this._finishSleep=e}constructor(){super(),this._keyframeNodeOwners=[],this._updateMode=t.AnimatorUpdateMode.Normal,this._lowUpdateDelty=20,this._animatorParams={},this._linkAvatarSpritesData={},this._linkAvatarSprites=[],this.cullingMode=Aa.CULLINGMODE_CULLCOMPLETELY,this._finishSleep=!1,this._LateUpdateEvents=new t.Delegate,this._controllerLayers=[],this._speed=1,this._keyframeNodeOwnerMap={},this._updateMark=0}_addKeyframeNodeOwner(r,a,i){var n=a._indexInList,s=a.fullPath,o=this._keyframeNodeOwnerMap[s];let l=!1;if(o)o.referenceCount++,r[n]=o;else{for(var h=i,d=0,c=a.propertyCount;d<c&&((h=h[a.getPropertyByIndex(d)])instanceof t.Material&&(l=!0),h);d++);(o=this._keyframeNodeOwnerMap[s]=new Wr).isMaterial=l,o.fullPath=s,o.indexInList=this._keyframeNodeOwners.length,o.referenceCount=1,o.propertyOwner=i,o.nodePath=a.nodePath,o.callbackFunData=a.callbackFunData,o.callParams=a.callParams,o.getCallbackNode();var u=a.propertyCount,_=[];for(d=0;d<u;d++)_[d]=a.getPropertyByIndex(d);if(o.property=_,o.type=a.type,h)if(a.type===e.KeyFrameValueType.Float||a.type===e.KeyFrameValueType.Boolean)o.defaultValue=h;else{var f=new h.constructor;h.cloneTo(f),o.defaultValue=f,o.value=new h.constructor,o.crossFixedValue=new h.constructor}this._keyframeNodeOwners.push(o),r[n]=o}}_removeKeyframeNodeOwner(e,t){var r=t.fullPath,a=this._keyframeNodeOwnerMap[r];a&&(a.referenceCount--,0===a.referenceCount&&(delete this._keyframeNodeOwnerMap[r],this._keyframeNodeOwners.splice(this._keyframeNodeOwners.indexOf(a),1)),e[t._indexInList]=null)}_getOwnersByClip(e){if(e._clip){var t=e._clip._nodes,r=t.count,a=e._nodeOwners;a.length=r;for(var i=0;i<r;i++){for(var n=t.getNodeByIndex(i),s=this.owner,o=0,l=n.ownerPathCount;o<l;o++){var h=n.getOwnerPathByIndex(o);if(""===h)break;if(!(s=s.getChild(h)))break}if(s){var d=n.propertyOwner;const e=s;d&&(s=s[d]),s||(s=Ta.getAnimatorResource(e,d)),s&&this._addKeyframeNodeOwner(a,n,s)}}}}_updatePlayer(e,t,r,a,i){var n=e._clip._duration*(e.clipEnd-e.clipStart),s=t._elapsedTime,o=s+r;t._lastElapsedTime=s,t._elapsedTime=o;var l=o/n;t._normalizedTime=l;var h=l%1;if(t._normalizedPlayTime=h<0?h+1:h,t._duration=n,o>=n)if(a){let t=Math.floor(o/n);Math.floor(s/n)!=t&&e._eventLoop()}else t._finish=!0,t._elapsedTime=n,t._normalizedPlayTime=1;!t._finish&&e._eventStateUpdate(t._normalizedPlayTime),this._applyTransition(e,i,e._eventtransition(t._normalizedPlayTime,this.animatorParams))}_applyTransition(e,t,r){r?r!=e.curTransition&&(e.curTransition=r,this._LateUpdateEvents.add(this.crossFade,this,[r.destState.name,r.transduration,t,r.transstartoffset])):e.curTransition&&(e.curTransition=null)}_updateStateFinish(e,t){t._finish&&e._eventExit()}_updateEventScript(e,r){if(!this.owner._getBit(t.NodeFlags.HAS_SCRIPT))return;let a=e._clip,i=a._animationEvents;if(!i||0==i.length||null==r.animatorState)return;let n=a._duration,s=r._normalizedPlayTime*n,o=r._parentPlayTime;null==o&&(o=n*r.animatorState.clipStart),s<o&&this._eventScript(i,o,n*r.animatorState.clipEnd),this._eventScript(i,o,s),r._parentPlayTime=s}_eventScript(e,t,r){let a=this.owner.components;for(let i=0,n=e.length;i<n;i++){let n=e[i];if(n.time>t&&n.time<=r)for(let e=0,t=a.length;e<t;e++){let t=a[e];if(t._isScript()){let e=t[n.eventName];e&&e.apply(t,n.params)}}else if(n.time>r)break}}_updateClipDatas(e,t,r,a=null){var i=e._clip,n=i._duration,s=e.clipStart*n+r._normalizedPlayTime*r._duration,o=e._currentFrameIndices,l=r._elapsedTime>r._lastElapsedTime;i._evaluateClipDatasRealTime(i._nodes,s,o,t,l,e._realtimeDatas,a)}_applyFloat(e,t,r,a,i,n){if(t.updateMark===this._updateMark)if(r)e+=a*n;else{e=e+a*(n-e)}else if(i)e=r?t.defaultValue+n:n;else if(r)e=t.defaultValue+a*n;else{var s=t.defaultValue;e=s+a*(n-s)}return e}_applyVec2(e,t,r,a,i,n){if(!e)return null;if(t.updateMark===this._updateMark)if(r)e.x+=a*n.x,e.y+=a*n.y;else{var s=e;e.x=s.x+a*(n.x-s.x),e.y=s.y+a*(n.y-s.y)}else if(i)r?(e.x=t.defaultValue.x+n.x,e.y=t.defaultValue.y+n.y):n.cloneTo(e);else if(r)e.x=t.defaultValue.x+a*n.x,e.y=t.defaultValue.y+a*n.y;else{var o=t.defaultValue;e.x=o.x+a*(n.x-o.x),e.y=o.y+a*(n.y-o.y)}return e}_applyVec3(e,t,r,a,i,n){if(!e)return null;if(t.updateMark===this._updateMark)if(r)e.x+=a*n.x,e.y+=a*n.y,e.z+=a*n.z;else{var s=e;e.x=s.x+a*(n.x-s.x),e.y=s.y+a*(n.y-s.y),e.z=s.z+a*(n.z-s.z)}else if(i)r?(e.x=t.defaultValue.x+n.x,e.y=t.defaultValue.y+n.y,e.z=t.defaultValue.z+n.z):n.cloneTo(e);else if(r)e.x=t.defaultValue.x+a*n.x,e.y=t.defaultValue.y+a*n.y,e.z=t.defaultValue.z+a*n.z;else{var o=t.defaultValue;e.x=o.x+a*(n.x-o.x),e.y=o.y+a*(n.y-o.y),e.z=o.z+a*(n.z-o.z)}return e}_applyVec4(e,t,r,a,i,n){if(!e)return null;if(t.updateMark===this._updateMark)if(r)e.x+=a*n.x,e.y+=a*n.y,e.z+=a*n.z,e.w+=a*n.w;else{var s=e;e.x=s.x+a*(n.x-s.x),e.y=s.y+a*(n.y-s.y),e.z=s.z+a*(n.z-s.z),e.w=s.w+a*(n.w-s.w)}else if(i)r?(e.x=t.defaultValue.x+n.x,e.y=t.defaultValue.y+n.y,e.z=t.defaultValue.z+n.z,e.w=t.defaultValue.w+n.w):n.cloneTo(e);else if(r)e.x=t.defaultValue.x+a*n.x,e.y=t.defaultValue.y+a*n.y,e.z=t.defaultValue.z+a*n.z,e.w=t.defaultValue.w+a*n.w;else{var o=t.defaultValue;e.x=o.x+a*(n.x-o.x),e.y=o.y+a*(n.y-o.y),e.z=o.z+a*(n.z-o.z),e.w=o.w+a*(n.w-o.w)}return e}_applyColor(e,t,r,a,i,n){if(!e)return null;if(t.updateMark===this._updateMark)if(r)e.r+=a*n.x,e.g+=a*n.y,e.b+=a*n.z,e.a+=a*n.w;else{var s=e;e.r=s.r+a*(n.x-s.r),e.g=s.g+a*(n.y-s.g),e.b=s.b+a*(n.z-s.b),e.a=s.a+a*(n.w-s.a)}else if(i)r?(e.r=t.defaultValue.r+n.x,e.g=t.defaultValue.g+n.y,e.b=t.defaultValue.b+n.z,e.a=t.defaultValue.a+n.w):e.setValue(n.x,n.y,n.z,n.w);else if(r)e.r=t.defaultValue.r+a*n.x,e.g=t.defaultValue.g+a*n.y,e.b=t.defaultValue.b+a*n.z,e.a=t.defaultValue.a+a*n.w;else{var o=t.defaultValue;e.r=o.r+a*(n.x-o.r),e.g=o.g+a*(n.y-o.g),e.b=o.b+a*(n.z-o.b),e.a=o.a+a*(n.w-o.a)}return e}_applyPositionAndRotationEuler(e,t,r,a,i,n){if(e.updateMark===this._updateMark)if(t)n.x+=r*i.x,n.y+=r*i.y,n.z+=r*i.z;else{var s=n.x,o=n.y,l=n.z;n.x=s+r*(i.x-s),n.y=o+r*(i.y-o),n.z=l+r*(i.z-l)}else if(a)if(t){var h=e.defaultValue;n.x=h.x+i.x,n.y=h.y+i.y,n.z=h.z+i.z}else n.x=i.x,n.y=i.y,n.z=i.z;else if(h=e.defaultValue,t)n.x=h.x+r*i.x,n.y=h.y+r*i.y,n.z=h.z+r*i.z;else{var d=h.x,c=h.y,u=h.z;n.x=d+r*(i.x-d),n.y=c+r*(i.y-c),n.z=u+r*(i.z-u)}}_applyRotation(e,r,a,i,n,s){if(e.updateMark===this._updateMark)r?(K.quaternionWeight(n,a,Ma),Ma.normalize(Ma),t.Quaternion.multiply(s,Ma,s)):t.Quaternion.lerp(s,n,a,s);else if(i)if(r){var o=e.defaultValue;t.Quaternion.multiply(o,n,s)}else s.x=n.x,s.y=n.y,s.z=n.z,s.w=n.w;else o=e.defaultValue,r?(K.quaternionWeight(n,a,Ma),Ma.normalize(Ma),t.Quaternion.multiply(o,Ma,s)):t.Quaternion.lerp(o,n,a,s)}_applyScale(e,t,r,a,i,n){if(e.updateMark===this._updateMark)t?(K.scaleWeight(i,r,xa),n.x=n.x*xa.x,n.y=n.y*xa.y,n.z=n.z*xa.z):K.scaleBlend(n,i,r,n);else if(a)if(t){var s=e.defaultValue;n.x=s.x*i.x,n.y=s.y*i.y,n.z=s.z*i.z}else n.x=i.x,n.y=i.y,n.z=i.z;else s=e.defaultValue,t?(K.scaleWeight(i,r,xa),n.x=s.x*xa.x,n.y=s.y*xa.y,n.z=s.z*xa.z):K.scaleBlend(s,i,r,n)}_applyCrossData(r,a,i,n,s,o,l){var h=r.propertyOwner;let d;if(h){switch(r.type){case e.KeyFrameValueType.Boolean:console.log("Animator:Boolean not support3");break;case e.KeyFrameValueType.Float:for(var c=(M=r.property).length-1,u=0;u<c&&(h=h[M[u]]);u++);var _=s+l*(o-s);r.value=_,d=M[c],r.isMaterial?h&&h.setFloat(d,this._applyFloat(h.getFloat(d),r,a,i,n,_)):h&&(h[d]=this._applyFloat(h[d],r,a,i,n,_)),r.callbackFun&&r.animatorDataSetCallBack();break;case e.KeyFrameValueType.Position:var f=h.localPosition,g=r.value,m=s.x,p=s.y,S=s.z;g.x=m+l*(o.x-m),g.y=p+l*(o.y-p),g.z=S+l*(o.z-S),this._applyPositionAndRotationEuler(r,a,i,n,g,f),h.localPosition=f;break;case e.KeyFrameValueType.Rotation:var E=h.localRotation,D=r.value;t.Quaternion.lerp(s,o,l,D),this._applyRotation(r,a,i,n,D,E),h.localRotation=E;break;case e.KeyFrameValueType.Scale:var T=h.localScale,A=r.value;K.scaleBlend(s,o,l,A),this._applyScale(r,a,i,n,A,T),h.localScale=T;break;case e.KeyFrameValueType.RotationEuler:var x=h.localRotationEuler,R=r.value;m=s.x,p=s.y,S=s.z,R.x=m+l*(o.x-m),R.y=p+l*(o.y-p),R.z=S+l*(o.z-S),this._applyPositionAndRotationEuler(r,a,i,n,R,x),h.localRotationEuler=x;break;case e.KeyFrameValueType.Color:for(c=(M=r.property).length-1,u=0;u<c&&(h=h[M[u]]);u++);let C=r.value;C.x=s.r+l*(o.r-s.r),C.y=s.g+l*(o.g-s.g),C.z=s.b+l*(o.b-s.b),C.w=s.a+l*(o.a-s.a),r.value=C,d=M[c],r.isMaterial?h&&h.setColor(d,this._applyColor(h.getColor(d),r,a,i,n,C)):h&&(h[d]=this._applyColor(h[d],r,a,i,n,C)),r.callbackFun&&r.animatorDataSetCallBack();break;case e.KeyFrameValueType.Vector2:for(c=(M=r.property).length-1,u=0;u<c&&(h=h[M[u]]);u++);let I=r.value;I.x=s.r+l*(o.r-s.r),I.y=s.g+l*(o.g-s.g),r.value=I,d=M[c],r.isMaterial?h&&h.setVector2(d,this._applyVec2(h.getVector2(d),r,a,i,n,I)):h&&(h[d]=this._applyVec2(h[d],r,a,i,n,I)),r.callbackFun&&r.animatorDataSetCallBack();break;case e.KeyFrameValueType.Vector4:for(c=(M=r.property).length-1,u=0;u<c&&(h=h[M[u]]);u++);let v=r.value;v.x=s.x+l*(o.x-s.x),v.y=s.y+l*(o.y-s.y),v.z=s.z+l*(o.z-s.z),r.value=v,d=M[c],r.isMaterial?h&&h.setVector4(d,this._applyVec4(h.getVector4(d),r,a,i,n,v)):h&&(h[d]=this._applyVec4(h[d],r,a,i,n,v)),r.callbackFun&&r.animatorDataSetCallBack();break;case e.KeyFrameValueType.Vector3:var M;for(c=(M=r.property).length-1,u=0;u<c&&(h=h[M[u]]);u++);let y=r.value;y.x=s.x+l*(o.x-s.x),y.y=s.y+l*(o.y-s.y),y.z=s.z+l*(o.z-s.z),r.value=y,d=M[c],r.isMaterial?h&&h.setVector3(d,this._applyVec3(h.getVector3(d),r,a,i,n,y)):h&&(h[d]=this._applyVec3(h[d],r,a,i,n,y)),r.callbackFun&&r.animatorDataSetCallBack()}r.updateMark=this._updateMark}}_setClipDatasToNode(t,r,a,i,n=null){for(var s=t._realtimeDatas,o=t._clip._nodes,l=t._nodeOwners,h=0,d=o.count;h<d;h++){var c=l[h];if(c){var u=o.getNodeByIndex(h);if(n.avatarMask&&!n.avatarMask.getTransformActive(u.nodePath))continue;var _=c.propertyOwner;let t;if(_){switch(c.type){case e.KeyFrameValueType.Boolean:for(var f=(D=c.property).length-1,g=0;g<f&&(_=_[D[g]]);g++);let n=D[f];c.isMaterial||_&&(_[n]=s[h]);break;case e.KeyFrameValueType.Float:for(f=(D=c.property).length-1,g=0;g<f&&(_=_[D[g]]);g++);let o=D[f];c.isMaterial?_&&_.setFloat(o,this._applyFloat(0,c,r,a,i,s[h])):(_&&(_[o]=this._applyFloat(_[o],c,r,a,i,s[h])),c.callbackFun&&c.animatorDataSetCallBack());break;case e.KeyFrameValueType.Position:var m=_.localPosition;this._applyPositionAndRotationEuler(c,r,a,i,s[h],m),_.localPosition=m;break;case e.KeyFrameValueType.Rotation:var p=_.localRotation;this._applyRotation(c,r,a,i,s[h],p),_.localRotation=p;break;case e.KeyFrameValueType.Scale:var S=_.localScale;this._applyScale(c,r,a,i,s[h],S),_.localScale=S;break;case e.KeyFrameValueType.RotationEuler:var E=_.localRotationEuler;this._applyPositionAndRotationEuler(c,r,a,i,s[h],E),_.localRotationEuler=E;break;case e.KeyFrameValueType.Vector2:for(f=(D=c.property).length-1,g=0;g<f&&(_=_[D[g]]);g++);t=D[f],c.isMaterial?_&&_.getVector2(t)&&_.setVector2(t,this._applyVec2(_.getVector2(t),c,r,a,i,s[h])):(_&&(_[t]=this._applyVec2(_[t],c,r,a,i,s[h])),c.callbackFun&&c.animatorDataSetCallBack());break;case e.KeyFrameValueType.Vector3:for(f=(D=c.property).length-1,g=0;g<f&&(_=_[D[g]]);g++);t=D[f],c.isMaterial?_&&_.getVector3(t)&&_.setVector3(t,this._applyVec3(_.getVector3(t),c,r,a,i,s[h])):(_&&(_[t]=this._applyVec3(_[t],c,r,a,i,s[h])),c.callbackFun&&c.animatorDataSetCallBack());break;case e.KeyFrameValueType.Vector4:for(f=(D=c.property).length-1,g=0;g<f&&(_=_[D[g]]);g++);t=D[f],c.isMaterial?_&&_.getVector4(t)&&_.setVector4(t,this._applyVec4(_.getVector4(t),c,r,a,i,s[h])):(_&&(_[t]=this._applyVec4(_[t],c,r,a,i,s[h])),c.callbackFun&&c.animatorDataSetCallBack());break;case e.KeyFrameValueType.Color:var D;for(f=(D=c.property).length-1,g=0;g<f&&(_=_[D[g]]);g++);t=D[f],c.isMaterial?_&&_.getColor(t)&&_.setColor(t,this._applyColor(_.getColor(t),c,r,a,i,s[h])):(_&&(_[t]=this._applyColor(_[t],c,r,a,i,s[h])),c.callbackFun&&c.animatorDataSetCallBack())}c.updateMark=this._updateMark}}}}_setCrossClipDatasToNode(e,t,r,a,i){for(var n=e._crossNodesOwners,s=e._crossNodesOwnersCount,o=e.blendingMode!==Da.BLENDINGMODE_OVERRIDE,l=e.defaultWeight,h=r._realtimeDatas,d=e._destCrossClipNodeIndices,c=r._nodeOwners,u=t._realtimeDatas,_=e._srcCrossClipNodeIndices,f=t._nodeOwners,g=0;g<s;g++){var m=n[g];if(m){var p=_[g],S=d[g];if(-1==p&&-1==S)continue;var E=-1!==p?u[p]:c[S].defaultValue;if(null==E)continue;var D=-1!==S?h[S]:f[p].defaultValue;if(D||(D=f[p].defaultValue),null==D)continue;e.avatarMask&&!e.avatarMask.getTransformActive(m.nodePath)||this._applyCrossData(m,o,l,i,E,D,a)}}}_setFixedCrossClipDatasToNode(e,t,r,a){for(var i=e._crossNodesOwners,n=e._crossNodesOwnersCount,s=e.blendingMode!==Da.BLENDINGMODE_OVERRIDE,o=e.defaultWeight,l=t._realtimeDatas,h=e._destCrossClipNodeIndices,d=0;d<n;d++){var c=i[d];if(c){var u,_=h[d],f=c.crossFixedValue;u=-1!=_&&l[_]?l[_]:c.defaultValue,this._applyCrossData(c,s,o,a,f,u,r)}}}_revertDefaultKeyframeNodes(t){for(var r=t._nodeOwners,a=0,i=r.length;a<i;a++){var n=r[a];if(n){var s=n.propertyOwner;let t;if(s)switch(n.type){case e.KeyFrameValueType.Boolean:console.log("Animator:Boolean not support2");break;case e.KeyFrameValueType.Float:for(var o=(g=n.property).length-1,l=0;l<o&&(s=s[g[l]]);l++);let r=g[o];n.isMaterial?s&&s.setFloat(r,n.defaultValue):(s&&(s[r]=n.defaultValue),n.callbackFun&&n.animatorDataSetCallBack());break;case e.KeyFrameValueType.Position:var h=s.localPosition,d=n.defaultValue;h.x=d.x,h.y=d.y,h.z=d.z,s.localPosition=h;break;case e.KeyFrameValueType.Rotation:var c=s.localRotation,u=n.defaultValue;c.x=u.x,c.y=u.y,c.z=u.z,c.w=u.w,s.localRotation=c;break;case e.KeyFrameValueType.Scale:var _=s.localScale;d=n.defaultValue,_.x=d.x,_.y=d.y,_.z=d.z,s.localScale=_;break;case e.KeyFrameValueType.RotationEuler:var f=s.localRotationEuler;d=n.defaultValue,f.x=d.x,f.y=d.y,f.z=d.z,s.localRotationEuler=f;break;case e.KeyFrameValueType.Vector2:for(o=(g=n.property).length-1,l=0;l<o&&(s=s[g[l]]);l++);t=g[o],n.isMaterial?s&&s.getVector2(t)&&s.setVector2(t,n.defaultValue):(s&&(s[t]=n.defaultValue),n.callbackFun&&n.animatorDataSetCallBack());break;case e.KeyFrameValueType.Vector3:for(o=(g=n.property).length-1,l=0;l<o&&(s=s[g[l]]);l++);t=g[o],n.isMaterial?s&&s.getVector3(t)&&s.setVector3(t,n.defaultValue):(s&&(s[t]=n.defaultValue),n.callbackFun&&n.animatorDataSetCallBack());break;case e.KeyFrameValueType.Vector4:for(o=(g=n.property).length-1,l=0;l<o&&(s=s[g[l]]);l++);t=g[o],n.isMaterial?s&&s.getVector3(t)&&s.setVector3(t,n.defaultValue):(s&&(s[t]=n.defaultValue),n.callbackFun&&n.animatorDataSetCallBack());break;case e.KeyFrameValueType.Color:var g;for(o=(g=n.property).length-1,l=0;l<o&&(s=s[g[l]]);l++);t=g[o],Ra.r=n.defaultValue.x,Ra.g=n.defaultValue.y,Ra.b=n.defaultValue.z,Ra.a=n.defaultValue.w,n.isMaterial?s&&s.getColor(t)&&s.setColor(t,Ra):(s&&(s[t]=Ra),n.callbackFun&&n.animatorDataSetCallBack());break;default:throw"Animator:unknown type."}}}}onAfterDeserialize(){let e=this.controllerLayers;if(e&&null==this.controller){delete this.controllerLayers,this._controllerLayers.length=0;for(let t of e)this.addControllerLayer(t)}}_onEnable(){for(let e=0,t=this._controllerLayers.length;e<t;e++)if(this._controllerLayers[e].playOnWake){let t=this.getDefaultState(e);t&&this.play(null,e,t.cycleOffset)}}_onDestroy(){this._controller&&(this._controller._removeReference(),this._controller=null);for(let e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e]._removeReference()}_applyUpdateMode(e){let r;switch(this._updateMode){case t.AnimatorUpdateMode.Normal:r=e;break;case t.AnimatorUpdateMode.LowFrame:r=t.Stat.loopCount%this._lowUpdateDelty==0?e*this._lowUpdateDelty:0;break;case t.AnimatorUpdateMode.UnScaleTime:r=0}return r}_handleSpriteOwnersBySprite(e,t,r){for(var a=0,i=this._controllerLayers.length;a<i;a++)if(this._controllerLayers[a].enable)for(var n=this._controllerLayers[a]._states,s=0,o=n.length;s<o;s++){var l=n[s],h=l._clip,d=t.join("/"),c=h._nodesMap[d];if(c)for(var u=l._nodeOwners,_=0,f=c.length;_<f;_++)e?this._addKeyframeNodeOwner(u,c[_],r):this._removeKeyframeNodeOwner(u,c[_])}}onUpdate(){let e=this.owner._scene.timer.delta/1e3;if(e=this._applyUpdateMode(e),0!==this._speed&&0!==e&&t.Stat.enableAnimatorUpdate){var r,a;for(this._updateMark++,r=0,a=this._controllerLayers.length;r<a;r++){var i=this._controllerLayers[r];if(i.enable){var n=i._playStateInfo;if(!this.sleep||!n._finish||0!=i._playType){var s=i._crossPlayStateInfo;switch(d=i.blendingMode!==Da.BLENDINGMODE_OVERRIDE,i._playType){case 0:var o=n.currentState;o._clip;var l=this._speed*o.speed,h=n._finish;h||this._updatePlayer(o,n,e*l,o.islooping,r);var d=i.blendingMode!==Da.BLENDINGMODE_OVERRIDE;this._updateClipDatas(o,d,n,i.avatarMask),this._setClipDatasToNode(o,d,i.defaultWeight,0===r,i),h||this._updateEventScript(o,n),h||this._updateStateFinish(o,n);break;case 1:(o=n.currentState)._clip;var c=i._crossPlayState,u=c._clip,_=i._crossDuration,f=s._startPlayTime,g=u._duration-f,m=_>g&&0!=g?g/_:1,p=this._speed*c.speed;this._updatePlayer(c,s,e*m*p,u.islooping,r);var S=(s._elapsedTime-f)/m/_,E=!1;S>=1?(this._updateClipDatas(c,d,s,i.avatarMask),this._setClipDatasToNode(c,d,i.defaultWeight,0===r,i),i._playType=0,n.currentState=c,s._cloneTo(n)):(n._finish||(l=this._speed*o.speed,E=!0,this._updatePlayer(o,n,e*l,o.islooping,r),this._updateClipDatas(o,d,n,i.avatarMask)),this._updateClipDatas(c,d,s,i.avatarMask),this._setCrossClipDatasToNode(i,o,c,S,0===r)),this._updateEventScript(o,n),this._updateEventScript(c,s),this._updateStateFinish(c,s),E&&this._updateStateFinish(n.currentState,n);break;case 2:u=(c=i._crossPlayState)._clip,_=i._crossDuration,f=s._startPlayTime,m=_>(g=u._duration-f)?g/_:1,p=this._speed*c.speed,this._updatePlayer(c,s,e*m*p,c.islooping,r),(S=(s._elapsedTime-f)/m/_)>=1?(this._updateClipDatas(c,d,s,i.avatarMask),this._setClipDatasToNode(c,d,1,0===r,i),i._playType=0,n.currentState=c,s._cloneTo(n)):(this._updateClipDatas(c,d,s,i.avatarMask),this._setFixedCrossClipDatasToNode(i,c,S,0===r)),this._updateEventScript(c,s),this._updateStateFinish(c,s)}}}}this._LateUpdateEvents.invoke(),this._LateUpdateEvents.clear()}}_cloneTo(e){e.cullingMode=this.cullingMode;for(var t=0,r=this._controllerLayers.length;t<r;t++){var a=this._controllerLayers[t];e.addControllerLayer(a.clone());for(var i=a._states,n=0,s=i.length;n<s;n++){var o=i[n].clone(),l=e.getControllerLayer(t);l.addState(o),0==n&&(l.defaultState=o)}}e.controller=this._controller}getDefaultState(e=0){return this._controllerLayers[e].defaultState}addState(e,t=0){this._controllerLayers[t].addState(e),console.warn("Animator:this function is discard,please use animatorControllerLayer.addState() instead.")}removeState(e,t=0){this._controllerLayers[t].removeState(e),console.warn("Animator:this function is discard,please use animatorControllerLayer.removeState() instead.")}addControllerLayer(e){this._controllerLayers.push(e),e._animator=this,e._addReference();for(var t=e._states,r=0,a=t.length;r<a;r++)this._getOwnersByClip(t[r])}getControllerLayer(e=0){return this._controllerLayers[e]}play(e=null,t=0,r=Number.NEGATIVE_INFINITY){var a=this._controllerLayers[t];if(a){var i=a.defaultState;if(!e&&!i)throw new Error("Animator:must have default clip value,please set clip property.");var n=a._playStateInfo,s=n.currentState,o=e?a.getAnimatorState(e):i;if(!o._clip)return;var l=o._clip._duration,h=o._clip._duration*(o.clipEnd-o.clipStart);s!==o?(r!==Number.NEGATIVE_INFINITY?n._resetPlayState(l*r,h):n._resetPlayState(0,h),null!==s&&s!==o&&this._revertDefaultKeyframeNodes(s),a._playType=0,n.currentState=o):r!==Number.NEGATIVE_INFINITY&&(n._resetPlayState(l*r,h),a._playType=0),o._scripts,o._eventStart(this,t)}else console.warn("Invalid layerIndex "+t+".");this.owner._scene&&this.onUpdate()}crossFade(e,t,r=0,a=Number.NEGATIVE_INFINITY){var i=this._controllerLayers[r];if(i){var n=i.getAnimatorState(e);if(n){var s=i._playType;if(-1===s)return void this.play(e,r,a);var o=i._crossPlayStateInfo,l=i._crossNodesOwners,h=i._crossNodesOwnersIndicesMap,d=i._playStateInfo.currentState,c=n._nodeOwners,u=i._destCrossClipNodeIndices,_=n._clip,f=_._nodes,g=_._nodesDic,m=0;switch(s){case 0:var p=d._nodeOwners,S=i._srcCrossClipNodeIndices,E=d._clip,D=E._nodes,T=E._nodesDic;i._playType=1;var A=++i._crossMark;m=i._crossNodesOwnersCount=0;for(var x=0,R=D.count;x<R;x++){var M=D.getNodeByIndex(x),C=M._indexInList,I=p[C];if(I){var v=M.fullPath;S[m]=C;var y=g[v];u[m]=y?y._indexInList:-1,h[v]=A,l[m]=I,m++}}for(x=0,R=f.count;x<R;x++){var B=(y=f.getNodeByIndex(x))._indexInList,w=c[B];if(w){var L=y.fullPath;T[L]||(S[m]=-1,u[m]=B,h[L]=A,l[m]=w,m++)}}break;case 1:case 2:for(i._playType=2,x=0,R=l.length;x<R;x++){var N=l[x];N.saveCrossFixedValue(),y=g[N.fullPath],u[x]=y?y._indexInList:-1}for(m=i._crossNodesOwnersCount,A=i._crossMark,x=0,R=f.count;x<R;x++)(w=c[B=(y=f.getNodeByIndex(x))._indexInList])&&h[L=y.fullPath]!==A&&(u[m]=B,h[L]=A,N=c[B],l[m]=N,N.saveCrossFixedValue(),m++)}i._crossNodesOwnersCount=m,i._crossPlayState=n,i._crossDuration=d._clip._duration*t,a!==Number.NEGATIVE_INFINITY?o._resetPlayState(_._duration*a,i._crossDuration):o._resetPlayState(0,i._crossDuration),n._eventStart(this,r)}else console.warn("Invalid name "+r+".")}else console.warn("Invalid layerIndex "+r+".")}setParamsTrigger(e){let r;r="number"==typeof e?e:t.AnimatorStateCondition.conditionNameToID(e),this._animatorParams[r]=!0}setParamsNumber(e,r){let a;a="number"==typeof e?e:t.AnimatorStateCondition.conditionNameToID(e),this._animatorParams[a]=r}setParamsBool(e,r){let a;a="number"==typeof e?e:t.AnimatorStateCondition.conditionNameToID(e),this._animatorParams[a]=r}getParamsvalue(e){let r;return r="number"==typeof e?e:t.AnimatorStateCondition.conditionNameToID(e),this._animatorParams[r]}getCurrentAnimatorPlayState(e=0){return this._controllerLayers[e]._playStateInfo}}Aa.CULLINGMODE_ALWAYSANIMATE=0,Aa.CULLINGMODE_CULLCOMPLETELY=2;const xa=new t.Vector3,Ra=new t.Color,Ma=new t.Quaternion;class Ca extends t.EventDispatcher{get clip(){return this._clip}set clip(r){if(this._clip!==r){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),r){var a=this._realtimeDatas,i=r._nodes,n=i.count;this._currentFrameIndices=new Int16Array(n),this._resetFrameIndices(),this._referenceCount>0&&r._addReference(this._referenceCount),this._realtimeDatas.length=n;for(var s=0;s<n;s++)switch(i.getNodeByIndex(s).type){case e.KeyFrameValueType.Boolean:case e.KeyFrameValueType.Float:break;case e.KeyFrameValueType.Position:case e.KeyFrameValueType.Scale:case e.KeyFrameValueType.RotationEuler:case e.KeyFrameValueType.Vector3:a[s]=new t.Vector3;break;case e.KeyFrameValueType.Rotation:a[s]=new t.Quaternion;break;case e.KeyFrameValueType.Vector2:a[s]=new t.Vector2;break;case e.KeyFrameValueType.Vector4:case e.KeyFrameValueType.Color:a[s]=new t.Vector4;break;default:throw new Error("AnimationClipParser04:unknown type.")}}this._clip=r}}get islooping(){return 0!=this._isLooping?1==this._isLooping:this._clip.islooping}get transitions(){return this._transitions}set transitions(e){this._transitions=e}get soloTransitions(){return this._soloTransitions}set soloTransitions(e){this._soloTransitions=e}constructor(){super(),this._referenceCount=0,this._clip=null,this._nodeOwners=[],this._currentFrameIndices=null,this._isLooping=0,this._realtimeDatas=[],this._scripts=null,this._transitions=[],this._soloTransitions=[],this.speed=1,this.clipStart=0,this.clipEnd=1,this.cycleOffset=0}_eventStart(e,t){if(this.event(Ca.EVENT_OnStateEnter),this._scripts)for(var r=0,a=this._scripts.length;r<a;r++)this._scripts[r].setPlayScriptInfo(e,t,this),this._scripts[r].onStateEnter()}_eventExit(){if(this.event(Ca.EVENT_OnStateExit),this.curTransition=null,this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateExit()}_eventStateUpdate(e){if(this.event(Ca.EVENT_OnStateUpdate,e),this._scripts)for(var t=0,r=this._scripts.length;t<r;t++)this._scripts[t].onStateUpdate(e)}_eventLoop(){if(this.event(Ca.EVENT_OnStateLoop),this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateLoop&&this._scripts[e].onStateLoop()}_eventtransition(e,t){let r=this._soloTransitions.length;if(r>0){for(var a=0;a<r;a++)if(this._soloTransitions[a].check(e,t))return this._soloTransitions[a];return null}let i=this._transitions.length;for(a=0;a<i;a++)if(this._transitions[a].check(e,t))return this._transitions[a];return null}_getReferenceCount(){return this._referenceCount}_addReference(e=1){this._clip&&this._clip._addReference(e),this._referenceCount+=e}_removeReference(e=1){this._clip&&this._clip._removeReference(e),this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}_resetFrameIndices(){for(var e=0,t=this._currentFrameIndices.length;e<t;e++)this._currentFrameIndices[e]=-1}addScript(e){var t=new e;return this._scripts=this._scripts||[],this._scripts.push(t),t}getScript(e){if(this._scripts)for(var t=0,r=this._scripts.length;t<r;t++){var a=this._scripts[t];if(a instanceof e)return a}return null}getScripts(e){var t=null;if(this._scripts)for(var r=0,a=this._scripts.length;r<a;r++){var i=this._scripts[r];i instanceof e&&(t=t||[]).push(i)}return t}cloneTo(e){e.name=this.name,e.speed=this.speed,e.clipStart=this.clipStart,e.clipEnd=this.clipEnd,e.clip=this._clip}clone(){var e=new Ca;return this.cloneTo(e),e}}Ca.EVENT_OnStateEnter="OnStartEnter",Ca.EVENT_OnStateUpdate="OnStateUpdate",Ca.EVENT_OnStateLoop="OnStateLoop",Ca.EVENT_OnStateExit="OnStateExit";class Ia{constructor(e){this._avatarPathMap=(null==e?void 0:e._avatarPathMap)||{}}getTransformActive(e){return this._avatarPathMap[e]}setTransformActive(e,t){this._avatarPathMap[e]=t}getAllTranfromPath(){return this._avatarPathMap}clone(){var e=new Ia;return this.cloneTo(e),e}cloneTo(e){for(var t in this._avatarPathMap)e.setTransformActive(t,this._avatarPathMap[t])}}class va{constructor(){this._active=!0,this._singleton=!0}get singleton(){return this._singleton}set singleton(e){this._singleton=e}get active(){return this._active}set active(e){this._active=e}getCameraDepthTextureModeFlag(){return 0}effectInit(e){}release(e){}render(e){}}class ya{constructor(){this._conditions=[],this._exitByTime=!0,this._exitTime=.85,this._transduration=.15,this._transstartoffset=0,this._mute=!1}get name(){return this._name}set name(e){this._name=e}get mute(){return this._mute}set mute(e){this._mute=e}get destState(){return this._destState}set destState(e){this._destState=e}get conditions(){return this._conditions}set conditions(e){for(var t=this._conditions.length-1;t>=0;t--)this.removeCondition(this._conditions[t]);for(t=0;t<e.length;t++)this.addCondition(e[t])}get exitByTime(){return this._exitByTime}set exitByTime(e){this._exitByTime=e}set transduration(e){this._transduration=Math.max(0,Math.min(e,1))}get transduration(){return this._transduration}set transstartoffset(e){this._transstartoffset=Math.max(0,Math.min(e,1))}get transstartoffset(){return this._transstartoffset}get exitTime(){return this._exitTime}set exitTime(e){this._exitTime=Math.max(0,Math.min(e,1))}addCondition(e){-1==this._conditions.indexOf(e)&&this._conditions.push(e)}removeCondition(e){let t=this._conditions.indexOf(e);-1!=t&&this._conditions.splice(t,0)}get isAndOperEnabled(){return this._isAndOperEnabled}set isAndOperEnabled(e){this._isAndOperEnabled=e}check(e,r){if(this._mute)return!1;if(0==this._conditions.length){if(e>=this._exitTime)return!0}else{if(this._exitByTime&&e<this._exitTime)return!1;if(this._isAndOperEnabled){for(var a=0;a<this._conditions.length;a++){let e=this._conditions[a];if(!e.checkState(r[e.id]))return!1;e.type==t.AniStateConditionType.Trigger&&(r[e.id]=!1)}return!0}for(a=0;a<this._conditions.length;a++){let e=this._conditions[a];if(e.checkState(r[e.id]))return e.type==t.AniStateConditionType.Trigger&&(r[e.id]=!1),!0}}return!1}}class Ba extends t.Resource{constructor(e){super();let r=t.AnimatorControllerParse.parse(e);this.data=r.ret,this.clipsID=r.clipsID}getLayers(){let e=this.data.controllerLayers,t=[];for(let r=e.length-1;r>=0;r--){let a=e[r],i=new Da(a.name);a.avatarMask&&(i.avatarMask=a.avatarMask),t.unshift(i);for(let e in a)if("avatarMask"!=e&&"name"!=e&&"states"!=e&&null!=a[e])try{i[e]=a[e]}catch(e){}this.getState(a.states,i,this.data)}return t}updateTo(e){let r=e._controllerLayers;for(let e=0,t=r.length;e<t;e++)r[e]._removeReference();r.length=0;let a=this.getLayers();for(let t=0,r=a.length;t<r;t++)e.addControllerLayer(a[t]);let i=this.data.animatorParams;if(i)for(let r=i.length-1;r>=0;r--){let a=i[r];if(t.AniParmType.Bool==a.type)e.setParamsBool(a.name,Boolean(a.val));else if(t.AniParmType.Float==a.type){let t=Number(a.val);isNaN(t)&&(t=0),e.setParamsNumber(a.name,t)}else t.AniParmType.Trigger==a.type&&a.val&&e.setParamsTrigger(a.name)}}createState(e,r,a){if(!e)return null;let i={},n=null;for(let s=e.length-1;s>=0;s--){let o=e[s],l=o.states;if(l){let e=this.createState(l,r,a);e&&(r[o.id]=e.states[e.id]);continue}if(0>Number(o.id)){if("-1"==o.id){let e=o.soloTransitions;e&&0<e.length&&(n=e[0].id)}continue}let h=new Ca;r[o.id]=h,i[o.id]=h;for(let e in o)try{if("scripts"==e){let r=o[e];if(r&&Array.isArray(r))for(let e=r.length-1;e>=0;e--){let a=r[e];a&&0==a.indexOf("res://")&&(a=a.substring(6));let i=t.ClassUtils.getClass(a);i&&h.addScript(i)}continue}if("soloTransitions"==e)continue;null!=o[e]&&(h[e]=o[e])}catch(e){}a.addState(h)}return{id:n,states:i}}setExitTransition(e,t,r,a,i){for(let n in e){let s=r[n];if(s){let o=s.transitions,l=s.soloTransitions,h=e[n];for(let e=t.length-1;e>=0;e--){let s=t[e];if("-3"!=s.id)for(let e=h.length-1;e>=0;e--){let t=h[e],i=new ya;i.destState=r[s.id],s.conditions&&this.addConditions(s.conditions,i,a),t.conditions&&this.addConditions(t.conditions,i,a);for(let e in s)"solo"!=e&&"id"!=e&&"conditions"!=e&&(i[e]=s[e]);s.solo?l.unshift(i):o.unshift(i)}else null==i[n]&&(i[n]=[]),i[n].push(s)}}}}setTransitions(e,t,r,a,i){if(!e)return null;let n={};for(let i=e.length-1;i>=0;i--){let s=e[i];if(s.states){let e=this.setTransitions(s.states,t,r,a,s);if(e){let r=s.soloTransitions;r&&this.setExitTransition(e,r,t,a,n)}}}for(let s=e.length-1;s>=0;s--){let o=e[s];if(o.states)continue;if("-1"==o.id){if(o.soloTransitions&&0<o.soloTransitions.length){null==i?r.defaultState=t[o.soloTransitions[0].id]:t[i.id]=t[o.soloTransitions[0].id];continue}}else{if("-2"==o.id){let e=o.soloTransitions;if(e)for(let r=e.length-1;r>=0;r--){let i=e[r],n=t[i.id];if(n)for(let e in t){let r=t[e],s=new ya;s.destState=n,i.conditions&&this.addConditions(i.conditions,s,a);for(let e in i)"solo"!=e&&"id"!=e&&"conditions"!=e&&(s[e]=i[e]);i.solo?r.soloTransitions.unshift(s):r.transitions.unshift(s)}}continue}if("-3"==o.id)continue}let l=o.soloTransitions;if(l&&t[o.id]){let e=t[o.id].transitions,r=t[o.id].soloTransitions;for(let i=l.length-1;i>=0;i--){let s=l[i];if("-3"==s.id){null==n[o.id]&&(n[o.id]=[]),n[o.id].push(s);continue}let h=new ya;t[s.id]&&(h.destState=t[s.id]),s.conditions&&this.addConditions(s.conditions,h,a);for(let e in s)"solo"!=e&&"id"!=e&&"conditions"!=e&&(h[e]=s[e]);s.solo?r.unshift(h):e.unshift(h)}}}return n}getState(e,t,r){if(e){let a={};this.createState(e,a,t),this.setTransitions(e,a,t,r)}}addConditions(e,r,a){let i=a.animatorParams;if(null!=i&&0!=i.length)for(let a=0,n=e.length;a<n;a++){let n,s=e[a],o=null;for(let e=i.length-1;e>=0;e--)if(i[e].id==s.id){o=i[e];break}if(null==o)return;if(o.type==t.AniParmType.Bool){let e=new t.AnimatorStateBoolCondition(o.name);e.compareFlag=Boolean(s.checkValue),n=e}else if(o.type==t.AniParmType.Float){let e=new t.AnimatorStateNumberCondition(o.name);e.numberValue=Number(s.checkValue),e.compareFlag=s.type,n=e}else if(o.type==t.AniParmType.Trigger){n=new t.AnimatorStateTriggerCondition(o.name)}r.addCondition(n)}}}class wa{constructor(){this.updateMark=-1,this.indexInList=-1,this.batched=!1}}class La{constructor(){this._instanceBatchOpaqueMarks=[],this.updateCountMark=0}_getData(e,t,r){return null==r&&(r=Array),"boolean"==typeof e?t[e?0:1]||(t[e?0:1]=new r):t[e]||(t[e]=new r)}getInstanceBatchOpaquaMark(e){let t=!!e._transform&&e._transform._isFrontFaceInvert,r=e._baseRender._receiveShadow,a=(e._material._id<<17)+(e._geometry._id<<2)+(Number(t)<<1)+Number(r),i=((e._baseRender._probReflection?e._baseRender._probReflection._reflectionProbeID:-1)+1<<10)+(e._baseRender.lightmapIndex+1<<20)+((e._baseRender._lightProb?e._baseRender._lightProb._volumetricProbeID:-1)+1);var n=this._getData(a,this._instanceBatchOpaqueMarks);return this._getData(i,n,wa)}}La.instance=new La;class Na extends U{constructor(){super(),this._lodInstanceRenderElement={},this._RenderBitFlag=e.RenderBitFlag.RenderBitFlag_Batch,this._renderElements=[],this._lodInstanceRenderElement[-1]=[],this._batchList=new t.SingletonList}get checkLOD(){return this._checkLOD}set checkLOD(e){this._checkLOD=e}get lodCullRateArray(){return this._lodRateArray}set lodCullRateArray(e){this._checkLOD&&(e.sort(((e,t)=>t-e)),this._lodRateArray=e)}_canBatch(e){return e._batchRender,!1}_onEnable(){if(super._onEnable(),this._batchList)for(let e=0,t=this._batchList.length;e<t;e++)this._batchList.elements[e].setRenderbitFlag(this._RenderBitFlag,!0)}_onDisable(){if(super._onDisable(),this._batchList)for(let e=0,t=this._batchList.length;e<t;e++)this._batchList.elements[e].setRenderbitFlag(this._RenderBitFlag,!1)}_changeLOD(e){this._cacheLod!=e&&(this._cacheLod==this.lodCullRateArray.length-1&&(e=-1),this._renderElements=this._lodInstanceRenderElement[e],this._lodInstanceRenderElement[e]&&-1!=e?(this._renderElements||(this._renderElements=[]),this._renderElements=this._renderElements.concat(this._lodInstanceRenderElement[-1])):this._renderElements=this._lodInstanceRenderElement[-1])}onPreRender(){if(!this.checkLOD||!this._lodRateArray||this._lodRateArray.length<1)this._changeLOD(0);else{let e=this.owner.scene.cullInfoCamera,r=e.maxlocalYDistance;t.Vector3.subtract(this._bounds._imp.getCenter(),e.transform.position,Pa);let a=Pa.length()/e.farPlane*r,i=this._lodsize/a;for(let e=0;e<this._lodRateArray.length;e++)if(!(i<this._lodRateArray[e])){this._changeLOD(e);break}}}_batchOneRender(e){return!1}_removeOneRender(e){}_updateOneRender(e){}addList(e){for(var t=0,r=e.length;t<r;t++){let r=e[t];this._canBatch(r)&&this._batchList.add(r)}}reBatch(){let e=this._batchList.length,t=this._batchList.elements;for(var r=0;r<e;r++){let e=t[r];this._batchOneRender(e)}}_restorRenderNode(){for(let e=0,t=this._batchList.length;e<t;e++)this._removeOneRender(this._batchList.elements[e])}_clear(){this._restorRenderNode(),this._renderElements=[],this._batchList.destroy(),this._batchList=new t.SingletonList,this._lodInstanceRenderElement={},this._lodInstanceRenderElement[-1]=[]}}const Pa=new t.Vector3;class Fa extends Na{constructor(){super(),this._insBatchMarksNums=[],this._insElementMarksArray=[],this._instanceBatchminNums=10,this._updateChangeElement=[],this.checkLOD=!0,this._batchManager=new La,this._RenderBitFlag=e.RenderBitFlag.RenderBitFlag_InstanceBatch}_isRenderNodeAllCanInstanceBatch(e){let t=e._renderElements;for(var r=0,a=t.length;r<a;r++){if(!t[r].material._shader._enableInstancing)return!1}return!0}_sumInstanceBatch(e){let t=e._renderElements;for(var r=0,a=t.length;r<a;r++){let e=t[r];var i=this._batchManager.getInstanceBatchOpaquaMark(e);-1==i.indexInList&&(i.indexInList=this._insBatchMarksNums.length,this._insBatchMarksNums.push(0)),this._insBatchMarksNums[i.indexInList]+=1}}_batchOneElement(e,t){var r=this._batchManager.getInstanceBatchOpaquaMark(e);if(-1==r.indexInList)return;let a=this._insElementMarksArray[r.indexInList];a||(a=this._createInstanceElement(e,t,r));let i=a._instanceBatchElementList;i.length==Xt.maxInstanceCount&&(this._insBatchMarksNums.push(this._insBatchMarksNums[r.indexInList]),r.indexInList=this._insBatchMarksNums.length-1,a=this._createInstanceElement(e,t,r),i=a._instanceBatchElementList),-1==i.indexof(e)&&(i.add(e),a._isUpdataData=!0,-1==this._updateChangeElement.indexOf(a)&&this._updateChangeElement.push(a))}_removeOneElement(e,t){this._batchManager.getInstanceBatchOpaquaMark(e).indexInList}_updateOneElement(e,t){}_createInstanceElement(e,t,r){let a=new Xt;a.render=t,a._geometry.subMesh=e._geometry,a.material=e.material,a.setTransform(null),a.renderSubShader=e.renderSubShader;let i=a._instanceBatchElementList;return i.length=0,i.add(e),this._insElementMarksArray[r.indexInList]=a,r.batched=!0,this._lodInstanceRenderElement[t._LOD]||(this._lodInstanceRenderElement[t._LOD]=[]),this._lodInstanceRenderElement[t._LOD].push(a),a}_canBatch(e){let t=e._renderElements;for(var r=0,a=t.length;r<a;r++){let e=t[r];var i=this._batchManager.getInstanceBatchOpaquaMark(e);if(this._insBatchMarksNums[i.indexInList]<this._instanceBatchminNums||e.material.renderQueue>=3e3)return!1}return!0}_calculateBoundingBox(){let e=this._bounds;for(let t=0,r=this._batchList.length;t<r;t++)0==t?this._batchList.elements[t].bounds.cloneTo(e):w.merge(e,this._batchList.elements[t].bounds,e);let t=this._bounds.getExtent();return this._lodsize=2*Math.max(t.x,t.y,t.z),this._bounds}_onDestroy(){super._onDestroy()}_batchOneRender(t){if(!this._canBatch(t))return!1;this.boundsChange=!0;let r=t._renderElements;for(let e=0,a=r.length;e<a;e++){let a=r[e];this._batchOneElement(a,t)}return t._batchRender=this,t.setRenderbitFlag(e.RenderBitFlag.RenderBitFlag_InstanceBatch,!0),!0}_removeOneRender(t){if(this._canBatch(t)&&-1!=this._batchList.indexof(t)){this.boundsChange=!0;let r=t._renderElements;for(let e=0,a=r.length;e<a;e++){let a=r[e];this._removeOneElement(a,t)}t._batchRender=null,t.setRenderbitFlag(e.RenderBitFlag.RenderBitFlag_InstanceBatch,!1)}}_updateOneRender(e){if(this._canBatch(e)&&-1!=this._batchList.indexof(e)){this.boundsChange=!0;let t=e._renderElements;for(let r=0,a=t.length;r<a;r++){let a=t[r];this._updateOneElement(a,e)}}}_clear(){super._clear(),this._insElementMarksArray.forEach((e=>{e&&e.destroy()})),this._insElementMarksArray=[],this._updateChangeElement=[],this._insBatchMarksNums=[]}addList(e){this._batchList||(this._batchList=new t.SingletonList);let r=[];for(var a=0;a<e.length;a++){let t=e[a];t._batchRender||this._isRenderNodeAllCanInstanceBatch(t)&&(r.push(t),this._sumInstanceBatch(t))}a=0;for(var i=r.length;a<i;a++){let e=r[a];this._canBatch(e)&&this._batchList.add(e)}}reBatch(){let e=this._batchList.length,t=this._batchList.elements;for(var r=0;r<e;r++){let e=t[r];this._batchOneRender(e)}}}class Oa extends Na{_addList(e){}}class ba extends L{_getStaticInstanceBatchRender(){let e=this.owner.getComponent(Fa);return e||(e=this.owner.addComponent(Fa)),e}_getStatiVertexMergeBatchRender(){let e=this.owner.getComponent(Oa);return e||(e=this.owner.addComponent(Oa)),e}get checkLOD(){return this._checkLOD}set checkLOD(e){this._checkLOD=e,this._enableStaticInstanceBatch&&(this._instanceBatchRender.checkLOD=e),this._enableStaticVertexMergeBatch&&(this._vertexMergeBatchRender.checkLOD=e),this._enableCustomBatch&&this._customBatchs.forEach((t=>{t.checkLOD=e}))}get enableStaticInstanceBatchRender(){return this._enableStaticInstanceBatch}set enableStaticInstanceBatchRender(e){!this._instanceBatchRender&&e&&(this._instanceBatchRender=this._getStaticInstanceBatchRender()),e!=this._enableStaticInstanceBatch&&(this._instanceBatchRender.enabled=!!e,this._enableStaticInstanceBatch=e)}get enableMergeBatchRender(){return this._enableStaticVertexMergeBatch}set enableMergeBatchRender(e){!this._vertexMergeBatchRender&&e&&(this._vertexMergeBatchRender=this._getStatiVertexMergeBatchRender()),e!=this._enableStaticVertexMergeBatch&&(this._vertexMergeBatchRender.enabled=!!e,this._enableStaticVertexMergeBatch=e)}get enableCustomBatchRender(){return this._enableCustomBatch}set enableCustomBatchRender(e){this._enableCustomBatch=e,this._customBatchs.forEach((t=>{t.enabled=e}))}get customBatchRenders(){return this._customBatchs}set customBatchRenders(e){this._customBatchs&&this._customBatchs.forEach((e=>{this.owner._destroyComponent(e)})),this._customBatchs=e,this._customBatchs.forEach((e=>{this.owner.addComponentInstance(e)})),this.enableCustomBatchRender=this._enableCustomBatch}constructor(){super(),this._customBatchs=[],this.checkLOD=!0,this._enableStaticInstanceBatch=!1,this._enableStaticVertexMergeBatch=!1,this._cacheRender=new t.SingletonList,this._batchRender=new t.SingletonList,this._enableCustomBatch=!1}_restorRenderNode(){this.enableCustomBatchRender&&this._customBatchs.forEach((e=>{e._clear()})),this._enableStaticInstanceBatch&&this._instanceBatchRender._clear(),this.enableCustomBatchRender&&this._vertexMergeBatchRender._clear()}__addRenderNodeToBatch(e){this.enableCustomBatchRender&&this._customBatchs.forEach((t=>{t._batchOneRender(e)})),this._enableStaticInstanceBatch&&this._instanceBatchRender._batchOneRender(e)||!this.enableCustomBatchRender||this._vertexMergeBatchRender._batchOneRender(e)}__removeRenderNodeFromBatch(e){e._batchRender._removeOneRender(e)}_onEnable(){super._onEnable(),this._enableStaticInstanceBatch&&this._instanceBatchRender&&(this._instanceBatchRender.enabled=!0),this._enableStaticVertexMergeBatch&&this._vertexMergeBatchRender&&(this._vertexMergeBatchRender.enabled=!0),this.enableCustomBatchRender&&this._customBatchs.forEach((e=>{e.enabled=!0}))}_onDisable(){super._onDisable(),this._enableStaticInstanceBatch&&this._instanceBatchRender&&(this._instanceBatchRender.enabled=!1),this._enableStaticVertexMergeBatch&&this._vertexMergeBatchRender&&(this._vertexMergeBatchRender.enabled=!1),this.enableCustomBatchRender&&this._customBatchs.forEach((e=>{e.enabled=!1}))}_addRenderNode(t){if(t.renderNode.staticMask==e.StaticFlag.StaticBatch){if(-1!=this._cacheRender.indexof(t))return;this._cacheRender.add(t),this._batchRender.length>0&&this.__addRenderNodeToBatch(t)}}_removeRenderNode(t){t.renderNode.staticMask==e.StaticFlag.StaticBatch&&-1!=this._batchRender.indexof(t)&&(this.__removeRenderNodeFromBatch(t),this._batchRender.remove(t))}_VolumeChange(){super._VolumeChange(),this._cacheRender.clear()}onStart(){this.reBatch()}reBatch(){this._cacheRender.elements.length=this._cacheRender.length,this._batchRender.clear(),this._restorRenderNode(),this.enableCustomBatchRender&&this._customBatchs.forEach((e=>{e.addList(this._cacheRender.elements),e.reBatch()})),this._enableStaticInstanceBatch&&(this._instanceBatchRender.addList(this._cacheRender.elements),this._instanceBatchRender.reBatch()),this.enableCustomBatchRender&&(this._vertexMergeBatchRender.addList(this._cacheRender.elements),this._vertexMergeBatchRender.reBatch());for(var e=0,t=this._cacheRender.length;e<t;e++)this._cacheRender.elements[e]._batchRender&&this._batchRender.add(this._cacheRender.elements[e])}}class Va extends xe{constructor(e){super(t.MeshTopology.Triangles,t.DrawType.DrawElement),this._owner=e,this.bufferState=new t.BufferState,this._bound=new w,this._createBuffer(),this.indexFormat=t.IndexFormat.UInt16}get bounds(){return this._bound}_createBuffer(){var e=t.VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),r=.5,a=.5;this._vertex=new Float32Array([-.5,a,0,0,0,1,0,0,r,a,0,0,0,1,1,0,-.5,-.5,0,0,0,1,0,1,r,-.5,0,0,0,1,1,1]),this._index=new Uint16Array([0,1,2,3,2,1]),this._vertexBuffer=E.renderOBJCreate.createVertexBuffer3D(4*this._vertex.length,t.BufferUsage.Dynamic,!1),this._vertexBuffer.vertexDeclaration=e,this._vertexBuffer.setData(this._vertex.buffer),this._indexBuffer=E.renderOBJCreate.createIndexBuffer3D(t.IndexFormat.UInt16,this._index.length,t.BufferUsage.Static,!1),this._indexBuffer.setData(this._index),this.bufferState=new t.BufferState,this.bufferState.applyState([this._vertexBuffer],this._indexBuffer),this._bound.setExtent(new t.Vector3(r,a,r)),this._bound.setCenter(new t.Vector3(0,0,0)),this._positionArray=[new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3],this._positionArray[0].set(-.5,r,0),this._positionArray[1].set(a,r,0),this._positionArray[2].set(-.5,-.5,0),this._positionArray[3].set(a,-.5,0)}_updateRenderParams(e){this.clearRenderParams(),this.setDrawElemenParams(6,0)}destroy(){super.destroy(),this.bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this.bufferState=null,this._vertexBuffer=null,this._indexBuffer=null,delete this._vertex,delete this._index}}Va._type=xe._typeCounter++,new t.Vector3;class Ua extends U{get sprite(){return this._uisprite}set sprite(e){e!=this._uisprite&&(this._uisprite=e,this._shellSprite.removeChildren(0,this._shellSprite.numChildren-1),e&&this._shellSprite.addChild(e),this._resizeRT(),this.boundsChange=!0)}get prefab(){return this._prefab}set prefab(e){this._prefab=e,this.sprite=e?e.create():null}get scale(){return this._size}set scale(e){e.x<=0||e.y<=0||t.Vector2.equals(e,this._size)||(e.cloneTo(this._size),this._resizeRT(),this.boundsChange=!0,this._scale.setValue(e.x,e.y,1))}get renderMode(){return this.sharedMaterial||(this.sharedMaterial=this._ui3DMat),this.sharedMaterial.materialRenderMode}set renderMode(e){this.sharedMaterial.materialRenderMode=e,this.boundsChange=!0}get cull(){let e=this.sharedMaterial;return e||(e=this._ui3DMat),e.cull}set cull(e){this.sharedMaterial&&(this.sharedMaterial.cull=e)}get resolutionRate(){return this._resolutionRate}set resolutionRate(e){e<=0||this._resolutionRate!=e&&(this._resolutionRate=e,this._resizeRT())}get billboard(){return this._view}set billboard(e){this._view=e,this._sizeChange=!0,this.boundsChange=!0}get enableHit(){return this._hit}set enableHit(e){this._hit=e}set cameraSpace(e){this._cameraSpace!=e&&(this._cameraSpace=e,this._resizeRT())}get cameraSpace(){return this._cameraSpace}set cameraPlaneDistance(e){e=Math.max(0,e),this._cameraPlaneDistance=e}get cameraPlaneDistance(){return this._cameraPlaneDistance}set attachCamera(e){this._camera!=e&&(this._camera=e,this._resizeRT())}get attachCamera(){return this._camera}constructor(){super(),this._sizeChange=!0,this._view=!0,this._bindPropertyName="u_AlbedoTexture",this._hit=!1,this._cameraSpace=!1,this._worldParams=new t.Vector4,this._size=new t.Vector2(1,1),this._resolutionRate=128,this._shellSprite=new t.Sprite,this._shellSprite.name="UI3D",this._shellSprite._setBit(t.NodeFlags.DISPLAYED_INSTAGE,!0),this._shellSprite._setBit(t.NodeFlags.ACTIVE_INHIERARCHY,!0),this._shellSprite._parent=t.ILaya.stage,this._baseRenderNode.shaderData.addDefine(D.SHADERDEFINE_UV0),this._matrix=new t.Matrix4x4,this._scale=new t.Vector3(1,1,1)}_creatDefaultMat(){this._ui3DMat||(this._ui3DMat=new S,this._ui3DMat.materialRenderMode=t.MaterialRenderMode.RENDERMODE_OPAQUE,this._ui3DMat.cull=a.CULL_BACK)}_addRenderElement(){var e=this._renderElements;this.sharedMaterial||(this._creatDefaultMat(),this.sharedMaterial=this._ui3DMat),this._setMaterialTexture();var t=this.sharedMaterial,r=new H;r.setTransform(this.owner._transform),r.render=this,r.material=t,r.renderSubShader=r.material.shader.getSubShaderAt(0),this._geometry=new Va(this),r.setGeometry(this._geometry),e.push(r),this._setRenderElements(),this.geometryBounds=this._geometry.bounds}_isCameraSpaceMode(){return this._cameraSpace&&this._camera}_parseHit(e){let r,a,i=Ua._ray;if(!this._uisprite||!t.LayaEnv.isPlaying)return null;this._matrix.invert(Ha),t.Vector3.transformCoordinate(e.origin,Ha,i.origin),t.Vector3.TransformNormal(e.direction,Ha,i.direction),i.direction.normalize();let n=0,s=0,o=-i.origin.z/i.direction.z;if(o<0)return null;r=i.origin.x+o*i.direction.x,a=i.origin.y+o*i.direction.y,n=r+.5,s=a+.5;let l=n*this._rendertexure2D.width,h=(1-s)*this._rendertexure2D.height,d=t.InputManager.inst.getSpriteUnderPoint(this._uisprite,l,h);return d||null}_resizeRT(){let e,r;this._isCameraSpaceMode()?(e=this._camera.viewport.width,r=this._camera.viewport.height):(e=this._size.x*this._resolutionRate,r=this._size.y*this._resolutionRate);let a=!t.LayaGL.renderEngine._screenInvertY;this._rendertexure2D?this._rendertexure2D.width==e&&this._rendertexure2D.height==r||(this._rendertexure2D.destroy(),this._rendertexure2D=new t.RenderTexture2D(e,r,t.RenderTargetFormat.R8G8B8A8,t.RenderTargetFormat.None),this._rendertexure2D._invertY=a,this._setMaterialTexture()):(this._rendertexure2D=new t.RenderTexture2D(e,r,t.RenderTargetFormat.R8G8B8A8,t.RenderTargetFormat.None),this._rendertexure2D._invertY=a),this._submitRT()}onPreRender(){if(this._isCameraSpaceMode()){this.boundsChange=!0;let e=t.Vector3.TEMP,r=t.Quaternion.TEMP,a=Ga,i=this._camera;if(i.transform.getForward(e),e=e.normalize(),t.Vector3.scale(e,this._cameraPlaneDistance,e),t.Vector3.add(i.transform.position,e,e),i.transform.rotation.cloneTo(r),i.orthographic)a.setValue(i.orthographicVerticalSize*i.aspectRatio,i.orthographicVerticalSize,1);else{let e=Math.tan(t.Utils.toRadian(i.fieldOfView/2))*this._cameraPlaneDistance*2;a.setValue(e*i.aspectRatio,e,1)}t.Matrix4x4.createAffineTransformation(e,r,a,this._matrix)}else if(this.billboard){this._sizeChange=!1;let e=this.owner.scene.cullInfoCamera;t.Matrix4x4.createAffineTransformation(this._transform.position,e.transform.rotation,this._scale,this._matrix)}else this._sizeChange&&(this.boundsChange=!0,this._transform.worldMatrix.cloneTo(this._matrix))}getUITexture(){return this._rendertexure2D}_getCameraDistance(e){return t.Vector3.distance(e,this.owner.transform.position)}_renderUpdate(e){let t=this._baseRenderNode.shaderData;t.setMatrix4x4(x.WORLDMATRIX,this._matrix);let r=this.owner.transform,a=this._worldParams;a.x=r.getFrontFaceValue(),t.setVector(x.WORLDINVERTFRONT,a)}renderUpdate(e){this._renderElements.forEach((t=>{let r=t._geometry;t._renderElementOBJ.isRender=r._prepareRender(e),r._updateRenderParams(e)}))}_submitRT(){this._rendertexure2D&&this._shellSprite.drawToRenderTexture2D(this._rendertexure2D.width,this._rendertexure2D.height,0,0,this._rendertexure2D,!1),this._setMaterialTexture()}_setMaterialTexture(){this._rendertexure2D?(this.sharedMaterial.addDefine(S.SHADERDEFINE_ALBEDOTEXTURE),this.sharedMaterial.setTexture(this._bindPropertyName,this._rendertexure2D)):this.sharedMaterial.removeDefine(S.SHADERDEFINE_ALBEDOTEXTURE)}_checkUIPos(e){return!!this.enableHit&&this._parseHit(e)}_calculateBoundingBox(){this._geometry.bounds._tranform(this._matrix,this._bounds)}_onAdded(){super._onAdded(),this._addRenderElement()}_onDisable(){super._onDisable(),this.owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._transByRotate),this.owner.scene._UI3DManager.remove(this)}_onEnable(){super._onEnable(),this.owner.scene._UI3DManager.add(this),this.owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._transByRotate),this._transByRotate()}_onDestroy(){super._onDestroy(),this._rendertexure2D&&this._rendertexure2D.destroy(),this._shellSprite&&(this._shellSprite._parent=null),this._uisprite&&this._uisprite.destroy(),this._shellSprite&&this._shellSprite.destroy(),this._ui3DMat&&this._ui3DMat.destroy(),this._resolutionRate=null,this._size=null,this._scale=null,this._matrix=null}_transByRotate(){this.billboard||(this._sizeChange=!0),this.boundsChange=!0}}Ua.DEBUG=!1,Ua._ray=new Ve(new t.Vector3,new t.Vector3);const Ha=new t.Matrix4x4,Ga=new t.Vector3;var ka;t.Loader.registerLoader(["lani"],class{load(e){let r=t.AssetDb.inst.getSubAssetURL(e.url,e.uuid,null,"lani");return e.loader.fetch(r,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?Xr._parse(e):null))}},t.Loader.ANIMATIONCLIP);class za{constructor(){ka||(ka={"WhiteTextureCube.ltc":t.TextureCube.whiteTexture,"BlackTextureCube.ltc":t.TextureCube.blackTexture,"GrayTextureCube.ltc":t.TextureCube.grayTexture})}load(e){if(-1!=e.url.indexOf("internal/")){let r=ka[t.Utils.getBaseName(e.url)];if(r)return Promise.resolve(r)}if("ktx"==e.ext||"cubemap"==e.ext){let r=e.url;return"cubemap"==e.ext&&(r=t.AssetDb.inst.getSubAssetURL(r,e.uuid,"0","ktx")),e.loader.fetch(r,"arraybuffer",e.progress.createCallback(),e.options).then((r=>{if(!r)return null;let a=t.KTXTextureInfo.getKTXTextureInfo(r);if(a.dimension!=t.TextureDimension.Cube)return t.Loader.warn("ktxInfo.dimension != TextureDimension.Cube! "+e.url),null;let i=new t.TextureCube(a.width,a.format,a.mipmapCount>1,a.sRGB);i.setKTXData(a);let n=e.obsoluteInst;return n&&n instanceof t.TextureCube&&(i=this.move(n,i)),i}))}return"ltcb"==e.ext||"ltcb.ls"==e.ext?e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((r=>{if(!r)return null;let a=new t.Byte(r),i=a.readUTFString();if("LAYATEXTURECUBE:0000"!==i)return console.warn(`CubemapBinLoader: unknow version. ${i}`),null;let n=a.readUint8(),s=a.getUint8(),o=a.readUint16(),l=a.getUint8(),h=a.getUint8(),d=a.getUint8(),c=a.getUint8(),u=new t.TextureCube(o,n,s>1);u.setPixelsData(null,!1,!1),u.filterMode=l,u.wrapModeU=h,u.wrapModeV=d,u.anisoLevel=c;let _=a.pos,f=o;for(let e=0;e<s;e++){let t=new Array(6),a=f*f*u._getFormatByteCount();for(let e=0;e<6;e++)t[e]=new Uint8Array(r,_,a),_+=a;u.updateSubPixelsData(t,0,0,f,f,e,!1,!1,!1),f/=2}let g=e.obsoluteInst;return g&&g instanceof t.TextureCube&&(u=this.move(g,u)),u})):e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then((r=>{if(!r)return null;let a=t.URL.getPath(e.url),i=[t.URL.join(a,r.front),t.URL.join(a,r.back),t.URL.join(a,r.left),t.URL.join(a,r.right),t.URL.join(a,r.up),t.URL.join(a,r.down)];return Promise.all(i.map((t=>t?e.loader.fetch(t,"image",e.progress.createCallback(),e.options):Promise.resolve(null)))).then((r=>{var a,i;let n=e.options.constructParams,s=n?n[0]:null!==(i=null===(a=r[0])||void 0===a?void 0:a.width)&&void 0!==i?i:1,o=n?n[1]:t.TextureFormat.R8G8B8A8,l=!!n&&n[3],h=!n||n[5],d=new t.TextureCube(s,o,l,h);d.setImageData(r,!1,!1);let c=e.obsoluteInst;return c&&c instanceof t.TextureCube&&(d=this.move(c,d)),d}))}))}move(e,r){return e._texture=r._texture,e._format=r.format,e.width=r.width,e.height=r.height,e.obsolute=!1,delete t.Resource._idResourcesMap[r.id],e}}t.Loader.registerLoader(["ltc","ltcb","ltcb.ls","cubemap"],za,t.Loader.TEXTURECUBE);t.Loader.registerLoader(["tex2darray"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(),e.options).then((r=>{if(!r)return null;let a=r.textures;if(a){let i=[],n=t.URL.getPath(e.url);for(let e=a.length-1;e>=0;e--)i.unshift(t.URL.join(n,a[e]));return Promise.all(i.map((t=>t?e.loader.fetch(t,"image",e.progress.createCallback(),e.options):Promise.resolve(null)))).then((e=>{let a=new t.Texture2DArray(r.width,r.height,r.depth,r.format,r.mipmap,!1,r.sRGB);return a.setImageData(e,r.premultiplyAlpha,r.invertY),a}))}return new t.Texture2DArray(r.width,r.height,r.depth,r.format,r.mipmap,!1,r.sRGB)}))}},t.Loader.TEXTURECUBE);t.Loader.registerLoader(["lavm"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(),e.options).then((e=>e?new Ia(e):null))}});t.Loader.registerLoader(["controller"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then((t=>{let r=new Ba(t);if(r.data&&r.data.controllerLayers){let t=r.data.controllerLayers,a=[];for(let r=t.length-1;r>=0;r--){t[r].avatarMask&&this.loadAvatarMask(t[r],a,e);let i=t[r].states;this.loadStates(i,a,e)}return Promise.all(a).then((e=>(r.addDeps(e),r)))}return r}))}loadAvatarMask(e,r,a){let i=t.URL.getPath(a.url);if(e.avatarMask&&e.avatarMask._$uuid&&""!=e.avatarMask._$uuid){let n=t.URL.getResURLByUUID(e.avatarMask._$uuid);n.startsWith("res://")||(n=t.URL.join(i,n)),r.push(a.loader.load(n).then((t=>(e.avatarMask=t,t))))}else e.avatarMask=null}loadStates(e,r,a){let i=t.URL.getPath(a.url);for(let n=e.length-1;n>=0;n--){if(e[n].clip&&e[n].clip._$uuid){let s=t.URL.getResURLByUUID(e[n].clip._$uuid);s.startsWith("res://")||(s=t.URL.join(i,s)),r.push(a.loader.load(s).then((t=>(e[n].clip=t,t))))}e[n].states&&this.loadStates(e[n].states,r,a)}}});class Wa{constructor(){this.succeeded=!1,this.collider=null,this.point=new t.Vector3,this.normal=new t.Vector3,this.hitFraction=0,this._inPool=!1}}const Qa=new t.Vector2,Ya=new Ve(new t.Vector3,new t.Vector3),Xa=new Wa;t.InputManager.prototype.getSprite3DUnderPoint=function(r,a){Xa.succeeded=!1;var i=r*=this._stage.clientScaleX,n=a*=this._stage.clientScaleY,s=r/t.Render._mainCanvas.width,o=a/t.Render._mainCanvas.height;r=this._stage.width*s,a=this._stage.height*o,Qa.setValue(r,a);for(let r of this._stage._scene3Ds){let a=r._physicsManager,s=r._UI3DManager,o=r._cameraPool;for(let r=o.length-1;r>=0;r--){let l=o[r],h=l.viewport,d=t.Config3D.pixelRatio;if(i>=h.x&&n>=h.y&&i<=h.width/d+h.x&&n<=h.height/d+h.y){l.viewportPointToRay(Qa,Ya);let t=s.rayCast(Ya);if(t)return t;if(!a)continue;if(a.rayCast(Ya,Xa)||l.clearFlag===e.CameraClearFlags.SolidColor||l.clearFlag===e.CameraClearFlags.Sky)break}}if(Xa.succeeded)return Xa.collider.owner}return null};class Ka{static parse(e,t,r,a){Ka._mesh=r,Ka._subMeshes=a,Ka._version=t,Ka._readData=e,Ka.READ_DATA(),Ka.READ_BLOCK(),Ka.READ_STRINGS();for(var i=0,n=Ka._BLOCK.count;i<n;i++){Ka._readData.pos=Ka._BLOCK.blockStarts[i];var s=Ka._readData.getUint16(),o=Ka._strings[s],l=Ka["READ_"+o];if(null==l)throw new Error("model file err,no this function:"+s+" "+o);l.call(null)}Ka._strings.length=0,Ka._readData=null,Ka._version=null,Ka._mesh=null,Ka._subMeshes=null}static _readString(){return Ka._strings[Ka._readData.getUint16()]}static READ_DATA(){Ka._DATA.offset=Ka._readData.getUint32(),Ka._DATA.size=Ka._readData.getUint32()}static READ_BLOCK(){for(var e=Ka._BLOCK.count=Ka._readData.getUint16(),t=Ka._BLOCK.blockStarts=[],r=Ka._BLOCK.blockLengths=[],a=0;a<e;a++)t.push(Ka._readData.getUint32()),r.push(Ka._readData.getUint32())}static READ_STRINGS(){var e=Ka._readData.getUint32(),t=Ka._readData.getUint16(),r=Ka._readData.pos;Ka._readData.pos=e+Ka._DATA.offset;for(var a=0;a<t;a++)Ka._strings[a]=Ka._readData.readUTFString();Ka._readData.pos=r}static READ_MESH(){Ka._readString();var e,r=Ka._readData.__getBuffer(),a=0,i=Ka._readData.getInt16(),n=Ka._DATA.offset;for(e=0;e<i;e++){var s,o=n+Ka._readData.getUint32(),l=Ka._readData.getUint32(),h=r.slice(o,o+l),d=new Float32Array(h),c=Ka._readString();switch(Ka._version){case"LAYAMODEL:0301":case"LAYAMODEL:0400":s=t.VertexMesh.getVertexDeclaration(c);break;case"LAYAMODEL:0401":s=t.VertexMesh.getVertexDeclaration(c,!1);break;default:throw new Error("LoadModelV03: unknown version.")}if(!s)throw new Error("LoadModelV03: unknown vertexDeclaration.");var u=E.renderOBJCreate.createVertexBuffer3D(4*d.length,t.BufferUsage.Static,!0);u.vertexDeclaration=s,u.setData(d.buffer),Ka._mesh._vertexBuffer=u,Ka._mesh._vertexCount+=u._byteLength/s.vertexStride,a+=4*d.length}var _=n+Ka._readData.getUint32(),f=Ka._readData.getUint32(),g=new Uint16Array(r.slice(_,_+f)),m=E.renderOBJCreate.createIndexBuffer3D(t.IndexFormat.UInt16,f/2,t.BufferUsage.Static,!0);m.setData(g),Ka._mesh._indexBuffer=m,a+=2*m.indexCount,Ka._mesh._setBuffer(Ka._mesh._vertexBuffer,m),Ka._mesh._setCPUMemory(a),Ka._mesh._setGPUMemory(a);var p=Ka._mesh._boneNames=[],S=Ka._readData.getUint16();for(p.length=S,e=0;e<S;e++)p[e]=Ka._strings[Ka._readData.getUint16()];Ka._readData.pos+=8;var D=Ka._readData.getUint32(),T=Ka._readData.getUint32(),A=new Float32Array(r.slice(n+D,n+D+T)),x=A.length,R=Ka._mesh._inverseBindPosesBuffer=new ArrayBuffer(4*x);for(Ka._mesh._inverseBindPoses=[],Ka._mesh._instanceBufferStateType=0!=x?jt.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR:jt.MESH_INSTANCEBUFFER_TYPE_NORMAL,e=0;e<x;e+=16){var M=new t.Matrix4x4(A[e+0],A[e+1],A[e+2],A[e+3],A[e+4],A[e+5],A[e+6],A[e+7],A[e+8],A[e+9],A[e+10],A[e+11],A[e+12],A[e+13],A[e+14],A[e+15],new Float32Array(R,4*e,16));Ka._mesh._inverseBindPoses[e/16]=M}return!0}static READ_SUBMESH(){var e=Ka._readData.__getBuffer(),t=new Kt(Ka._mesh);Ka._readData.getInt16(),Ka._readData.getUint32(),Ka._readData.getUint32();var r=Ka._readData.getUint32(),a=Ka._readData.getUint32(),i=Ka._mesh._indexBuffer;t._indexBuffer=i,t._setIndexRange(r,a);var n=Ka._mesh._vertexBuffer;t._vertexBuffer=n;var s=Ka._DATA.offset,o=t._subIndexBufferStart,l=t._subIndexBufferCount,h=t._boneIndicesList,d=Ka._readData.getUint16();o.length=d,l.length=d,h.length=d;var c=Ka._mesh._skinnedMatrixCaches,u=Ka._subMeshes.length;c.length=Ka._mesh._inverseBindPoses.length;for(var _=0;_<d;_++){o[_]=Ka._readData.getUint32(),l[_]=Ka._readData.getUint32();for(var f=Ka._readData.getUint32(),g=Ka._readData.getUint32(),m=h[_]=new Uint16Array(e.slice(s+f,s+f+g)),p=m.length,S=0;S<p;S++){var E=m[S];c[E]||(c[E]=new Jt(u,_,S))}}return Ka._subMeshes.push(t),!0}}Ka._BLOCK={count:0},Ka._DATA={offset:0,size:0},Ka._strings=[];class Ja{constructor(){this.fullWeight=1}}class ja{constructor(){this.targetCount=0,this.targets=new Array}getTargetByIndex(e){return this.targets[e]}addTarget(e){this.targetCount++,this.targets.push(e),this.targets.sort(((e,t)=>e.fullWeight-t.fullWeight))}}class qa{constructor(){this.targets=new Array,this.channels=new Array,this.bounds=new w,this.params=new t.Vector4}addMorphChannel(e){e._index=this.channels.length,this.channels.push(e),e.targets.forEach((e=>{e._index=this.targets.length,this.targets.push(e)}))}getMorphChannel(e){return this.channels.find((t=>t.name==e))}getMorphChannelbyIndex(e){return this.channels[e]}get targetCount(){return this.targets.length}get channelCount(){return this.channels.length}initData(){if(t.LayaGL.renderEngine.getCapable(t.RenderCapable.Texture3D)){let e=this.targets.length,r=t.LayaGL.renderEngine.getParams(t.RenderParams.MAX_Texture_Size),a=this.vertexCount,i=this.vertexDec,n=i.vertexStride/4,s=i.vertexElementCount;this.elementCount=s;let o=Math.floor(s*a/r)+1,l=4;this.targetTexture=new t.Texture2DArray(r,o,e,t.TextureFormat.R32G32B32A32,!1,!1,!1),this.targetTexture.filterMode=t.FilterMode.Point,this.targetTexture.anisoLevel=1,this.targetTexture.lock=!0;let h=new Float32Array(r*o*e*l).fill(0),d=this.attributeOffset=new t.Vector4(0,0,0,0);d.x=i._vertexElements.indexOf(i.getVertexElementByUsage(t.VertexMesh.MESH_POSITION0)),d.y=i._vertexElements.indexOf(i.getVertexElementByUsage(t.VertexMesh.MESH_NORMAL0)),d.z=i._vertexElements.indexOf(i.getVertexElementByUsage(t.VertexMesh.MESH_TANGENT0));let c=r*o;for(let r=0;r<e;r++){let e=this.targets[r];for(let o=0;o<a;o++){let a=(r*c+o*s)*l;i._vertexElements.forEach(((r,i)=>{let s=a+4*i,l=r.offset/4,d=o*n+l;switch(r.elementUsage){case t.VertexMesh.MESH_POSITION0:case t.VertexMesh.MESH_NORMAL0:h[s]=e.data[d],h[s+1]=e.data[d+1],h[s+2]=e.data[d+2];break;case t.VertexMesh.MESH_TANGENT0:h[s]=e.data[d],h[s+1]=e.data[d+1],h[s+2]=e.data[d+2],h[s+3]=e.data[d+3]}}))}}this.targetTexture.setPixelsData(h,!1,!1),this.params.setValue(this.targetTexture.width,this.targetTexture.height,this.elementCount,this.channelCount)}}destroy(){this.targetTexture&&(this.targetTexture.lock=!1,this.targetTexture.destroy(),this.targetTexture=null),this.targets=null,this.channels=null}clone(){let e=new qa;e.bounds.setMin(this.bounds.getMin()),e.bounds.setMax(this.bounds.getMax()),e.vertexCount=this.vertexCount,e.vertexDec=this.vertexDec;let t=this.channelCount;for(let r=0;r<t;r++){let t=this.getMorphChannelbyIndex(r),a=new ja;a.name=t.name;let i=t.targetCount;for(let e=0;e<i;e++){let r=t.getTargetByIndex(e),i=new Ja;i.name=r.name,i.fullWeight=r.fullWeight,i.data=new Float32Array(r.data),a.addTarget(i)}e.addMorphChannel(a)}return e.initData(),e}}class Za{static parse(e,t,r,a){Za._mesh=r,Za._subMeshes=a,Za._version=t,Za._readData=e,Za.READ_DATA(),Za.READ_BLOCK(),Za.READ_STRINGS();for(var i=0,n=Za._BLOCK.count;i<n;i++){Za._readData.pos=Za._BLOCK.blockStarts[i];var s=Za._readData.getUint16(),o=Za._strings[s],l=Za["READ_"+o];null==l?console.warn("model file err,no this function:"+s+" "+o):l.call(null)}Za._strings.length=0,Za._readData=null,Za._version=null,Za._mesh=null,Za._subMeshes=null}static _readString(){return Za._strings[Za._readData.getUint16()]}static READ_DATA(){Za._DATA.offset=Za._readData.getUint32(),Za._DATA.size=Za._readData.getUint32()}static READ_BLOCK(){for(var e=Za._BLOCK.count=Za._readData.getUint16(),t=Za._BLOCK.blockStarts=[],r=Za._BLOCK.blockLengths=[],a=0;a<e;a++)t.push(Za._readData.getUint32()),r.push(Za._readData.getUint32())}static READ_STRINGS(){var e=Za._readData.getUint32(),t=Za._readData.getUint16(),r=Za._readData.pos;Za._readData.pos=e+Za._DATA.offset;for(var a=0;a<t;a++)Za._strings[a]=Za._readData.readUTFString();Za._readData.pos=r}static READ_MESH(){var e,r=0;Za._readString();var a=Za._readData,i=a.__getBuffer(),n=a.getInt16(),s=Za._DATA.offset;for(e=0;e<n;e++){var o,l,h,d=s+a.getUint32(),c=a.getUint32(),u=Za._readString(),_=t.VertexMesh.getVertexDeclaration(u,!1),f=_.vertexStride,g=u.split(","),m=g.length,p=Za._mesh;switch(Za._version){case"LAYAMODEL:05":case"LAYAMODEL:0501":case"LAYAMODEL:0502":o=i.slice(d,d+c*f),l=new Float32Array(o),h=new Uint8Array(o);break;case"LAYAMODEL:COMPRESSION_05":case"LAYAMODEL:COMPRESSION_0501":o=new ArrayBuffer(f*c),l=new Float32Array(o),h=new Uint8Array(o);var S=a.pos;a.pos=d;for(var D=0;D<c;D++)for(var T,A=D*f,x=0;x<m;x++)switch(g[x]){case"POSITION":l[T=A/4]=t.HalfFloatUtils.convertToNumber(a.getUint16()),l[T+1]=t.HalfFloatUtils.convertToNumber(a.getUint16()),l[T+2]=t.HalfFloatUtils.convertToNumber(a.getUint16()),A+=12;break;case"NORMAL":l[T=A/4]=a.getUint8()/127.5-1,l[T+1]=a.getUint8()/127.5-1,l[T+2]=a.getUint8()/127.5-1,A+=12;break;case"COLOR":case"BLENDWEIGHT":l[T=A/4]=a.getUint8()/255,l[T+1]=a.getUint8()/255,l[T+2]=a.getUint8()/255,l[T+3]=a.getUint8()/255,A+=16;break;case"UV":case"UV1":l[T=A/4]=t.HalfFloatUtils.convertToNumber(a.getUint16()),l[T+1]=t.HalfFloatUtils.convertToNumber(a.getUint16()),A+=8;break;case"BLENDINDICES":h[A]=a.getUint8(),h[A+1]=a.getUint8(),h[A+2]=a.getUint8(),h[A+3]=a.getUint8(),A+=4;break;case"TANGENT":l[T=A/4]=a.getUint8()/127.5-1,l[T+1]=a.getUint8()/127.5-1,l[T+2]=a.getUint8()/127.5-1,l[T+3]=a.getUint8()/127.5-1,A+=16}a.pos=S}var R=E.renderOBJCreate.createVertexBuffer3D(o.byteLength,t.BufferUsage.Static,!0);R.vertexDeclaration=_,R.setData(o);c=R._byteLength/_.vertexStride;p._indexFormat=c>65535?t.IndexFormat.UInt32:t.IndexFormat.UInt16,p._vertexBuffer=R,p._vertexCount+=c,r+=4*l.length}var M,C=s+a.getUint32(),I=a.getUint32();M=p.indexFormat==t.IndexFormat.UInt32?new Uint32Array(i.slice(C,C+I)):new Uint16Array(i.slice(C,C+I));var v=E.renderOBJCreate.createIndexBuffer3D(p.indexFormat,M.length,t.BufferUsage.Static,!0);if(v.setData(M),p._indexBuffer=v,p._setBuffer(p._vertexBuffer,v),r+=M.byteLength,p._setCPUMemory(r),p._setGPUMemory(r),"LAYAMODEL:0501"==Za._version||"LAYAMODEL:COMPRESSION_0501"==Za._version||"LAYAMODEL:0502"==Za._version){var y=p.bounds,B=y.getMin(),w=y.getMax();B.setValue(a.getFloat32(),a.getFloat32(),a.getFloat32()),w.setValue(a.getFloat32(),a.getFloat32(),a.getFloat32()),y.setMin(B),y.setMax(w),p.bounds=y}var L=p._boneNames=[],N=a.getUint16();for(L.length=N,e=0;e<N;e++)L[e]=Za._strings[a.getUint16()];var P=a.getUint32(),F=a.getUint32(),O=new Float32Array(i.slice(s+P,s+P+F)),b=O.length,V=p._inverseBindPosesBuffer=new ArrayBuffer(4*b);for(p._inverseBindPoses=[],p._instanceBufferStateType=0!=b?jt.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR:jt.MESH_INSTANCEBUFFER_TYPE_NORMAL,e=0;e<b;e+=16){var U=new t.Matrix4x4(O[e+0],O[e+1],O[e+2],O[e+3],O[e+4],O[e+5],O[e+6],O[e+7],O[e+8],O[e+9],O[e+10],O[e+11],O[e+12],O[e+13],O[e+14],O[e+15],new Float32Array(V,4*e,16));p._inverseBindPoses[e/16]=U}return!0}static READ_SUBMESH(){var e=Za._readData,t=e.__getBuffer(),r=new Kt(Za._mesh);e.getInt16();var a=e.getUint32(),i=e.getUint32(),n=Za._mesh._indexBuffer;r._indexBuffer=n,r._setIndexRange(a,i);var s=Za._mesh._vertexBuffer;r._vertexBuffer=s;var o=Za._DATA.offset,l=r._subIndexBufferStart,h=r._subIndexBufferCount,d=r._boneIndicesList,c=e.getUint16();l.length=c,h.length=c,d.length=c;var u=Za._mesh._skinnedMatrixCaches,_=Za._subMeshes.length;u.length=Za._mesh._inverseBindPoses.length;for(var f=0;f<c;f++){l[f]=e.getUint32(),h[f]=e.getUint32();for(var g=e.getUint32(),m=e.getUint32(),p=d[f]=new Uint16Array(t.slice(o+g,o+g+m)),S=0,E=p.length;S<E;S++){var D=p[S];u[D]||(u[D]=new Jt(_,f,S))}}return Za._subMeshes.push(r),!0}static READ_MORPH(){let e=Za._readData,r=e.__getBuffer(),a=Za._DATA.offset,i=Za._mesh,n=i.morphTargetData=new qa,s=Za._strings[e.getUint16()];n.vertexDec=t.VertexMesh.getVertexDeclaration(s);let o=n.bounds,l=o.getMin(),h=o.getMax();l.set(e.getFloat32(),e.getFloat32(),e.getFloat32()),h.set(e.getFloat32(),e.getFloat32(),e.getFloat32()),o.setMin(l),o.setMax(h);let d=e.readUint16();for(let t=0;t<d;t++){let t=new ja;t.name=Za._strings[e.getUint16()];let i=e.readUint16();for(let n=0;n<i;n++){let i=new Ja,n=Za._strings[e.getUint16()];i.name=n,i.fullWeight=e.readFloat32();let s=e.readUint32(),o=e.readUint32();i.data=new Float32Array(r.slice(a+s,a+s+o)),t.addTarget(i)}n.addMorphChannel(t)}return n.vertexCount=i.vertexCount,n.initData(),!0}static READ_UVSIZE(){Za._mesh._width=Za._readData.readUint16(),Za._mesh._height=Za._readData.readUint16()}}Za._BLOCK={count:0},Za._DATA={offset:0,size:0},Za._strings=[];class $a{static parse(e,t){var r=new jt;let a=r._subMeshes;switch(t){case"LAYAMODEL:0301":case"LAYAMODEL:0400":case"LAYAMODEL:0401":Ka.parse(e,t,r,a);break;case"LAYAMODEL:05":case"LAYAMODEL:COMPRESSION_05":case"LAYAMODEL:0501":case"LAYAMODEL:COMPRESSION_0501":case"LAYAMODEL:0502":Za.parse(e,t,r,a);break;default:throw new Error("unknown mesh version: "+t)}return r._setSubMeshes(a),"LAYAMODEL:0501"!=t&&"LAYAMODEL:COMPRESSION_0501"!=t&&"LAYAMODEL:0502"!=t&&r.calculateBounds(),r}static _parse(e){var t=new jt;return $a.read(e,t,t._subMeshes),t}static read(e,r,a){var i=new t.Byte(e);i.pos=0;var n=i.readUTFString();switch(n){case"LAYAMODEL:0301":case"LAYAMODEL:0400":case"LAYAMODEL:0401":Ka.parse(i,n,r,a);break;case"LAYAMODEL:05":case"LAYAMODEL:COMPRESSION_05":case"LAYAMODEL:0501":case"LAYAMODEL:COMPRESSION_0501":case"LAYAMODEL:0502":Za.parse(i,n,r,a);break;default:throw new Error("unknown mesh version: "+n)}r._setSubMeshes(a),"LAYAMODEL:0501"!=n&&"LAYAMODEL:COMPRESSION_0501"!=n&&"LAYAMODEL:0502"!=n&&r.calculateBounds()}}t.MeshLoader.v3d=$a;let ei=t.ClassUtils.regClass;ei("Sprite3D",x),ei("Scene3D",Qt),ei("Camera",Vt),ei("LightSprite",Kr),ei("AreaLightCom",da),ei("DirectionLightCom",sa),ei("PointLightCom",oa),ei("SpotLightCom",la),ei("RenderableSprite3D",B),ei("MeshSprite3D",z),ei("MeshFilter",A),ei("BaseRender",U),ei("MeshRenderer",k),ei("SimpleSkinnedMeshSprite3D",Mr),ei("SkinnedMeshSprite3D",qr),ei("SkinnedMeshRenderer",xr),ei("SimpleSkinnedMeshRenderer",Rr),ei("SkyRenderer",Ie),ei("PixelLineRenderer",Sa),ei("PixelLineData",fa),ei("Transform3D",fe),ei("Lightmap",Pe),ei("ReflectionProbe",b),ei("VolumetricGI",P),ei("StaticBatchVolume",ba),ei("StaticInstanceBatchRender",Fa),ei("SphericalHarmonicsL2",Zr),ei("Viewport",t.Viewport),ei("Bounds",w),ei("BoundBox",aa),ei("TextureCube",t.TextureCube),ei("Mesh",jt),ei("RenderTexture",t.RenderTexture),ei("Animator",Aa),ei("AnimatorController",Ba),ei("AnimatorControllerLayer",Da),ei("AnimatorState",Ca),ei("AnimationClip",Xr),ei("AvatarMask",Ia),ei("UI3D",Ua),ei("Material",t.Material),ei("BlinnPhongMaterial",i),ei("EffectMaterial",Jr),ei("ExtendTerrainMaterial",jr),ei("PBRStandardMaterial",g),ei("SkyBoxMaterial",m),ei("SkyPanoramicMaterial",Cr),ei("SkyProceduralMaterial",p),ei("UnlitMaterial",S),ei("LODInfo",ua),ei("LODGroup",_a),ei("DirectionLightCom",sa),ei("MeshRenderer",k),ei("MeshFilter",A),ei("MeshRenderer",k),ei("SkinnedMeshRenderer",xr),ei("SimpleSkinnedMeshRenderer",Rr),ei("SkyRenderer",Ie),ei("PostProcess",Br),ei("PostProcessEffect",va);class ti extends Vt{constructor(){super(...arguments),this.isWebXR=!0}get renderTarget(){return this._internalRenderTexture}set renderTarget(e){this._internalRenderTexture=e}set clientWidth(e){this._clientWidth=e}set clientHeight(e){this._clientHeight=e}get clientWidth(){return this._clientWidth}get clientHeight(){return this._clientHeight}_restoreView(e){var t,r,a=this.viewport,i=a.width,n=a.height;this._needInternalRenderTexture()?(t=0,r=0):(t=a.x,r=this._getCanvasHeight()-a.y-n),e.viewport(t,r,i,n)}render(){if(this.activeInHierarchy){this.viewport;var e=Y._instance;e.scene=this._scene,e.pipelineMode=e.configPipeLineMode}}_renderMainPass(e,t,r,a,i,n){}_calculateProjectionMatrix(){}clear(e){e.viewport(0,0,this._clientWidth,this._clientHeight),e.scissor(0,0,this._clientWidth,this._clientHeight),e.clearColor(this.clearColor.r,this.clearColor.g,this.clearColor.b,this.clearColor.a),t.RenderStateContext.setDepthMask(!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}destroy(){super.destroy(!0)}}class ri extends t.RenderTexture{constructor(){super(1,1,1,t.RenderTargetFormat.STENCIL_8,!1,1),this.frameLoop=-1}set frameBuffer(e){this._frameBuffer=e}_create(e,t){}}class ai extends t.EventDispatcher{constructor(){super(),this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this._sessionEnded=!1}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e}get sessionMode(){return this._sessionMode}exitXR(){this.endXRRenderLoop(),this.event(ai.EVENT_MANAGER_END)}initializeXRGL(e,t){return t.makeXRCompatible().then((()=>!0))}initializeAsync(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")}isSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);this._xrNavigator=navigator;return navigator.xr.isSessionSupported||navigator.xr.supportsSession?navigator.xr.isSessionSupported(e):Promise.resolve(!1)}initializeSessionAsync(e="immersive-vr",t={}){return this._xrNavigator.xr.requestSession("immersive-vr").then((t=>(this.session=t,this._sessionMode=e,this._sessionEnded=!1,this.session.addEventListener("end",(()=>{this._sessionEnded=!0,this.exitXR()}),{once:!0}),this.session)))}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){this.session.requestAnimationFrame.bind(this.session);let e=(r,a)=>{this._updateByXrFrame(a,r),this.event(ai.EVENT_FRAME_LOOP,[a]),t.ILaya.stage._loop(),this.session.requestAnimationFrame(e)};this.session.requestAnimationFrame(e)}endXRRenderLoop(){}_updateByXrFrame(e,t){this.currentFrame=e,this.currentTimestamp=t}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then((e=>e),(e=>this.session.requestReferenceSpace("viewer").then((e=>{const t=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return e.getOffsetReferenceSpace(t)}),(e=>{throw'XR initialization failed: required "viewer" reference space type not supported.'})))).then((e=>(this.referenceSpace=this.baseReferenceSpace=e,this.referenceSpace)))}updateRenderStateAsync(e){return e.baseLayer&&(this._baseLayer=e.baseLayer),this.session.updateRenderState(e)}get currentFrameRate(){var e;return null===(e=this.session)||void 0===e?void 0:e.frameRate}get supportedFrameRates(){var e;return null===(e=this.session)||void 0===e?void 0:e.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}destroy(){this._sessionEnded||this.exitXR()}}ai.EVENT_MANAGER_END="xrManagerDestory",ai.EVENT_FRAME_LOOP="xrFrameLoop";class ii{get position(){return this._position}set position(e){e.cloneTo(this._position)}get rotationQuaternion(){return this._referenceQuaternion}set rotationQuaternion(e){e.cloneTo(this._referenceQuaternion)}get rigCameras(){return this._rigCameras}constructor(e,r=null){this._referenceQuaternion=new t.Quaternion,this._referencedPosition=new t.Vector3,this._firstFrame=!0,this._XRRenderTexture=new ri,this._rigCameras=new Array,this._position=new t.Vector3,this.owner=e,this.owner.enableRender=!1,this.owner.aspectRatio||console.warn("owner is not Camera"),this._webXRSessionManager=r,this._webXRSessionManager.on(ai.EVENT_FRAME_LOOP,this,this._updateFromXRSession),this._webXRSessionManager.on(ai.EVENT_FRAME_LOOP,this,this._updateReferenceSpace),this._webXRSessionManager.on(ai.EVENT_MANAGER_END,this,this.destroy)}_updateFromXRSession(){let e=this._webXRSessionManager.currentFrame&&this._webXRSessionManager.currentFrame.getViewerPose(this._webXRSessionManager.referenceSpace);const t=e.transform.position,r=e.transform.orientation;this._referenceQuaternion.setValue(r.x,r.y,r.z,r.w),this._referencedPosition.setValue(t.x,t.y,t.z),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.setValue(0,0,0,1)):(this.rotationQuaternion=this._referenceQuaternion,this.position=this._referencedPosition),this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach(((e,t)=>{const r=this.rigCameras[t];"right"===e.eye?r.name="right":"left"===e.eye&&(r.name="left");const a=e.transform.position,i=e.transform.orientation;if(r.transform.position.setValue(a.x,a.y,a.z),r.transform.rotation.setValue(i.x,i.y,i.z,i.w),r.transform.position=r.transform.position,r.transform.rotation=r.transform.rotation,this._webXRSessionManager.session.renderState.baseLayer){var n=this._webXRSessionManager.session.renderState.baseLayer.getViewport(e),s=this._webXRSessionManager.session.renderState.baseLayer.framebufferWidth,o=this._webXRSessionManager.session.renderState.baseLayer.framebufferHeight;this._XRRenderTexture.frameBuffer=this._webXRSessionManager.session.renderState.baseLayer.framebuffer,r.renderTarget=this._XRRenderTexture,r.clientWidth=s,r.clientHeight=o;var l=r.viewport;l.x=n.x,l.y=n.y,l.width=n.width,l.height=n.height,r.viewport=l,r.projectionMatrix.cloneByArray(e.projectionMatrix)}}))}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){var t=new ti(this.owner.aspectRatio,this.owner.nearPlane,this.owner.farPlane);t.clearFlag=this.owner.clearFlag,t.clearColor=this.owner.clearColor,this.owner.addChild(t),this.rigCameras.push(t)}for(;this.rigCameras.length>e;){let e=this.rigCameras.pop();this.owner.removeChild(e)}}_updateReferenceSpace(){}destroy(){this.owner.enableRender=!0,this._webXRSessionManager.off(ai.EVENT_FRAME_LOOP,this,this._updateFromXRSession),this._webXRSessionManager.off(ai.EVENT_FRAME_LOOP,this,this._updateReferenceSpace),this._webXRSessionManager.off(ai.EVENT_MANAGER_END,this,this.destroy),this._rigCameras.forEach((e=>{e.destroy()})),this._rigCameras=null,this._XRRenderTexture.destroy()}}class ni extends t.EventDispatcher{constructor(e,t){super(),this.axisData=new Array,this.handness=e,this.axisData.length=t,this.axisLength=t}update(e){for(let r=0,a=0;r<e.axes.length;r+=2,++a)this.axisData[a]||(this.axisData[a]=new t.Vector2),this.axisData[a].setValue(e.axes[r],e.axes[r+1]),this.outPutStickValue(this.axisData[a],a)}outPutStickValue(e,t){const r=ni.EVENT_OUTPUT+t.toString();this.event(r,[e])}destroy(){for(let e=0;e<this.axisLength;e++){let t=ni.EVENT_OUTPUT+e.toString();this.offAll(t)}}}ni.EVENT_OUTPUT="outputAxi_id";class si extends t.EventDispatcher{constructor(e,t){super(),this.lastTouch=!1,this.lastPress=!1,this.lastPressValue=0,this.touch=!1,this.press=!1,this.pressValue=0,this.handness=e,this.index=t}update(e){this.lastTouch=this.touch,this.lastPress=this.press,this.lastPressValue=this.pressValue,this.touch=e.touched,this.press=e.pressed,this.pressValue=e.value,(this.lastTouch||this.touch)&&(this.lastTouch!=this.touch&&this.touch?this.touchEnter():this.lastTouch==this.touch&&this.touch?this.touchStay():this.lastTouch==this.touch||this.touch||this.touchOut(),this.lastPress!=this.press&&this.press?this.pressEnter():this.lastPress==this.press&&this.press?this.pressStay():this.lastPress==this.press||this.press||this.pressOut(),this.touch&&this.outpressed())}touchEnter(){this.event(si.EVENT_TOUCH_ENTER)}touchStay(){this.event(si.EVENT_TOUCH_STAY)}touchOut(){this.event(si.EVENT_TOUCH_OUT)}pressEnter(){this.event(si.EVENT_PRESS_ENTER)}pressStay(){this.event(si.EVENT_PRESS_STAY)}pressOut(){this.event(si.EVENT_PRESS_OUT)}outpressed(){this.event(si.EVENT_PRESS_VALUE,[this.pressValue])}destroy(){this.offAll(si.EVENT_PRESS_ENTER),this.offAll(si.EVENT_PRESS_STAY),this.offAll(si.EVENT_PRESS_OUT),this.offAll(si.EVENT_PRESS_ENTER),this.offAll(si.EVENT_PRESS_STAY),this.offAll(si.EVENT_PRESS_OUT),this.offAll(si.EVENT_PRESS_VALUE)}}si.EVENT_TOUCH_ENTER="touchEnter",si.EVENT_TOUCH_STAY="touchStay",si.EVENT_TOUCH_OUT="touchOut",si.EVENT_PRESS_ENTER="pressEnter",si.EVENT_PRESS_STAY="pressStay",si.EVENT_PRESS_OUT="pressOut",si.EVENT_PRESS_VALUE="outpressed";class oi extends t.EventDispatcher{constructor(e){super(),this.preButtonEventList=[],this.preAxisEventList=[],this.handness=e,this.position=new t.Vector3,this.rotation=new t.Quaternion,this.ray=new Ve(new t.Vector3,new t.Vector3)}_updateByXRPose(e,r){const a=e.getPose(this._inputSource.targetRaySpace,r);if(this._lastXRPose=a,a){const e=a.transform.position,r=a.transform.orientation;oi.tempQua.setValue(r.x,r.y,r.z,r.w),this.ray.origin.setValue(e.x,e.y,e.z),t.Vector3.transformQuat(t.Vector3.UnitZ,oi.tempQua,this.ray.direction),t.Vector3.scale(this.ray.direction,-1,this.ray.direction)}if(this._inputSource.gripSpace){let t=e.getPose(this._inputSource.gripSpace,r);if(t){const e=t.transform.position,r=t.transform.orientation;this.position.setValue(e.x,e.y,e.z),this.rotation.setValue(r.x,r.y,r.z,r.w)}}this.event(oi.EVENT_FRAMEUPDATA_WEBXRINPUT,[this]),this._handleProcessGamepad()}_handleProcessGamepad(){const e=this._inputSource.gamepad;if(this.gamepadAxis||(this.gamepadAxis=new ni(this.handness,e.axes.length),this.preAxisEventList.forEach((e=>{this.gamepadAxis.on(e.eventnam,e.caller,e.listener)}))),!this.gamepadButton){this.gamepadButton=[];for(let t=0;t<e.buttons.length;++t)this.gamepadButton.push(new si(this.handness,t));this.preButtonEventList.forEach((e=>{this.addButtonEvent(e.index,e.type,e.caller,e.listener)}))}this.gamepadAxis.update(e);for(let t=0;t<e.buttons.length;++t){this.gamepadButton[t].update(e.buttons[t])}}addButtonEvent(e,t,r,a){if(this.gamepadButton){this.gamepadButton[e].on(t,r,a)}else this.preButtonEventList.push({index:e,type:t,caller:r,listener:a})}addAxisEvent(e,t,r,a){if(this.gamepadAxis){const i=t+e.toString();this.gamepadAxis.on(i,r,a)}else this.preAxisEventList.push({eventnam:t+e.toString(),caller:r,listener:a})}offAxisEvent(e,t,r,a){if(this.gamepadAxis){const i=t+e.toString();this.gamepadAxis.off(i,r,a)}}offButtonEvent(e,t,r,a){if(this.gamepadButton){this.gamepadButton[e].off(t,r,a)}}destroy(){this.preButtonEventList=null,this.ray=null,this.position=null,this.rotation=null,this.gamepadAxis.destroy(),this.gamepadButton.forEach((e=>{e.destroy()}))}}oi.HANDNESS_LEFT="left",oi.HANDNESS_RIGHT="right",oi.EVENT_FRAMEUPDATA_WEBXRINPUT="frameXRInputUpdate",oi.tempQua=new t.Quaternion;class li{constructor(e,r){this.controllers=new Map,this.controllerHandMesh=new Map,this.controllerLineRender=new Map,this.lineColor=t.Color.RED,this.rayLength=2,this.webXRSessionManager=e,this.webXRCameraManager=r,this.webXRSessionManager.on(ai.EVENT_MANAGER_END,this,this.destory),this.webXRSessionManager.on(ai.EVENT_FRAME_LOOP,this,this._updateFromXRFrame)}_updateMeshRender(e){const r=e.handness;if(this.controllerHandMesh.has(r)){let t=this.controllerHandMesh.get(r);t.transform.position=e.position,t.transform.rotation=e.rotation}if(this.controllerLineRender.has(r)){let a=this.controllerLineRender.get(r);a.clear();let i=e.ray;hi.setValue(i.origin.x,i.origin.y,i.origin.z),t.Vector3.scale(i.direction,this.rayLength,di),t.Vector3.add(hi,di,di),a.addLine(hi,di,this.lineColor,this.lineColor)}}_updateFromXRFrame(e){const t=this.webXRSessionManager.session,r=this.webXRSessionManager.referenceSpace;for(let a of t.inputSources){const t=a.handedness;let i;i=this.controllers.has(t)?this.controllers.get(t):this.getController(t),i&&(i=this.controllers.get(t),i._inputSource=a,i._updateByXRPose(e,r))}}bindMeshNode(e,t){this.controllerHandMesh.set(t,e)}bindRayNode(e,t){this.controllerLineRender.set(t,e)}getController(e){if("left"!=e&&"right"!=e)return null;if(!this.controllers.has(e)){let t=new oi(e);this.controllers.set(e,t),t.on(oi.EVENT_FRAMEUPDATA_WEBXRINPUT,this,this._updateMeshRender)}return this.controllers.get(e)}destory(){this.webXRSessionManager.off(ai.EVENT_FRAME_LOOP,this,this._updateFromXRFrame);for(let e in this.controllers)this.controllers.get(e).off("frameXRInputUpdate",this,this._updateMeshRender),this.controllers.get(e).destroy();this.controllers=null,this.controllerHandMesh=null,this.controllerLineRender=null}}const hi=new t.Vector3,di=new t.Vector3;class ci{static supportXR(e){return ci.xr_Manager.isSessionSupportedAsync(e).then((e=>(ci.supported=e,e)))}static enterXRAsync(e,r,a){return"immersive-ar"===e&&"unbounded"!==r&&console.warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode"),ci.xr_Manager.initializeSessionAsync(e).then((()=>ci.xr_Manager.setReferenceSpaceTypeAsync(r))).then((()=>ci.xr_Manager.initializeXRGL(e,t.LayaGL.renderEngine.gl))).then((()=>(ci.glInstance=t.LayaGL.renderEngine.gl,ci.xr_Manager.updateRenderStateAsync({depthFar:a.depthFar,depthNear:a.depthNear,baseLayer:new XRWebGLLayer(ci.xr_Manager.session,t.LayaGL.renderEngine.gl)})))).then((()=>(ci.xr_Manager.runXRRenderLoop(),ci.xr_Manager)))}static setWebXRCamera(e,t){return new ii(e,t)}static setWebXRInput(e,t){return new li(e,t)}}ci.xr_Manager=new ai,ci.supported=!1,ci.canvasOptions={antialias:!0,depth:!0,stencil:!1,alpha:!0,multiview:!1,framebufferScaleFactor:1};class ui extends U{constructor(){super(),this._singleton=!1}get curHLODRS(){return this._curHLODRS}set curHLODRS(e){this._curHLODRS||(this._renderElements=[],this._renderElements.push(new H),this._renderElements[0].render=this),e!=this._curHLODRS&&(this._changeMesh(e.HLODMesh),this._curHLODRS=e,this._createRenderelementByHLODElement(this._curHLODRS,this._renderElements[0]))}_createRenderelementByHLODElement(e,t){t.setGeometry(e.HLODMesh),t.material=e.material}_changeMesh(e){var t=this._baseRenderNode.shaderData;this.boundsChange=!0;let r=A._meshVerticeDefine;if(this.curHLODRS){T.getMeshDefine(this.curHLODRS.HLODMesh.batchMesh,r);for(var a=0,i=r.length;a<i;a++)t.removeDefine(A._meshVerticeDefine[a])}if(e){T.getMeshDefine(e.batchMesh,r);for(a=0,i=A._meshVerticeDefine.length;a<i;a++)t.addDefine(A._meshVerticeDefine[a])}this._curSubBatchMeshBounds.length=e.batchSubMeshInfo.length;for(let t=0,r=e.batchSubMeshInfo.length;t<r;t++)this._curSubBatchMeshBounds[t]=this._curSubBatchMeshBounds[t]?this._curSubBatchMeshBounds[t]:new w}_applyLightMapParams(){if(this._scene){var e=this._baseRenderNode.shaderData,t=this._curHLODRS.lightmap;t&&t.lightmapColor?(e.setTexture(B.LIGHTMAP,t.lightmapColor),e.addDefine(B.SAHDERDEFINE_LIGHTMAP),t.lightmapDirection?(e.setTexture(B.LIGHTMAP_DIRECTION,t.lightmapDirection),e.addDefine(B.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)):e.removeDefine(B.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)):(e.removeDefine(B.SAHDERDEFINE_LIGHTMAP),e.removeDefine(B.SHADERDEFINE_LIGHTMAP_DIRECTIONAL))}}_calculateBoundingBox(){if(this._curHLODRS){var e=this._curHLODRS.HLODMesh;if(e){var t=this._transform.worldMatrix;e.batchMesh.bounds._tranform(t,this._bounds)}for(let r=0,a=this._curSubBatchMeshBounds.length;r<a;r++)e.batchSubMeshInfo[r].bounds._tranform(t,this._curSubBatchMeshBounds[r])}}_renderUpdate(e){this._applyLightMapParams(),this._baseRenderNode.shaderData.setMatrix4x4(x.WORLDMATRIX,this._transform.worldMatrix)}_needRender(e,t){if(e){if(e.intersects(this.bounds)){let t=this.curHLODRS.HLODMesh.drawSubMeshs,r=this._curHLODRS.HLODMesh.batchSubMeshInfo;t.length=0;for(let a=0,i=this._curSubBatchMeshBounds.length;a<i;a++)e.intersects(this._curSubBatchMeshBounds[a])&&t.push(r[a]);return this._curHLODRS.HLODMesh.drawSubMeshs=t,!0}return!1}return!0}onDestroy(){super.onDestroy(),this._renderElements.forEach((e=>{e.material._removeReference(),e.destroy()})),this._renderElements=null}}const _i=new t.Vector3;class fi extends t.Component{constructor(){super(),this._singleton=!0}get bounds(){return this._bounds}set bounds(e){this._bounds=e,this.recalculateBounds()}get lodResource(){return this._resourceList}set lodResource(e){this._resourceList=e}get lodCullRateArray(){return this._lodRateArray}set lodCullRateArray(e){e.sort(((e,t)=>t-e)),this._lodRateArray=e}_applyLODResource(e){this._curLODSource=e;let t=e.resources;for(let e=0,r=t.length;e<r;e++){let r=this.owner.addComponent(ui);this._curRender.push(r),r.curHLODRS=t[e]}}_releaseGroupRender(){this._curRender.forEach((e=>{e.destroy()})),this._curRender=[]}recalculateBounds(){let e=this._bounds.getExtent();this._size=2*Math.max(e.x,e.y,e.z)}onPreRender(){let e=this.owner.scene.cullInfoCamera,r=e.maxlocalYDistance,a=e.boundFrustum;t.Vector3.subtract(this.owner.transform.position,e.transform.position,_i);let i=_i.length();if(i>e.farPlane||0==a.containsPoint(this.owner.transform.position))return;let n=i/e.farPlane*r,s=this._size/n;for(let e=0;e<this._lodRateArray.length;e++)if(!(s<this._lodRateArray[e])){this.applyResource(this._resourceList[e]);break}}onUpdate(){this._curLODSource.updateMark=Vt._updateMark}applyResource(e){e!=this._curLODSource&&(e.loaded?this._curLODSource&&(this._releaseGroupRender(),this._applyLODResource(e)):e.load(this.applyResource,this))}}var gi=t.Script;class mi{constructor(){this.indexStart=0,this.indexCount=0,this.meshBounds=new w(new t.Vector3,new t.Vector3),this.needRender=!1}}class pi extends xe{constructor(){super(t.MeshTopology.Triangles,t.DrawType.DrawElement),this.subInfos=[]}addSubMesh(e,t,r){let a=new mi;a.indexCount=e,a.indexStart=t,r.cloneTo(a.meshBounds),this.subInfos.push(a)}_getType(){return pi._type}_updateRenderParams(e){this.clearRenderParams();let r=e.camera.transform.position;this.subInfos.sort(((e,a)=>{let i=e.meshBounds.getCenter(),n=t.Vector3.distanceSquared(i,r),s=a.meshBounds.getCenter();return n-t.Vector3.distanceSquared(s,r)}));for(const e of this.subInfos)e.needRender&&this.setDrawElemenParams(e.indexCount,e.indexStart*this.indexByteCount)}_prepareRender(e){return!!this.subInfos.find((e=>e.needRender))}destroy(){for(const e of this.subInfos);this.subInfos=null}}pi._type=xe._typeCounter++;const Si=new t.Matrix4x4,Ei=[0,1,2],Di=[0,2,1];class Ti{static create(e){let r,a=new Ti,n=e.vertexCount,s=e.indexCount,o=e.vertexDec,l=o.vertexStride/4,h=new ArrayBuffer(o.vertexStride*n),d=new Float32Array(h),c=t.IndexFormat.UInt16,u=2;n>65535?(c=t.IndexFormat.UInt32,u=4,r=new Uint32Array(s)):r=new Uint16Array(s);let _,f=0,g=0,m=0;for(const n of e.renders){let e=n.lightmapScaleOffset;_||(_=a.bounds,n.bounds.cloneTo(_)),w.merge(_,n.bounds,_);let s=n.owner,h=s.transform._isFrontFaceInvert,p=s.transform.worldMatrix,S=Si;p.invert(S),S.transpose();let E=n.getMesh(),D=E.vertexCount,T=E.indexCount,A=E._vertexBuffer.getFloat32Data();d.set(A,f);for(let r=0;r<D;r++){let a=r*l;for(const r of o._vertexElements)switch(a+=r.offset/4,r.elementUsage){case t.VertexMesh.MESH_POSITION0:K.transformVector3ArrayToVector3ArrayCoordinate(A,a,p,d,f+a);break;case t.VertexMesh.MESH_NORMAL0:case t.VertexMesh.MESH_TANGENT0:K.transformVector3ArrayToVector3ArrayNormal(A,a,S,d,f+a);break;case t.VertexMesh.MESH_TEXTURECOORDINATE1:K.transformLightingMapTexcoordArray(A,a,e,d,f+a)}}let x=E._indexBuffer.getData(),R=h?Di:Ei;for(let e=0;e<T;e+=3)r[m+e]=x[e+R[0]]+g,r[m+e+1]=x[e+R[1]]+g,r[m+e+2]=x[e+R[2]]+g;let M=E.subMeshCount;for(let e=0;e<M;e++){let t=n.sharedMaterials[e]||i.defaultMaterial,r=a._staticSubMeshes.get(t);r||(r=new pi,r.indexByteCount=u,a._staticSubMeshes.set(t,r),r.bufferState=a._bufferState,r.indexFormat=c);let s=E.getSubMesh(e);r.addSubMesh(s.indexCount,s._indexStart+m,n.bounds)}f+=A.length,g+=D,m+=x.length}let p=E.renderOBJCreate.createVertexBuffer3D(h.byteLength,t.BufferUsage.Static,!1);p.vertexDeclaration=o,p.setData(h);let S=E.renderOBJCreate.createIndexBuffer3D(c,s,t.BufferUsage.Static,!1);return S.setData(r),a.setBuffer(p,S),a}constructor(){this._bufferState=new t.BufferState,this._staticSubMeshes=new Map,this.bounds=new w}setBuffer(e,t){let r=this._bufferState;this._vertexBuffer=e,this._indexBuffer=t,r.applyState([e],t)}destroy(){this._staticSubMeshes.forEach((e=>{e.destroy()})),this._staticSubMeshes.clear(),this._staticSubMeshes=null,this._bufferState.destroy()}}class Ai extends H{constructor(){super()}getInvertFront(){return!1}}class xi extends U{static create(e){let t=new xi;return t.mergeInfo=e,t}get staticMesh(){return this._staticMesh}get mergeInfo(){return this._mergeInfo}set mergeInfo(e){this._mergeInfo=e;let t=Ti.create(e);this._staticMesh=t,this.lightmapIndex=e.lightmapIndex,this._staticMesh=t,this.geometryBounds=t.bounds;let r=A._meshVerticeDefine,a=this._baseRenderNode.shaderData;this._getMeshDefine(t,r);for(const e of r)a.addDefine(e);this._renderElements.forEach((e=>{e.material._removeReference(),e.destroy()})),this._renderElements=[],t._staticSubMeshes.forEach(((e,t)=>{let r=new Ai;this._renderElements.push(r),r.render=this,r.material=t,r.setGeometry(e),t._addReference()})),t.bounds.cloneTo(this.bounds)}constructor(){super(),this._singleton=!1}_calculateBoundingBox(){}_renderUpdate(e){}_getMeshDefine(e,r){let a=e._vertexBuffer.vertexDeclaration._vertexElements;for(const e of a)switch(e.elementUsage){case t.VertexMesh.MESH_COLOR0:r.push(D.SHADERDEFINE_COLOR);break;case t.VertexMesh.MESH_TEXTURECOORDINATE0:r.push(D.SHADERDEFINE_UV0);break;case t.VertexMesh.MESH_TEXTURECOORDINATE1:r.push(D.SHADERDEFINE_UV1);break;case t.VertexMesh.MESH_TANGENT0:r.push(D.SHADERDEFINE_TANGENT)}}_needRender(e,t){if(e){if(e.intersects(this.bounds)){let t=!1;return this.staticMesh._staticSubMeshes.forEach((r=>{for(const a of r.subInfos)a.needRender=e.intersects(a.meshBounds),t=t||a.needRender})),t}return!1}return!0}onEnable(){super.onEnable(),this.mergeInfo.renders.forEach((t=>{t.setRenderbitFlag(e.RenderBitFlag.RenderBitFlag_Batch,!0)}))}onDisable(){super.onDisable(),this.mergeInfo.renders.forEach((t=>{t.setRenderbitFlag(e.RenderBitFlag.RenderBitFlag_Batch,!1)}))}onDestroy(){super.onDestroy(),this._renderElements.forEach((e=>{e.material._removeReference(),e.destroy()})),this._renderElements=null,this._staticMesh.destroy(),this._staticMesh=null}_cloneTo(e){e.mergeInfo=this.mergeInfo}}class Ri{static create(e){let t=e.getMesh(),r=new Ri;return r.lightmapIndex=e.lightmapIndex,r.receiveShadow=e.receiveShadow,r.vertexDec=t?t.getVertexDeclaration():null,r}get renders(){return this._renders}constructor(){this._renders=[],this.vertexCount=0,this.indexCount=0}match(e){let t=e.getMesh();e.owner;let r=!0;return r=r&&this.lightmapIndex==e.lightmapIndex,r=r&&this.receiveShadow==e.receiveShadow,r=r&&this.vertexDec==t.getVertexDeclaration(),r}addElement(e){this.renders.push(e);let t=e.getMesh();this.vertexCount+=t.vertexCount,this.indexCount+=t.indexCount}destroy(){this._renders=null}}class Mi{constructor(){this._isNeedUpdate=!1}createInstanceVertexBuffer3D(){this._instanceData=new Float32Array(Lt.maxInstanceCount*this._vertexStride),this._vertexBuffer=E.renderOBJCreate.createVertexBuffer3D(4*this._instanceData.length,t.BufferUsage.Dynamic,!1),this._vertexBuffer.vertexDeclaration=this._vertexDeclaration,this._vertexBuffer.instanceBuffer=!0}updateVertexBufferData(e){if(!this._isNeedUpdate)return;let t,r=this._instanceData,a=this._value,i=this._value.length,n=this._vertexStride,s=0;switch(this._value instanceof Float32Array||(s=1),s){case 0:r.set(a,0);break;case 1:for(let e=0;e<i;e++)t=a[e],t.writeTo(r,e*n)}this._vertexBuffer._deviceBuffer.setDataLength(this._vertexBuffer._byteLength),this._vertexBuffer.setData(r.buffer,0,0,4*e*n)}destroy(){delete this._value,delete this._instanceData,this._vertexDeclaration=null,this._vertexBuffer.destroy()}}var Ci;e.InstanceLocation=void 0,(Ci=e.InstanceLocation||(e.InstanceLocation={}))[Ci.CUSTOME0=12]="CUSTOME0",Ci[Ci.CUSTOME1=13]="CUSTOME1",Ci[Ci.CUSTOME2=14]="CUSTOME2",Ci[Ci.CUSTOME3=15]="CUSTOME3";class Ii{constructor(){this._type=0,this._propertyMap={}}_checkPropertyLegal(e,t,r,a){if(a._vertexDeclaration._vertexElements[0]._elementFormat!==e)throw"Data exists and format does not match";if(a._name!==t)throw"You cannot add a new property to an existing attributeLocation,Please use another attributeLocation"}_creatProperty(e,r,a,i,n){var s=this._propertyMap[n]=new Mi;s._name=e,s._value=r,s._vertexDeclaration=new t.VertexDeclaration(a,[new t.VertexElement(0,i,n)]),s._isNeedUpdate=!0,s._vertexStride=a/4,s.createInstanceVertexBuffer3D()}setVectorArray(e,r,a){var i=this._propertyMap[a];i?(this._checkPropertyLegal(t.VertexElementFormat.Vector4,e,a,i),i._value=r,i._isNeedUpdate=!0):this._creatProperty(e,r,16,t.VertexElementFormat.Vector4,a)}setVector3Array(e,r,a){var i=this._propertyMap[a];i?(this._checkPropertyLegal(t.VertexElementFormat.Vector3,e,a,i),i._value=r,i._isNeedUpdate=!0):this._creatProperty(e,r,12,t.VertexElementFormat.Vector3,a)}setVector2Array(e,r,a){var i=this._propertyMap[a];i?(this._checkPropertyLegal(t.VertexElementFormat.Vector2,e,a,i),i._value=r,i._isNeedUpdate=!0):this._creatProperty(e,r,8,t.VertexElementFormat.Vector2,a)}setNumberArray(e,r,a){var i=this._propertyMap[a];i?(this._checkPropertyLegal(t.VertexElementFormat.Single,e,a,i),i._value=r,i._isNeedUpdate=!0):this._creatProperty(e,r,4,t.VertexElementFormat.Single,a)}getPropertyArray(e){var t=this._propertyMap[e];return t?t._value:null}clear(){for(var e in this._propertyMap)this._propertyMap[e].destroy();this._propertyMap={}}}Ii.INSTANCETYPE_ATTRIBUTE=0,Ii.INSTANCETYPE_UNIFORMBUFFER=1;var vi={};class yi{constructor(){vi||(vi={default:t.Texture2DArray.defaultTexture})}load(e){if(-1!=e.url.indexOf("internal/")){const r=vi[t.Utils.getBaseName(e.url)];if(r)return Promise.resolve(r)}return e.loader.fetch(e.url,"json",e.progress.createCallback(),e.options).then((r=>{if(!r)return null;let a=r.width,i=r.height,n=r.depth,s=r.format,o=r.mipmap,l=r.sRGB,h=!!r.premultiplyAlpha,d=!!r.invertY,c=r.textures,u=[];for(let e=0;e<c.length;e++)u.push(c[e]);return Promise.all(u.map((t=>t?e.loader.fetch(t,"image",e.progress.createCallback(),e.options):Promise.resolve(null)))).then((e=>{if(t.LayaGL.renderEngine.getCapable(t.RenderCapable.Texture3D)){let r=new t.Texture2DArray(a,i,n,s,o,l);return r.setImageData(e,h,d),r}return null}))}))}}t.Loader.registerLoader(["tex2darray"],yi,t.Loader.TEXTURE2DARRAY);class Bi{get center(){return this._center}set center(e){e.cloneTo(this._center)}get radius(){return this._radius}set radius(e){this._radius=e}constructor(e=new t.Vector3,r=0){this._center=e,this._radius=r}toDefault(){this._center.toDefault(),this._radius=0}static createFromSubPoints(e,r,a,i){if(null==e)throw new Error("points");if(r<0||r>=e.length)throw new Error("start"+r+"Must be in the range [0, "+(e.length-1)+"]");if(a<0||r+a>e.length)throw new Error("count"+a+"Must be in the range <= "+e.length+"}");var n=r+a,s=wi;s.x=0,s.y=0,s.z=0;for(var o=r;o<n;++o)t.Vector3.add(e[o],s,s);var l=i.center;t.Vector3.scale(s,1/a,l);var h=0;for(o=r;o<n;++o){var d=t.Vector3.distanceSquared(l,e[o]);d>h&&(h=d)}i.radius=Math.sqrt(h)}static createfromPoints(e,t){if(null==e)throw new Error("points");Bi.createFromSubPoints(e,0,e.length,t)}intersectsRayDistance(e){return He.intersectsRayAndSphereRD(e,this)}intersectsRayPoint(e,t){return He.intersectsRayAndSphereRP(e,this,t)}cloneTo(e){this._center.cloneTo(e._center),e._radius=this._radius}clone(){var e=new Bi(new t.Vector3,0);return this.cloneTo(e),e}}const wi=new t.Vector3;class Li{get min(){return this.getMin()}set min(e){this.setMin(e)}get max(){return this.getMax()}set max(e){this.setMax(e)}setMin(e){var t=this._boundBox.min;e!==t&&e.cloneTo(t),this._setUpdateFlag(Li._UPDATE_CENTER|Li._UPDATE_EXTENT,!0),this._setUpdateFlag(Li._UPDATE_MIN,!1)}getMin(){var e=this._boundBox.min;return this._getUpdateFlag(Li._UPDATE_MIN)&&(this._getMin(this.getCenter(),this.getExtent(),e),this._setUpdateFlag(Li._UPDATE_MIN,!1)),e}setMax(e){var t=this._boundBox.max;e!==t&&e.cloneTo(t),this._setUpdateFlag(Li._UPDATE_CENTER|Li._UPDATE_EXTENT,!0),this._setUpdateFlag(Li._UPDATE_MAX,!1)}getMax(){var e=this._boundBox.max;return this._getUpdateFlag(Li._UPDATE_MAX)&&(this._getMax(this.getCenter(),this.getExtent(),e),this._setUpdateFlag(Li._UPDATE_MAX,!1)),e}setCenter(e){e!==this._center&&e.cloneTo(this._center),this._getMin(this._center,this._extent,this._boundBox.min),this._getMax(this._center,this._extent,this._boundBox.max),this._setUpdateFlag(Li._UPDATE_CENTER|Li._UPDATE_MIN|Li._UPDATE_MAX,!1)}getCenter(){return this._getUpdateFlag(Li._UPDATE_CENTER)&&(this._getCenter(this.getMin(),this.getMax(),this._center),this._setUpdateFlag(Li._UPDATE_CENTER,!1)),this._center}setExtent(e){e!==this._extent&&e.cloneTo(this._extent),this._getMin(this._center,this._extent,this._boundBox.min),this._getMax(this._center,this._extent,this._boundBox.max),this._setUpdateFlag(Li._UPDATE_CENTER|Li._UPDATE_MIN|Li._UPDATE_MAX,!1)}getExtent(){return this._getUpdateFlag(Li._UPDATE_EXTENT)&&(this._getExtent(this.getMin(),this.getMax(),this._extent),this._setUpdateFlag(Li._UPDATE_EXTENT,!1)),this._extent}constructor(e,r){this._updateFlag=0,this._center=new t.Vector3,this._extent=new t.Vector3,this._boundBox=new aa(new t.Vector3,new t.Vector3),e&&e.cloneTo(this._boundBox.min),r&&r.cloneTo(this._boundBox.max),this._setUpdateFlag(Li._UPDATE_MIN|Li._UPDATE_MAX,!1),this._setUpdateFlag(Li._UPDATE_CENTER|Li._UPDATE_EXTENT,!0)}_getUpdateFlag(e){return 0!=(this._updateFlag&e)}_setUpdateFlag(e,t){t?this._updateFlag|=e:this._updateFlag&=~e}_getCenter(e,r,a){t.Vector3.add(e,r,a),t.Vector3.scale(a,.5,a)}_getExtent(e,r,a){t.Vector3.subtract(r,e,a),t.Vector3.scale(a,.5,a)}_getMin(e,r,a){t.Vector3.subtract(e,r,a)}_getMax(e,r,a){t.Vector3.add(e,r,a)}_rotateExtents(e,t,r){var a=e.x,i=e.y,n=e.z,s=t.elements;r.x=Math.abs(s[0]*a)+Math.abs(s[4]*i)+Math.abs(s[8]*n),r.y=Math.abs(s[1]*a)+Math.abs(s[5]*i)+Math.abs(s[9]*n),r.z=Math.abs(s[2]*a)+Math.abs(s[6]*i)+Math.abs(s[10]*n)}_tranform(e,r){var a=r._center,i=r._extent;t.Vector3.transformCoordinate(this.getCenter(),e,a),this._rotateExtents(this.getExtent(),e,i),r._boundBox.setCenterAndExtent(a,i),r._updateFlag=0}_getBoundBox(){if(this._updateFlag&Li._UPDATE_MIN){var e=this._boundBox.min;this._getMin(this.getCenter(),this.getExtent(),e),this._setUpdateFlag(Li._UPDATE_MIN,!1)}if(this._updateFlag&Li._UPDATE_MAX){var t=this._boundBox.max;this._getMax(this.getCenter(),this.getExtent(),t),this._setUpdateFlag(Li._UPDATE_MAX,!1)}return this._boundBox}calculateBoundsintersection(e){var t=this.getMax(),r=this.getMin(),a=e.getMax(),i=e.getMin(),n=Ni,s=Pi,o=this.getExtent(),l=e.getExtent();return n.setValue(Math.max(t.x,a.x)-Math.min(r.x,i.x),Math.max(t.y,a.y)-Math.min(r.y,i.y),Math.max(t.z,a.z)-Math.min(r.z,i.z)),s.setValue(2*(o.x+l.x),2*(o.y+l.y),2*(o.z+l.z)),n.x>s.x||n.y>s.y||n.z>s.z?-1:(s.x-n.x)*(s.y-n.y)*(s.z-n.z)}cloneTo(e){this.getMin().cloneTo(e._boundBox.min),this.getMax().cloneTo(e._boundBox.max),this.getCenter().cloneTo(e._center),this.getExtent().cloneTo(e._extent),e._updateFlag=0}clone(){var e=new Li(new t.Vector3,new t.Vector3);return this.cloneTo(e),e}}Li._UPDATE_MIN=1,Li._UPDATE_MAX=2,Li._UPDATE_CENTER=4,Li._UPDATE_EXTENT=8;const Ni=new t.Vector3,Pi=new t.Vector3;class Fi{constructor(e){if(!(e instanceof Array)||4!==e.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|e[0],this._state0L=0|e[1],this._state1U=0|e[2],this._state1L=0|e[3]}randomint(){var e=this._state0U,t=this._state0L,r=this._state1U,a=this._state1L,i=(a>>>0)+(t>>>0),n=r+e+(i/2>>>31)>>>0,s=i>>>0;this._state0U=r,this._state0L=a;var o=0,l=0;o=(e^=o=e<<23|(-512&t)>>>9)^r,l=(t^=l=t<<23)^a;o^=e>>>18,l^=t>>>18|(262143&e)<<14;return o^=r>>>5,l^=a>>>5|(31&r)<<27,this._state1U=o,this._state1L=l,[n,s]}random(){var e=this.randomint(),t=e[0],r=1023<<20|t>>>12,a=0|(e[1]>>>12|(4095&t)<<20);return Fi._CONVERTION_BUFFER.setUint32(0,r,!1),Fi._CONVERTION_BUFFER.setUint32(4,a,!1),Fi._CONVERTION_BUFFER.getFloat64(0,!1)-1}}Fi._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8)),Fi.defaultRand=new Fi([0,Date.now()/65536,0,Date.now()%65536]);var Oi;e.ShadowLightType=void 0,(Oi=e.ShadowLightType||(e.ShadowLightType={}))[Oi.DirectionLight=0]="DirectionLight",Oi[Oi.SpotLight=1]="SpotLight",Oi[Oi.PointLight=2]="PointLight";class bi{constructor(){this.boundFrustum=new Je(new t.Matrix4x4)}}class Vi{}Vi.COLLISIONFILTERGROUP_DEFAULTFILTER=1,Vi.COLLISIONFILTERGROUP_STATICFILTER=2,Vi.COLLISIONFILTERGROUP_KINEMATICFILTER=4,Vi.COLLISIONFILTERGROUP_DEBRISFILTER=8,Vi.COLLISIONFILTERGROUP_SENSORTRIGGER=16,Vi.COLLISIONFILTERGROUP_CHARACTERFILTER=32,Vi.COLLISIONFILTERGROUP_CUSTOMFILTER1=64,Vi.COLLISIONFILTERGROUP_CUSTOMFILTER2=128,Vi.COLLISIONFILTERGROUP_CUSTOMFILTER3=256,Vi.COLLISIONFILTERGROUP_CUSTOMFILTER4=512,Vi.COLLISIONFILTERGROUP_CUSTOMFILTER5=1024,Vi.COLLISIONFILTERGROUP_CUSTOMFILTER6=2048,Vi.COLLISIONFILTERGROUP_CUSTOMFILTER7=4096,Vi.COLLISIONFILTERGROUP_CUSTOMFILTER8=8192,Vi.COLLISIONFILTERGROUP_CUSTOMFILTER9=16384,Vi.COLLISIONFILTERGROUP_CUSTOMFILTER10=32768,Vi.COLLISIONFILTERGROUP_ALLFILTER=-1,Vi.PHYSXDEFAULTMASKVALUE=4294967295;class Ui{static get fullScreen(){return new Ui(-1,-1)}get width(){return-1===this._width?Y.clientWidth:this._width}get height(){return-1===this._height?Y.clientHeight:this._height}constructor(e,t){this._width=0,this._height=0,this._width=e,this._height=t}}e.AlternateLightQueue=Ne,e.AnimationClip=Xr,e.AnimationClipParser03=zr,e.AnimationClipParser04=Qr,e.AnimationEvent=kr,e.Animator=Aa,e.AnimatorController=Ba,e.AnimatorControllerLayer=Da,e.AnimatorPlayState=Ea,e.AnimatorResource=Ta,e.AnimatorState=Ca,e.AnimatorStateScript=class{setPlayScriptInfo(e,t,r){this.playStateInfo.animator=e,this.playStateInfo.layerindex=t,this.playStateInfo.playState=r}constructor(){this.playStateInfo={animator:null,layerindex:-1,playState:null}}onStateEnter(){}onStateUpdate(e){}onStateExit(){}onStateLoop(){}},e.AnimatorTransition=ya,e.AreaLightCom=da,e.AvatarMask=Ia,e.AxiGamepad=ni,e.BaseCamera=we,e.BaseRender=U,e.BatchMark=wa,e.BatchRender=Na,e.BlinnPhongMaterial=i,e.BlinnPhongShaderInit=sr,e.BlitFrameBufferCMD=Ht,e.BlitQuadCMDData=class{get element(){return this._element}set element(e){this._element=e}get dest(){return this._dest}set dest(e){this._dest=e}get viewport(){return this._viewport}set viewport(e){this._viewport=e}get scissor(){return this._scissor}set scissor(e){this._scissor=e}get source(){return this._source}set source(e){this._source=e}get offsetScale(){return this._offsetScale}set offsetScale(e){this._offsetScale=e}apply(e){throw new t.NotImplementedError}},e.BlitScreenQuadCMD=Mt,e.BlitScreenShaderInit=rr,e.BoundBox=aa,e.BoundFrustum=Je,e.BoundSphere=Bi,e.Bounds=w,e.BoundsImpl=Li,e.ButtonGamepad=si,e.Camera=Vt,e.CameraCullInfo=bi,e.Cluster=ie,e.Collision=class{constructor(){this._lastUpdateFrame=-2147483648,this._updateFrame=-2147483648,this._isTrigger=!1,this.contacts=[],this._inPool=!1}_setUpdateFrame(e){this._lastUpdateFrame=this._updateFrame,this._updateFrame=e}},e.CollisionUtils=He,e.Command=Q,e.CommandBuffer=Ft,e.CommandUniformMap=class{constructor(e){}addShaderUniform(e,t,r){throw"need override it"}addShaderUniformArray(e,t,r,a){throw"need override it"}},e.ContactPoint=class{constructor(){this._idCounter=0,this._colliderA=null,this._colliderB=null,this.distance=0,this.normal=new t.Vector3,this.positionOnA=new t.Vector3,this.positionOnB=new t.Vector3,this._id=++this._idCounter}},e.ContainmentType=Ue,e.CubemapLoader=za,e.DepthPass=pt,e.DirectionLightCom=sa,e.DrawElementCMDData=class{setRenderelements(e){throw new t.NotImplementedError}apply(e){throw new t.NotImplementedError}},e.DrawMeshCMD=vt,e.DrawMeshInstancedCMD=Lt,e.DrawNodeCMDData=class{get node(){return this._node}set node(e){this._node=e}get destShaderData(){return this._destShaderData}set destShaderData(e){this._destShaderData=e}get destSubShader(){return this._destSubShader}set destSubShader(e){this._destSubShader=e}get subMeshIndex(){return this._subMeshIndex}set subMeshIndex(e){this._subMeshIndex=e}apply(e){throw new t.NotImplementedError}},e.DrawRenderCMD=yt,e.DrawRenderElementCMD=Pt,e.EffectMaterial=Jr,e.ExtendTerrainMaterial=jr,e.FrustumCulling=class{static cullingRenderBounds(e,t){for(var r=t.cullPlaneCount,a=t.cullPlanes,i=e._imp.getMin(),n=e._imp.getMax(),s=i.x,o=i.y,l=i.z,h=n.x,d=n.y,c=n.z,u=!0,_=0;_<r;_++){var f=a[_],g=f.normal;if(f.distance+g.x*(g.x<0?s:h)+g.y*(g.y<0?o:d)+g.z*(g.z<0?l:c)<0){u=!1;break}}return u}},e.GeometryElement=xe,e.HLOD=fi,e.HLODBatchMesh=class extends xe{constructor(){super(t.MeshTopology.Triangles,t.DrawType.DrawElement)}get batchMesh(){return this._mesh}set batchMesh(e){this._mesh!=e&&(this._mesh&&this._mesh._removeReference(),this.indexFormat=e.indexFormat,this._mesh=e,this._mesh._addReference())}get batchSubMeshInfo(){return this._batchSubMeshInfos}set batchSubMeshInfo(e){this._batchSubMeshInfos=e}get drawSubMeshs(){return this._drawSubMeshs}set drawSubMeshs(e){this._drawSubMeshs=e}_prepareRender(e){return this._mesh._uploadVerticesData(),!0}_updateRenderParams(e){var r,a=this._mesh;switch(a.indexFormat){case t.IndexFormat.UInt32:r=4;break;case t.IndexFormat.UInt16:r=2;break;case t.IndexFormat.UInt8:r=1}this.clearRenderParams(),this.bufferState=a._bufferState,this._drawSubMeshs&&this._drawSubMeshs.forEach((e=>{this.setDrawElemenParams(e.drawPramas.y,e.drawPramas.x*r)}))}destroy(){this._mesh&&this._mesh._removeReference(),delete this._batchSubMeshInfos,delete this._drawSubMeshs}},e.HLODBatchSubMesh=class{},e.HLODConfig=class{},e.HLODElement=class{get material(){return this._material}set material(e){this._material!=e&&(this._material&&this._material._removeReference(),this._material=e,this._material._addReference())}get lightmap(){return this._lightmap}set lightmap(e){this._lightmap!=e&&(this._lightmap&&(this._lightmap.lightmapColor._removeReference(),this._lightmap.lightmapDirection._removeReference()),this._lightmap=e,this._lightmap.lightmapColor._addReference(),this._lightmap.lightmapDirection._addReference()),this._lightmap=e}release(){this.HLODMesh.destroy(),this.material.destroy(),this.lightmap&&(this._lightmap.lightmapColor.destroy(),this._lightmap.lightmapDirection.destroy())}},e.HLODRender=ui,e.HLODResourceGroup=class{load(e,r){this.loaded||t.Laya.loader.load(this.url,t.Handler.create(this,(t=>{e.apply(r,[this]),this.loaded=!0}),[this]))}release(){this.resources.forEach((e=>{e.release()})),this.loaded=!1}},e.HitResult=Wa,e.ILaya3D=r,e.IndexBuffer3D=Lr,e.InstanceBatchManager=La,e.InstanceRenderElement=Xt,e.KeyframeNode=Gr,e.KeyframeNodeList=Yr,e.KeyframeNodeOwner=Wr,e.LODGroup=_a,e.LODInfo=ua,e.Laya3D=wr,e.Laya3DRender=E,e.LengencyRenderEngine3DFactory=Pr,e.Light=lt,e.LightQueue=Le,e.LightSprite=Kr,e.Lightmap=Pe,e.LoadModelV04=Ka,e.LoadModelV05=Za,e.MaterialInstanceProperty=Mi,e.MaterialInstancePropertyBlock=Ii,e.Mesh=jt,e.MeshFilter=A,e.MeshInstanceGeometry=wt,e.MeshReader=$a,e.MeshRenderer=k,e.MeshSprite3D=z,e.MeshSprite3DShaderDeclaration=D,e.MeshUtil=T,e.MorphTarget=Ja,e.MorphTargetChannel=ja,e.MorphTargetData=qa,e.PBRDefaultDFG=s,e.PBRMaterial=f,e.PBRShaderLib=_,e.PBRStandardMaterial=g,e.PBRStandardShaderInit=or,e.Physics3DStatInfo=vr,e.Physics3DUtils=Vi,e.PhysicsSettings=_e,e.Picker=St,e.PixelLineData=fa,e.PixelLineFilter=ga,e.PixelLineMaterial=Ir,e.PixelLineRenderer=Sa,e.PixelLineSprite3D=class extends B{get maxLineCount(){return this._render.maxLineCount}set maxLineCount(e){this._render.maxLineCount=e}get lineCount(){return this._render.lineCount}get pixelLineRenderer(){return this._render}constructor(e=2,t=null){super(t),this._isRenderActive=!1,this._isInRenders=!1,this._render=this.addComponent(Sa),this._geometryFilter=this._render._pixelLineFilter,this._render.maxLineCount=e,(this._render.material=new S).enableVertexColor=!0}addLine(e,t,r,a){this._render.addLine(e,t,r,a)}addLines(e){this._render.addLines(e)}removeLine(e){this._render.removeLine(e)}setLine(e,t,r,a,i){this._render.setLine(e,t,r,a,i)}getLine(e,t){this._render.getLine(e,t)}clear(){this._render.clear()}},e.PixelLineVertex=W,e.Plane=be,e.PointLightCom=oa,e.PostProcess=Br,e.PostProcessEffect=va,e.PostProcessRenderContext=yr,e.PrimitiveMesh=$t,e.Rand=class{static getFloatFromInt(e){return 1/8388607*(8388607&e)}static getByteFromInt(e){return(8388607&e)>>>15}get seed(){return this.seeds[0]}set seed(e){this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}constructor(e){this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}getUint(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3]}getFloat(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)}getSignedFloat(){return 2*this.getFloat()-1}},e.RandX=Fi,e.Ray=Ve,e.ReflectionProbe=b,e.ReflectionProbeManager=N,e.RenderContext3D=Y,e.RenderElement=H,e.RenderState=a,e.RenderableSprite3D=B,e.Scene3D=Qt,e.Scene3DShaderDeclaration=Fe,e.SceneRenderManager=Gt,e.SceneRenderManagerOBJ=class{constructor(){this._renders=new t.SingletonList,this._motionRenders=new t.SingletonList,this.baseRenderList=new t.SingletonList}get list(){return this._renders}set list(e){this._renders=e}addRenderObject(e){this._renders.add(e),this.baseRenderList.add(e._baseRenderNode)}removeRenderObject(e){this._renders.remove(e),this.baseRenderList.remove(e._baseRenderNode),this.removeMotionObject(e)}removeMotionObject(e){}updateMotionObjects(){}addMotionObject(e){}destroy(){this._renders.destroy()}},e.ScreenQuad=Rt,e.Script3D=gi,e.SetDefineCMD=It,e.SetGlobalShaderDataCMD=Bt,e.SetRTCMD=Nt,e.SetRenderDataCMD=class{get value(){return this._value}set value(e){this._value=e}get dataType(){return this._dataType}set dataType(e){this._dataType=e}get propertyID(){return this._propertyID}set propertyID(e){this._propertyID=e}get dest(){return this._dest}set dest(e){this._dest=e}apply(e){throw new t.NotImplementedError}},e.SetRenderTargetCMD=class{get rt(){return this._rt}set rt(e){this._rt=e}get clearFlag(){return this._clearFlag}set clearFlag(e){this._clearFlag=e}get clearDepthValue(){return this._clearDepthValue}set clearDepthValue(e){this._clearDepthValue=e}get clearStencilValue(){return this._clearStencilValue}set clearStencilValue(e){this._clearStencilValue=e}get clearColorValue(){return this._clearColorValue}set clearColorValue(e){this._clearColorValue=e}apply(e){throw new t.NotImplementedError}},e.SetShaderDataCMD=Ct,e.SetShaderDefineCMD=class{get define(){return this._define}set define(e){this._define=e}get dest(){return this._dest}set dest(e){this._dest=e}get add(){return this._add}set add(e){this._add=e}apply(e){throw new t.NotImplementedError}},e.SetViewportCMD=class{get viewport(){return this._viewport}set viewport(e){this._viewport=e}get scissor(){return this._scissor}set scissor(e){this._scissor=e}apply(e){throw new t.NotImplementedError}},e.ShaderData=class{constructor(e=null){this._ownerResource=e}getDefineData(){throw new t.NotImplementedError}getData(){throw new t.NotImplementedError}addDefine(e){throw new t.NotImplementedError}addDefines(e){throw new t.NotImplementedError}removeDefine(e){throw new t.NotImplementedError}hasDefine(e){throw new t.NotImplementedError}clearDefine(){throw new t.NotImplementedError}clearData(){throw new t.NotImplementedError}getBool(e){throw new t.NotImplementedError}setBool(e,r){throw new t.NotImplementedError}getInt(e){throw new t.NotImplementedError}setInt(e,r){throw new t.NotImplementedError}getNumber(e){throw new t.NotImplementedError}setNumber(e,r){throw new t.NotImplementedError}getVector2(e){throw new t.NotImplementedError}setVector2(e,r){throw new t.NotImplementedError}getVector3(e){throw new t.NotImplementedError}setVector3(e,r){throw new t.NotImplementedError}getVector(e){throw new t.NotImplementedError}setVector(e,r){throw new t.NotImplementedError}getColor(e){throw new t.NotImplementedError}setColor(e,r){throw new t.NotImplementedError}getMatrix4x4(e){throw new t.NotImplementedError}setMatrix4x4(e,r){throw new t.NotImplementedError}getMatrix3x3(e){throw new t.NotImplementedError}setMatrix3x3(e,r){throw new t.NotImplementedError}getBuffer(e){throw new t.NotImplementedError}setBuffer(e,r){throw new t.NotImplementedError}setTexture(e,r){throw new t.NotImplementedError}getTexture(e){throw new t.NotImplementedError}setShaderData(t,r,a){switch(r){case e.ShaderDataType.Int:this.setInt(t,a);break;case e.ShaderDataType.Bool:this.setBool(t,a);break;case e.ShaderDataType.Float:this.setNumber(t,a);break;case e.ShaderDataType.Vector2:this.setVector2(t,a);break;case e.ShaderDataType.Vector3:this.setVector3(t,a);break;case e.ShaderDataType.Vector4:this.setVector(t,a);break;case e.ShaderDataType.Color:this.setColor(t,a);break;case e.ShaderDataType.Matrix4x4:this.setMatrix4x4(t,a);break;case e.ShaderDataType.Matrix3x3:this.setMatrix3x3(t,a);break;case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:this.setTexture(t,a);break;case e.ShaderDataType.Buffer:this.setBuffer(t,a);break;default:throw new Error(`unknown shader data type: ${r}`)}}getShaderData(t,r){switch(r){case e.ShaderDataType.Int:return this.getInt(t);case e.ShaderDataType.Bool:return this.getBool(t);case e.ShaderDataType.Float:return this.getNumber(t);case e.ShaderDataType.Vector2:return this.getVector2(t);case e.ShaderDataType.Vector3:return this.getVector3(t);case e.ShaderDataType.Vector4:return this.getVector(t);case e.ShaderDataType.Color:return this.getColor(t);case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:return this.getTexture(t);case e.ShaderDataType.Buffer:return this.getBuffer(t);case e.ShaderDataType.Matrix3x3:return this.getMatrix3x3(t);case e.ShaderDataType.Matrix4x4:return this.getMatrix4x4(t);default:throw"unknown shader data type."}}_setInternalTexture(e,r){throw new t.NotImplementedError}cloneTo(e){throw new t.NotImplementedError}clone(){throw new t.NotImplementedError}destroy(){throw new t.NotImplementedError}},e.ShaderDataDefaultValue=function(r){switch(r){case e.ShaderDataType.Int:return 0;case e.ShaderDataType.Bool:return!1;case e.ShaderDataType.Float:return 0;case e.ShaderDataType.Vector2:return t.Vector2.ZERO;case e.ShaderDataType.Vector3:return t.Vector3.ZERO;case e.ShaderDataType.Vector4:return t.Vector4.ZERO;case e.ShaderDataType.Color:return t.Color.BLACK;case e.ShaderDataType.Matrix4x4:return t.Matrix4x4.DEFAULT;case e.ShaderDataType.Matrix3x3:return t.Matrix3x3.DEFAULT}return null},e.ShaderDefine=class{constructor(e,t){this._index=e,this._value=t}},e.ShaderInit3D=Dr,e.ShadowCasterPass=mt,e.ShadowCullInfo=class{},e.ShadowSliceData=class{constructor(){this.position=new t.Vector3,this.viewMatrix=new t.Matrix4x4,this.projectionMatrix=new t.Matrix4x4,this.viewProjectMatrix=new t.Matrix4x4,this.cullPlanes=[new be(new t.Vector3,0),new be(new t.Vector3,0),new be(new t.Vector3,0),new be(new t.Vector3,0),new be(new t.Vector3,0),new be(new t.Vector3,0),new be(new t.Vector3,0),new be(new t.Vector3,0),new be(new t.Vector3,0),new be(new t.Vector3,0)],this.splitBoundSphere=new Bi(new t.Vector3,0),this.cameraShaderValue=t.LayaGL.renderDeviceFactory.createShaderData(null)}destroy(){this.cameraShaderValue.destroy(),this.cameraShaderValue=null,this.cullPlanes=null}},e.ShadowSpotData=class{constructor(){this.position=new t.Vector3,this.viewMatrix=new t.Matrix4x4,this.projectionMatrix=new t.Matrix4x4,this.viewProjectMatrix=new t.Matrix4x4,this.cameraShaderValue=t.LayaGL.renderDeviceFactory.createShaderData(null),this.cameraCullInfo=new bi}destroy(){this.cameraShaderValue.destroy(),this.cameraShaderValue=null,this.cameraCullInfo=null}},e.ShadowUtils=ht,e.SimpleSkinnedMeshRenderer=Rr,e.SimpleSkinnedMeshSprite3D=Mr,e.Size=Ui,e.SkinRenderElement=Ar,e.SkinnedMeshRenderer=xr,e.SkinnedMeshSprite3D=qr,e.SkinnedMeshSprite3DShaderDeclaration=Tr,e.SkyBox=Re,e.SkyBoxMaterial=m,e.SkyBoxShaderInit=lr,e.SkyDome=Ce,e.SkyPanoramicMaterial=Cr,e.SkyPanoramicShaderInit=Er,e.SkyProceduralMaterial=p,e.SkyProceduralShaderInit=hr,e.SkyRenderElement=ye,e.SkyRenderer=Ie,e.SphericalHarmonicsL2=Zr,e.SphericalHarmonicsL2Generater=ra,e.SpotLightCom=la,e.Sprite3D=x,e.Sprite3DRenderDeclaration=V,e.StatiVertexMergeBatchRender=Oa,e.StaticBatchMesh=Ti,e.StaticBatchMeshRender=xi,e.StaticBatchMeshRenderElement=Ai,e.StaticBatchSubInfo=mi,e.StaticBatchSubMesh=pi,e.StaticBatchVolume=ba,e.StaticInstanceBatchRender=Fa,e.StaticMeshBatchManager=class{constructor(){this.meshVertexDecSet=new Set}combine(e){for(const t of e){let e=!1;for(const r of this.meshVertexDecSet)r.match(t)&&(e=!0,r.addElement(t));if(!e){let e=Ri.create(t);e.addElement(t),this.meshVertexDecSet.add(e)}}let t=[];for(const e of this.meshVertexDecSet)t.push(xi.create(e));return this.meshVertexDecSet.clear(),t}merge(e){return xi.create(e)}},e.StaticMeshMergeInfo=Ri,e.SubMesh=Kt,e.SubMeshInstanceBatch=Yt,e.SubMeshRenderElement=G,e.TextMesh=class{get text(){return this._text}set text(e){this._text=e}get fontSize(){return this._fontSize}set fontSize(e){this._fontSize=e}get color(){return this._color}set color(e){this._color=e}constructor(){}},e.Texture2DArrayLoader=yi,e.TextureGenerator=X,e.Transform3D=fe,e.UBOStat=Vr,e.UI3D=Ua,e.UI3DGeometry=Va,e.UI3DManager=kt,e.UniformBufferAlone=Ur,e.UniformBufferBlock=Fr,e.UniformBufferCluster=Or,e.UniformBufferManager=class{constructor(e){this._destroyed=!1,this._needUpdateClusters=[],this._removeHoleArray=[],this._optimizeBufferPosArray=[],this._useBigBuffer=!0,this.byteAlign=256,this.clusterMaxBlock=256,this.uploadThreshold=200,this.removeHoleThreshold=10,this._enableStat=!0,this.aloneBuffers=[],this._useBigBuffer=e,this._clustersAll=new Map,this._clustersCur=new Map,this._stat=new Vr}_createBufferCluster(e,t){return new Or(e,t,this)}_addCluster(e,t=16){const r=br(e,this.byteAlign),a=this._createBufferCluster(r,t),i=this._clustersAll.get(r);return i?(i.push(a),a._sn=i.length-1):this._clustersAll.set(r,[a]),this._clustersCur.set(r,a),a}startFrame(){}endFrame(){if(this._enableStat&&(this._stat.moveNum=0,this._stat.uploadNum=0,this._stat.uploadByte=0,this._stat.timeCostCount++),this._useBigBuffer){if(this._removeHoleArray.length>0){for(let e=this._removeHoleArray.length-1;e>-1;e--)this._removeHoleArray[e].removeHole();this._removeHoleArray.length=0}if(this._optimizeBufferPosArray.length>0){for(let e=this._optimizeBufferPosArray.length-1;e>-1;e--)this._optimizeBufferPosArray[e].optimize();this._optimizeBufferPosArray.length=0}}}getBufferAlone(e,t){const r=br(e,this.byteAlign);return this.statisGPUMemory(r),this.createGPUBuffer(r,t)}removeCluster(e,t){var r;const a=br(e,this.byteAlign);if(t<0)return this._clustersAll.delete(a),void this._clustersCur.delete(a);const i=null===(r=this._clustersCur.get(a))||void 0===r?void 0:r._sn,n=this._clustersAll.get(a);if(n.length>t){if(n.splice(t,1),0===n.length)return this._clustersAll.delete(a),void this._clustersCur.delete(a);for(let e=t;e<n.length;e++)n[e]._sn--;if(void 0!==i&&i===t){let e=-1,t=-1,r=-1;for(let a=n.length-1;a>-1;a--)t=n[a].usedNum,t>e&&t<this.clusterMaxBlock&&(r=a,e=t);r>=0?this._clustersCur.set(a,n[r]):this._clustersCur.delete(a)}}}getBlock(e,t){const r=br(e,this.byteAlign);let a=this._clustersCur.get(r);if(!a)return this._addCluster(r).getBlock(e,t);if(a.usedNum<this.clusterMaxBlock)return a.getBlock(e,t);a=null;const i=this._clustersAll.get(r);let n=-1,s=-1,o=-1;for(let e=i.length-1;e>0;e--)s=i[e].usedNum,s>n&&s<this.clusterMaxBlock&&(o=e,n=s);return o>=0?(a=i[o],this._clustersCur.set(r,a)):this._clustersCur.delete(r),a?a.getBlock(e,t):this._addCluster(r).getBlock(e,t)}freeBlock(e){const t=e.cluster;return!!t&&(!!t.freeBlock(e)&&(0===t.usedNum&&this.removeCluster(t._blockSize,t._sn),!0))}upload(){if(this._useBigBuffer){let e,t;this._enableStat&&(e=performance.now());for(let e=this._needUpdateClusters.length-1;e>-1;e--)t=this._needUpdateClusters[e],t.upload(),t._inManagerUpdateArray=!1;this._needUpdateClusters.length=0,this._enableStat&&this.statisTimeCostAvg(performance.now()-e)}}_addUpdateArray(e){e._inManagerUpdateArray||(this._needUpdateClusters.push(e),e._inManagerUpdateArray=!0)}_addRemoveHoleCluster(e){-1===this._removeHoleArray.indexOf(e)&&this._removeHoleArray.push(e)}_addOptimizeBufferPos(e){-1===this._optimizeBufferPosArray.indexOf(e)&&this._optimizeBufferPosArray.push(e)}clear(){this._clustersAll.forEach((e=>{for(let t=e.length-1;t>-1;t--)e[t].clear()}))}destroy(){return this._destroyed?(console.warn("UniformBufferManager: object alreay destroyed!"),!1):(this.clear(),this._clustersAll.clear(),this._clustersCur.clear(),this._destroyed=!0,!0)}createGPUBuffer(e,t){}writeBuffer(e,t,r,a){}statisGPUMemory(e){}statisTimeCostAvg(e){this._stat.timeCostSum+=e,this._stat.timeCostCount>100&&(this._stat.timeCostAvg=(this._stat.timeCostSum/this._stat.timeCostCount*1e4|0)/10,this._stat.timeCostSum=0,this._stat.timeCostCount=0)}statisUpload(e,t){this._stat.uploadNum+=e,this._stat.uploadByte+=t}},e.UniformBufferUser=Hr,e.UnlitMaterial=S,e.UnlitShaderInit=nr,e.Utils3D=K,e.VertexBuffer3D=Nr,e.VertexPositionTexture=Me,e.Volume=L,e.VolumeManager=O,e.VolumetricGI=P,e.VolumetricGIManager=F,e.WebXRCamera=ti,e.WebXRCameraInfo=class{},e.WebXRCameraManager=ii,e.WebXRExperienceHelper=ci,e.WebXRInput=oi,e.WebXRInputManager=li,e.WebXRRenderTexture=ri,e.WebXRSessionManager=ai,e.checkShaderDataValueLegal=function(r,a){let i=!1;switch(a){case e.ShaderDataType.Int:case e.ShaderDataType.Float:i="number"==typeof r;break;case e.ShaderDataType.Bool:i="boolean"==typeof r;break;case e.ShaderDataType.Vector2:i=r instanceof t.Vector2;break;case e.ShaderDataType.Vector3:i=r instanceof t.Vector3;break;case e.ShaderDataType.Vector4:i=r instanceof t.Vector4;break;case e.ShaderDataType.Color:i=r instanceof t.Color;break;case e.ShaderDataType.Matrix4x4:i=r instanceof t.Matrix4x4;break;case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:i=r instanceof t.BaseTexture;break;case e.ShaderDataType.Buffer:i=r instanceof ArrayBuffer;break;case e.ShaderDataType.Matrix3x3:i=r instanceof t.Matrix3x3;break;default:i=!1}return i||console.warn("The setting value and Shader type do not match"),i},e.roundDown=function(e,t){const r=((e+t-1)/t|0)*t;return r>e?r-t:r},e.roundUp=br,e.skinnedMatrixCache=Jt,e.volumeIntersectInfo=class{}}(window.Laya=window.Laya||{},Laya);